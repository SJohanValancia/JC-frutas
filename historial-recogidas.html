<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial de Recogidas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #ffffff;
            --secondary-color: #ff6b6b;
            --success-color: #4ecdc4;
            --warning-color: #ffe66d;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2b2b2b 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 15px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 0 10px;
        }

        .header h1 {
            font-size: 2.2em;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .filters-container {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-input, .filter-select {
            padding: 14px 16px;
            border: 2px solid transparent;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 1em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-height: 48px;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            transform: translateY(-2px);
        }

        .filter-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .filter-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9em;
            min-height: 48px;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), #0099cc);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, var(--secondary-color), #cc5555);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recogidas-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .recogida-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .recogida-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 20px 20px 0 0;
        }

        .recogida-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 15px;
        }

        .finca-info h3 {
            font-size: 1.4em;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-weight: 700;
            line-height: 1.3;
        }

        .finca-info p {
            color: var(--text-secondary);
            font-size: 1em;
            line-height: 1.4;
        }

        .fecha-badge {
            background: linear-gradient(45deg, var(--success-color), #45b7aa);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            white-space: nowrap;
        }

        .card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .info-item:hover {
            background: rgba(0, 0, 0, 0.3);
            transform: scale(1.05);
        }

        .info-icon {
            font-size: 1.6em;
            margin-bottom: 10px;
        }

        .info-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--glass-border);
        }

        .usuario-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .usuario-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1em;
        }

        .usuario-name {
            font-size: 0.95em;
            font-weight: 600;
        }

        .pesas-summary {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 18px;
            margin-top: 15px;
        }

        .pesas-title {
            font-size: 0.95em;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
        }

        .pesa-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: var(--text-secondary);
        }

        .no-results {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .quality-badge {
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quality-primera {
            background: linear-gradient(45deg, var(--success-color), #45b7aa);
            color: white;
        }

        .quality-segunda {
            background: linear-gradient(45deg, var(--warning-color), #e6cc00);
            color: #333;
        }

        .quality-extra {
            background: linear-gradient(45deg, var(--secondary-color), #cc5555);
            color: white;
        }

        /* OPTIMIZACIÓN ESPECÍFICA PARA iPhone 12 Pro (390px x 844px) */
        @media (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }

            .header h1 {
                font-size: 2em;
                margin-bottom: 12px;
            }

            .header p {
                font-size: 1em;
            }

            .filters-container {
                padding: 20px;
                margin-bottom: 25px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
                margin-bottom: 25px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-value {
                font-size: 1.8em;
            }

            /* TARJETAS: 2 por fila en móvil con márgenes apropiados */
            .recogidas-container {
                grid-template-columns: 1fr 1fr;
                gap: 16px;
                margin: 0 -2px; /* Compensar márgenes */
            }

            .recogida-card {
                padding: 18px;
                border-radius: 16px;
            }

            .card-header {
                margin-bottom: 16px;
                padding-bottom: 12px;
            }

            .finca-info h3 {
                font-size: 1.1em;
                margin-bottom: 6px;
            }

            .finca-info p {
                font-size: 0.85em;
            }

            .fecha-badge {
                padding: 6px 12px;
                font-size: 0.75em;
            }

            .card-body {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 16px;
            }

            .info-item {
                padding: 12px;
            }

            .info-icon {
                font-size: 1.3em;
                margin-bottom: 8px;
            }

            .info-label {
                font-size: 0.75em;
                margin-bottom: 6px;
            }

            .info-value {
                font-size: 1em;
            }

            .usuario-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.85em;
            }

            .usuario-name {
                font-size: 0.85em;
            }

            .pesas-summary {
                padding: 14px;
                margin-top: 12px;
            }

            .pesas-title {
                font-size: 0.8em;
                margin-bottom: 10px;
            }

            .pesas-grid {
                grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
                gap: 8px;
            }

            .pesa-item {
                padding: 8px;
                font-size: 0.8em;
            }

            .filter-actions {
                flex-direction: column;
                margin-top: 20px;
            }

            .btn {
                width: 100%;
                padding: 16px;
                font-size: 0.95em;
            }
        }

        /* PANTALLAS MUY PEQUEÑAS: 1 tarjeta por fila */
        @media (max-width: 480px) {
            .container {
                padding: 16px 12px;
            }

            .recogidas-container {
                grid-template-columns: 1fr;
                gap: 20px;
                margin: 0;
            }

            .recogida-card {
                padding: 20px;
            }

            .card-body {
                grid-template-columns: 1fr 1fr;
            }

            .stats-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .card-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .fecha-badge {
                align-self: flex-end;
            }
        }

        /* Animaciones mejoradas */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .recogida-card {
            animation: fadeInUp 0.6s ease forwards;
        }

        .recogida-card:nth-child(even) {
            animation-delay: 0.1s;
        }

        .recogida-card:nth-child(odd) {
            animation-delay: 0.2s;
        }

        /* Mejoras de accesibilidad */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Optimización para pantallas de alta densidad */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .header h1 {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }

        .volver-btn {
  background: linear-gradient(135deg, #6c757d, #495057);
  color: white;
  border: none;
  padding: 15px 25px;
  border-radius: 25px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 20px;
  width: 100%;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.volver-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
}

    </style>
</head>
<body>

  <button class="volver-btn" onclick="window.history.back()">← Volver</button>


  <div class="container">
    <div class="header">

            <div class="stats-container" id="statsContainer">
      <!-- Las estadísticas se cargarán dinámicamente -->
    </div>

      <h1>📊 Historial de Recogidas</h1>
      <p>aqui podras ver todas las recogidas de frutas que se han echo filtrarlas como mas te guste</p>
    </div>

    <div class="filters-container">
      <div class="filters-grid">
        <div class="filter-group">
          <label>🔍 Buscar por texto</label>
          <input type="text" id="searchText" class="filter-input" placeholder="Finca, propietario, usuario...">
        </div>

        <div class="filter-group">
          <label>🍎 Fruta</label>
          <select id="filtroFruta" class="filter-select">
            <option value="">Todas las frutas</option>
          </select>
        </div>

        <div class="filter-group">
          <label>⭐ Calidad</label>
          <select id="filtroCalidad" class="filter-select">
            <option value="">Todas las calidades</option>
            <option value="primera">Primera</option>
            <option value="segunda">Segunda</option>
            <option value="extra">Extra</option>
          </select>
        </div>

        <div class="filter-group">
          <label>👤 Usuario</label>
          <select id="filtroUsuario" class="filter-select">
            <option value="">Todos los usuarios</option>
          </select>
        </div>

        <div class="filter-group">
          <label>📅 Rango de fechas</label>
          <div class="date-range">
            <input type="date" id="fechaDesde" class="filter-input">
            <input type="date" id="fechaHasta" class="filter-input">
          </div>
        </div>
      </div>

      <div class="filter-actions">
        <button class="btn btn-primary" onclick="aplicarFiltros()">🔍 Aplicar Filtros</button>
        <button class="btn btn-secondary" onclick="limpiarFiltros()">🗑️ Limpiar</button>
        <button class="btn btn-primary" onclick="exportarDatos()">📥 Exportar</button>
      </div>
    </div>



    <div id="recogidasContainer" class="recogidas-container">
      <div class="loading">⏳ Cargando recogidas...</div>
    </div>
  </div>

  <script>
    // Variables globales
    let todasLasRecogidas = [];
    let recogidasFiltradas = [];
    let tipoUsuarioActual = 1;
    let esSubusuario = false;

    // Obtener parámetros de URL
    const params = new URLSearchParams(window.location.search);
    const usuario = params.get("usuario") || "admin";


      function volverPaginaAnterior() {
    if (document.referrer !== '') {
      window.history.back(); // Regresar a la página anterior si existe en el historial
    } else {
      window.location.href = 'index.html'; // Si no hay historial, redirigir a la página de inicio o a una página predeterminada
    }
  }

    // Verificar tipo de usuario al cargar
    async function verificarTipoUsuario() {
      try {
        const storedData = sessionStorage.getItem('userData');
        if (storedData) {
          const userData = JSON.parse(storedData);
          tipoUsuarioActual = userData.tipo;
          esSubusuario = userData.tipo === 2;
        } else if (usuario) {
          const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
          if (response.ok) {
            const userData = await response.json();
            tipoUsuarioActual = userData.tipo;
            esSubusuario = userData.tipo === 2;
          }
        }
        console.log("👤 Tipo de usuario:", tipoUsuarioActual, "Es subusuario:", esSubusuario);
      } catch (error) {
        console.error("Error al verificar tipo de usuario:", error);
      }
    }

    // Cargar todas las recogidas
    async function cargarRecogidas() {
      try {
        await verificarTipoUsuario();
        
        // Determinar el adminAlias
        let adminAlias = params.get("alias");
        if (!adminAlias && usuario) {
          const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
          if (response.ok) {
            const userData = await response.json();
            adminAlias = userData.alias;
          }
        }

        console.log("📥 Cargando recogidas para adminAlias:", adminAlias);

        // Cargar recogidas del administrador
        const response = await fetch(`https://jc-frutas.onrender.com/recogidas/resumen/${adminAlias}?usuario=${encodeURIComponent(usuario)}`);
        
        if (!response.ok) {
          throw new Error(`Error del servidor: ${response.status}`);
        }

        const data = await response.json();
        todasLasRecogidas = data.recogidas || [];
        recogidasFiltradas = [...todasLasRecogidas];

        console.log("✅ Recogidas cargadas:", todasLasRecogidas.length);

        // Actualizar filtros y mostrar datos
        actualizarFiltros();
        actualizarStats();
        mostrarRecogidas();

      } catch (error) {
        console.error("❌ Error al cargar recogidas:", error);
        document.getElementById('recogidasContainer').innerHTML = `
          <div class="no-results">
            ❌ Error al cargar las recogidas: ${error.message}
          </div>
        `;
      }
    }

    // Actualizar opciones de filtros
    function actualizarFiltros() {
      // Frutas únicas
      const frutas = [...new Set(todasLasRecogidas.map(r => r.fruta).filter(Boolean))];
      const selectFruta = document.getElementById('filtroFruta');
      selectFruta.innerHTML = '<option value="">Todas las frutas</option>';
      frutas.forEach(fruta => {
        selectFruta.innerHTML += `<option value="${fruta}">${fruta}</option>`;
      });

      // Usuarios únicos
      const usuarios = [...new Set(todasLasRecogidas.map(r => r.alias || r.usuario).filter(Boolean))];
      const selectUsuario = document.getElementById('filtroUsuario');
      selectUsuario.innerHTML = '<option value="">Todos los usuarios</option>';
      usuarios.forEach(usuario => {
        selectUsuario.innerHTML += `<option value="${usuario}">${usuario}</option>`;
      });

      // Configurar fechas por defecto
      const fechas = todasLasRecogidas.map(r => new Date(r.fecha)).filter(f => !isNaN(f));
      if (fechas.length > 0) {
        const fechaMin = new Date(Math.min(...fechas));
        const fechaMax = new Date(Math.max(...fechas));
        
        document.getElementById('fechaDesde').value = fechaMin.toISOString().split('T')[0];
        document.getElementById('fechaHasta').value = fechaMax.toISOString().split('T')[0];
      }
    }

    // Actualizar estadísticas
    function actualizarStats() {
      const recogidas = recogidasFiltradas;
      const totalRecogidas = recogidas.length;
      const totalKilos = recogidas.reduce((sum, r) => sum + (r.totalKilos || 0), 0);
      const totalPagado = esSubusuario ? 0 : recogidas.reduce((sum, r) => sum + (r.valorPagar || 0), 0);
      const promedioKilos = totalRecogidas > 0 ? (totalKilos / totalRecogidas) : 0;

      const statsHTML = `
        <div class="stat-card">
          <div class="stat-value">${totalRecogidas}</div>
          <div class="stat-label">📊 Total Recogidas</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalKilos.toFixed(1)}</div>
          <div class="stat-label">⚖️ Total Kilos</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${promedioKilos.toFixed(1)}</div>
          <div class="stat-label">📈 Promedio/Recogida</div>
        </div>
        ${!esSubusuario ? `
        <div class="stat-card">
          <div class="stat-value">$${totalPagado.toLocaleString()}</div>
          <div class="stat-label">💰 Total Pagado</div>
        </div>
        ` : ''}
      `;

      document.getElementById('statsContainer').innerHTML = statsHTML;
    }

    // Mostrar recogidas
 function mostrarRecogidas() {
  const container = document.getElementById('recogidasContainer');
  
  if (recogidasFiltradas.length === 0) {
    container.innerHTML = `
      <div class="no-results">
        🔍 No se encontraron recogidas con los filtros aplicados
      </div>
    `;
    return;
  }

  const recogidasHTML = recogidasFiltradas.map(recogida => {
    const fecha = new Date(recogida.fecha);
    const fechaFormateada = fecha.toLocaleDateString('es-ES', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });

    const usuarioMostrar = recogida.alias || recogida.usuario || 'Usuario';
    const avatarInitial = usuarioMostrar.charAt(0).toUpperCase();

    const pesasHTML = recogida.pesas && recogida.pesas.length > 0 ? `
      <div class="pesas-summary">
        <div class="pesas-title">🧺 Detalle de Pesas (${recogida.pesas.length})</div>
        <div class="pesas-grid">
          ${recogida.pesas.map(pesa => `
            <div class="pesa-item">
              ${pesa.kilos} kg
              ${!esSubusuario && pesa.valor ? `<br><small>$${pesa.valor.toLocaleString()}</small>` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    ` : '';

    return `
      <div class="recogida-card">
        <div class="card-header">
          <div class="finca-info">
            <h3>🏡 ${recogida.finca || 'Finca'}</h3>
            <p>👤 ${recogida.propietario || 'Propietario'}</p>
          </div>
          <div class="fecha-badge">📅 ${fechaFormateada}</div>
        </div>

        <div class="card-body">
          <div class="info-item">
            <div class="info-icon">🍎</div>
            <div class="info-label">Fruta</div>
            <div class="info-value">${recogida.fruta || 'N/A'}</div>
          </div>

          <div class="info-item">
            <div class="info-icon">⭐</div>
            <div class="info-label">Calidad</div>
            <div class="info-value">
              <span class="quality-badge quality-${recogida.calidad || 'primera'}">${recogida.calidad || 'N/A'}</span>
            </div>
          </div>

          <div class="info-item">
            <div class="info-icon">⚖️</div>
            <div class="info-label">Total Kilos</div>
            <div class="info-value">${(recogida.totalKilos || 0).toFixed(1)} kg</div>
          </div>

          <div class="info-item">
            <div class="info-icon">🧺</div>
            <div class="info-label">Cantidad Pesas</div>
            <div class="info-value">${recogida.pesas ? recogida.pesas.length : 0}</div>
          </div>

          ${!esSubusuario ? `
          <div class="info-item">
            <div class="info-icon">💵</div>
            <div class="info-label">Precio/Kg</div>
            <div class="info-value">$${(recogida.precio || 0).toLocaleString()}</div>
          </div>

          <div class="info-item">
            <div class="info-icon">💰</div>
            <div class="info-label">Total a Pagar</div>
            <div class="info-value">$${(recogida.valorPagar || 0).toLocaleString()}</div>
          </div>
          ` : ''}
        </div>

        ${pesasHTML}

        <div class="card-footer">
          <div class="usuario-info">
            <div class="usuario-avatar">${avatarInitial}</div>
            <div>
              <div style="font-weight: 600;">${usuarioMostrar}</div>
              <div style="font-size: 0.8em; color: var(--text-secondary);">Registrado por</div>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
            <button class="editar-btn" data-id="${recogida._id}" data-finca-id="${recogida.fincaId}">✏️ Editar</button>
            <div style="text-align: right; font-size: 0.8em; color: var(--text-secondary);">
              ID: ${recogida._id ? recogida._id.slice(-6) : 'N/A'}
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = recogidasHTML;

  // ✅ AGREGAR EVENT LISTENERS A LOS BOTONES DE EDITAR
  document.querySelectorAll('.editar-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const recogidaId = e.target.getAttribute('data-id');
      const fincaId = e.target.getAttribute('data-finca-id');
      
      if (recogidaId && fincaId) {
        // 🔥 CONSTRUIR URL DE EDICIÓN CON LOS MISMOS PARÁMETROS QUE historial.html
        const urlParams = new URLSearchParams(window.location.search);
        const usuario = urlParams.get('usuario') || params.get('usuario');
        
        const editarUrl = `recogida.html?modo=editar&idRecogida=${recogidaId}&fincaId=${fincaId}&usuario=${encodeURIComponent(usuario)}`;
        
        console.log('🔄 Redirigiendo a editar:', editarUrl);
        window.location.href = editarUrl;
      } else {
        console.error('❌ Faltan datos para editar: recogidaId =', recogidaId, 'fincaId =', fincaId);
        alert('Error: No se pueden obtener los datos necesarios para editar esta recogida');
      }
    });
  });
}

// ✅ AGREGAR ESTILOS CSS PARA EL BOTÓN DE EDITAR
// Agregar esto en la sección <style> del archivo historial-recogidas.html

const editarBtnStyles = `
.editar-btn {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
  font-size: 0.85em;
  min-width: 80px;
}

.editar-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
  background: linear-gradient(135deg, #218838, #1e7e34);
}

.editar-btn:active {
  transform: translateY(0);
}

/* Responsive para móviles */
@media (max-width: 768px) {
  .card-footer {
    flex-direction: column;
    gap: 12px;
    align-items: stretch !important;
  }
  
  .editar-btn {
    width: 100%;
    padding: 12px;
    font-size: 0.9em;
  }
  
  .card-footer > div:last-child {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
}

@media (max-width: 480px) {
  .card-footer {
    padding-top: 12px;
  }
  
  .usuario-info {
    justify-content: center;
    text-align: center;
  }
}
`;

// ✅ FUNCIÓN PARA INYECTAR LOS ESTILOS
function inyectarEstilosEditar() {
  const style = document.createElement('style');
  style.textContent = editarBtnStyles;
  document.head.appendChild(style);
}

// ✅ LLAMAR LA FUNCIÓN AL CARGAR LA PÁGINA
document.addEventListener('DOMContentLoaded', () => {
  // Inyectar estilos del botón editar
  inyectarEstilosEditar();
  
  // El resto del código existente...
  document.getElementById('searchText').addEventListener('input', debounce(aplicarFiltros, 500));
  document.getElementById('filtroFruta').addEventListener('change', aplicarFiltros);
  document.getElementById('filtroCalidad').addEventListener('change', aplicarFiltros);
  document.getElementById('filtroUsuario').addEventListener('change', aplicarFiltros);
  document.getElementById('fechaDesde').addEventListener('change', aplicarFiltros);
  document.getElementById('fechaHasta').addEventListener('change', aplicarFiltros);
  
  cargarRecogidas();
});
// ✅ LLAMAR LA FUNCIÓN AL CARGAR LA PÁGINA
document.addEventListener('DOMContentLoaded', () => {
  // Inyectar estilos del botón editar
  inyectarEstilosEditar();
  
  // El resto del código existente...
  document.getElementById('searchText').addEventListener('input', debounce(aplicarFiltros, 500));
  document.getElementById('filtroFruta').addEventListener('change', aplicarFiltros);
  document.getElementById('filtroCalidad').addEventListener('change', aplicarFiltros);
  document.getElementById('filtroUsuario').addEventListener('change', aplicarFiltros);
  document.getElementById('fechaDesde').addEventListener('change', aplicarFiltros);
  document.getElementById('fechaHasta').addEventListener('change', aplicarFiltros);
  
  cargarRecogidas();
});

    // Aplicar filtros
    function aplicarFiltros() {
      const textoBusqueda = document.getElementById('searchText').value.toLowerCase();
      const filtroFruta = document.getElementById('filtroFruta').value;
      const filtroCalidad = document.getElementById('filtroCalidad').value;
      const filtroUsuario = document.getElementById('filtroUsuario').value;
      const fechaDesde = document.getElementById('fechaDesde').value;
      const fechaHasta = document.getElementById('fechaHasta').value;

      recogidasFiltradas = todasLasRecogidas.filter(recogida => {
        // Filtro de texto
        if (textoBusqueda) {
          const textoCompleto = `${recogida.finca || ''} ${recogida.propietario || ''} ${recogida.alias || ''} ${recogida.usuario || ''} ${recogida.fruta || ''}`.toLowerCase();
          if (!textoCompleto.includes(textoBusqueda)) return false;
        }

        // Filtro de fruta
        if (filtroFruta && recogida.fruta !== filtroFruta) return false;

        // Filtro de calidad
        if (filtroCalidad && recogida.calidad !== filtroCalidad) return false;

        // Filtro de usuario
        if (filtroUsuario) {
          const usuarioRecogida = recogida.alias || recogida.usuario;
          if (usuarioRecogida !== filtroUsuario) return false;
        }

        // Filtro de fechas
        if (fechaDesde || fechaHasta) {
          const fechaRecogida = new Date(recogida.fecha);
          if (fechaDesde && fechaRecogida < new Date(fechaDesde)) return false;
          if (fechaHasta && fechaRecogida > new Date(fechaHasta + 'T23:59:59')) return false;
        }

        return true;
      });

      // Ordenar por fecha (más recientes primero)
      recogidasFiltradas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

      actualizarStats();
      mostrarRecogidas();
    }

    // Limpiar filtros
    function limpiarFiltros() {
      document.getElementById('searchText').value = '';
      document.getElementById('filtroFruta').value = '';
      document.getElementById('filtroCalidad').value = '';
      document.getElementById('filtroUsuario').value = '';
      document.getElementById('fechaDesde').value = '';
      document.getElementById('fechaHasta').value = '';
      
      recogidasFiltradas = [...todasLasRecogidas];
      actualizarStats();
      mostrarRecogidas();
    }

    // Exportar datos
    function exportarDatos() {
      if (recogidasFiltradas.length === 0) {
        alert('No hay datos para exportar');
        return;
      }

      const fechaExportacion = new Date().toLocaleDateString('es-ES');
      let contenido = `=== REPORTE DE RECOGIDAS ===\nFecha de exportación: ${fechaExportacion}\nTotal de registros: ${recogidasFiltradas.length}\n\n`;

      // Estadísticas generales
      const totalKilos = recogidasFiltradas.reduce((sum, r) => sum + (r.totalKilos || 0), 0);
      const totalPagado = esSubusuario ? 0 : recogidasFiltradas.reduce((sum, r) => sum + (r.valorPagar || 0), 0);
      
      contenido += `=== RESUMEN ESTADÍSTICO ===\n`;
      contenido += `Total Kilos: ${totalKilos.toFixed(1)} kg\n`;
      if (!esSubusuario) {
        contenido += `Total Pagado: ${totalPagado.toLocaleString()}\n`;
      }
      contenido += `Promedio por Recogida: ${(totalKilos / recogidasFiltradas.length).toFixed(1)} kg\n\n`;

      // Detalle de recogidas
      contenido += `=== DETALLE DE RECOGIDAS ===\n`;
      
      recogidasFiltradas.forEach((recogida, index) => {
        const fecha = new Date(recogida.fecha).toLocaleDateString('es-ES');
        const usuario = recogida.alias || recogida.usuario || 'Usuario';
        
        contenido += `\n${index + 1}. RECOGIDA DEL ${fecha}\n`;
        contenido += `   Finca: ${recogida.finca || 'N/A'} - Propietario: ${recogida.propietario || 'N/A'}\n`;
        contenido += `   Usuario: ${usuario}\n`;
        contenido += `   Fruta: ${recogida.fruta || 'N/A'} - Calidad: ${recogida.calidad || 'N/A'}\n`;
        contenido += `   Total Kilos: ${(recogida.totalKilos || 0).toFixed(1)} kg\n`;
        
        if (!esSubusuario) {
          contenido += `   Precio/Kg: ${(recogida.precio || 0).toLocaleString()}\n`;
          contenido += `   Total a Pagar: ${(recogida.valorPagar || 0).toLocaleString()}\n`;
        }
        
        // Detalle de pesas
        if (recogida.pesas && recogida.pesas.length > 0) {
          contenido += `   Pesas (${recogida.pesas.length}): `;
          const pesasDetalle = recogida.pesas.map(pesa => {
            if (!esSubusuario && pesa.valor) {
              return `${pesa.kilos}kg(${pesa.valor.toLocaleString()})`;
            } else {
              return `${pesa.kilos}kg`;
            }
          }).join(', ');
          contenido += pesasDetalle + '\n';
        }
        
        contenido += `   ID: ${recogida._id ? recogida._id.slice(-8) : 'N/A'}\n`;
      });

      // Descargar archivo
      const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `recogidas_${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      // Mostrar confirmación
      mostrarNotificacion('📥 Reporte exportado exitosamente', 'success');
    }

    // Mostrar notificación
    function mostrarNotificacion(mensaje, tipo = 'info') {
      const notificacion = document.createElement('div');
      notificacion.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        background: ${tipo === 'success' ? 'linear-gradient(45deg, #4ecdc4, #45b7aa)' : 'linear-gradient(45deg, #00d4ff, #0099cc)'};
        color: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        font-weight: 600;
        animation: slideInRight 0.3s ease;
      `;
      
      // Agregar animación CSS
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      notificacion.textContent = mensaje;
      document.body.appendChild(notificacion);
      
      setTimeout(() => {
        notificacion.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
          if (notificacion.parentNode) {
            notificacion.parentNode.removeChild(notificacion);
          }
        }, 300);
      }, 3000);
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Aplicar filtros en tiempo real para búsqueda de texto
      document.getElementById('searchText').addEventListener('input', debounce(aplicarFiltros, 500));
      
      // Aplicar filtros al cambiar selects
      document.getElementById('filtroFruta').addEventListener('change', aplicarFiltros);
      document.getElementById('filtroCalidad').addEventListener('change', aplicarFiltros);
      document.getElementById('filtroUsuario').addEventListener('change', aplicarFiltros);
      document.getElementById('fechaDesde').addEventListener('change', aplicarFiltros);
      document.getElementById('fechaHasta').addEventListener('change', aplicarFiltros);
      
      // Cargar datos inicial
      cargarRecogidas();
    });

    // Función debounce para optimizar búsqueda
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Función para formatear moneda
    function formatearMoneda(valor) {
      if (!valor && valor !== 0) return "$0";
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(valor);
    }

    // Agregar funcionalidad de navegación


  </script>
</body>
</html>