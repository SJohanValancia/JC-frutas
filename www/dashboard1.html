
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Tipo 1</title>
  <link rel="stylesheet" href="style.css">

<script type="module">
  import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@7/+esm';
  window.idb = { openDB };
</script>

  <script src="jc-loader.js"></script>
    <script src="blockCheck.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .card-glass {
      background: var(--glass-bg, rgba(255, 255, 255, 0.1));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .finca-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .finca-title {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary-color, #00d4ff);
      margin-bottom: 5px;
    }

    .propietario {
      opacity: 0.8;
      font-size: 0.95em;
    }

    .recogida-info {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      align-items: flex-start;
    }

    .info-label {
      font-weight: bold;
      opacity: 0.8;
      min-width: 35%;
    }

    .info-value {
      color: var(--primary-color, #00d4ff);
      font-weight: bold;
      text-align: right;
      max-width: 60%;
      word-wrap: break-word;
    }

    .primera-finca-badge {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #333;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 0.75em;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.5);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .primera-finca-badge:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
    }

    .primera-finca-badge::before {
      content: 'üëë';
      font-size: 0.9em;
    }

    .sin-recogidas {
      text-align: center;
      opacity: 0.6;
      font-style: italic;
      padding: 20px;
    }

    .botones-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .botones-container button {
      flex: 1;
      min-width: 120px;
      padding: 8px 12px;
      font-size: 0.85em;
    }

    .loading-info {
      text-align: center;
      padding: 10px;
      font-style: italic;
    }

    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-text {
      height: 16px;
      border-radius: 4px;
      margin: 8px 0;
    }

    .skeleton-title {
      height: 24px;
      border-radius: 6px;
      margin: 10px 0;
      width: 70%;
    }

    .general-loader {
      text-align: center;
      padding: 40px 20px;
      color: var(--primary-color, #00d4ff);
      font-size: 1.1em;
    }

    .loader-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 212, 255, 0.3);
      border-top: 4px solid var(--primary-color, #00d4ff);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* MENU STYLES */
    .menu-container {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 99999;
    }

    .menu-toggle {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }

    .menu-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
    }

    .menu-toggle.active {
      transform: scale(1.1) rotate(180deg);
      background: linear-gradient(135deg, #764ba2, #667eea);
    }

    .menu-icon {
      width: 24px;
      height: 24px;
      position: relative;
      transition: all 0.3s ease;
    }

    .menu-icon span {
      display: block;
      position: absolute;
      height: 3px;
      width: 100%;
      background: white;
      border-radius: 2px;
      opacity: 1;
      left: 0;
      transform: rotate(0deg);
      transition: .25s ease-in-out;
    }

    .menu-icon span:nth-child(1) {
      top: 4px;
    }

    .menu-icon span:nth-child(2) {
      top: 10px;
    }

    .menu-icon span:nth-child(3) {
      top: 16px;
    }

    .menu-toggle.active .menu-icon span:nth-child(1) {
      top: 10px;
      transform: rotate(135deg);
    }

    .menu-toggle.active .menu-icon span:nth-child(2) {
      opacity: 0;
      left: -60px;
    }

    .menu-toggle.active .menu-icon span:nth-child(3) {
      top: 10px;
      transform: rotate(-135deg);
    }

    .menu-options {
      position: absolute;
      top: 75px;
      left: 0;
      min-width: 280px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-20px) scale(0.9);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .menu-options.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }

    .menu-options::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 22px;
      width: 16px;
      height: 16px;
      background: rgba(255, 255, 255, 0.95);
      transform: rotate(45deg);
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      border-left: 1px solid rgba(255, 255, 255, 0.3);
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      margin: 5px 0;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      color: #333;
      text-decoration: none;
      opacity: 0;
      transform: translateX(-20px);
      animation: slideInMenuItem 0.5s ease forwards;
    }

    .menu-item:nth-child(1) { animation-delay: 0.1s; }
    .menu-item:nth-child(2) { animation-delay: 0.2s; }
    .menu-item:nth-child(3) { animation-delay: 0.3s; }
    .menu-item:nth-child(4) { animation-delay: 0.4s; }

    @keyframes slideInMenuItem {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .menu-item:hover {
      background: rgba(102, 126, 234, 0.2);
      transform: translateX(8px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }

    .menu-item:active {
      transform: translateX(8px) scale(0.98);
    }

    .menu-item-icon {
      font-size: 1.2em;
      min-width: 24px;
    }

    .menu-item-text {
      flex: 1;
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      .menu-options {
        background: rgba(30, 30, 30, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .menu-options::before {
        background: rgba(30, 30, 30, 0.95);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        border-left: 1px solid rgba(255, 255, 255, 0.1);
      }

      .menu-item {
        background: rgba(50, 50, 50, 0.7);
        color: #eee;
      }

      .menu-item:hover {
        background: rgba(102, 126, 234, 0.3);
      }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .menu-container {
        top: 10px;
        left: 10px;
      }

      .menu-toggle {
        width: 50px;
        height: 50px;
      }

      .menu-options {
        min-width: 260px;
        top: 65px;
      }

      .menu-item {
        padding: 12px;
        font-size: 0.9rem;
      }
    }

    @media (max-width: 480px) {
      .menu-options {
        min-width: 240px;
        left: -20px;
      }

      .menu-options::before {
        left: 42px;
      }
    }

    /* Overlay for menu */
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.1);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 99998;
    }

    .menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Adjustments for main content when menu is present */
    .container {
      margin-top: 20px;
    }

    /* Responsive optimizations */
    @media (max-width: 480px) {
      .info-row {
        flex-direction: column;
        gap: 2px;
      }
      
      .info-value {
        text-align: left;
        max-width: 100%;
      }
      
      .info-label {
        min-width: auto;
      }
    }

    /* Estilos para las notas */
    .nota-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #2196F3;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
      transition: all 0.3s ease;
    }

    .nota-badge:hover {
      background: #0b7dda;
      transform: scale(1.05);
    }

    .nota-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .nota-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .nota-modal-content {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }

    .nota-modal.active .nota-modal-content {
      transform: translateY(0);
    }

    .nota-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      padding-bottom: 10px;
    }

    .nota-modal-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }

    .nota-modal-close {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: #666;
    }

    .nota-list {
      margin-top: 15px;
    }

    .nota-item {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .nota-content {
      margin-bottom: 10px;
      white-space: pre-wrap;
    }

    .nota-meta {
      font-size: 0.8em;
      color: #666;
      display: flex;
      justify-content: space-between;
    }

    .nota-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .nota-actions button {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8em;
    }

    .edit-nota-btn {
      background: #4CAF50;
      color: white;
    }

    .delete-nota-btn {
      background: #f44336;
      color: white;
    }

    .add-nota-btn {
      background: #2196F3;
      color: white;
    }

    .quick-note-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      z-index: 1001;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .quick-note-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .quick-note-header {
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    .quick-note-textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
      resize: vertical;
    }

    .quick-note-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .quick-note-actions button {
      padding: 8px 15px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }

    .quick-note-cancel {
      background: #f5f5f5;
      color: #333;
    }

    .quick-note-save {
      background: #2196F3;
      color: white;
    }

    /* Dark mode support for notes */
    @media (prefers-color-scheme: dark) {
      .nota-modal-content,
      .quick-note-modal {
        background: rgba(30, 30, 30, 0.95);
        color: #eee;
      }

      .nota-item {
        background: rgba(50, 50, 50, 0.7);
        color: #eee;
      }

      .nota-modal-title {
        color: #eee;
      }

      .nota-modal-close {
        color: #aaa;
      }

      .nota-meta {
        color: #aaa;
      }

      .quick-note-header {
        color: #eee;
      }

      .quick-note-textarea {
        background: rgba(50, 50, 50, 0.7);
        color: #eee;
        border-color: #444;
      }

      .quick-note-cancel {
        background: #444;
        color: #eee;
      }
    }

    /* SCROLL BUTTON STYLES */
.scroll-button {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #4CAF50, #45a049);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  z-index: 9999;
  overflow: hidden;
}

.scroll-button:hover {
  transform: scale(1.1);
  box-shadow: 0 12px 35px rgba(76, 175, 80, 0.5);
}

.scroll-button:active {
  transform: scale(1.05);
}

.scroll-button-icon {
  width: 24px;
  height: 24px;
  position: relative;
  transition: all 0.3s ease;
}

.scroll-arrow {
  position: absolute;
  width: 3px;
  height: 12px;
  background: white;
  border-radius: 2px;
  left: 50%;
  top: 50%;
  transform-origin: center;
  transition: all 0.3s ease;
}

.scroll-arrow:nth-child(1) {
  transform: translate(-50%, -50%) rotate(45deg) translate(-4px, -2px);
}

.scroll-arrow:nth-child(2) {
  transform: translate(-50%, -50%) rotate(-45deg) translate(4px, -2px);
}

.scroll-button.up .scroll-arrow:nth-child(1) {
  transform: translate(-50%, -50%) rotate(-45deg) translate(-4px, 2px);
}

.scroll-button.up .scroll-arrow:nth-child(2) {
  transform: translate(-50%, -50%) rotate(45deg) translate(4px, 2px);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .scroll-button {
    width: 50px;
    height: 50px;
    bottom: 15px;
    right: 15px;
  }
  
  .scroll-button-icon {
    width: 20px;
    height: 20px;
  }
  
  .scroll-arrow {
    width: 2px;
    height: 10px;
  }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
  .scroll-button {
    background: linear-gradient(135deg, #2E7D32, #1B5E20);
    box-shadow: 0 8px 25px rgba(46, 125, 50, 0.3);
  }
  
  .scroll-button:hover {
    box-shadow: 0 12px 35px rgba(46, 125, 50, 0.5);
  }
}

  </style>
</head>
<body>
  <!-- Menu Container -->
  <div class="menu-container">
    <button class="menu-toggle" id="menuToggle">
      <div class="menu-icon">
        <span>-</span>
        <span>-</span>
        <span>-</span>
      </div>
    </button>
    
    <div class="menu-options" id="menuOptions">
      <div class="menu-item" id="historialCompletoMenu">
        <div class="menu-item-icon">üìä</div>
        <div class="menu-item-text">Historial Completo</div>
      </div>
      
      <div class="menu-item" id="globalizarPreciosMenu">
        <div class="menu-item-icon">‚úèÔ∏è</div>
        <div class="menu-item-text">Globalizar Precios</div>
      </div>
      
      <div class="menu-item" id="liquidacionesMenu">
        <div class="menu-item-icon">üí∞</div>
        <div class="menu-item-text">Liquidaciones</div>
      </div>
    </div>
  </div>

  <!-- Menu overlay -->
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- Scroll Button -->
<button class="scroll-button" id="scrollButton">
  <div class="scroll-button-icon">
    <div class="scroll-arrow"></div>
    <div class="scroll-arrow"></div>
  </div>
</button>

  <div class="container">
<p id="saludo" style="font-weight: bold; font-size: 24px;"></p>    <button id="btnAgregarFinca">‚ûï Agregar Finca</button>
    <input type="text" id="buscarFinca" placeholder="Buscar finca o propietario...">
    <div id="listaFincas"></div>
  </div>

  <div id="modalFinca" class="modal hidden">
    <div class="modal-content">
      <h3>Agregar Finca</h3>
      <input type="text" id="nombreFinca" placeholder="Nombre de la finca">
      <input type="text" id="propietarioFinca" placeholder="Nombre del propietario">
      <button id="guardarFinca">Guardar</button>
    </div>
  </div>

 

  <!-- Modal para agregar nota r√°pida -->
  <div id="quickNoteModal" class="quick-note-modal">
    <div class="quick-note-header" id="quickNoteTitle">Agregar nota para finca</div>
    <textarea id="quickNoteContent" class="quick-note-textarea" placeholder="Escribe tu nota aqu√≠..."></textarea>
    <div class="quick-note-actions">
      <button id="quickNoteCancel" class="quick-note-cancel">Cancelar</button>
      <button id="quickNoteSave" class="quick-note-save">Guardar Nota</button>
    </div>
  </div>

  <!-- Modal para ver todas las notas -->
  <div id="notasModal" class="nota-modal">
    <div class="nota-modal-content">
      <div class="nota-modal-header">
        <div class="nota-modal-title" id="notasModalTitle">Notas de la finca</div>
        <button class="nota-modal-close" id="notasModalClose">&times;</button>
      </div>
      <div class="nota-list" id="notasList">
        <!-- Las notas se cargar√°n aqu√≠ -->
      </div>
      <div class="nota-actions" style="justify-content: center;">
        <button id="addNewNoteBtn" class="add-nota-btn">‚ûï Agregar Nueva Nota</button>
      </div>
    </div>
  </div>

  <script type="module">
    
    import { apiFetch } from "./api.js";

    // üîç DEBUG: Verificar la URL completa
    console.log("=== URL Y PAR√ÅMETROS ===");
    console.log("URL completa:", window.location.href);
    console.log("Search params:", window.location.search);

    // Obtener los par√°metros de la URL
    const params = new URLSearchParams(window.location.search);
    const usuario = params.get("usuario");
    let alias = params.get("alias");
    let adminAlias = alias;
    const esEnlazado = params.get("enlazado") === "true";
    const tipoEnlace = params.get("tipoEnlace");
    const adminEnlazado = params.get("adminEnlazado");

    // Variables globales
    let todasLasFincas = [];
    let todasLasRecogidas = {};
    let tipoUsuarioActual = 1;
    let aliasEfectivo = alias;

    // üî• NUEVA L√ìGICA: Manejar admins enlazados
    if (esEnlazado && tipoEnlace === "admin" && adminEnlazado) {
        console.log("üîó Detectado admin enlazado");
        console.log("üë§ Admin enlazado:", adminEnlazado);
        console.log("üéØ Admin principal:", alias);
        
        aliasEfectivo = alias;
        
        const mostrarSaludo = () => {
            const saludo = document.getElementById("saludo");
            saludo.innerHTML = `
                <div>Bienvenido, ${adminEnlazado}</div>
                <div style="font-size: 0.8em; opacity: 0.8; color: var(--primary-color, #00d4ff);">
                    üîó Enlazado a: ${alias}
                </div>
            `;
        };
    } else {
        const mostrarSaludo = () => {
            const saludo = document.getElementById("saludo");
            if (usuario) {
                saludo.textContent = `Bienvenido, ${alias || usuario}`;
            } else {
                saludo.textContent = "Bienvenido (usuario no identificado)";
            }
        };
    }

    // Variables para manejo de notas
    let notasPorFinca = {};
    let fincaActualParaNota = null;

    // MENU FUNCTIONALITY
    const menuToggle = document.getElementById('menuToggle');
    const menuOptions = document.getElementById('menuOptions');
    const menuOverlay = document.getElementById('menuOverlay');
    const historialCompletoMenu = document.getElementById('historialCompletoMenu');
    const globalizarPreciosMenu = document.getElementById('globalizarPreciosMenu');
    const liquidacionesMenu = document.getElementById('liquidacionesMenu');

    let isMenuOpen = false;

    function toggleMenu() {
      isMenuOpen = !isMenuOpen;
      
      if (isMenuOpen) {
        menuToggle.classList.add('active');
        menuOptions.classList.add('active');
        menuOverlay.classList.add('active');
        
        // Reset animation for menu items
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach((item, index) => {
          item.style.animation = 'none';
          setTimeout(() => {
            item.style.animation = `slideInMenuItem 0.5s ease forwards`;
            item.style.animationDelay = `${0.1 * (index + 1)}s`;
          }, 10);
        });
      } else {
        menuToggle.classList.remove('active');
        menuOptions.classList.remove('active');
        menuOverlay.classList.remove('active');
      }
    }

    function closeMenu() {
      if (isMenuOpen) {
        toggleMenu();
      }
    }

    // Menu event listeners
    menuToggle.addEventListener('click', toggleMenu);
    menuOverlay.addEventListener('click', closeMenu);

    // Menu item functionality
    historialCompletoMenu.addEventListener('click', () => {
      // Esta funci√≥n se mantendr√° igual que la original pero desde el menu
      navegarAHistorialCompleto();
      closeMenu();
    });

    globalizarPreciosMenu.addEventListener('click', () => {
      let preciosUrl = `gestion-precios.html?usuario=${encodeURIComponent(usuario)}`;
      if (alias) {
        preciosUrl += `&alias=${encodeURIComponent(alias)}`;
      }
      window.location.href = preciosUrl;
      closeMenu();
    });

    liquidacionesMenu.addEventListener('click', () => {
      window.location.href = "liquidacionmes.html";
      closeMenu();
    });

    // Close menu when clicking outside or pressing escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isMenuOpen) {
        closeMenu();
      }
    });

    // Funci√≥n para navegar al historial completo (mantiene la l√≥gica original)
    async function navegarAHistorialCompleto() {
      try {
        const tienePermisos = await verificarPermisosHistorial();
        
        if (!tienePermisos) {
          alert('No tienes permisos para ver el historial completo');
          return;
        }

        if (window.location.pathname.includes('historial-recogidas.html')) {
          console.log('‚ÑπÔ∏è Ya estamos en la p√°gina de historial completo');
          return;
        }

        // Construir URL del historial completo
        let historialUrl = `historial-recogidas.html?usuario=${encodeURIComponent(usuario)}`;
        
        if (alias) {
          historialUrl += `&alias=${encodeURIComponent(alias)}`;
        }

        console.log('üìä Navegando al historial completo:', historialUrl);
        
        // Mostrar indicador de carga en el menu item
        historialCompletoMenu.innerHTML = `
          <div class="menu-item-icon">‚è≥</div>
          <div class="menu-item-text">Cargando...</div>
        `;
        
        // Redirigir despu√©s de un breve delay
        setTimeout(() => {
          window.location.href = historialUrl;
        }, 300);
      } catch (error) {
        console.error('‚ùå Error al navegar al historial:', error);
        // Restaurar el contenido original del menu item
        historialCompletoMenu.innerHTML = `
          <div class="menu-item-icon">üìä</div>
          <div class="menu-item-text">Historial Completo</div>
        `;
      }
    }

    async function verificarPermisosHistorial() {
      try {
        const params = new URLSearchParams(window.location.search);
        const usuario = params.get('usuario');
        
        if (!usuario) return false;

        const storedData = sessionStorage.getItem('userData');
        if (storedData) {
          const userData = JSON.parse(storedData);
          return userData.tipo === 1 || userData.tipo === 2;
        }

        const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
        if (response.ok) {
          const userData = await response.json();
          return userData.tipo === 1 || userData.tipo === 2;
        }

        return false;
      } catch (error) {
        console.error('‚ùå Error al verificar permisos:', error);
        return false;
      }
    }

    // Si no se encuentra alias en la URL, hacer una llamada al servidor para obtenerlo
    if (!alias && usuario) {
      console.log("Alias no encontrado en la URL, haciendo una llamada al servidor para obtenerlo...");

      async function obtenerAliasDesdeServidor() {
        try {
          const response = await apiFetch(`/auth/get-alias?usuario=${usuario}`, "GET");
          alias = response.alias || 'Alias no disponible';
          adminAlias = alias;
          console.log("Alias obtenido desde el servidor:", alias);
          mostrarUsuarioYAlias();
        } catch (error) {
          console.error("Error al obtener alias desde el servidor:", error);
          alias = 'Alias no disponible';
          adminAlias = alias;
          mostrarUsuarioYAlias();
        }
      }

      obtenerAliasDesdeServidor();
    } else {
      console.log("Alias encontrado en la URL:", alias);
      adminAlias = alias;
      mostrarUsuarioYAlias();
    }

    // Funci√≥n para mostrar el usuario y alias
    function mostrarUsuarioYAlias() {
      console.log("=== DEBUG URL ===");
      console.log("Usuario extra√≠do de URL:", usuario);
      console.log("Alias extra√≠do de URL:", alias);
      console.log("AdminAlias asignado:", adminAlias);

      const saludo = document.getElementById("saludo");
      if (usuario) {
        saludo.textContent = `Bienvenido, ${alias}`;
      } else {
        saludo.textContent = "Bienvenido (usuario no identificado)";
      }
    }


    function mostrarSaludo() {
  const ahora = new Date();
  const hora = ahora.getHours();
  let saludo = "";

  if (hora >= 5 && hora < 12) {
    saludo = "¬°Buenos d√≠as!";
  } else if (hora >= 12 && hora < 19) {
    saludo = "¬°Buenas tardes!";
  } else {
    saludo = "¬°Buenas noches!";
  }

  document.getElementById("saludo").textContent = saludo;
}

// Mostrar el saludo al cargar la p√°gina
mostrarSaludo();

    // OPTIMIZACI√ìN: Cargar todas las recogidas de una vez
    async function cargarTodasLasRecogidas(fincaIds) {
      console.log("Cargando recogidas para todas las fincas de una vez...");
      const startTime = performance.now();
      
      try {
        const promises = fincaIds.map(async (fincaId) => {
          try {
            const recogidas = await apiFetch(`/recogidas/por-finca/${fincaId}`, "GET");
            return { fincaId, recogidas: recogidas || [] };
          } catch (error) {
            console.error(`Error cargando recogidas para finca ${fincaId}:`, error);
            return { fincaId, recogidas: [] };
          }
        });

        const resultados = await Promise.all(promises);
        
        resultados.forEach(({ fincaId, recogidas }) => {
          todasLasRecogidas[fincaId] = recogidas;
        });

        const endTime = performance.now();
        console.log(`Recogidas cargadas en ${(endTime - startTime).toFixed(0)}ms`);
        console.log(`Total fincas procesadas: ${fincaIds.length}`);
        
        return todasLasRecogidas;
      } catch (error) {
        console.error("Error cargando recogidas:", error);
        return {};
      }
    }

    // OPTIMIZACI√ìN: Obtener informaci√≥n de recogida desde cache
    function obtenerInfoRecogidaDesdeCache(fincaId) {
      const recogidas = todasLasRecogidas[fincaId] || [];
      
      if (recogidas.length === 0) {
        return null;
      }

      const ultimaRecogida = recogidas[0];
      const totalRecogidas = recogidas.length;
      const totalKilosAcumulado = recogidas.reduce((sum, r) => sum + (r.totalKilos || 0), 0);
      const totalPagadoAcumulado = recogidas.reduce((sum, r) => sum + (r.valorPagar || 0), 0);
      
      return {
        ultimaRecogida,
        totalRecogidas,
        totalKilosAcumulado,
        totalPagadoAcumulado
      };
    }

    // OPTIMIZACI√ìN: Renderizar finca sin llamadas as√≠ncronas
    function renderFincaRapido(finca) {
      const div = document.createElement("div");
      div.className = "card-glass";
      div.dataset.fincaId = finca._id;
      
      div.innerHTML = `
        <div class="finca-header">
          <div class="finca-title">${finca.nombre}</div>
          <div class="propietario">Propietario: ${finca.propietario}</div>
        </div>
        
        <div class="recogida-info" data-finca-id="${finca._id}">
          <div class="loading-info">‚è≥ Cargando informaci√≥n de recogidas...</div>
        </div>
        
        <div class="botones-container">
          <button onclick="location.href='precios.html?id=${finca._id}&usuario=${encodeURIComponent(usuario)}'">üí∞ Precios</button>
          <button onclick="location.href='recogida.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üìä Recogida</button>
          <button onclick="location.href='historial.html?id=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}'">üìã Historial</button>
          <button onclick="location.href='liquidacion.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üí∞ Liquidaci√≥n</button>
          <button onclick="verLiquidacionesFinca('${finca._id}', '${encodeURIComponent(finca.nombre)}', '${encodeURIComponent(finca.propietario)}')">‚úÖ Recibos Liquidados</button>
        </div>
      `;
      
      if (finca.esPrimeraFinca) {
        const primeraFincaBadge = document.createElement('div');
        primeraFincaBadge.className = 'primera-finca-badge';
        primeraFincaBadge.textContent = 'Primera Finca';
        primeraFincaBadge.title = `Esta fue la primera finca creada por el administrador ${adminAlias}`;
        
        primeraFincaBadge.addEventListener('mouseenter', function() {
          this.style.transform = 'scale(1.1) rotate(2deg)';
        });
        
        primeraFincaBadge.addEventListener('mouseleave', function() {
          this.style.transform = 'scale(1) rotate(0deg)';
        });
        
        div.appendChild(primeraFincaBadge);
        
        console.log("Etiqueta de primera finca a√±adida a:", finca.nombre);
      }
      
      if (notasPorFinca[finca._id] && notasPorFinca[finca._id].total > 0) {
        const notaBadge = document.createElement('div');
        notaBadge.className = 'nota-badge';
        notaBadge.textContent = `üìù ${notasPorFinca[finca._id].total} nota${notasPorFinca[finca._id].total > 1 ? 's' : ''}`;
        notaBadge.addEventListener('click', (e) => {
          e.stopPropagation();
          mostrarNotasFinca(finca);
        });
        div.appendChild(notaBadge);
      }
      
      let pressTimer;
      div.addEventListener('mousedown', (e) => {
        pressTimer = setTimeout(() => {
          mostrarQuickNoteModal(finca);
        }, 1000);
      });
      
      div.addEventListener('mouseup', () => {
        clearTimeout(pressTimer);
      });
      
      div.addEventListener('mouseleave', () => {
        clearTimeout(pressTimer);
      });
      
      div.addEventListener('touchstart', (e) => {
        pressTimer = setTimeout(() => {
          e.preventDefault();
          mostrarQuickNoteModal(finca);
        }, 3000);
      });
      
      div.addEventListener('touchend', () => {
        clearTimeout(pressTimer);
      });
      
      return div;
    }

    // Hacer la funci√≥n verLiquidacionesFinca accesible globalmente
    window.verLiquidacionesFinca = function(fincaId, fincaNombre, fincaPropietario) {
      console.log('Navegando a liquidaciones de finca:', { fincaId, fincaNombre, fincaPropietario });
      
      const params = new URLSearchParams(window.location.search);
      let usuarioActual = params.get("usuario") || usuario;
      let adminAliasActual = params.get("alias") || alias;
      
      if (!usuarioActual || !adminAliasActual) {
        const storedData = sessionStorage.getItem('userData');
        if (storedData) {
          const sessionData = JSON.parse(storedData);
          usuarioActual = usuarioActual || sessionData.username;
          adminAliasActual = adminAliasActual || sessionData.adminAlias || sessionData.alias;
        }
      }
      
      const fincaDecodificada = decodeURIComponent(fincaNombre);
      const propietarioDecodificado = decodeURIComponent(fincaPropietario);
      
      const baseUrl = 'liquidacion-finca.html';
      const urlParams = new URLSearchParams({
        fincaId: fincaId,
        finca: fincaDecodificada,
        propietario: propietarioDecodificado,
        usuario: usuarioActual,
        adminAlias: adminAliasActual
      });
      
      const url = `${baseUrl}?${urlParams.toString()}`;
      
      console.log('URL construida para liquidaciones de finca:', url);
      
      window.location.href = url;
    };

    // OPTIMIZACI√ìN: Actualizar informaci√≥n de recogidas despu√©s del renderizado
    function actualizarInfoRecogidas(div, finca) {
      const recogidaInfoDiv = div.querySelector('.recogida-info');
      const infoRecogidas = obtenerInfoRecogidaDesdeCache(finca._id);
      
      if (infoRecogidas && infoRecogidas.ultimaRecogida) {
        const { ultimaRecogida, totalRecogidas, totalKilosAcumulado, totalPagadoAcumulado } = infoRecogidas;
        
        const usuarioMostrar = ultimaRecogida.alias || ultimaRecogida.usuario || 'Usuario desconocido';
        const frutasInfo = analizarFrutasDeRecogida(ultimaRecogida);
        
        const esUsuarioActualSubusuario = tipoUsuarioActual === 2;
        
        if (!esUsuarioActualSubusuario) {
          recogidaInfoDiv.innerHTML = `
            <div style="text-align: center; font-weight: bold; margin-bottom: 10px; color: var(--primary-color, #00d4ff);">
              üìä √öltima Recogida - ${formatearFechaUniversal(ultimaRecogida.fecha)}
            </div>

            <div class="info-row">
              <span class="info-label">üë§ Usuario:</span>
              <span class="info-value">${usuarioMostrar}</span>
            </div>
            
            ${generarHtmlFrutas(frutasInfo, false)}
            
            <div class="info-row">
              <span class="info-label">‚öñÔ∏è Kilos:</span>
              <span class="info-value">${ultimaRecogida.totalKilos ? ultimaRecogida.totalKilos.toFixed(1) + ' kg' : 'N/A'}</span>
            </div>
            
            <div class="info-row">
              <span class="info-label">üß∫ Pesas:</span>
              <span class="info-value">${ultimaRecogida.pesas ? ultimaRecogida.pesas.length : 0}</span>
            </div>
            
            <div class="info-row">
              <span class="info-label">üíµ A pagar:</span>
              <span class="info-value">${formatearMoneda(ultimaRecogida.valorPagar)}</span>
            </div>
            
            <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px; padding-top: 10px;">
              <div class="info-row">
                <span class="info-label">üìà Total recogidas:</span>
                <span class="info-value">${totalRecogidas}</span>
              </div>
              
              <div class="info-row">
                <span class="info-label">üì¶ Total kilos:</span>
                <span class="info-value">${totalKilosAcumulado.toFixed(1)} kg</span>
              </div>
              
              <div class="info-row">
                <span class="info-label">üí∞ Total pagado:</span>
                <span class="info-value">${formatearMoneda(totalPagadoAcumulado)}</span>
              </div>
            </div>
          `;
        } else {
          recogidaInfoDiv.innerHTML = `
            <div style="text-align: center; font-weight: bold; margin-bottom: 10px; color: var(--primary-color, #00d4ff);">
              üìä √öltima Recogida - ${formatearFechaUniversal(ultimaRecogida.fecha)}
            </div>

            <div class="info-row">
              <span class="info-label">üë§ Usuario:</span>
              <span class="info-value">${usuarioMostrar}</span>
            </div>
            
            ${generarHtmlFrutas(frutasInfo, true)}
            
            <div class="info-row">
              <span class="info-label">‚öñÔ∏è Kilos:</span>
              <span class="info-value">${ultimaRecogida.totalKilos ? ultimaRecogida.totalKilos.toFixed(1) + ' kg' : 'N/A'}</span>
            </div>
            
            <div class="info-row">
              <span class="info-label">üß∫ Pesas:</span>
              <span class="info-value">${ultimaRecogida.pesas ? ultimaRecogida.pesas.length : 0}</span>
            </div>
            
            <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px; padding-top: 10px;">
              <div class="info-row">
                <span class="info-label">üìà Total recogidas:</span>
                <span class="info-value">${totalRecogidas}</span>
              </div>
              
              <div class="info-row">
                <span class="info-label">üì¶ Total kilos:</span>
                <span class="info-value">${totalKilosAcumulado.toFixed(1)} kg</span>
              </div>
            </div>
          `;
        }
      } else {
        recogidaInfoDiv.innerHTML = `
          <div class="sin-recogidas">
            üìù Sin recogidas registradas<br>
            <small>¬°Realiza tu primera recogida!</small>
          </div>
        `;
      }
    }

    // Funci√≥n para formatear fecha universal
    function formatearFechaUniversal(fecha) {
      if (!fecha) return "No disponible";
      
      try {
        let dateObj;
        
        if (typeof fecha === 'string' && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
          const [year, month, day] = fecha.split('-');
          dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        } else {
          dateObj = new Date(fecha);
          
          const timeComponent = dateObj.getUTCHours() + dateObj.getUTCMinutes() + dateObj.getUTCSeconds();
          
          if (timeComponent === 0) {
            const dia = String(dateObj.getUTCDate()).padStart(2, '0');
            const mes = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
            const a√±o = dateObj.getUTCFullYear();
            return `${dia}/${mes}/${a√±o}`;
          }
        }
        
        if (isNaN(dateObj.getTime())) {
          return "Fecha inv√°lida";
        }
        
        const dia = String(dateObj.getDate()).padStart(2, '0');
        const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
        const a√±o = dateObj.getFullYear();
        
        return `${dia}/${mes}/${a√±o}`;
        
      } catch (error) {
        console.error("Error al formatear fecha universal:", error, "Fecha:", fecha);
        return "Fecha inv√°lida";
      }
    }

    // Funci√≥n para formatear moneda
    function formatearMoneda(valor) {
      if (!valor && valor !== 0) return "$0";
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(valor);
    }

    // Funci√≥n para analizar frutas de recogida
    function analizarFrutasDeRecogida(recogida) {
      const frutasInfo = {
        frutasUnicas: [],
        calidadesUnicas: [],
        resumenDetallado: {},
        esSoloUnaFruta: false,
        esSoloUnaCalidad: false
      };

      if (recogida.pesas && recogida.pesas.length > 0) {
        recogida.pesas.forEach(pesa => {
          const fruta = pesa.fruta || recogida.fruta || 'Sin especificar';
          const calidad = pesa.calidad || recogida.calidad || 'Sin especificar';
          
          if (!frutasInfo.frutasUnicas.includes(fruta)) {
            frutasInfo.frutasUnicas.push(fruta);
          }
          
          if (!frutasInfo.calidadesUnicas.includes(calidad)) {
            frutasInfo.calidadesUnicas.push(calidad);
          }
          
          const clave = `${fruta} (${calidad})`;
          if (!frutasInfo.resumenDetallado[clave]) {
            frutasInfo.resumenDetallado[clave] = {
              fruta: fruta,
              calidad: calidad,
              kilos: 0,
              pesas: 0
            };
          }
          
          frutasInfo.resumenDetallado[clave].kilos += pesa.kilos || 0;
          frutasInfo.resumenDetallado[clave].pesas += 1;
        });
      } else {
        const fruta = recogida.fruta || 'Sin especificar';
        const calidad = recogida.calidad || 'Sin especificar';
        
        frutasInfo.frutasUnicas = [fruta];
        frutasInfo.calidadesUnicas = [calidad];
        
        const clave = `${fruta} (${calidad})`;
        frutasInfo.resumenDetallado[clave] = {
          fruta: fruta,
          calidad: calidad,
          kilos: recogida.totalKilos || 0,
          pesas: recogida.pesas ? recogida.pesas.length : 1
        };
      }

      frutasInfo.esSoloUnaFruta = frutasInfo.frutasUnicas.length === 1;
      frutasInfo.esSoloUnaCalidad = frutasInfo.calidadesUnicas.length === 1;

      return frutasInfo;
    }

    // Funci√≥n para generar HTML de frutas
    function generarHtmlFrutas(frutasInfo, esSubusuario = false) {
      let html = '';

      if (frutasInfo.esSoloUnaFruta && frutasInfo.esSoloUnaCalidad) {
        const fruta = frutasInfo.frutasUnicas[0];
        const calidad = frutasInfo.calidadesUnicas[0];
        
        html += `
          <div class="info-row">
            <span class="info-label">üéÉ Fruta:</span>
            <span class="info-value">${fruta}</span>
          </div>
          
          <div class="info-row">
            <span class="info-label">‚≠ê Calidad:</span>
            <span class="info-value">${calidad}</span>
          </div>
        `;
      } else {
        if (frutasInfo.frutasUnicas.length > 1) {
          html += `
            <div class="info-row">
              <span class="info-label">üéÉ Frutas:</span>
              <span class="info-value">${frutasInfo.frutasUnicas.join(', ')}</span>
            </div>
          `;
        } else {
          html += `
            <div class="info-row">
              <span class="info-label">üéÉ Fruta:</span>
              <span class="info-value">${frutasInfo.frutasUnicas[0]}</span>
            </div>
          `;
        }

        if (frutasInfo.calidadesUnicas.length > 1) {
          html += `
            <div class="info-row">
              <span class="info-label">‚≠ê Calidades:</span>
              <span class="info-value">${frutasInfo.calidadesUnicas.join(', ')}</span>
            </div>
          `;
        } else {
          html += `
            <div class="info-row">
              <span class="info-label">‚≠ê Calidad:</span>
              <span class="info-value">${frutasInfo.calidadesUnicas[0]}</span>
            </div>
          `;
        }

        const combinaciones = Object.keys(frutasInfo.resumenDetallado);
        if (combinaciones.length > 1) {
          html += `
            <div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 8px;">
              <div style="font-size: 0.85em; font-weight: bold; margin-bottom: 5px; opacity: 0.9;">
                üìã Detalle por combinaci√≥n:
              </div>
          `;
          
          combinaciones.forEach(clave => {
            const detalle = frutasInfo.resumenDetallado[clave];
            html += `
              <div style="font-size: 0.8em; margin: 2px 0; opacity: 0.8;">
                ‚Ä¢ ${clave}: ${detalle.kilos.toFixed(1)} kg (${detalle.pesas} pesas)
              </div>
            `;
          });
          
          html += '</div>';
        }
      }

      return html;
    }

    // FUNCIONES PARA MANEJAR NOTAS DE FINCAS
    async function cargarNotasFincas() {
      try {
        if (!adminAlias) {
          console.log("No hay adminAlias definido, no se cargar√°n notas");
          return {};
        }

        console.log("Cargando notas para admin:", adminAlias);
        const response = await apiFetch(`/notas-finca/conteos/${adminAlias}`, "GET");
        notasPorFinca = response || {};
        console.log(`Notas cargadas para ${Object.keys(notasPorFinca).length} fincas`);
        return notasPorFinca;
      } catch (error) {
        console.error("Error al cargar notas de fincas:", error);
        return {};
      }
    }

    function mostrarQuickNoteModal(finca) {
      fincaActualParaNota = finca;
      const quickNoteModal = document.getElementById('quickNoteModal');
      const quickNoteTitle = document.getElementById('quickNoteTitle');
      
      quickNoteTitle.textContent = `Agregar nota para finca ${finca.nombre}`;
      document.getElementById('quickNoteContent').value = '';
      quickNoteModal.classList.add('active');
    }

    async function guardarNotaFinca() {
      const quickNoteModal = document.getElementById('quickNoteModal');
      const contenido = document.getElementById('quickNoteContent').value.trim();
      
      if (!contenido || !fincaActualParaNota) {
        alert("Por favor escribe una nota");
        return;
      }

      try {
        const nuevaNota = await apiFetch("/notas-finca/agregar", "POST", {
          fincaId: fincaActualParaNota._id,
          contenido,
          usuario,
          adminAlias
        });

        console.log("Nota guardada:", nuevaNota);
        
        if (!notasPorFinca[fincaActualParaNota._id]) {
          notasPorFinca[fincaActualParaNota._id] = { total: 0, fincaNombre: fincaActualParaNota.nombre };
        }
        notasPorFinca[fincaActualParaNota._id].total += 1;
        
        const tarjetaFinca = document.querySelector(`.card-glass[data-finca-id="${fincaActualParaNota._id}"]`);
        if (tarjetaFinca) {
          const existingBadge = tarjetaFinca.querySelector('.nota-badge');
          if (existingBadge) {
            existingBadge.textContent = `üìù ${notasPorFinca[fincaActualParaNota._id].total} nota${notasPorFinca[fincaActualParaNota._id].total > 1 ? 's' : ''}`;
          } else {
            const notaBadge = document.createElement('div');
            notaBadge.className = 'nota-badge';
            notaBadge.textContent = `üìù ${notasPorFinca[fincaActualParaNota._id].total} nota${notasPorFinca[fincaActualParaNota._id].total > 1 ? 's' : ''}`;
            notaBadge.addEventListener('click', (e) => {
              e.stopPropagation();
              mostrarNotasFinca(fincaActualParaNota);
            });
            tarjetaFinca.appendChild(notaBadge);
          }
        }

        quickNoteModal.classList.remove('active');

        // ‚úÖ Guardar en IndexedDB despu√©s de agregar nota
await saveDashboardData(usuario, {
  usuario,
  alias,
  adminAlias,
  esEnlazado,
  tipoEnlace,
  adminEnlazado,
  tipoUsuarioActual,
  fincas: todasLasFincas,
  recogidas: todasLasRecogidas,
  notas: notasPorFinca,
  timestamp: new Date().toISOString()
});

      } catch (error) {
        console.error("Error al guardar nota:", error);
        alert("Error al guardar la nota: " + error.message);
      }
    }

    async function mostrarNotasFinca(finca) {
      fincaActualParaNota = finca;
      const notasModal = document.getElementById('notasModal');
      const notasModalTitle = document.getElementById('notasModalTitle');
      const notasList = document.getElementById('notasList');
      
      notasModalTitle.textContent = `Notas de ${finca.nombre}`;
      notasList.innerHTML = '<div style="text-align: center; padding: 20px;">Cargando notas...</div>';
      notasModal.classList.add('active');

      try {
        const notas = await apiFetch(`/notas-finca/finca/${finca._id}`, "GET");
        
        if (notas.length === 0) {
          notasList.innerHTML = '<div style="text-align: center; padding: 20px;">No hay notas para esta finca</div>';
          return;
        }

        notasList.innerHTML = '';
        notas.forEach(nota => {
          const notaItem = document.createElement('div');
          notaItem.className = 'nota-item';
          
          const fechaCreacion = new Date(nota.fechaCreacion).toLocaleString();
          
          notaItem.innerHTML = `
            <div class="nota-content">${nota.contenido}</div>
            <div class="nota-meta">
              <span>Creada: ${fechaCreacion}</span>
            </div>
            <div class="nota-actions">
              <button class="delete-nota-btn" data-nota-id="${nota._id}">üóëÔ∏è Eliminar</button>
            </div>
          `;
          
          notasList.appendChild(notaItem);
        });

        document.querySelectorAll('.delete-nota-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const notaId = e.target.dataset.notaId;
            eliminarNota(notaId);
          });
        });
      } catch (error) {
        console.error("Error al cargar notas:", error);
        notasList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f44336;">Error al cargar las notas</div>';
      }
    }

    // Funci√≥n para eliminar una nota
    async function eliminarNota(notaId) {
      if (!confirm("¬øEst√°s seguro de que quieres eliminar esta nota?")) {
        return;
      }

      try {
        await apiFetch(`/notas-finca/eliminar/${notaId}`, "DELETE");
        console.log("‚úÖ Nota eliminada:", notaId);
        
        // Actualizar el cache local
        if (notasPorFinca[fincaActualParaNota._id] && notasPorFinca[fincaActualParaNota._id].total > 0) {
          notasPorFinca[fincaActualParaNota._id].total -= 1;
          
          // Actualizar la tarjeta de la finca
          const tarjetaFinca = document.querySelector(`.card-glass[data-finca-id="${fincaActualParaNota._id}"]`);
          if (tarjetaFinca) {
            const existingBadge = tarjetaFinca.querySelector('.nota-badge');
            if (existingBadge) {
              if (notasPorFinca[fincaActualParaNota._id].total === 0) {
                existingBadge.remove();
              } else {
                existingBadge.textContent = `üìù ${notasPorFinca[fincaActualParaNota._id].total} nota${notasPorFinca[fincaActualParaNota._id].total > 1 ? 's' : ''}`;
              }
            }
          }
        }
        
        mostrarNotasFinca(fincaActualParaNota);

        // ‚úÖ Guardar en IndexedDB despu√©s de eliminar nota
await saveDashboardData(usuario, {
  usuario,
  alias,
  adminAlias,
  esEnlazado,
  tipoEnlace,
  adminEnlazado,
  tipoUsuarioActual,
  fincas: todasLasFincas,
  recogidas: todasLasRecogidas,
  notas: notasPorFinca,
  timestamp: new Date().toISOString()
});

      } catch (error) {
        console.error("‚ùå Error al eliminar nota:", error);
        alert("Error al eliminar la nota: " + error.message);
      }
    }

    // üöÄ OPTIMIZACI√ìN: Mostrar fincas de forma r√°pida
    async function mostrarFincasOptimizado(fincas) {
      const lista = document.getElementById("listaFincas");
      
      if (fincas.length === 0) {
        lista.innerHTML = "<p>No tienes fincas registradas a√∫n.</p>";
        return;
      }

      // Mostrar loader general
      lista.innerHTML = `
        <div class="general-loader">
          <div class="loader-spinner"></div>
          <div>Cargando informaci√≥n de ${fincas.length} finca${fincas.length > 1 ? 's' : ''}...</div>
        </div>
      `;

      console.log("üöÄ Iniciando renderizado optimizado...");
      const startTime = performance.now();

      // 1. Cargar notas de fincas primero
      await cargarNotasFincas();

      // 2. Renderizar todas las fincas (sin datos de recogidas)
      const fragments = document.createDocumentFragment();
      const divsFincas = [];

      fincas.forEach(finca => {
        const div = renderFincaRapido(finca);
        fragments.appendChild(div);
        divsFincas.push({ div, finca });
      });

      // Limpiar y agregar todas las fincas de una vez
      lista.innerHTML = "";
      lista.appendChild(fragments);

      const renderTime = performance.now();
      console.log(`‚úÖ Fincas renderizadas en ${(renderTime - startTime).toFixed(0)}ms`);

      // 3. Cargar todas las recogidas en paralelo
      const fincaIds = fincas.map(f => f._id);
      await cargarTodasLasRecogidas(fincaIds);

      // 4. Actualizar la informaci√≥n de recogidas para todas las fincas
      divsFincas.forEach(({ div, finca }) => {
        actualizarInfoRecogidas(div, finca);
      });

      const totalTime = performance.now();
      console.log(`üéâ Proceso completo terminado en ${(totalTime - startTime).toFixed(0)}ms`);
      console.log(`üìä Rendimiento: ${fincas.length} fincas en ${((totalTime - startTime) / 1000).toFixed(2)} segundos`);
    }

    // üöÄ OPTIMIZACI√ìN: Obtener tipo de usuario al inicio
    async function obtenerTipoUsuario() {
      try {
        const storedData = sessionStorage.getItem('userData');
        if (storedData) {
          const userData = JSON.parse(storedData);
          tipoUsuarioActual = userData.tipo;
          console.log("üë§ Tipo de usuario desde sessionStorage:", tipoUsuarioActual);
          return tipoUsuarioActual;
        }

        if (usuario) {
          const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
          if (response.ok) {
            const userData = await response.json();
            tipoUsuarioActual = userData.tipo;
            console.log("üë§ Tipo de usuario desde servidor:", tipoUsuarioActual);
            
            // Guardar en sessionStorage para pr√≥ximas consultas
            sessionStorage.setItem('userData', JSON.stringify(userData));
            return tipoUsuarioActual;
          }
        }

        console.log("üë§ Usando tipo de usuario por defecto:", tipoUsuarioActual);
        return tipoUsuarioActual;
      } catch (error) {
        console.error("‚ùå Error al obtener tipo de usuario:", error);
        return tipoUsuarioActual;
      }
    }

    // Event listeners y funciones principales
    const btnAgregar = document.getElementById("btnAgregarFinca");
    const modal = document.getElementById("modalFinca");
    const guardar = document.getElementById("guardarFinca");
    const lista = document.getElementById("listaFincas");

    // Event listeners para el modal de notas
    document.getElementById('quickNoteCancel').addEventListener('click', () => {
      document.getElementById('quickNoteModal').classList.remove('active');    });

    document.getElementById('quickNoteSave').addEventListener('click', guardarNotaFinca);

    document.getElementById('notasModalClose').addEventListener('click', () => {
      document.getElementById('notasModal').classList.remove('active');
    });

    document.getElementById('addNewNoteBtn').addEventListener('click', () => {
      document.getElementById('notasModal').classList.remove('active');
      mostrarQuickNoteModal(fincaActualParaNota);
    });

    // Event listener para guardar finca
guardar.addEventListener("click", async () => {
  const nombre = document.getElementById("nombreFinca").value.trim();
  const propietario = document.getElementById("propietarioFinca").value.trim();

  if (!nombre || !propietario) return alert("Completa todos los campos");

  try {
    // üî• USAR aliasEfectivo para que las fincas se asignen al admin principal
    const finca = await apiFetch("/fincas/agregar", "POST", { 
      nombre, 
      propietario, 
      usuario: esEnlazado && adminEnlazado ? adminEnlazado : usuario, // Usuario que crea
      adminAlias: aliasEfectivo // Admin al que pertenece
    });
    
    if (todasLasFincas.length === 0) {
      finca.esPrimeraFinca = true;
      console.log("üëë Esta es la primera finca del administrador");
    }
    
    todasLasFincas.unshift(finca);
    
    const div = renderFincaRapido(finca);
    lista.prepend(div);
    
    await cargarTodasLasRecogidas([finca._id]);
    actualizarInfoRecogidas(div, finca);
    
    modal.classList.add("hidden");

    // ‚úÖ Guardar en IndexedDB despu√©s de agregar finca
await saveDashboardData(usuario, {
  usuario,
  alias,
  adminAlias,
  esEnlazado,
  tipoEnlace,
  adminEnlazado,
  tipoUsuarioActual,
  fincas: todasLasFincas,
  recogidas: todasLasRecogidas,
  notas: notasPorFinca,
  timestamp: new Date().toISOString()
});
    
    document.getElementById("nombreFinca").value = "";
    document.getElementById("propietarioFinca").value = "";
  } catch (err) {
    console.error("Error al guardar finca:", err);
    alert("Error al guardar finca: " + err.message);
  }
});

async function cargarFincas() {
  try {
    if (!navigator.onLine) {
      console.log("üì¥ Modo offline. Cargando desde IndexedDB...");
      const datos = await getDashboardData(usuario);
      if (!datos || !datos.fincas) {
        alert("‚ùå No hay datos offline disponibles.");
        document.getElementById("listaFincas").innerHTML = "<p>No hay datos disponibles sin conexi√≥n.</p>";
        return;
      }

      // ‚úÖ Restaurar datos desde IndexedDB
      todasLasFincas = datos.fincas;
      notasPorFinca = datos.notas || {};
      tipoUsuarioActual = datos.tipoUsuarioActual || 1;

      console.log("‚úÖ Datos cargados desde IndexedDB:", todasLasFincas.length, "fincas");
      await mostrarFincasOptimizado(todasLasFincas);
      return;
    }

    console.log("üåê Modo online. Cargando fincas para administrador:", aliasEfectivo);

    if (!aliasEfectivo) {
      console.error("‚ùå No hay aliasEfectivo definido");
      const todasFincas = await apiFetch("/fincas/listar", "GET");
      const fincasUsuario = todasFincas.filter(f => f.usuario === usuario);
      todasLasFincas = fincasUsuario;
    } else {
      const response = await fetch(`https://jc-frutas.onrender.com/fincas/por-admin/${aliasEfectivo}`);
      if (response.ok) {
        const fincasAdmin = await response.json();
        todasLasFincas = fincasAdmin;
        console.log("üìã Fincas del administrador:", todasLasFincas.length);
      } else {
        const todasFincas = await apiFetch("/fincas/listar", "GET");
        const fincasUsuario = todasFincas.filter(f => f.usuario === usuario || f.adminAlias === aliasEfectivo);
        todasLasFincas = fincasUsuario;
      }
    }

    // Identificar la primera finca creada por el admin
    if (todasLasFincas.length > 0) {
      const fincasOrdenadas = [...todasLasFincas].sort((a, b) => {
        const fechaA = new Date(a.fecha || a.createdAt || '1970-01-01');
        const fechaB = new Date(b.fecha || b.createdAt || '1970-01-01');
        return fechaA - fechaB;
      });
      const primeraFinca = fincasOrdenadas[0];
      primeraFinca.esPrimeraFinca = true;
      console.log("üëë Primera finca identificada:", primeraFinca.nombre, "- Fecha:", primeraFinca.fecha);

      todasLasFincas = todasLasFincas.map(finca => {
        if (finca._id === primeraFinca._id) {
          return { ...finca, esPrimeraFinca: true };
        }
        return finca;
      });
    }

    console.log("üìã Total de fincas cargadas:", todasLasFincas.length);

    await obtenerTipoUsuario();
    await mostrarFincasOptimizado(todasLasFincas);

    // ‚úÖ Guardar en IndexedDB para uso offline
    await saveDashboardData(usuario, {
      usuario,
      alias,
      adminAlias,
      esEnlazado,
      tipoEnlace,
      adminEnlazado,
      tipoUsuarioActual,
      fincas: todasLasFincas,
      recogidas: todasLasRecogidas,
      notas: notasPorFinca,
      timestamp: new Date().toISOString()
    });

  } catch (err) {
    console.error("Error al cargar fincas:", err);
    alert("Error al cargar fincas: " + err.message);
  }
}

// Event listeners para el modal
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.add("hidden");
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        modal.classList.add("hidden");
      }
    });

    btnAgregar.addEventListener("click", () => {
      modal.classList.remove("hidden");
    });

    // üöÄ OPTIMIZACI√ìN: B√∫squeda optimizada
    const inputBuscar = document.getElementById("buscarFinca");
    let timeoutBusqueda;

    inputBuscar.addEventListener("input", () => {
      // Debounce para evitar b√∫squedas excesivas
      clearTimeout(timeoutBusqueda);
      
      timeoutBusqueda = setTimeout(async () => {
        const texto = inputBuscar.value.toLowerCase();

        const filtradas = todasLasFincas.filter(finca =>
          finca.nombre.toLowerCase().includes(texto) ||
          finca.propietario.toLowerCase().includes(texto)
        );

        console.log(`üîç B√∫squeda: "${texto}" - ${filtradas.length} resultados`);
        await mostrarFincasOptimizado(filtradas);
      }, 300); // Esperar 300ms despu√©s de que el usuario deje de escribir
    });

    // Agregar estilos responsivos
    function agregarEstilosResponsivos() {
      const style = document.createElement('style');
      style.textContent = `
        @media (max-width: 768px) {
          #historial-top-container {
            padding: 8px 15px;
          }

          #historial-top-container .historial-btn {
            padding: 10px 20px;
            font-size: 0.9rem;
            min-width: 160px;
          }

          body[style*="padding-top"] {
            padding-top: 60px !important;
          }
          .container[style*="margin-top"] {
            margin-top: 60px !important;
          }
        }

        @media (max-width: 480px) {
          #historial-top-container {
            padding: 6px 10px;
          }

          #historial-top-container .historial-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            min-width: 140px;
            gap: 6px;
          }

          body[style*="padding-top"] {
            padding-top: 50px !important;
          }
          .container[style*="margin-top"] {
            margin-top: 50px !important;
          }
        }

        #historial-top-container {
          animation: slideDownFromTop 0.5s ease forwards;
          z-index: 99999 !important;
          background: rgba(255, 255, 255, 0.9) !important;
          backdrop-filter: blur(20px) !important;
          -webkit-backdrop-filter: blur(20px) !important;
          border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        @keyframes slideDownFromTop {
          from {
            opacity: 0;
            transform: translateY(-100%);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        @media (prefers-color-scheme: dark) {
          #historial-top-container {
            background: rgba(0, 0, 0, 0.8) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
          }
        }
      `;
      document.head.appendChild(style);
    }

    // Inicializaci√≥n principal
    document.addEventListener('DOMContentLoaded', () => {
      agregarEstilosResponsivos();
      
      setTimeout(() => {
        inicializarBotonHistorial();
      }, 500);
    });

    if (document.readyState === 'loading') {
      // El evento DOMContentLoaded se ejecutar√°
    } else {
      setTimeout(() => {
        agregarEstilosResponsivos();
        inicializarBotonHistorial();
      }, 100);
    }

    // Cleanup al salir de la p√°gina
    window.addEventListener('beforeunload', () => {
      const topContainer = document.getElementById('historial-top-container');
      if (topContainer) {
        topContainer.remove();
      }
      
      const body = document.body;
      const container = document.querySelector('.container');
      
      if (body.style.paddingTop) {
        body.style.paddingTop = '';
      }
      
      if (container && container.style.marginTop) {
        container.style.marginTop = '';
      }
    });

    

    // Cargar fincas al iniciar
    cargarFincas();

// SCROLL BUTTON FUNCTIONALITY PARA CONTENEDOR ESPEC√çFICO
const scrollButton = document.getElementById('scrollButton');
const container = document.querySelector('.container');
let isAtBottom = false;

// Asegurar que el contenedor tenga scroll habilitado
function setupContainerScroll() {
  if (container) {
    // Si el contenedor no tiene altura espec√≠fica, configurarlo
    if (!container.style.height && !container.style.maxHeight) {
      container.style.height = '80vh'; // O el valor que necesites
      container.style.overflowY = 'auto';
    }
  }
}

function updateScrollButtonState() {
  if (!container) return;
  
  const scrollTop = container.scrollTop;
  const scrollHeight = container.scrollHeight;
  const clientHeight = container.clientHeight;
  
  // Considerar que est√° en el fondo si est√° dentro de los √∫ltimos 50px
  const threshold = 50;
  isAtBottom = scrollTop + clientHeight >= scrollHeight - threshold;
  
  // Mostrar/ocultar bot√≥n solo si hay contenido que hacer scroll
  if (scrollHeight > clientHeight) {
    scrollButton.style.display = 'flex';
    
    if (isAtBottom) {
      scrollButton.classList.add('up');
    } else {
      scrollButton.classList.remove('up');
    }
  } else {
    // No hay contenido suficiente para scroll, ocultar bot√≥n
    scrollButton.style.display = 'none';
  }
}

function smoothScrollTo(targetPosition, duration = 800) {
  if (!container) return;
  
  const startPosition = container.scrollTop;
  const distance = targetPosition - startPosition;
  const startTime = performance.now();

  function animation(currentTime) {
    const timeElapsed = currentTime - startTime;
    const progress = Math.min(timeElapsed / duration, 1);
    
    // Funci√≥n de easing suave
    const ease = progress < 0.5 
      ? 4 * progress * progress * progress 
      : 1 - Math.pow(-2 * progress + 2, 3) / 2;
    
    container.scrollTop = startPosition + distance * ease;
    
    if (timeElapsed < duration) {
      requestAnimationFrame(animation);
    }
  }
  
  requestAnimationFrame(animation);
}

scrollButton.addEventListener('click', () => {
  if (!container) return;
  
  // A√±adir efecto visual al bot√≥n
  scrollButton.style.transform = 'scale(0.95)';
  setTimeout(() => {
    scrollButton.style.transform = '';
  }, 150);
  
  if (isAtBottom) {
    // Scroll hacia arriba (al inicio del contenedor)
    smoothScrollTo(0);
  } else {
    // Scroll hacia abajo (al final del contenedor)
    const scrollHeight = container.scrollHeight;
    const clientHeight = container.clientHeight;
    smoothScrollTo(scrollHeight - clientHeight);
  }
});

// Actualizar estado del bot√≥n al hacer scroll en el contenedor
if (container) {
  container.addEventListener('scroll', updateScrollButtonState);
  
  // Tambi√©n escuchar cambios en el tama√±o del contenedor
  const resizeObserver = new ResizeObserver(updateScrollButtonState);
  resizeObserver.observe(container);
}

// Actualizar cuando cambie el tama√±o de la ventana
window.addEventListener('resize', updateScrollButtonState);

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
  setupContainerScroll();
  
  // Dar tiempo a que el contenido se cargue
  setTimeout(updateScrollButtonState, 500);
});

// Tambi√©n actualizar despu√©s de que se carguen las fincas
// (puedes llamar esta funci√≥n despu√©s de cargar el contenido)
function actualizarScrollDespuesDeCargar() {
  setTimeout(updateScrollButtonState, 100);
}

  </script>
</body>
</html>