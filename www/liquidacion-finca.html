<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jc-loader.js"></script>
      <script src="blockCheck.js"></script>

    <title>Liquidaciones de Finca</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f0f0f0;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 36px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .finca-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .finca-info h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .finca-info p {
            color: #6c757d;
            font-size: 16px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 14px;
        }

        .filters-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }

        .filter-group input, .filter-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .filter-clear {
            background: #dc3545;
            color: white;
        }

        .liquidaciones-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .liquidacion-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .liquidacion-card:hover {
            border-color: #667eea;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .liquidacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .liquidacion-fecha {
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .estado-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .estado-liquidada {
            background: #d1edff;
            color: #0c5460;
            border: 1px solid #bee1e5;
        }

        .liquidacion-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .info-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: #6c757d;
            font-weight: 500;
        }

        .info-value {
            color: #2c3e50;
            font-weight: bold;
        }

        .actions-section {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 18px;
            color: #6c757d;
        }

        .loading::before {
            content: "üîÑ";
            display: block;
            font-size: 48px;
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .no-data::before {
            content: "üì≠";
            display: block;
            font-size: 64px;
            margin-bottom: 20px;
        }

        .back-button {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 1000;
        }

        .summary-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .filters-container {
                grid-template-columns: 1fr;
            }
            
            .liquidacion-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .liquidacion-info {
                grid-template-columns: 1fr;
            }

            .back-button, .summary-button {
                position: static;
                margin: 10px 0;
            }
        }

        .highlight {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea !important;
        }
    </style>
</head>
<body>

    
    <div class="back-button">
        <button class="btn btn-secondary" onclick="volverAtras()">
            ‚Üê Volver
        </button>
    </div>

    <div class="container">
        <div class="header">
            <h1>üè† Liquidaciones de Finca</h1>
            <p>Recogidas liquidadas de la finca seleccionada</p>
        </div>

        <div class="finca-info" id="fincaInfo">
            <h2 id="fincaNombre">Cargando informaci√≥n...</h2>
            <p id="fincaPropietario"></p>
        </div>

        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <h3 id="totalLiquidadas">0</h3>
                <p>‚úÖ Recogidas Liquidadas</p>
            </div>
            <div class="stat-card">
                <h3 id="totalKilos">0</h3>
                <p>‚öñÔ∏è Kilos Totales</p>
            </div>
            <div class="stat-card">
                <h3 id="totalPesas">0</h3>
                <p>üì¶ Pesas Totales</p>
            </div>
            <div class="stat-card" id="totalValorCard">
                <h3 id="totalValor">$0</h3>
                <p>üí∞ Valor Total</p>
            </div>
        </div>

        <div class="filters-container">
            <div class="filter-group">
                <label for="filtroRecolector">üë§ Recolector:</label>
                <input type="text" id="filtroRecolector" placeholder="Buscar por alias/usuario">
            </div>
            <div class="filter-group">
                <label for="filtroFecha">üìÖ Fecha:</label>
                <input type="date" id="filtroFecha">
            </div>
            <div class="filter-group">
                <label for="filtroFruta">üçì Fruta:</label>
                <input type="text" id="filtroFruta" placeholder="Buscar por fruta">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn filter-clear" onclick="limpiarFiltros()">
                    üßπ Limpiar Filtros
                </button>
            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            Cargando liquidaciones de la finca...
        </div>

        <div id="noDataMessage" class="no-data" style="display: none;">
            <h3>No se encontraron liquidaciones</h3>
            <p>Esta finca no tiene recogidas liquidadas que coincidan con los filtros aplicados</p>
        </div>

        <div class="liquidaciones-grid" id="liquidacionesContainer">
        </div>
    </div>


    <div class="summary-button">
        <button class="btn btn-success" onclick="generarResumenFinca()" id="btnResumen" style="display: none;">
            üìä Resumen Finca
        </button>
    </div>

    <!-- Script para html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Variables globales
        let todasLasLiquidaciones = [];
        let liquidacionesFiltradas = [];
        let isSubusuario = false;
        let fincaInfo = null;
        let usuario = '';
        let adminAlias = '';

        // Obtener par√°metros de URL
        const urlParams = new URLSearchParams(window.location.search);
        const fincaId = urlParams.get('fincaId');
        const fincaNombre = urlParams.get('finca');
        const fincaPropietario = urlParams.get('propietario');
        usuario = urlParams.get('usuario') || '';
        adminAlias = urlParams.get('adminAlias') || '';

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            if (!fincaId) {
                alert('Error: No se especific√≥ la finca');
                volverAtras();
                return;
            }

            // Obtener informaci√≥n de usuario y admin
            await obtenerInfoUsuario();

            // Mostrar informaci√≥n de la finca
            mostrarInfoFinca();

            // Configurar filtros en tiempo real
            configurarFiltros();

            // Cargar liquidaciones de la finca
            await cargarLiquidacionesFinca();
        });

        // Obtener informaci√≥n del usuario
        async function obtenerInfoUsuario() {
            try {
                const storedData = sessionStorage.getItem('userData');
                if (storedData) {
                    const sessionData = JSON.parse(storedData);
                    adminAlias = sessionData.adminAlias || sessionData.alias;
                    usuario = sessionData.username;
                    isSubusuario = sessionData.tipo === 2;
                } else if (usuario) {
                    const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
                    if (response.ok) {
                        const userData = await response.json();
                        isSubusuario = userData.tipo === 2;
                        adminAlias = userData.aliasAdmin || userData.alias;
                    }
                }

                // Ocultar valores monetarios para subusuarios
                if (isSubusuario) {
                    document.getElementById('totalValorCard').style.display = 'none';
                }
            } catch (error) {
                console.error('Error obteniendo informaci√≥n de usuario:', error);
            }
        }

        // Mostrar informaci√≥n de la finca
        function mostrarInfoFinca() {
            document.getElementById('fincaNombre').textContent = fincaNombre || 'Finca sin nombre';
            document.getElementById('fincaPropietario').textContent = `Propietario: ${fincaPropietario || 'No especificado'}`;
        }

        // Configurar filtros en tiempo real
        function configurarFiltros() {
            const filtros = ['filtroRecolector', 'filtroFecha', 'filtroFruta'];
            
            filtros.forEach(filtroId => {
                const elemento = document.getElementById(filtroId);
                elemento.addEventListener('input', filtrarLiquidaciones);
                elemento.addEventListener('change', filtrarLiquidaciones);
            });
        }

        // Cargar liquidaciones de la finca espec√≠fica
        async function cargarLiquidacionesFinca() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('noDataMessage').style.display = 'none';

                // Obtener todas las liquidaciones del administrador
                const response = await fetch(`https://jc-frutas.onrender.com/recogidas/historial-liquidaciones/${adminAlias}?usuario=${encodeURIComponent(usuario)}&estado=liquidada`);
                
                if (!response.ok) {
                    throw new Error('Error al cargar liquidaciones');
                }

                const data = await response.json();
                
                // Filtrar solo las liquidaciones de esta finca espec√≠fica
                todasLasLiquidaciones = data.recogidas.filter(liquidacion => 
                    liquidacion.fincaId === fincaId && liquidacion.estadoLiquidacion === 'liquidada'
                );

                console.log(`Liquidaciones de finca ${fincaNombre}:`, todasLasLiquidaciones.length);

                // Aplicar filtros
                filtrarLiquidaciones();

            } catch (error) {
                console.error('Error cargando liquidaciones de finca:', error);
                document.getElementById('loadingIndicator').innerHTML = '‚ùå Error al cargar liquidaciones: ' + error.message;
            }
        }

        // Filtrar liquidaciones
        function filtrarLiquidaciones() {
            const filtroRecolector = document.getElementById('filtroRecolector').value.toLowerCase();
            const filtroFecha = document.getElementById('filtroFecha').value;
            const filtroFruta = document.getElementById('filtroFruta').value.toLowerCase();

            liquidacionesFiltradas = todasLasLiquidaciones.filter(liquidacion => {
                // Filtro por recolector
                const cumpleRecolector = !filtroRecolector || 
                    (liquidacion.alias && liquidacion.alias.toLowerCase().includes(filtroRecolector)) ||
                    (liquidacion.usuario && liquidacion.usuario.toLowerCase().includes(filtroRecolector));

                // Filtro por fecha
                let cumpleFecha = true;
                if (filtroFecha) {
                    const fechaLiquidacion = liquidacion.fecha ? liquidacion.fecha.split('T')[0] : '';
                    cumpleFecha = fechaLiquidacion === filtroFecha;
                }

                // Filtro por fruta
                let cumpleFruta = true;
                if (filtroFruta) {
                    cumpleFruta = (liquidacion.fruta && liquidacion.fruta.toLowerCase().includes(filtroFruta)) ||
                        (liquidacion.pesas && liquidacion.pesas.some(pesa => 
                            pesa.fruta && pesa.fruta.toLowerCase().includes(filtroFruta)
                        ));
                }

                return cumpleRecolector && cumpleFecha && cumpleFruta;
            });

            mostrarLiquidaciones();
        }

        // Mostrar liquidaciones filtradas
        function mostrarLiquidaciones() {
            document.getElementById('loadingIndicator').style.display = 'none';

            if (liquidacionesFiltradas.length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('btnResumen').style.display = 'none';
                document.getElementById('liquidacionesContainer').innerHTML = '';
                return;
            }

            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'grid';
            document.getElementById('btnResumen').style.display = 'block';

            // Calcular estad√≠sticas
            let totalLiquidadas = liquidacionesFiltradas.length;
            let totalKilos = 0;
            let totalValor = 0;
            let totalPesas = 0;

            liquidacionesFiltradas.forEach(liquidacion => {
                totalKilos += liquidacion.totalKilos || 0;
                if (!isSubusuario) {
                    totalValor += liquidacion.valorPagar || 0;
                }
                if (liquidacion.pesas) {
                    totalPesas += liquidacion.pesas.length;
                }
            });

            // Actualizar estad√≠sticas
            document.getElementById('totalLiquidadas').textContent = totalLiquidadas;
            document.getElementById('totalKilos').textContent = totalKilos + ' kg';
            document.getElementById('totalPesas').textContent = totalPesas;
            if (!isSubusuario) {
                document.getElementById('totalValor').textContent = '$' + totalValor.toLocaleString();
            }

            // Mostrar liquidaciones
            const container = document.getElementById('liquidacionesContainer');
            container.innerHTML = '';

            liquidacionesFiltradas.forEach((liquidacion, index) => {
                const card = crearTarjetaLiquidacion(liquidacion, index + 1);
                container.appendChild(card);
            });
        }

        // Crear tarjeta de liquidaci√≥n
        function crearTarjetaLiquidacion(liquidacion, numero) {
            const div = document.createElement('div');
            div.className = 'liquidacion-card';

            const fecha = formatearFechaLocal(liquidacion.fecha);
            const fechaLiquidacion = formatearFechaLocal(liquidacion.fechaLiquidacion);
            const totalPesas = liquidacion.pesas ? liquidacion.pesas.length : 0;

            div.innerHTML = `
                <div class="liquidacion-header">
                    <div class="liquidacion-fecha">
                        üìÖ ${fecha} - Liquidaci√≥n #${numero}
                    </div>
                    <div class="estado-badge estado-liquidada">
                        ‚úÖ Liquidada
                    </div>
                </div>
                
                <div class="liquidacion-info">
                    <div class="info-section">
                        <h4>üë§ Informaci√≥n de Recogida</h4>
                        <div class="info-item">
                            <span class="info-label">Recolector:</span>
                            <span class="info-value">${liquidacion.alias || liquidacion.usuario}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Fruta Principal:</span>
                            <span class="info-value">${liquidacion.fruta || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Calidad:</span>
                            <span class="info-value">${liquidacion.calidad || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="info-section">
                        <h4>üìä Totales</h4>
                        <div class="info-item">
                            <span class="info-label">Total Kilos:</span>
                            <span class="info-value">${liquidacion.totalKilos || 0} kg</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Total Pesas:</span>
                            <span class="info-value">${totalPesas}</span>
                        </div>
                        ${!isSubusuario ? `
                        <div class="info-item">
                            <span class="info-label">Valor Total:</span>
                            <span class="info-value">$${(liquidacion.valorPagar || 0).toLocaleString()}</span>
                        </div>
                        ` : ''}
                    </div>

                    <div class="info-section">
                        <h4>‚úÖ Informaci√≥n de Liquidaci√≥n</h4>
                        <div class="info-item">
                            <span class="info-label">Fecha Liquidaci√≥n:</span>
                            <span class="info-value">${fechaLiquidacion}</span>
                        </div>
                        ${liquidacion.usuarioLiquida ? `
                        <div class="info-item">
                            <span class="info-label">Liquidado por:</span>
                            <span class="info-value">${liquidacion.usuarioLiquida}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <div class="actions-section">
                    <button class="btn btn-primary" onclick="verDetalleLiquidacion('${liquidacion._id}')">
                        üëÅÔ∏è Ver Detalles
                    </button>
                </div>
            `;

            return div;
        }

        // Ver detalle de liquidaci√≥n
        function verDetalleLiquidacion(liquidacionId) {
            const liquidacion = todasLasLiquidaciones.find(l => l._id === liquidacionId);
            if (!liquidacion) {
                mostrarNotificacion('‚ùå No se encontr√≥ la liquidaci√≥n', 'error');
                return;
            }

            // Crear modal con detalle completo
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 30px;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;

            const fecha = formatearFechaLocal(liquidacion.fecha);
            const fechaLiquidacion = formatearFechaLocal(liquidacion.fechaLiquidacion);
            const totalPesas = liquidacion.pesas ? liquidacion.pesas.length : 0;

            modalContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #2c3e50; margin-bottom: 10px;">üìã Detalle de Liquidaci√≥n</h2>
                    <p style="color: #7f8c8d;">Recogida liquidada de ${fincaNombre}</p>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üìÖ ${fecha}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>üè† Finca:</strong> ${liquidacion.finca || 'N/A'}</div>
                        <div><strong>üë§ Propietario:</strong> ${liquidacion.propietario || 'N/A'}</div>
                        <div><strong>üåæ Recolector:</strong> ${liquidacion.alias || liquidacion.usuario}</div>
                        <div><strong>‚úÖ Liquidado:</strong> ${fechaLiquidacion}</div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üìä Resumen de Recogida</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                            <strong style="display: block; font-size: 24px; color: #667eea;">${liquidacion.totalKilos || 0}</strong>
                            <span style="color: #6c757d;">Kilos Totales</span>
                        </div>
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                            <strong style="display: block; font-size: 24px; color: #667eea;">${totalPesas}</strong>
                            <span style="color: #6c757d;">Total Pesas</span>
                        </div>
                        ${!isSubusuario ? `
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                            <strong style="display: block; font-size: 24px; color: #667eea;">${(liquidacion.valorPagar || 0).toLocaleString()}</strong>
                            <span style="color: #6c757d;">Valor Total</span>
                        </div>
                        ` : ''}
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                            <strong style="display: block; font-size: 24px; color: #667eea;">${liquidacion.fruta || 'N/A'}</strong>
                            <span style="color: #6c757d;">Fruta Principal</span>
                        </div>
                    </div>
                </div>

                ${liquidacion.pesas && liquidacion.pesas.length > 0 ? `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üì¶ Detalle de ${totalPesas} Pesas</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        ${liquidacion.pesas.map((pesa, idx) => `
                            <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; font-size: 13px;">
                                <strong style="display: block; color: #2c3e50; margin-bottom: 5px;">Pesa ${idx + 1}</strong>
                                <div>${pesa.kilos} kg</div>
                                <div style="color: #667eea;">${pesa.fruta || liquidacion.fruta}</div>
                                <div style="color: #6c757d;">${pesa.calidad || liquidacion.calidad}</div>
                                ${!isSubusuario && pesa.valor ? `<div style="font-weight: bold; color: #28a745;">${pesa.valor.toLocaleString()}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="cerrarModal()" style="padding: 12px 30px;">
                        Cerrar
                    </button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Funci√≥n para cerrar modal
            window.cerrarModal = function() {
                document.body.removeChild(modal);
                delete window.cerrarModal;
            };

            // Cerrar al hacer clic fuera del modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    window.cerrarModal();
                }
            });
        }

        // Formatear fecha local
        function formatearFechaLocal(fechaString) {
            if (!fechaString) return 'Sin fecha';
            
            const partes = fechaString.split('T')[0].split('-');
            if (partes.length === 3) {
                const a√±o = parseInt(partes[0]);
                const mes = parseInt(partes[1]) - 1;
                const dia = parseInt(partes[2]);
                
                const fecha = new Date(a√±o, mes, dia);
                return fecha.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            return new Date(fechaString).toLocaleDateString('es-ES');
        }

        // Mostrar notificaci√≥n
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notificacion = document.createElement('div');
            const colores = {
                'success': 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)',
                'error': 'linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)',
                'warning': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
            };

            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colores[tipo]};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 2000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;

            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);

            // Remover despu√©s de 4 segundos
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notificacion.parentNode) {
                            notificacion.parentNode.removeChild(notificacion);
                        }
                    }, 300);
                }
            }, 4000);
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('filtroRecolector').value = '';
            document.getElementById('filtroFecha').value = '';
            document.getElementById('filtroFruta').value = '';
            
            filtrarLiquidaciones();
        }

        // Generar resumen de la finca
        async function generarResumenFinca() {
            if (liquidacionesFiltradas.length === 0) {
                mostrarNotificacion('‚ùå No hay liquidaciones para generar resumen', 'error');
                return;
            }

            try {
                console.log('üöÄ Generando resumen de liquidaciones de finca...');
                
                // Procesar datos para el resumen
                const resumenPorRecolector = {};
                const resumenPorFruta = {};
                const resumenPorMes = {};
                let totalKilosGeneral = 0;
                let totalValorGeneral = 0;
                let totalPesasGeneral = 0;

                liquidacionesFiltradas.forEach(liquidacion => {
                    const recolector = liquidacion.alias || liquidacion.usuario || 'Sin especificar';
                    const fruta = liquidacion.fruta || 'Sin especificar';
                    const fecha = new Date(liquidacion.fecha);
                    const mesAno = `${fecha.getMonth() + 1}/${fecha.getFullYear()}`;

                    // Resumen por recolector
                    if (!resumenPorRecolector[recolector]) {
                        resumenPorRecolector[recolector] = { cantidad: 0, kilos: 0, valor: 0 };
                    }
                    resumenPorRecolector[recolector].cantidad++;
                    resumenPorRecolector[recolector].kilos += liquidacion.totalKilos || 0;
                    resumenPorRecolector[recolector].valor += liquidacion.valorPagar || 0;

                    // Resumen por fruta
                    if (!resumenPorFruta[fruta]) {
                        resumenPorFruta[fruta] = { cantidad: 0, kilos: 0, valor: 0 };
                    }
                    resumenPorFruta[fruta].cantidad++;
                    resumenPorFruta[fruta].kilos += liquidacion.totalKilos || 0;
                    resumenPorFruta[fruta].valor += liquidacion.valorPagar || 0;

                    // Resumen por mes
                    if (!resumenPorMes[mesAno]) {
                        resumenPorMes[mesAno] = { cantidad: 0, kilos: 0, valor: 0 };
                    }
                    resumenPorMes[mesAno].cantidad++;
                    resumenPorMes[mesAno].kilos += liquidacion.totalKilos || 0;
                    resumenPorMes[mesAno].valor += liquidacion.valorPagar || 0;

                    // Totales generales
                    totalKilosGeneral += liquidacion.totalKilos || 0;
                    totalValorGeneral += liquidacion.valorPagar || 0;
                    if (liquidacion.pesas) {
                        totalPesasGeneral += liquidacion.pesas.length;
                    }
                });

                // Crear resumen visual
                const divResumen = crearResumenFinca(
                    resumenPorRecolector,
                    resumenPorFruta,
                    resumenPorMes,
                    totalKilosGeneral,
                    totalValorGeneral,
                    totalPesasGeneral,
                    liquidacionesFiltradas.length
                );

                document.body.appendChild(divResumen);
                await document.fonts.ready;

                // Generar imagen
                const canvas = await html2canvas(divResumen, {
                    scale: 3,
                    useCORS: true,
                    allowTaint: false,
                    backgroundColor: '#ffffff',
                    width: divResumen.offsetWidth,
                    height: divResumen.offsetHeight,
                    logging: false,
                    imageTimeout: 0
                });

                document.body.removeChild(divResumen);

                // Crear archivo
                const blob = await new Promise(resolve => 
                    canvas.toBlob(resolve, "image/png", 1.0)
                );
                
                const nombreArchivo = `liquidaciones_${fincaNombre}_${new Date().toISOString().split('T')[0]}.png`;
                const file = new File([blob], nombreArchivo, { type: "image/png" });

                // Compartir archivo
                const mensaje = `üè† Liquidaciones de ${fincaNombre}\n‚úÖ ${liquidacionesFiltradas.length} recogidas liquidadas\n‚öñÔ∏è ${totalKilosGeneral} kg totales${!isSubusuario ? `\nüíµ ${totalValorGeneral.toLocaleString()} valor total` : ''}`;

                if (navigator.share) {
                    await navigator.share({
                        title: `Liquidaciones de ${fincaNombre}`,
                        text: mensaje,
                        files: [file],
                    });
                } else {
                    // Fallback para navegadores sin Web Share API
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = nombreArchivo;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                console.log('‚úÖ Resumen de finca generado exitosamente');

            } catch (error) {
                console.error('‚ùå Error generando resumen:', error);
                mostrarNotificacion('‚ùå Error al generar resumen: ' + error.message, 'error');
            }
        }

        // Crear resumen visual de la finca
        function crearResumenFinca(resumenRecolector, resumenFruta, resumenMes, totalKilos, totalValor, totalPesas, totalLiquidaciones) {
            const div = document.createElement("div");
            div.style.cssText = `
                width: 900px;
                min-height: 1200px;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                color: #2c3e50;
                font-family: 'Arial', sans-serif;
                padding: 40px;
                margin: 0;
                box-sizing: border-box;
                position: relative;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            `;

            const fechaActual = new Date().toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            div.innerHTML = `
                <div style="text-align: center; margin-bottom: 40px;">
                    <h1 style="margin: 0; font-size: 36px; font-weight: bold; color: #34495e;">
                        üè† LIQUIDACIONES DE FINCA
                    </h1>
                    <h2 style="margin: 10px 0; font-size: 28px; color: #667eea;">${fincaNombre}</h2>
                    <p style="margin: 5px 0; font-size: 18px; color: #7f8c8d;">Propietario: ${fincaPropietario}</p>
                    <div style="width: 80px; height: 4px; background: linear-gradient(to right, #3498db, #2ecc71); margin: 20px auto; border-radius: 2px;"></div>
                    <p style="margin: 10px 0; font-size: 16px; color: #7f8c8d;">Generado el ${fechaActual}</p>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 25px; border-radius: 20px; margin-bottom: 30px; backdrop-filter: blur(10px);">
                    <h2 style="margin: 0 0 20px 0; text-align: center; font-size: 24px; color: #2c3e50;">üéØ TOTALES DE LA FINCA</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: #2c3e50; margin-bottom: 5px;">${totalLiquidaciones}</div>
                            <div style="font-size: 14px; color: #2c3e50; opacity: 0.8;">Recogidas Liquidadas</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: #2c3e50; margin-bottom: 5px;">${totalKilos}</div>
                            <div style="font-size: 14px; color: #2c3e50; opacity: 0.8;">Kilos Totales</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: #2c3e50; margin-bottom: 5px;">${totalPesas}</div>
                            <div style="font-size: 14px; color: #2c3e50; opacity: 0.8;">Pesas Totales</div>
                        </div>
                        ${!isSubusuario ? `
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: #2c3e50; margin-bottom: 5px;">${totalValor.toLocaleString()}</div>
                            <div style="font-size: 14px; color: #2c3e50; opacity: 0.8;">Valor Total</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 25px; border-radius: 20px; margin-bottom: 30px; backdrop-filter: blur(10px);">
                    <h2 style="margin: 0 0 20px 0; text-align: center; font-size: 20px; color: #2c3e50;">üë§ RESUMEN POR RECOLECTOR</h2>
                    <div style="display: grid; gap: 12px;">
                        ${Object.entries(resumenRecolector).slice(0, 10).map(([recolector, datos]) => `
                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; display: grid; grid-template-columns: 2fr 1fr 1fr ${!isSubusuario ? '1fr' : ''}; gap: 15px; align-items: center;">
                                <div style="font-weight: bold; color: #2c3e50;">${recolector}</div>
                                <div style="text-align: center; font-weight: bold;">${datos.cantidad} recogidas</div>
                                <div style="text-align: center; font-weight: bold;">${datos.kilos} kg</div>
                                ${!isSubusuario ? `<div style="text-align: center; font-weight: bold;">${datos.valor.toLocaleString()}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 25px; border-radius: 20px; margin-bottom: 30px; backdrop-filter: blur(10px);">
                    <h2 style="margin: 0 0 20px 0; text-align: center; font-size: 20px; color: #2c3e50;">üçì RESUMEN POR FRUTA</h2>
                    <div style="display: grid; gap: 12px;">
                        ${Object.entries(resumenFruta).map(([fruta, datos]) => `
                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; display: grid; grid-template-columns: 2fr 1fr 1fr ${!isSubusuario ? '1fr' : ''}; gap: 15px; align-items: center;">
                                <div style="font-weight: bold; color: #2c3e50;">${fruta}</div>
                                <div style="text-align: center; font-weight: bold;">${datos.cantidad} recogidas</div>
                                <div style="text-align: center; font-weight: bold;">${datos.kilos} kg</div>
                                ${!isSubusuario ? `<div style="text-align: center; font-weight: bold;">${datos.valor.toLocaleString()}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 25px; border-radius: 20px; margin-bottom: 30px; backdrop-filter: blur(10px);">
                    <h2 style="margin: 0 0 20px 0; text-align: center; font-size: 20px; color: #2c3e50;">üìÖ RESUMEN POR MES</h2>
                    <div style="display: grid; gap: 12px;">
                        ${Object.entries(resumenMes).map(([mes, datos]) => `
                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; display: grid; grid-template-columns: 1fr 1fr 1fr ${!isSubusuario ? '1fr' : ''}; gap: 15px; align-items: center;">
                                <div style="font-weight: bold; color: #2c3e50; text-align: center;">${mes}</div>
                                <div style="text-align: center; font-weight: bold;">${datos.cantidad} recogidas</div>
                                <div style="text-align: center; font-weight: bold;">${datos.kilos} kg</div>
                                ${!isSubusuario ? `<div style="text-align: center; font-weight: bold;">${datos.valor.toLocaleString()}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="position: absolute; bottom: 20px; right: 40px; font-size: 12px; color: #95a5a6;">
                    Generado: ${new Date().toLocaleString('es-ES')}
                </div>
            `;

            return div;
        }

        // Volver atr√°s
        function volverAtras() {
            window.history.back();
        }

        // Agregar estilos de animaci√≥n
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>