<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Subusuario</title>
  <link rel="stylesheet" href="style.css">
  <script src="jc-loader.js"></script>
  <script src="blockCheck.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .card-glass {
      background: var(--glass-bg, rgba(255, 255, 255, 0.1));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .finca-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .finca-title {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary-color, #00d4ff);
      margin-bottom: 5px;
    }

    .propietario {
      opacity: 0.8;
      font-size: 0.95em;
    }

    .finca-meta {
      opacity: 0.6;
      font-size: 0.8em;
      margin-top: 5px;
    }

    .recogida-info {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }

    .info-label {
      font-weight: bold;
      opacity: 0.8;
    }

    .info-value {
      color: var(--primary-color, #00d4ff);
      font-weight: bold;
    }

    .sin-recogidas {
      text-align: center;
      opacity: 0.6;
      font-style: italic;
      padding: 20px;
    }

    .botones-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .botones-container button {
      flex: 1;
      min-width: 120px;
      padding: 8px 12px;
      font-size: 0.85em;
    }

    .loading-info {
      opacity: 0.6;
      text-align: center;
      padding: 10px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="saludo">Bienvenido <span id="usuarioInfo"></span></h1>

    <input type="text" id="buscarFinca" placeholder="Buscar finca o propietario...">

    <div id="listaFincas"></div>
  </div>

  <div id="modalFinca" class="modal hidden">
    <div class="modal-content">
      <h3>Agregar Finca</h3>
      <input type="text" id="nombreFinca" placeholder="Nombre de la finca">
      <input type="text" id="propietarioFinca" placeholder="Nombre del propietario">
      <button id="guardarFinca">Guardar</button>
    </div>
  </div>

<script type="module">
  import { apiFetch } from "./api.js";

  // Par√°metros de URL
  const params = new URLSearchParams(window.location.search);
  const usuario = params.get("usuario");
  const adminAlias = params.get("admin");

  // Session user alias
  const sessionData = JSON.parse(sessionStorage.getItem('userData') || '{}');
  const currentUserAlias = sessionData.alias || '';

  document.getElementById("usuarioInfo").textContent = currentUserAlias;

  // Ocultar elementos si es subusuario (manteniendo tu l√≥gica)
  if (usuario && usuario !== "null" && usuario !== "undefined" && usuario !== null && usuario !== undefined) {
    if (sessionData.tipo === 2) {
      const btnAgregarFinca = document.getElementById("btnAgregarFinca");
      const adminInfo = document.getElementById("adminInfo");
      if (btnAgregarFinca) btnAgregarFinca.style.display = "none";
      if (adminInfo) adminInfo.style.display = "none";
    }
  }

  const lista = document.getElementById("listaFincas");
  const buscarInput = document.getElementById("buscarFinca");

  // IndexedDB manager (import din√°mico)
  let idbManager = null;

  // Helpers defensivos para trabajar con el m√≥dulo de IndexedDB aunque sus nombres var√≠en
  const putFincasBulk = async (fincas) => {
    if (!idbManager) return;
    if (typeof idbManager.putFincas === 'function') return idbManager.putFincas(fincas);
    if (typeof idbManager.putMany === 'function') return idbManager.putMany('fincas', fincas);
    if (typeof idbManager.put === 'function') {
      for (const f of fincas) await idbManager.put('fincas', f);
    }
  };

  const getAllFincasLocal = async () => {
    if (!idbManager) return [];
    if (typeof idbManager.getAllFincas === 'function') return idbManager.getAllFincas();
    if (typeof idbManager.getAll === 'function') return idbManager.getAll('fincas');
    console.warn('getAllFincas no disponible en indexeddb-manager');
    return [];
  };

  // Mostrar fincas (igual que tu funci√≥n original)
  async function mostrarFincas(fincas) {
    lista.innerHTML = "";
    if (!fincas || fincas.length === 0) {
      lista.innerHTML = `
        <div class="card-glass">
          <p style="text-align: center; opacity: 0.7;">
            üìã No hay fincas registradas para el administrador: <strong>${adminAlias}</strong><br>
            <small>Las fincas aparecer√°n aqu√≠ cuando se creen con este adminAlias.</small>
          </p>
        </div>
      `;
    } else {
      for (const finca of fincas) {
        const div = document.createElement("div");
        div.className = "card-glass";

        div.innerHTML = `
          <div class="finca-header">
            <div class="finca-title">${finca.nombre}</div>
            <div class="propietario">Propietario: ${finca.propietario}</div>
          </div>

          <div class="botones-container">
            <button onclick="location.href='recogida.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üìä Recogida</button>
          </div>
        `;

        lista.prepend(div);
      }
    }
  }

  // B√∫squeda
  function buscarFinca() {
    const query = buscarInput.value.toLowerCase();
    const fincas = document.querySelectorAll('.card-glass');

    fincas.forEach(finca => {
      const fincaNombre = finca.querySelector('.finca-title').textContent.toLowerCase();
      const propietario = finca.querySelector('.propietario').textContent.toLowerCase();

      if (fincaNombre.includes(query) || propietario.includes(query)) {
        finca.style.display = 'block';
      } else {
        finca.style.display = 'none';
      }
    });
  }
  buscarInput.addEventListener('input', buscarFinca);

  // Cargar fincas: intenta servidor -> guarda en IDB; si falla o est√° offline, carga desde IDB
  async function cargarFincas() {
    try {
      if (!adminAlias) {
        console.error("‚ùå No hay adminAlias definido");
        lista.innerHTML = "<p>‚ùå Error: No se puede cargar fincas sin adminAlias</p>";
        return;
      }

      // Si estamos online, preferimos traer del servidor y guardar en IndexedDB
      if (navigator.onLine) {
        try {
          console.log('üåê Online: obteniendo fincas del servidor...');
          const response = await fetch(`https://jc-frutas.onrender.com/fincas/por-admin/${adminAlias}`);
          if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
          const fincasAdmin = await response.json();

          // Guardar en IndexedDB (para uso offline posterior)
          try {
            if (idbManager) {
              await putFincasBulk(fincasAdmin);
              console.log('‚úÖ Fincas guardadas en IndexedDB');
            } else {
              console.log('IndexedDB manager no disponible: no se guardar√°n localmente');
            }
          } catch (e) {
            console.warn('‚ö†Ô∏è Error guardando en IndexedDB:', e);
          }

          await mostrarFincas(fincasAdmin);
          return;
        } catch (err) {
          console.warn('‚ùó No se pudo cargar desde servidor (se intentar√° la cach√©):', err);
          // caer√° al bloque de cache abajo
        }
      }

      // Offline o fallo al pedir al servidor -> cargar desde IndexedDB
      console.log('üì¥ Cargando fincas desde IndexedDB (offline fallback)...');
      const cached = await getAllFincasLocal();
      const filtradas = (cached || []).filter(f => {
        // filtrar por adminAlias (seg√∫n c√≥mo guardes adminAlias en el objeto)
        if (!f) return false;
        return (f.adminAlias && String(f.adminAlias) === String(adminAlias)) ||
               (f.admin && String(f.admin) === String(adminAlias)) ||
               (f.usuario && String(f.usuario) === String(adminAlias));
      });

      if (filtradas.length > 0) {
        console.log(`üì¶ Cargadas ${filtradas.length} fincas desde IndexedDB`);
        await mostrarFincas(filtradas);
      } else {
        console.warn('No hay fincas en IndexedDB para este adminAlias');
        lista.innerHTML = `
          <div class="card-glass">
            <p style="text-align:center; opacity:0.7;">
              üìã No hay datos offline para el administrador <strong>${adminAlias}</strong>.
              <br><small>Con√©ctate a Internet para descargar las fincas.</small>
            </p>
          </div>
        `;
      }
    } catch (err) {
      console.error('‚ùå Error general al cargar fincas:', err);
      lista.innerHTML = `<p>‚ùå Error al cargar fincas: ${err.message}</p>`;
    }
  }

  // Inicializar: importar IndexedDB manager (si existe) y cargar fincas
  async function inicializarApp() {
    console.log("üöÄ Inicializando dashboard subusuario...");

    if (!usuario) {
      alert("‚ùå Error: Falta el par√°metro 'usuario' en la URL");
      return;
    }

    if (!adminAlias) {
      alert("‚ùå Error: Falta el par√°metro 'admin' en la URL");
      return;
    }

    // Intentar cargar el manager de IndexedDB (no rompe si no existe)
    try {
      idbManager = await import('./indexeddb-manager.js');
      console.log('üîÅ indexeddb-manager cargado:', idbManager);
    } catch (e) {
      console.warn('‚ö†Ô∏è No se pudo cargar indexeddb-manager.js ‚Äî la app seguir√° funcionando online:', e);
      idbManager = null;
    }

    // Cargar las fincas (prefiere servidor si hay Internet, si no usa cach√©)
    await cargarFincas();
  }

  // Reintentar al volver online
  window.addEventListener('online', () => {
    console.log('üîî Volviste online: actualizando fincas desde servidor...');
    cargarFincas();
  });

  // Ejecutar
  inicializarApp();
</script>
</body>
</html>
