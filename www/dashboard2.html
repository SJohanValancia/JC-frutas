<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Subusuario</title>
  <link rel="stylesheet" href="style.css">
  <script src="jc-loader.js"></script>
  <script src="blockCheck.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .card-glass {
      background: var(--glass-bg, rgba(255, 255, 255, 0.1));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .finca-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .finca-title {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary-color, #00d4ff);
      margin-bottom: 5px;
    }

    .propietario {
      opacity: 0.8;
      font-size: 0.95em;
    }

    .finca-meta {
      opacity: 0.6;
      font-size: 0.8em;
      margin-top: 5px;
    }

    .recogida-info {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }

    .info-label {
      font-weight: bold;
      opacity: 0.8;
    }

    .info-value {
      color: var(--primary-color, #00d4ff);
      font-weight: bold;
    }

    .sin-recogidas {
      text-align: center;
      opacity: 0.6;
      font-style: italic;
      padding: 20px;
    }

    .botones-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .botones-container button {
      flex: 1;
      min-width: 120px;
      padding: 8px 12px;
      font-size: 0.85em;
    }

    .loading-info {
      opacity: 0.6;
      text-align: center;
      padding: 10px;
      font-style: italic;
    }


      .btn-sync:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }
  .btn-sync:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
/* Dark mode support */
@media (prefers-color-scheme: dark) {
  .scroll-button {
    background: linear-gradient(135deg, #2E7D32, #1B5E20);
    box-shadow: 0 8px 25px rgba(46, 125, 50, 0.3);
  }
  
  .scroll-button:hover {
    box-shadow: 0 12px 35px rgba(46, 125, 50, 0.5);
  }
}


/* Bot√≥n flotante para cambiar tema */
.theme-toggle {
  position: fixed;
  top: 15px;
  right: 15px;
  width: 50px;
  height: 50px;
  border: none;
  border-radius: 50%;
  background: linear-gradient(135deg, #ffd700, #ff8c00);
  color: #333;
  font-size: 1.4em;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
  z-index: 99999;
}

.theme-toggle:hover {
  transform: scale(1.1) rotate(10deg);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

body.light-mode {
  background: #f5f5f5;
  color: #222;
}

body.light-mode .card-glass {
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(0,0,0,0.1);
}

body.light-mode .info-value {
  color: #0077cc;
}


  </style>
</head>
<body>

  <!-- Bot√≥n de cambio de tema -->
<button id="themeToggle" class="theme-toggle" title="Cambiar tema">
  üåô
</button>

  <div class="container">

    <div id="syncContainer" style="display: none; text-align: center; margin: 15px 0;">
  <button id="btnSincronizarDatos" class="btn-sync" style="
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 12px 25px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  ">
    üîÑ Sincronizar Datos
  </button>
  <p style="margin-top: 8px; font-size: 0.9em; opacity: 0.8;">
    üì± Actualiza frutas y precios para uso offline
  </p>
</div>


    <h1 id="saludo">Bienvenido <span id="usuarioInfo"></span></h1>

    <input type="text" id="buscarFinca" placeholder="Buscar finca o propietario...">

    <div id="listaFincas"></div>
  </div>

  <div id="modalFinca" class="modal hidden">
    <div class="modal-content">
      <h3>Agregar Finca</h3>
      <input type="text" id="nombreFinca" placeholder="Nombre de la finca">
      <input type="text" id="propietarioFinca" placeholder="Nombre del propietario">
      <button id="guardarFinca">Guardar</button>
    </div>
  </div>

<script type="module">
  import { apiFetch } from "./api.js";
  import './dbb.js'; // ‚úÖ Cargar IDB_HELPER antes de usarlo

  console.log("üîç IDB_HELPER disponible:", window.IDB_HELPER);

  // Par√°metros de URL
  const params = new URLSearchParams(window.location.search);
  const usuario = params.get("usuario");
  const adminAlias = params.get("admin");

  // Session user alias
  const sessionData = JSON.parse(sessionStorage.getItem('userData') || '{}');
  const currentUserAlias = sessionData.alias || '';

  document.getElementById("usuarioInfo").textContent = currentUserAlias;

  // Ocultar elementos si es subusuario (manteniendo tu l√≥gica)
  if (usuario && usuario !== "null" && usuario !== "undefined" && usuario !== null && usuario !== undefined) {
    if (sessionData.tipo === 2) {
      const btnAgregarFinca = document.getElementById("btnAgregarFinca");
      const adminInfo = document.getElementById("adminInfo");
      if (btnAgregarFinca) btnAgregarFinca.style.display = "none";
      if (adminInfo) adminInfo.style.display = "none";
    }
  }

  const lista = document.getElementById("listaFincas");
  const buscarInput = document.getElementById("buscarFinca");

  // IndexedDB manager (import din√°mico)
  let idbManager = null;



  // üî• FUNCI√ìN PARA VERIFICAR CONEXI√ìN Y MOSTRAR/OCULTAR BOT√ìN
function verificarConexionYMostrarBoton() {
  const syncContainer = document.getElementById('syncContainer');
  const btnSincronizar = document.getElementById('btnSincronizarDatos');

  if (navigator.onLine) {
    console.log("üåê Con conexi√≥n - mostrando bot√≥n de sincronizaci√≥n");
    syncContainer.style.display = 'block';

    // Verificar si ya hay datos sincronizados
    const hayDatosOffline = localStorage.getItem('frutasSincronizadas_v1');
    if (!hayDatosOffline) {
      btnSincronizar.innerHTML = 'üîÑ Sincronizar Datos (Recomendado)';
      btnSincronizar.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%)';
    } else {
      btnSincronizar.innerHTML = 'üîÑ Sincronizar Datos';
      btnSincronizar.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
    }
  } else {
    console.log("üì¥ Sin conexi√≥n - ocultando bot√≥n de sincronizaci√≥n");
    syncContainer.style.display = 'none';
  }
}
// üî• FUNCI√ìN PARA SINCRONIZAR DATOS COMPLETOS (FINCAS + FRUTAS + PRECIOS)
async function sincronizarDatosCompletos() {
  const btnSincronizar = document.getElementById('btnSincronizarDatos');
  

  
  console.log("üîÑ Iniciando sincronizaci√≥n manual completa...");
  
  // Deshabilitar bot√≥n mientras sincroniza
  btnSincronizar.disabled = true;
  btnSincronizar.innerHTML = '‚è≥ Sincronizando...';
  
  try {
    let totalFincas = 0;
    let totalFrutas = 0;
    
    // 1. Obtener fincas del administrador
    console.log("üìã Obteniendo fincas del administrador...");
    const fincasResponse = await fetch(`https://jc-frutas.onrender.com/fincas/por-admin/${adminAlias}`);
    
    if (!fincasResponse.ok) throw new Error('No se pudieron obtener las fincas');
    
    const fincas = await fincasResponse.json();
    totalFincas = fincas.length;
    console.log(`‚úÖ Obtenidas ${totalFincas} fincas`);
    
    // Guardar fincas en IndexedDB
    if (idbManager && fincas.length > 0) {
      await putFincasBulk(fincas);
      console.log('‚úÖ Fincas guardadas en IndexedDB');
    }
    
    // 2. Obtener frutas y precios para cada finca
    console.log("üçé Obteniendo frutas y precios para cada finca...");
    
    for (const finca of fincas) {
      try {
        const preciosResponse = await fetch(`https://jc-frutas.onrender.com/precios/por-finca/${finca._id}`);
        
        if (!preciosResponse.ok) {
          console.warn(`‚ö†Ô∏è No se pudieron obtener precios para finca ${finca.nombre}`);
          continue;
        }
        
        const preciosData = await preciosResponse.json();
        let frutasFinales = [];
        
        // Buscar el documento con m√°s frutas
        for (const doc of preciosData) {
          if (doc.frutas?.length > frutasFinales.length) {
            frutasFinales = doc.frutas;
          }
        }
        
if (frutasFinales.length > 0) {
  if (window.IDB_HELPER && window.IDB_HELPER.saveFruits) {
    await window.IDB_HELPER.saveFruits(finca._id, frutasFinales);
    totalFrutas += frutasFinales.length;
    console.log(`‚úÖ ${frutasFinales.length} frutas sincronizadas para ${finca.nombre}`);
  } else {
    console.warn("‚ö†Ô∏è IDB_HELPER no est√° disponible. Verifica que dbb.js se haya cargado.");
  }
}
        
      } catch (error) {
        console.warn(`‚ö†Ô∏è Error al sincronizar frutas de ${finca.nombre}:`, error);
      }
    }
    
    // 3. Marcar que la sincronizaci√≥n fue exitosa
    localStorage.setItem('frutasSincronizadas_v1', 'true');
    localStorage.setItem('ultimaSincronizacion', new Date().toISOString());
    
    // 4. Actualizar la interfaz
    await cargarFincas();
    
    // 5. Mostrar notificaci√≥n de √©xito
    mostrarNotificacionElegante(
      `‚úÖ Sincronizaci√≥n completada!\n\n${totalFincas} fincas\n${totalFrutas} frutas actualizadas`, 
      "success"
    );
    
    console.log(`üéâ Sincronizaci√≥n completa: ${totalFincas} fincas, ${totalFrutas} frutas`);
    
  } catch (error) {
    console.error("‚ùå Error durante la sincronizaci√≥n:", error);
    mostrarNotificacionElegante("‚ùå Error al sincronizar: " + error.message, "error");
  } finally {
    // Rehabilitar bot√≥n
    btnSincronizar.disabled = false;
    btnSincronizar.innerHTML = 'üîÑ Sincronizar Datos';
    verificarConexionYMostrarBoton(); // Revisar si a√∫n sin conexi√≥n
  }
}

// üî• FUNCI√ìN PARA MOSTRAR NOTIFICACIONES ELEGANTES
function mostrarNotificacionElegante(mensaje, tipo = "success") {
  const colores = {
    success: "linear-gradient(135deg, #11998e 0%, #38ef7d 100%)",
    error: "linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)",
    warning: "linear-gradient(135deg, #f2994a 0%, #f2c94c 100%)",
    info: "linear-gradient(135deg, #56ccf2 0%, #2f80ed 100%)"
  };

  const notificacion = document.createElement("div");
  notificacion.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${colores[tipo] || colores.success};
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: bold;
    z-index: 25000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    transform: translateX(400px);
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    max-width: 350px;
    line-height: 1.4;
  `;

  notificacion.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 20px;">
        ${tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : tipo === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
      </span>
      <div>${mensaje.replace(/\n/g, '<br>')}</div>
    </div>
  `;

  document.body.appendChild(notificacion);

  // Animaci√≥n de entrada
  setTimeout(() => {
    notificacion.style.transform = "translateX(0)";
  }, 100);

  // Animaci√≥n de salida
  setTimeout(() => {
    notificacion.style.transform = "translateX(400px)";
    setTimeout(() => {
      if (notificacion.parentNode) {
        notificacion.parentNode.removeChild(notificacion);
      }
    }, 300);
  }, 3000);
}

  // Agrega esta funci√≥n antes de la funci√≥n sincronizarPreciosEnSegundoPlano
async function obtenerFincasDelAdmin() {
  try {
    if (!adminAlias) {
      console.warn("‚ö†Ô∏è No hay adminAlias para obtener fincas");
      return [];
    }
    
    const response = await fetch(`https://jc-frutas.onrender.com/fincas/por-admin/${adminAlias}`);
    if (!response.ok) throw new Error(`Error ${response.status}`);
    
    const fincas = await response.json();
    console.log(`‚úÖ Obtenidas ${fincas.length} fincas del admin`);
    return fincas;
    
  } catch (error) {
    console.error("‚ùå Error al obtener fincas del admin:", error);
    return [];
  }
}


// üîÅ SINCRONIZAR PRECIOS EN SEGUNDO PLANO AL INICIAR SESI√ìN
async function sincronizarPreciosEnSegundoPlano() {
  console.log("üîÑ Iniciando sincronizaci√≥n de precios en segundo plano...");

  if (!navigator.onLine) {
    console.log("üì° Sin conexi√≥n. Usando precios locales.");
    return;
  }

  try {
    // Verificar que adminAlias existe
    if (!adminAlias) {
      console.warn("‚ö†Ô∏è No hay adminAlias definido, no se pueden sincronizar precios");
      return;
    }

    const fincas = await obtenerFincasDelAdmin();
    if (!fincas || fincas.length === 0) {
      console.warn("‚ö†Ô∏è No hay fincas para sincronizar.");
      return;
    }

    let totalFrutas = 0;
    
    for (const finca of fincas) {
      try {
        const res = await fetch(`https://jc-frutas.onrender.com/precios/por-finca/${finca._id}`);
        if (!res.ok) {
          console.warn(`‚ö†Ô∏è No se pudieron obtener precios para finca ${finca._id}: ${res.status}`);
          continue;
        }

        const data = await res.json();
        let frutasFinales = [];

        for (const doc of data) {
          if (doc.frutas?.length > frutasFinales.length) {
            frutasFinales = doc.frutas;
          }
        }

        if (window.IDB_HELPER && window.IDB_HELPER.saveFruits && frutasFinales.length > 0) {
          await window.IDB_HELPER.saveFruits(finca._id, frutasFinales);
          totalFrutas += frutasFinales.length;
          console.log(`‚úÖ Precios sincronizados para finca: ${finca.nombre} (${frutasFinales.length} frutas)`);
        }

      } catch (err) {
        console.warn(`‚ö†Ô∏è Error al sincronizar precios de finca ${finca._id}:`, err);
      }
    }

    // Marcar sincronizaci√≥n exitosa
    localStorage.setItem('frutasSincronizadas_v1', 'true');
    localStorage.setItem('ultimaSincronizacion', new Date().toISOString());
    
    console.log(`‚úÖ Sincronizaci√≥n de precios en segundo plano completada. Total: ${totalFrutas} frutas`);

  } catch (error) {
    console.error("‚ùå Error general al sincronizar precios:", error);
  }
}
// Agrega este event listener adicional
window.addEventListener('online', async () => {
  console.log('üîî Volviste online: sincronizando precios...');
  await sincronizarPreciosEnSegundoPlano();
});
// üîÅ Ejecutar al cargar el dashboard
document.addEventListener('DOMContentLoaded', async () => {
  await sincronizarPreciosEnSegundoPlano();
});

  // Helpers defensivos para trabajar con el m√≥dulo de IndexedDB aunque sus nombres var√≠en
  const putFincasBulk = async (fincas) => {
    if (!idbManager) return;
    if (typeof idbManager.putFincas === 'function') return idbManager.putFincas(fincas);
    if (typeof idbManager.putMany === 'function') return idbManager.putMany('fincas', fincas);
    if (typeof idbManager.put === 'function') {
      for (const f of fincas) await idbManager.put('fincas', f);
    }
  };

  const getAllFincasLocal = async () => {
    if (!idbManager) return [];
    if (typeof idbManager.getAllFincas === 'function') return idbManager.getAllFincas();
    if (typeof idbManager.getAll === 'function') return idbManager.getAll('fincas');
    console.warn('getAllFincas no disponible en indexeddb-manager');
    return [];
  };

  // Mostrar fincas (igual que tu funci√≥n original)
  async function mostrarFincas(fincas) {
    lista.innerHTML = "";
    if (!fincas || fincas.length === 0) {
      lista.innerHTML = `
        <div class="card-glass">
          <p style="text-align: center; opacity: 0.7;">
            üìã No hay fincas registradas para el administrador: <strong>${adminAlias}</strong><br>
            <small>Las fincas aparecer√°n aqu√≠ cuando se creen con este adminAlias.</small>
          </p>
        </div>
      `;
    } else {
      for (const finca of fincas) {
        const div = document.createElement("div");
        div.className = "card-glass";

        div.innerHTML = `
          <div class="finca-header">
            <div class="finca-title">${finca.nombre}</div>
            <div class="propietario">Propietario: ${finca.propietario}</div>
          </div>

          <div class="botones-container">
            <button onclick="location.href='recogida.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üìä Recogida</button>
          </div>
        `;

        lista.prepend(div);
      }
    }
  }

  // B√∫squeda
  function buscarFinca() {
    const query = buscarInput.value.toLowerCase();
    const fincas = document.querySelectorAll('.card-glass');

    fincas.forEach(finca => {
      const fincaNombre = finca.querySelector('.finca-title').textContent.toLowerCase();
      const propietario = finca.querySelector('.propietario').textContent.toLowerCase();

      if (fincaNombre.includes(query) || propietario.includes(query)) {
        finca.style.display = 'block';
      } else {
        finca.style.display = 'none';
      }
    });
  }
  buscarInput.addEventListener('input', buscarFinca);

  // Cargar fincas: intenta servidor -> guarda en IDB; si falla o est√° offline, carga desde IDB
  async function cargarFincas() {
    try {
      if (!adminAlias) {
        console.error("‚ùå No hay adminAlias definido");
        lista.innerHTML = "<p>‚ùå Error: No se puede cargar fincas sin adminAlias</p>";
        return;
      }

      // Si estamos online, preferimos traer del servidor y guardar en IndexedDB
      if (navigator.onLine) {
        try {
          console.log('üåê Online: obteniendo fincas del servidor...');
          const response = await fetch(`https://jc-frutas.onrender.com/fincas/por-admin/${adminAlias}`);
          if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
          const fincasAdmin = await response.json();

          // Guardar en IndexedDB (para uso offline posterior)
          try {
            if (idbManager) {
              await putFincasBulk(fincasAdmin);
              console.log('‚úÖ Fincas guardadas en IndexedDB');
            } else {
              console.log('IndexedDB manager no disponible: no se guardar√°n localmente');
            }
          } catch (e) {
            console.warn('‚ö†Ô∏è Error guardando en IndexedDB:', e);
          }

          await mostrarFincas(fincasAdmin);
          return;
        } catch (err) {
          console.warn('‚ùó No se pudo cargar desde servidor (se intentar√° la cach√©):', err);
          // caer√° al bloque de cache abajo
        }
      }

      // Offline o fallo al pedir al servidor -> cargar desde IndexedDB
      console.log('üì¥ Cargando fincas desde IndexedDB (offline fallback)...');
      const cached = await getAllFincasLocal();
      const filtradas = (cached || []).filter(f => {
        // filtrar por adminAlias (seg√∫n c√≥mo guardes adminAlias en el objeto)
        if (!f) return false;
        return (f.adminAlias && String(f.adminAlias) === String(adminAlias)) ||
               (f.admin && String(f.admin) === String(adminAlias)) ||
               (f.usuario && String(f.usuario) === String(adminAlias));
      });

      if (filtradas.length > 0) {
        console.log(`üì¶ Cargadas ${filtradas.length} fincas desde IndexedDB`);
        await mostrarFincas(filtradas);
      } else {
        console.warn('No hay fincas en IndexedDB para este adminAlias');
        lista.innerHTML = `
          <div class="card-glass">
            <p style="text-align:center; opacity:0.7;">
              üìã No hay datos offline para el administrador <strong>${adminAlias}</strong>.
              <br><small>Con√©ctate a Internet para descargar las fincas.</small>
            </p>
          </div>
        `;
      }
    } catch (err) {
      console.error('‚ùå Error general al cargar fincas:', err);
      lista.innerHTML = `<p>‚ùå Error al cargar fincas: ${err.message}</p>`;
    }
  }

  // Inicializar: importar IndexedDB manager (si existe) y cargar fincas
  async function inicializarApp() {
    console.log("üöÄ Inicializando dashboard subusuario...");

    if (!usuario) {
      alert("‚ùå Error: Falta el par√°metro 'usuario' en la URL");
      return;
    }

    if (!adminAlias) {
      alert("‚ùå Error: Falta el par√°metro 'admin' en la URL");
      return;
    }

    // Intentar cargar el manager de IndexedDB (no rompe si no existe)
    try {
      idbManager = await import('./indexeddb-manager.js');
      console.log('üîÅ indexeddb-manager cargado:', idbManager);
    } catch (e) {
      console.warn('‚ö†Ô∏è No se pudo cargar indexeddb-manager.js ‚Äî la app seguir√° funcionando online:', e);
      idbManager = null;
    }

    // Cargar las fincas (prefiere servidor si hay Internet, si no usa cach√©)
    await cargarFincas();

    // üî• CONFIGURAR BOT√ìN DE SINCRONIZACI√ìN Y VERIFICAR CONEXI√ìN
verificarConexionYMostrarBoton();
document.getElementById('btnSincronizarDatos').addEventListener('click', sincronizarDatosCompletos);

// Escuchar cambios de conexi√≥n
window.addEventListener('online', () => {
  console.log('üîî Conexi√≥n restablecida');
  verificarConexionYMostrarBoton();
  mostrarNotificacionElegante("‚úÖ Conexi√≥n restablecida", "success");
});

window.addEventListener('offline', () => {
  console.log('‚ùå Conexi√≥n perdida');
  verificarConexionYMostrarBoton();
  mostrarNotificacionElegante("üì¥ Sin conexi√≥n - Bot√≥n de sincronizaci√≥n activado", "warning");
});

  }

  // Reintentar al volver online
  window.addEventListener('online', () => {
    console.log('üîî Volviste online: actualizando fincas desde servidor...');
    cargarFincas();
  });

  // Ejecutar
  inicializarApp();
</script>

<script>
  const themeToggle = document.getElementById("themeToggle");
  const body = document.body;

  // Mantener preferencia guardada
  if (localStorage.getItem("theme") === "light") {
    body.classList.add("light-mode");
    themeToggle.textContent = "‚òÄÔ∏è";
  }

  themeToggle.addEventListener("click", () => {
    body.classList.toggle("light-mode");
    if (body.classList.contains("light-mode")) {
      themeToggle.textContent = "‚òÄÔ∏è";
      localStorage.setItem("theme", "light");
    } else {
      themeToggle.textContent = "üåô";
      localStorage.setItem("theme", "dark");
    }
  });
</script>

</body>
</html>
