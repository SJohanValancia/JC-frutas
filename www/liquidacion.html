<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jc-loader.js"></script>
      <script src="blockCheck.js"></script>

        <title>Liquidación de Finca</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }



        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f0f0f0;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .finca-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filtros {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filtros label {
            font-weight: bold;
            color: #2c3e50;
        }

        .filtros input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .resumen-totales {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .total-item h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .total-item p {
            opacity: 0.9;
            font-size: 14px;
        }

        .recogidas-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }

        .recogida-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .recogida-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .recogida-card.liquidada {
            background: #f8f9fa;
            border-color: #28a745;
            opacity: 0.7;
        }

        .recogida-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .recogida-fecha {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .recogida-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item strong {
            display: block;
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .info-item span {
            color: #6c757d;
            font-size: 12px;
        }

        .pesas-detalle {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .pesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .pesa-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #6c757d;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .floating-recibo {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .btn-recibo {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }

        .btn-recibo:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.6);
        }

        /* 🔥 NUEVOS ESTILOS PARA LIQUIDACIÓN */
        .btn-liquidar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }

        .btn-liquidar:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-liquidar:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .liquidacion-exitosa {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745 !important;
            animation: liquidacionPulse 2s ease-in-out;
        }

        @keyframes liquidacionPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .notificacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .filtros {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filtros > * {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>

            <button class="btn btn-secondary" onclick="volverDashboard()" style="margin-top: 20px;">
            ← Volver 
        </button>

    <div class="container">
        <div class="header">
            <h1>📊 Liquidación de Finca</h1>
            <p>Resumen completo de recogidas por período</p>
        </div>

        <div class="finca-info" id="fincaInfo">
            <div>
                <strong>🏠 Finca:</strong>
                <span id="fincaNombre">Cargando...</span>
            </div>
            <div>
                <strong>👤 Propietario:</strong>
                <span id="propietarioNombre">Cargando...</span>
            </div>
            <div>
                <strong style="display: none;">📍 ID:</strong>
                <span style="display: none;" id="fincaId">-</span>
            </div>
        </div>

        <div class="filtros">
            <label for="fechaInicio">📅 Fecha Inicio:</label>
            <input type="date" id="fechaInicio">
            
            <label for="fechaFin">📅 Fecha Fin:</label>
            <input type="date" id="fechaFin">
            
            <button class="btn btn-primary" onclick="filtrarRecogidas()">
                🔍 Filtrar
            </button>
            
            <button class="btn btn-secondary" onclick="limpiarFiltros()">
                🧹 Limpiar Filtros
            </button>
        </div>

                 <button class="btn-liquidar-intervalo" onclick="liquidarIntervaloFechas()" id="btnLiquidarIntervalo" style="display: none;">
                💰 Liquidar Intervalo
            </button>

        <div class="resumen-totales" id="resumenTotales" style="display: none;">
            <div class="total-item">
                <h3 id="totalRecogidas">0</h3>
                <p>Recogidas Activas</p>
            </div>
            <div class="total-item">
                <h3 style="display: none;" id="totalKilos">0</h3>

            </div>
            <div class="total-item" id="totalValorContainer">
                <h3 id="totalValor">$0</h3>
                <p>Valor Pendiente</p>
            </div>
            <div  class="total-item">
                <h3 style="display: none;" id="totalPesas">0</h3>

            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            🔄 Cargando recogidas...
        </div>

        <div id="noDataMessage" class="no-data" style="display: none;">
            📭 No se encontraron recogidas activas para el período seleccionado
        </div>

        <div class="recogidas-grid" id="recogidasContainer">
        </div>


    </div>

    <div class="floating-recibo">
        <button class="btn-recibo" onclick="generarReciboLiquidacion()" id="btnRecibo" style="display: none;">
            📄 Generar Recibo
        </button>
    </div>

    <!-- Script para html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Variables globales
        let todasLasRecogidas = [];
        let recogidasFiltradas = [];
        let isSubusuario = false;
        let fincaData = {};

        // Obtener parámetros de URL
        const urlParams = new URLSearchParams(window.location.search);
        const fincaId = urlParams.get('fincaId');
        const fincaNombre = urlParams.get('finca');
        const propietario = urlParams.get('propietario');
        const usuario = urlParams.get('usuario');

        function configurarEventosFecha() {
    const fechaInicioInput = document.getElementById('fechaInicio');
    const fechaFinInput = document.getElementById('fechaFin');
    const btnLiquidarIntervalo = document.getElementById('btnLiquidarIntervalo');

    function verificarFechas() {
        if (fechaInicioInput.value && fechaFinInput.value) {
            btnLiquidarIntervalo.style.display = 'block';
        } else {
            btnLiquidarIntervalo.style.display = 'none';
        }
    }

    fechaInicioInput.addEventListener('change', verificarFechas);
    fechaFinInput.addEventListener('change', verificarFechas);
}

function extraerFechaSimple(fechaString) {
    if (!fechaString || fechaString === 'Sin fecha') {
        console.log('⚠️ Fecha vacía o sin fecha');
        return null;
    }
    
    try {
        // Si ya está en formato YYYY-MM-DD
        if (typeof fechaString === 'string' && fechaString.match(/^\d{4}-\d{2}-\d{2}$/)) {
            console.log(`✅ Fecha ya en formato correcto: ${fechaString}`);
            return fechaString;
        }
        
        // Si tiene la T (formato ISO como "2025-08-03T00:00:00.000Z")
        if (typeof fechaString === 'string' && fechaString.includes('T') && fechaString.includes('-')) {
            const fechaSolo = fechaString.split('T')[0];
            console.log(`✅ Fecha extraída de ISO: ${fechaString} → ${fechaSolo}`);
            return fechaSolo;
        }
        
        // 🔥 CASO PRINCIPAL: Fechas como "Sun Aug 03 2025 00:00:00 GMT+0000"
        // Crear objeto Date y extraer en UTC para evitar problemas de zona horaria
        const fechaObj = new Date(fechaString);
        if (!isNaN(fechaObj.getTime())) {
            const año = fechaObj.getUTCFullYear();
            const mes = String(fechaObj.getUTCMonth() + 1).padStart(2, '0');
            const dia = String(fechaObj.getUTCDate()).padStart(2, '0');
            const fechaFormateada = `${año}-${mes}-${dia}`;
            console.log(`✅ Fecha convertida de GMT: ${fechaString} → ${fechaFormateada}`);
            return fechaFormateada;
        }
        
        console.error(`❌ No se pudo procesar la fecha: ${fechaString}`);
        return null;
        
    } catch (error) {
        console.error(`❌ Error al procesar fecha "${fechaString}":`, error);
        return null;
    }
}

function fechaAYYYYMMDD(fecha) {
    if (!fecha) return null;
    
    try {
        const d = new Date(fecha);
        if (isNaN(d.getTime())) return null;
        
        // Usar UTC para evitar problemas de zona horaria
        const año = d.getUTCFullYear();
        const mes = String(d.getUTCMonth() + 1).padStart(2, '0');
        const dia = String(d.getUTCDate()).padStart(2, '0');
        
        return `${año}-${mes}-${dia}`;
    } catch (error) {
        console.error('Error procesando fecha:', fecha, error);
        return null;
    }
}

function extraerFechaRobusta(fechaString) {
    if (!fechaString || fechaString === 'Sin fecha') {
        return null;
    }
    
    try {
        // Siempre crear objeto Date y extraer componentes UTC
        const fechaObj = new Date(fechaString);
        
        if (isNaN(fechaObj.getTime())) {
            console.error(`❌ Fecha inválida: ${fechaString}`);
            return null;
        }
        
        const año = fechaObj.getUTCFullYear();
        const mes = String(fechaObj.getUTCMonth() + 1).padStart(2, '0');
        const dia = String(fechaObj.getUTCDate()).padStart(2, '0');
        const fechaFormateada = `${año}-${mes}-${dia}`;
        
        console.log(`🔄 Conversión: "${fechaString}" → "${fechaFormateada}"`);
        return fechaFormateada;
        
    } catch (error) {
        console.error(`❌ Error al procesar fecha "${fechaString}":`, error);
        return null;
    }
}

// Función para liquidar todas las recogidas en el intervalo seleccionado
// Función corregida para liquidar todas las recogidas en el intervalo seleccionado
async function liquidarIntervaloFechas() {
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    
    if (!fechaInicio || !fechaFin) {
        mostrarNotificacion('❌ Por favor selecciona un intervalo de fechas válido', 'error');
        return;
    }

    console.log('🔍 LIQUIDAR INTERVALO - Iniciando filtro');
    console.log(`📅 Fecha inicio: "${fechaInicio}"`);
    console.log(`📅 Fecha fin: "${fechaFin}"`);

    // Filtrar recogidas en el intervalo que no estén liquidadas
    const recogidasParaLiquidar = todasLasRecogidas.filter(recogida => {
        // Excluir ya liquidadas
        if (recogida.estadoLiquidacion === 'liquidada') {
            console.log(`❌ Recogida ${recogida._id} ya liquidada - excluida`);
            return false;
        }
        
        // Verificar fecha usando la misma función que el filtro principal
        const fechaRecogida = fechaAYYYYMMDD(recogida.fecha);
        
        console.log(`📦 Recogida ${recogida._id}:`);
        console.log(`   📅 Original: "${recogida.fecha}"`);
        console.log(`   📅 Convertida: "${fechaRecogida}"`);
        console.log(`   🏷️ Estado: ${recogida.estadoLiquidacion || 'SIN ESTADO (ACTIVA)'}`);
        
        if (!fechaRecogida) {
            console.log(`   ❌ Sin fecha válida - excluida`);
            return false;
        }
        
        // Aplicar filtros de fecha
        const cumple = fechaRecogida >= fechaInicio && fechaRecogida <= fechaFin;
        console.log(`   🔍 En rango ${fechaInicio} - ${fechaFin}? ${cumple}`);
        console.log(`   ${cumple ? '✅ INCLUIDA PARA LIQUIDAR' : '❌ FUERA DEL RANGO'}`);
        
        return cumple;
    });

    console.log(`📊 Resultado filtro: ${recogidasParaLiquidar.length}/${todasLasRecogidas.length} recogidas para liquidar`);

    if (recogidasParaLiquidar.length === 0) {
        mostrarNotificacion('ℹ️ No hay recogidas activas en el intervalo seleccionado para liquidar', 'warning');
        return;
    }

    if (!confirm(`¿Estás seguro que deseas liquidar TODAS las ${recogidasParaLiquidar.length} recogidas activas entre ${fechaInicio} y ${fechaFin}?`)) {
        return;
    }

    try {
        const storedData = sessionStorage.getItem('userData');
        let usuarioActual = usuario;
        let adminAlias = '';

        if (storedData) {
            const sessionData = JSON.parse(storedData);
            usuarioActual = sessionData.username;
            adminAlias = sessionData.adminAlias || sessionData.alias;
        }

        const btnLiquidar = document.getElementById('btnLiquidarIntervalo');
        if (btnLiquidar) {
            btnLiquidar.disabled = true;
            btnLiquidar.innerHTML = '⏳ Liquidando...';
        }

        // Obtener solo los IDs de las recogidas a liquidar
        const recogidaIds = recogidasParaLiquidar.map(r => r._id);

        console.log('🚀 Enviando solicitud de liquidación masiva para:', recogidaIds);

        // Llamar al endpoint para liquidación masiva
        const response = await fetch('https://jc-frutas.onrender.com/recogidas/liquidar-multiples', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                recogidaIds: recogidaIds,
                usuario: usuarioActual,
                adminAlias: adminAlias
            })
        });

        if (!response.ok) {
            throw new Error('Error en la solicitud de liquidación masiva');
        }

        const result = await response.json();

        if (result.success) {
            mostrarNotificacion(`✅ ${result.exitosas || recogidasParaLiquidar.length} recogidas liquidadas exitosamente`, 'success');
            
            // Recargar las recogidas para actualizar la vista
            await cargarRecogidas();
            
            // Restaurar botón
            if (btnLiquidar) {
                btnLiquidar.disabled = false;
                btnLiquidar.innerHTML = '💰 Liquidar Intervalo';
            }
        } else {
            throw new Error(result.message || 'Error al liquidar recogidas');
        }

    } catch (error) {
        console.error('❌ Error al liquidar intervalo:', error);
        mostrarNotificacion(`❌ Error al liquidar intervalo: ${error.message}`, 'error');
        
        const btnLiquidar = document.getElementById('btnLiquidarIntervalo');
        if (btnLiquidar) {
            btnLiquidar.disabled = false;
            btnLiquidar.innerHTML = '💰 Liquidar Intervalo';
        }
    }
}
function formatearFecha(fecha) {
    if (!fecha) return "Sin fecha";
    
    try {
        const d = new Date(fecha);
        if (isNaN(d.getTime())) return "Fecha inválida";
        
        // Usar UTC y formatear como DD/MM/YYYY
        const dia = String(d.getUTCDate()).padStart(2, '0');
        const mes = String(d.getUTCMonth() + 1).padStart(2, '0');
        const año = d.getUTCFullYear();
        
        return `${dia}/${mes}/${año}`;
    } catch (error) {
        console.error("Error formateando fecha:", fecha, error);
        return "Fecha inválida";
    }
}

        // 🔥 FUNCIÓN PARA COMPARAR FECHAS SIN PROBLEMAS DE ZONA HORARIA
        function compararFechas(fechaRecogida, fechaComparacion) {
            if (!fechaRecogida || !fechaComparacion) return true;
            
            const partes1 = fechaRecogida.split('T')[0].split('-');
            const partes2 = fechaComparacion.split('-');
            
            if (partes1.length === 3 && partes2.length === 3) {
                const fecha1 = new Date(parseInt(partes1[0]), parseInt(partes1[1]) - 1, parseInt(partes1[2]));
                const fecha2 = new Date(parseInt(partes2[0]), parseInt(partes2[1]) - 1, parseInt(partes2[2]));
                return fecha1.getTime() === fecha2.getTime() ? 0 : (fecha1 > fecha2 ? 1 : -1);
            }
            
            return 0;
        }

        // Inicializar página
        document.addEventListener('DOMContentLoaded', async () => {
            if (!fincaId) {
                alert('Error: No se especificó la finca');
                volverDashboard();
                return;
            }

            // Mostrar información de la finca
            document.getElementById('fincaNombre').textContent = fincaNombre || 'Sin nombre';
            document.getElementById('propietarioNombre').textContent = propietario || 'Sin propietario';
            document.getElementById('fincaId').textContent = fincaId;

            fincaData = { fincaId, fincaNombre, propietario };

            // Verificar tipo de usuario
            await verificarTipoUsuario();

            // Configurar fechas por defecto (última semana)
            const hoy = new Date();
            const haceUnaSemana = new Date();
            haceUnaSemana.setDate(hoy.getDate() - 7);

            document.getElementById('fechaFin').value = hoy.toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = haceUnaSemana.toISOString().split('T')[0];

            // Cargar recogidas
            await cargarRecogidas();
             configurarEventosFecha();
        });

        // Verificar tipo de usuario
        async function verificarTipoUsuario() {
            try {
                const storedData = sessionStorage.getItem('userData');
                if (storedData) {
                    const sessionData = JSON.parse(storedData);
                    isSubusuario = sessionData.tipo === 2;
                } else if (usuario) {
                    const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
                    if (response.ok) {
                        const userData = await response.json();
                        isSubusuario = userData.tipo === 2;
                    }
                }

                // Ocultar valores monetarios para subusuarios
                if (isSubusuario) {
                    document.getElementById('totalValorContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error verificando tipo de usuario:', error);
            }
        }

        // Cargar todas las recogidas de la finca
function filtrarRecogidas() {
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;

    console.log('🔍 FILTRO INICIADO');
    console.log(`📅 Fecha inicio: "${fechaInicio}"`);
    console.log(`📅 Fecha fin: "${fechaFin}"`);

    recogidasFiltradas = todasLasRecogidas.filter(recogida => {
        // Excluir liquidadas SIEMPRE
        if (recogida.estadoLiquidacion === 'liquidada') {
            return false;
        }
        
        // Si no hay filtros de fecha, incluir todas las activas
        if (!fechaInicio && !fechaFin) {
            return true;
        }
        
        // Convertir fecha de la recogida
        const fechaRecogida = fechaAYYYYMMDD(recogida.fecha);
        
        console.log(`📦 Recogida ${recogida._id}:`);
        console.log(`   📅 Original: "${recogida.fecha}"`);
        console.log(`   📅 Convertida: "${fechaRecogida}"`);
        
        if (!fechaRecogida) {
            console.log(`   ❌ Sin fecha válida - excluida`);
            return false;
        }
        
        // Aplicar filtros
        let cumple = true;
        
        if (fechaInicio) {
            cumple = cumple && (fechaRecogida >= fechaInicio);
            console.log(`   🔍 >= ${fechaInicio}? ${fechaRecogida >= fechaInicio}`);
        }
        
        if (fechaFin) {
            cumple = cumple && (fechaRecogida <= fechaFin);
            console.log(`   🔍 <= ${fechaFin}? ${fechaRecogida <= fechaFin}`);
        }
        
        console.log(`   ${cumple ? '✅ INCLUIDA' : '❌ EXCLUIDA'}`);
        return cumple;
    });

    console.log(`📊 Resultado: ${recogidasFiltradas.length}/${todasLasRecogidas.length} recogidas`);
    mostrarRecogidas();
}


// 🔥 FUNCIÓN ADICIONAL PARA DEBUG: Verificar estado de recogidas
function verificarEstadoRecogidas() {
    console.log('🔍 VERIFICANDO ESTADO DE TODAS LAS RECOGIDAS:');
    
    todasLasRecogidas.forEach((recogida, index) => {
        const estado = recogida.estadoLiquidacion;
        const fecha = recogida.fecha ? recogida.fecha.split('T')[0] : 'Sin fecha';
        const totalKilos = recogida.totalKilos || 0;
        const valor = recogida.valorPagar || 0;
        
        console.log(`📦 Recogida ${index + 1}:`);
        console.log(`   🆔 ID: ${recogida._id}`);
        console.log(`   📅 Fecha: ${fecha}`);
        console.log(`   ⚖️ Kilos: ${totalKilos}`);
        console.log(`   💰 Valor: ${valor}`);
        console.log(`   🏷️ Estado: ${estado || 'SIN ESTADO (ACTIVA)'}`);
        console.log(`   ✅ ¿Es activa?: ${!estado || estado !== 'liquidada' ? 'SÍ' : 'NO'}`);
        console.log('   ---');
    });
}

// 🔥 FUNCIÓN CORREGIDA: Cargar todas las recogidas de la finca
async function cargarRecogidas() {
    try {
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('noDataMessage').style.display = 'none';

        console.log('🔄 Cargando recogidas para finca:', fincaId);
        
        const response = await fetch(`https://jc-frutas.onrender.com/recogidas/por-finca/${fincaId}`);
        if (!response.ok) throw new Error('Error al cargar recogidas');

        todasLasRecogidas = await response.json();
        console.log('📥 Recogidas cargadas del servidor:', todasLasRecogidas.length);

        // 🔥 DEBUG INMEDIATO: Ver las primeras 3 recogidas
        console.log('🔍 ===== PRIMERAS 3 RECOGIDAS PARA DEBUG =====');
        todasLasRecogidas.slice(0, 3).forEach((recogida, index) => {
            console.log(`📦 Recogida ${index + 1}:`);
            console.log(`   🆔 ID: ${recogida._id}`);
            console.log(`   📅 Fecha RAW: ${recogida.fecha}`);
            console.log(`   📅 Tipo fecha: ${typeof recogida.fecha}`);
            console.log(`   🏷️ Estado liquidación: ${recogida.estadoLiquidacion || 'UNDEFINED (ACTIVA)'}`);
            console.log(`   ⚖️ Kilos: ${recogida.totalKilos}`);
            console.log('   ---');
        });
        console.log('===============================================');

        // Verificar estados de liquidación
        const estadisticas = {
            total: todasLasRecogidas.length,
            liquidadas: todasLasRecogidas.filter(r => r.estadoLiquidacion === 'liquidada').length,
            pendientes: todasLasRecogidas.filter(r => r.estadoLiquidacion === 'pendiente').length,
            sinEstado: todasLasRecogidas.filter(r => !r.estadoLiquidacion).length,
            conFecha: todasLasRecogidas.filter(r => r.fecha).length,
            sinFecha: todasLasRecogidas.filter(r => !r.fecha).length
        };

        console.log('📊 ESTADÍSTICAS DE RECOGIDAS:');
        console.log(`   📦 Total: ${estadisticas.total}`);
        console.log(`   ✅ Liquidadas: ${estadisticas.liquidadas}`);
        console.log(`   ⏳ Pendientes: ${estadisticas.pendientes}`);
        console.log(`   🆘 Sin estado (activas): ${estadisticas.sinEstado}`);
        console.log(`   📅 Con fecha: ${estadisticas.conFecha}`);
        console.log(`   ❌ Sin fecha: ${estadisticas.sinFecha}`);

        // Aplicar filtro inicial
        filtrarRecogidas();

    } catch (error) {
        console.error('❌ Error cargando recogidas:', error);
        document.getElementById('loadingIndicator').innerHTML = '❌ Error al cargar recogidas';
    }
}


// Mostrar recogidas filtradas
        function mostrarRecogidas() {
            document.getElementById('loadingIndicator').style.display = 'none';

            if (recogidasFiltradas.length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('resumenTotales').style.display = 'none';
                document.getElementById('btnRecibo').style.display = 'none';
                document.getElementById('recogidasContainer').innerHTML = '';
                return;
            }

            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('resumenTotales').style.display = 'grid';
            document.getElementById('btnRecibo').style.display = 'block';

            // Calcular totales SOLO DE RECOGIDAS ACTIVAS
            let totalRecogidas = recogidasFiltradas.length;
            let totalKilos = 0;
            let totalValor = 0;
            let totalPesas = 0;

            recogidasFiltradas.forEach(recogida => {
                totalKilos += recogida.totalKilos || 0;
                totalValor += recogida.valorPagar || 0;
                totalPesas += recogida.pesas ? recogida.pesas.length : 0;
            });

            // Actualizar resumen
            document.getElementById('totalRecogidas').textContent = totalRecogidas;
            document.getElementById('totalKilos').textContent = totalKilos + ' kg';
            document.getElementById('totalValor').textContent = '$' + totalValor.toLocaleString();
            document.getElementById('totalPesas').textContent = totalPesas;

            // Mostrar recogidas
            const container = document.getElementById('recogidasContainer');
            container.innerHTML = '';

            recogidasFiltradas.forEach((recogida, index) => {
                const card = crearTarjetaRecogida(recogida, index + 1);
                container.appendChild(card);
            });
        }

        // 🔥 NUEVA FUNCIÓN: Liquidar recogida automáticamente
        async function liquidarRecogidaAutomatica(recogidaId) {
            if (!confirm('🔥 ¿LIQUIDAR esta recogida inmediatamente?\n\n⚠️ Esta acción:\n✅ Marcará la recogida como LIQUIDADA\n🚫 La quitará de recogidas activas\n💰 Descontará del total a pagar\n\n¿Continuar?')) {
                return;
            }

            try {
                const storedData = sessionStorage.getItem('userData');
                let usuarioActual = usuario;
                let adminAlias = '';

                if (storedData) {
                    const sessionData = JSON.parse(storedData);
                    usuarioActual = sessionData.username;
                    adminAlias = sessionData.adminAlias || sessionData.alias;
                }

                // Deshabilitar botón para evitar doble clic
                const botonLiquidar = document.querySelector(`button[onclick="liquidarRecogidaAutomatica('${recogidaId}')"]`);
                if (botonLiquidar) {
                    botonLiquidar.disabled = true;
                    botonLiquidar.textContent = '⏳ Liquidando...';
                }

                console.log('🔥 Liquidando recogida automáticamente:', recogidaId);

                // 🔥 PASO 1: Marcar para liquidación si no está marcada
                const recogida = todasLasRecogidas.find(r => r._id === recogidaId);
                if (!recogida.estadoLiquidacion) {
                    const responseMarcar = await fetch(`https://jc-frutas.onrender.com/recogidas/marcar-liquidacion/${recogidaId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            usuario: usuarioActual,
                            adminAlias: adminAlias
                        })
                    });

                    if (!responseMarcar.ok) {
                        throw new Error('Error al marcar para liquidación');
                    }
                }

                // 🔥 PASO 2: Liquidar inmediatamente
                const responseLiquidar = await fetch(`https://jc-frutas.onrender.com/recogidas/cambiar-estado-liquidacion/${recogidaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        estado: 'liquidada',
                        usuario: usuarioActual
                    })
                });

                if (!responseLiquidar.ok) {
                    throw new Error('Error al liquidar la recogida');
                }

                const result = await responseLiquidar.json();
                
                if (result.success) {
                    // 🔥 MOSTRAR NOTIFICACIÓN DE ÉXITO
                    mostrarNotificacion('🎉 ¡RECOGIDA LIQUIDADA EXITOSAMENTE!', 'success');

                    // 🔥 ANIMAR LA TARJETA ANTES DE QUITARLA
                    const tarjeta = botonLiquidar.closest('.recogida-card');
                    if (tarjeta) {
                        tarjeta.classList.add('liquidacion-exitosa');
                        
                        // Esperar la animación y luego recargar
                        setTimeout(async () => {
                            // Recargar recogidas para actualizar totales
                            await cargarRecogidas();
                        }, 2000);
                    }

                    console.log('✅ Recogida liquidada exitosamente');
                } else {
                    throw new Error('La respuesta no indica éxito');
                }

            } catch (error) {
                console.error('❌ Error al liquidar recogida:', error);
                mostrarNotificacion('❌ Error al liquidar: ' + error.message, 'error');
                
                // Reactivar botón en caso de error
                const botonLiquidar = document.querySelector(`button[onclick="liquidarRecogidaAutomatica('${recogidaId}')"]`);
                if (botonLiquidar) {
                    botonLiquidar.disabled = false;
                    botonLiquidar.textContent = '💰 Liquidar';
                }
            }
        }

        // 🔥 FUNCIÓN PARA MOSTRAR NOTIFICACIONES
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion';
            
            const colores = {
                'success': 'linear-gradient(135deg, #28a745 0%, #20c997 100%)',
                'error': 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)',
                'warning': 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)'
            };

            notificacion.style.background = colores[tipo] || colores.success;
            notificacion.textContent = mensaje;
            
            document.body.appendChild(notificacion);

            // Remover después de 5 segundos
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notificacion.parentNode) {
                            notificacion.parentNode.removeChild(notificacion);
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Crear tarjeta de recogida - MODIFICADA PARA LIQUIDACIÓN AUTOMÁTICA
function crearTarjetaRecogida(recogida, numero) {
    const div = document.createElement('div');
    div.className = 'recogida-card';

    // 🔥 USAR LA MISMA FUNCIÓN DE FORMATEO QUE EN HISTORIAL
    const fecha = formatearFecha(recogida.fecha);
    const totalPesas = recogida.pesas ? recogida.pesas.length : 0;

    // Determinar estado de liquidación
    const estadoLiquidacion = recogida.estadoLiquidacion;
    let badgeEstado = '';
    let mostrarBotonLiquidar = !estadoLiquidacion || estadoLiquidacion === 'pendiente';

    if (estadoLiquidacion) {
        const colores = {
            'pendiente': 'background: #ffc107; color: #000;',
            'liquidada': 'background: #28a745; color: white;',
            'cancelada': 'background: #dc3545; color: white;'
        };
        const textos = {
            'pendiente': '⏳ Pendiente',
            'liquidada': '✅ Liquidada',
            'cancelada': '❌ Cancelada'
        };
        
        badgeEstado = `<span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; ${colores[estadoLiquidacion]}">${textos[estadoLiquidacion]}</span>`;
    }

    div.innerHTML = `
        <div class="recogida-header">
            <div class="recogida-fecha">📅 ${fecha} - Recogida #${numero}</div>
            <div style="display: flex; align-items: center; gap: 10px;">
                ${badgeEstado}
                <div style="font-size: 14px; color: #6c757d;">👤 ${recogida.alias || recogida.usuario}</div>
            </div>
        </div>
        
        <div class="recogida-info">
            <div class="info-item">
                <strong>${recogida.fruta || 'N/A'}</strong>
                <span>Fruta Principal</span>
            </div>

            <div class="info-item">
                <strong>${recogida.totalKilos || 0} kg</strong>
                <span>Total Kilos</span>
            </div>
            ${!isSubusuario ? `
            <div class="info-item">
                <strong>${(recogida.valorPagar || 0).toLocaleString()}</strong>
                <span>Valor Total</span>
            </div>
            ` : ''}
            <div class="info-item">
                <strong>${totalPesas}</strong>
                <span>Pesas</span>
            </div>
        </div>

        ${mostrarBotonLiquidar ? `
        <button class="btn-liquidar" onclick="liquidarRecogidaAutomatica('${recogida._id}')">
            💰 LIQUIDAR AHORA
        </button>
        ` : estadoLiquidacion === 'liquidada' ? `
        <div style="text-align: center; padding: 15px; background: #d4edda; border-radius: 10px; margin-top: 15px;">
            <strong style="color: #155724;">✅ RECOGIDA LIQUIDADA</strong>
            <div style="font-size: 12px; color: #155724; margin-top: 5px;">
                ${recogida.fechaLiquidacion ? `Liquidada el ${formatearFecha(recogida.fechaLiquidacion)}` : ''}
                ${recogida.usuarioLiquida ? ` por ${recogida.usuarioLiquida}` : ''}
            </div>
        </div>
        ` : ''}
    `;

    return div;
}
        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            recogidasFiltradas = [...todasLasRecogidas];
            filtrarRecogidas(); // Usar filtrarRecogidas para mantener el filtro de activas
        }

        // Volver al dashboard
        function volverDashboard() {
            window.history.back();
        }

        // Generar recibo de liquidación con múltiples páginas - SOLO RECOGIDAS ACTIVAS
        async function generarReciboLiquidacion() {
            if (recogidasFiltradas.length === 0) {
                alert('No hay recogidas activas para generar el recibo');
                return;
            }

            try {
                console.log('🚀 Iniciando generación de recibo de liquidación de recogidas ACTIVAS...');
                
                // Procesar datos para el recibo - SOLO RECOGIDAS FILTRADAS ACTIVAS
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                
                const resumenPorFrutaCalidad = {};
                let totalKilosGeneral = 0;
                let totalValorGeneral = 0;
                let totalPesasGeneral = 0;

                console.log('📊 Procesando', recogidasFiltradas.length, 'recogidas activas filtradas...');

                recogidasFiltradas.forEach(recogida => {
                    totalKilosGeneral += recogida.totalKilos || 0;
                    totalValorGeneral += recogida.valorPagar || 0;
                    
                    if (recogida.pesas) {
                        totalPesasGeneral += recogida.pesas.length;
                        
                        recogida.pesas.forEach(pesa => {
                            const fruta = pesa.fruta || recogida.fruta || 'Sin especificar';
                            const calidad = pesa.calidad || recogida.calidad || 'Sin especificar';
                            const precio = pesa.precio || recogida.precio || 0;
                            const clave = `${fruta} - ${calidad}`;
                            
                            if (!resumenPorFrutaCalidad[clave]) {
                                resumenPorFrutaCalidad[clave] = {
                                    kilos: 0,
                                    valor: 0,
                                    precio: precio,
                                    cantidad: 0
                                };
                            }
                            
                            resumenPorFrutaCalidad[clave].kilos += pesa.kilos || 0;
                            resumenPorFrutaCalidad[clave].valor += pesa.valor || 0;
                            resumenPorFrutaCalidad[clave].cantidad += 1;
                        });
                    }
                });

                console.log('📋 Resumen procesado:', Object.keys(resumenPorFrutaCalidad).length, 'combinaciones fruta-calidad');

                // 🔥 DIVIDIR EN PÁGINAS DE 15 ELEMENTOS MÁXIMO
                const entradasResumen = Object.entries(resumenPorFrutaCalidad);
                const ITEMS_POR_PAGINA = 15;
                const totalPaginas = Math.ceil(entradasResumen.length / ITEMS_POR_PAGINA);
                
                console.log('📄 Se generarán', totalPaginas, 'páginas de recibo');

                const archivos = [];

                // Generar cada página
                for (let i = 0; i < totalPaginas; i++) {
                    const inicio = i * ITEMS_POR_PAGINA;
                    const fin = Math.min(inicio + ITEMS_POR_PAGINA, entradasResumen.length);
                    const entradasPagina = entradasResumen.slice(inicio, fin);
                    
                    console.log(`📄 Generando página ${i + 1}/${totalPaginas} con ${entradasPagina.length} elementos`);

                    // Convertir de vuelta a objeto para esta página
                    const resumenPagina = {};
                    entradasPagina.forEach(([clave, datos]) => {
                        resumenPagina[clave] = datos;
                    });

                    // Crear página de recibo
                    const divRecibo = crearReciboLiquidacionPaginado(
                        resumenPagina,
                        totalKilosGeneral,
                        totalValorGeneral,
                        totalPesasGeneral,
                        recogidasFiltradas.length,
                        fechaInicio,
                        fechaFin,
                        i + 1,
                        totalPaginas
                    );

                    document.body.appendChild(divRecibo);
                    await document.fonts.ready;

                    // Generar imagen
                    const canvas = await html2canvas(divRecibo, {
                        scale: 3,
                        useCORS: true,
                        allowTaint: false,
                        backgroundColor: '#ffffff',
                        width: divRecibo.offsetWidth,
                        height: divRecibo.offsetHeight,
                        logging: false,
                        imageTimeout: 0
                    });

                    document.body.removeChild(divRecibo);

                    // Crear archivo
                    const blob = await new Promise(resolve => 
                        canvas.toBlob(resolve, "image/png", 1.0)
                    );
                    
                    const nombreArchivo = totalPaginas > 1 ? 
                        `liquidacion_pendiente_${fincaNombre}_pagina_${i + 1}.png` :
                        `liquidacion_pendiente_${fincaNombre}.png`;
                    
                    const file = new File([blob], nombreArchivo, { type: "image/png" });
                    archivos.push(file);
                }

                // Compartir todos los archivos
                const mensaje = totalPaginas > 1 ?
                    `💰 Recogidas Pendientes - ${fincaNombre}\n📊 ${recogidasFiltradas.length} recogidas activas\n⚖️ ${totalKilosGeneral} kg \n📄 ${totalPaginas} páginas generadas` :
                    `💰 Recogidas  - ${fincaNombre}\n📊 ${recogidasFiltradas.length} recogidas activas\n⚖️ ${totalKilosGeneral} kg `;

                console.log('📤 Compartiendo', archivos.length, 'archivos...');

                await navigator.share({
                    title: 'Recogidas Pendientes de Liquidación',
                    text: mensaje,
                    files: archivos,
                });

                console.log('✅ Recibo de recogidas  generado y compartido exitosamente');

            } catch (error) {
                console.error('❌ Error generando recibo:', error);
                mostrarNotificacion('❌ Error al generar recibo: ' + error.message, 'error');
            }
        }



        // Crear recibo de liquidación paginado con el mismo estilo - ACTUALIZADO PARA PENDIENTES
  function crearReciboLiquidacionPaginado(resumen, totalKilos, totalValor, totalPesas, totalRecogidas, fechaInicio, fechaFin, numeroPagina, totalPaginasRecibo) {
            const div = document.createElement("div");
            div.style.cssText = `
                width: 800px;
                min-height: 1000px;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                color: #2c3e50;
                font-family: 'Arial', sans-serif;
                padding: 30px;
                margin: 0;
                box-sizing: border-box;
                position: relative;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            `;

            // Formatear período correctamente
            let periodo = 'Todas las fechas';
            if (fechaInicio && fechaFin) {
                const fechaInicioObj = new Date(fechaInicio + 'T00:00:00');
                const fechaFinObj = new Date(fechaFin + 'T00:00:00');
                periodo = `${fechaInicioObj.toLocaleDateString('es-ES')} - ${fechaFinObj.toLocaleDateString('es-ES')}`;
            } else if (fechaInicio) {
                const fechaInicioObj = new Date(fechaInicio + 'T00:00:00');
                periodo = `Desde ${fechaInicioObj.toLocaleDateString('es-ES')}`;
            } else if (fechaFin) {
                const fechaFinObj = new Date(fechaFin + 'T00:00:00');
                periodo = `Hasta ${fechaFinObj.toLocaleDateString('es-ES')}`;
            }

            const tituloRecibo = totalPaginasRecibo > 1 ? 
                `⏳ LIQUIDACIÓN - PÁGINA ${numeroPagina}/${totalPaginasRecibo}` :
                `⏳  LIQUIDACIÓN`;

            div.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="margin: 0; font-size: 42px; font-weight: bold; color: #34495e;">
                        ${tituloRecibo}
                    </h1>
                    <div style="width: 60px; height: 4px; background: linear-gradient(to right, #f39c12, #e67e22); margin: 15px auto; border-radius: 2px;"></div>
                    ${totalPaginasRecibo > 1 ? `<p style="margin: 5px 0; font-size: 18px; color: #7f8c8d;">Página ${numeroPagina} de ${totalPaginasRecibo}</p>` : ''}
                </div>

                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; margin-bottom: 25px; backdrop-filter: blur(10px);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 20px;">
                        <div><strong>🏠 Finca:</strong> ${fincaNombre || 'Sin especificar'}</div>
                        <div><strong>👤 Propietario:</strong> ${propietario || 'Sin especificar'}</div>
                        <div><strong>📅 Período:</strong> ${periodo}</div>
                        <div><strong>⏳ Recogidas Pendientes:</strong> ${totalRecogidas}</div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; margin-bottom: 25px; backdrop-filter: blur(10px);">
                    <h3 style="margin: 0 0 25px 0; text-align: center; font-size: 26px;">📋 RESUMEN POR FRUTA Y CALIDAD </h3>
                    <div style="display: grid; gap: 18px;">
                        ${Object.entries(resumen).map(([clave, datos]) => `
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; display: grid; grid-template-columns: 2.5fr 1fr 1fr 1fr ${!isSubusuario ? '1.2fr' : ''}; gap: 18px; align-items: center; color: #2c3e50; box-shadow: 0 3px 10px rgba(0,0,0,0.1); font-size: 24px;">
                            <div style="font-weight: bold; color: #2c3e50;">${clave}</div>
                            <div style="text-align: center; color: #2c3e50; font-weight: 600;">${datos.kilos} kg</div>
                            <div style="text-align: center; color: #2c3e50;">${datos.precio.toLocaleString()}/kg</div>
                            ${!isSubusuario ? `<div style="text-align: center; color: #2c3e50; font-weight: bold;">${datos.valor.toLocaleString()}</div>` : ''}
                        </div>
                        `).join('')}
                    </div>
                </div>

                ${numeroPagina === totalPaginasRecibo ? `
                <div style="background: rgba(255,255,255,0.15); padding: 25px; border-radius: 15px; text-align: center; margin-top: 30px;">
                    <h2 style="margin: 0 0 15px 0; font-size: 32px; color: #2c3e50; font-weight: bold;">
                        ⏳ TOTALES
                    </h2>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 25px; margin-top: 20px; font-size: 22px; opacity: 0.9; flex-wrap: wrap;">
                        <span style="color: #2c3e50; font-weight: bold; background: rgba(243, 156, 18, 0.2); padding: 12px 18px; border-radius: 20px;">⚖️ ${totalKilos} kg</span>
                        ${!isSubusuario ? `<span style="color: #2c3e50; font-weight: bold; background: rgba(243, 156, 18, 0.2); padding: 12px 18px; border-radius: 20px;">💰 ${totalValor.toLocaleString()}</span>` : ''}
                    </div>
                </div>
                ` : `
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px; border: 2px dashed rgba(255,255,255,0.3);">
                    <p style="margin: 0; font-size: 20px; color: #2c3e50; opacity: 0.7;">
                        📄 Continúa en la página ${numeroPagina + 1}/${totalPaginasRecibo}
                    </p>
                </div>
                `}

                <div style="position: absolute; bottom: 20px; right: 30px; font-size: 16px; color: #95a5a6;">
                    Generado: ${new Date().toLocaleString('es-ES')}
                </div>
            `;

            return div;
        }
    </script>
</body>
</html>