<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jc-loader.js"></script>
      <script src="blockCheck.js"></script>

        <title>LiquidaciÃ³n de Finca</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }



        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f0f0f0;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .finca-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filtros {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filtros label {
            font-weight: bold;
            color: #2c3e50;
        }

        .filtros input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .resumen-totales {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .total-item h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .total-item p {
            opacity: 0.9;
            font-size: 14px;
        }

        .recogidas-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }

        .recogida-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .recogida-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .recogida-card.liquidada {
            background: #f8f9fa;
            border-color: #28a745;
            opacity: 0.7;
        }

        .recogida-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .recogida-fecha {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .recogida-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item strong {
            display: block;
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .info-item span {
            color: #6c757d;
            font-size: 12px;
        }

        .pesas-detalle {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .pesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .pesa-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #6c757d;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .floating-recibo {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .btn-recibo {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }

        .btn-recibo:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.6);
        }

        /* ğŸ”¥ NUEVOS ESTILOS PARA LIQUIDACIÃ“N */
        .btn-liquidar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }

        .btn-liquidar:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-liquidar:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .liquidacion-exitosa {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745 !important;
            animation: liquidacionPulse 2s ease-in-out;
        }

        @keyframes liquidacionPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .notificacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .filtros {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filtros > * {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>

            <button class="btn btn-secondary" onclick="volverDashboard()" style="margin-top: 20px;">
            â† Volver 
        </button>

    <div class="container">
        <div class="header">
            <h1>ğŸ“Š LiquidaciÃ³n de Finca</h1>
            <p>Resumen completo de recogidas por perÃ­odo</p>
        </div>

        <div class="finca-info" id="fincaInfo">
            <div>
                <strong>ğŸ  Finca:</strong>
                <span id="fincaNombre">Cargando...</span>
            </div>
            <div>
                <strong>ğŸ‘¤ Propietario:</strong>
                <span id="propietarioNombre">Cargando...</span>
            </div>
            <div>
                <strong style="display: none;">ğŸ“ ID:</strong>
                <span style="display: none;" id="fincaId">-</span>
            </div>
        </div>

        <div class="filtros">
            <label for="fechaInicio">ğŸ“… Fecha Inicio:</label>
            <input type="date" id="fechaInicio">
            
            <label for="fechaFin">ğŸ“… Fecha Fin:</label>
            <input type="date" id="fechaFin">
            
            <button class="btn btn-primary" onclick="filtrarRecogidas()">
                ğŸ” Filtrar
            </button>
            
            <button class="btn btn-secondary" onclick="limpiarFiltros()">
                ğŸ§¹ Limpiar Filtros
            </button>
        </div>

                 <button class="btn-liquidar-intervalo" onclick="liquidarIntervaloFechas()" id="btnLiquidarIntervalo" style="display: none;">
                ğŸ’° Liquidar Intervalo
            </button>

        <div class="resumen-totales" id="resumenTotales" style="display: none;">
            <div class="total-item">
                <h3 id="totalRecogidas">0</h3>
                <p>Recogidas Activas</p>
            </div>
            <div class="total-item">
                <h3 style="display: none;" id="totalKilos">0</h3>

            </div>
            <div class="total-item" id="totalValorContainer">
                <h3 id="totalValor">$0</h3>
                <p>Valor Pendiente</p>
            </div>
            <div  class="total-item">
                <h3 style="display: none;" id="totalPesas">0</h3>

            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            ğŸ”„ Cargando recogidas...
        </div>

        <div id="noDataMessage" class="no-data" style="display: none;">
            ğŸ“­ No se encontraron recogidas activas para el perÃ­odo seleccionado
        </div>

        <div class="recogidas-grid" id="recogidasContainer">
        </div>


    </div>

    <div class="floating-recibo">
        <button class="btn-recibo" onclick="generarReciboLiquidacion()" id="btnRecibo" style="display: none;">
            ğŸ“„ Generar Recibo
        </button>
    </div>

    <!-- Script para html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Variables globales
        let todasLasRecogidas = [];
        let recogidasFiltradas = [];
        let isSubusuario = false;
        let fincaData = {};

        // Obtener parÃ¡metros de URL
        const urlParams = new URLSearchParams(window.location.search);
        const fincaId = urlParams.get('fincaId');
        const fincaNombre = urlParams.get('finca');
        const propietario = urlParams.get('propietario');
        const usuario = urlParams.get('usuario');

// REEMPLAZAR la funciÃ³n isCapacitor() en liquidacion.html

function isCapacitor() {
    // Verificar mÃºltiples indicadores de Capacitor
    const capacitorIndicators = [
        // Indicador principal
        typeof window !== 'undefined' && window.Capacitor && window.Capacitor.isNative,
        // Plugin disponible
        typeof window !== 'undefined' && window.Capacitor && window.Capacitor.Plugins,
        // Verificar si existe el objeto Capacitor
        typeof window !== 'undefined' && window.Capacitor,
        // User agent contiene informaciÃ³n de Capacitor
        typeof navigator !== 'undefined' && navigator.userAgent && navigator.userAgent.includes('Capacitor')
    ];
    
    const isCapacitorEnv = capacitorIndicators.some(indicator => indicator);
    
    console.log('ğŸ” Verificando entorno Capacitor:');
    console.log('  - window.Capacitor existe:', !!(window && window.Capacitor));
    console.log('  - window.Capacitor.isNative:', !!(window && window.Capacitor && window.Capacitor.isNative));
    console.log('  - window.Capacitor.Plugins:', !!(window && window.Capacitor && window.Capacitor.Plugins));
    console.log('  - User Agent:', navigator.userAgent);
    console.log('  - Resultado final isCapacitor():', isCapacitorEnv);
    
    if (window && window.Capacitor && window.Capacitor.Plugins) {
        console.log('  - Plugins disponibles:', Object.keys(window.Capacitor.Plugins));
    }
    
    return isCapacitorEnv;
}

// TAMBIÃ‰N agregar esta funciÃ³n de debug justo despuÃ©s
function debugCapacitorEnvironment() {
    console.log('=== DEBUG CAPACITOR ENVIRONMENT ===');
    console.log('window:', typeof window);
    console.log('window.Capacitor:', window?.Capacitor);
    console.log('window.Capacitor.isNative:', window?.Capacitor?.isNative);
    console.log('window.Capacitor.Plugins:', window?.Capacitor?.Plugins);
    
    if (window?.Capacitor?.Plugins) {
        console.log('Plugins disponibles:');
        Object.keys(window.Capacitor.Plugins).forEach(pluginName => {
            console.log(`  - ${pluginName}:`, window.Capacitor.Plugins[pluginName]);
        });
    }
    
    console.log('navigator.userAgent:', navigator.userAgent);
    console.log('===================================');
}

// MODIFICAR el inicio de la funciÃ³n generarReciboLiquidacion():

async function generarReciboLiquidacion() {
    if (recogidasFiltradas.length === 0) {
        alert('No hay recogidas activas para generar el recibo');
        return;
    }

    try {
        console.log('ğŸš€ Iniciando generaciÃ³n de recibo de liquidaciÃ³n de recogidas ACTIVAS...');
        
        // ğŸ” DEBUG: Verificar entorno antes de continuar
        debugCapacitorEnvironment();
        const esCapacitor = isCapacitor();
        console.log('ğŸ” Resultado de isCapacitor():', esCapacitor);
        
        // Procesar datos para el recibo - SOLO RECOGIDAS FILTRADAS ACTIVAS
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;
        
        const resumenPorFrutaCalidad = {};
        let totalKilosGeneral = 0;
        let totalValorGeneral = 0;
        let totalPesasGeneral = 0;

        console.log('ğŸ“Š Procesando', recogidasFiltradas.length, 'recogidas activas filtradas...');

        recogidasFiltradas.forEach(recogida => {
            totalKilosGeneral += recogida.totalKilos || 0;
            totalValorGeneral += recogida.valorPagar || 0;
            
            if (recogida.pesas) {
                totalPesasGeneral += recogida.pesas.length;
                
                recogida.pesas.forEach(pesa => {
                    const fruta = pesa.fruta || recogida.fruta || 'Sin especificar';
                    const calidad = pesa.calidad || recogida.calidad || 'Sin especificar';
                    const precio = pesa.precio || recogida.precio || 0;
                    const clave = `${fruta} - ${calidad}`;
                    
                    if (!resumenPorFrutaCalidad[clave]) {
                        resumenPorFrutaCalidad[clave] = {
                            kilos: 0,
                            valor: 0,
                            precio: precio,
                            cantidad: 0
                        };
                    }
                    
                    resumenPorFrutaCalidad[clave].kilos += pesa.kilos || 0;
                    resumenPorFrutaCalidad[clave].valor += pesa.valor || 0;
                    resumenPorFrutaCalidad[clave].cantidad += 1;
                });
            }
        });

        console.log('ğŸ“‹ Resumen procesado:', Object.keys(resumenPorFrutaCalidad).length, 'combinaciones fruta-calidad');

        // Crear mensaje de texto para fallback
        const mensaje = `ğŸ’° Recogidas Pendientes - ${fincaNombre}
ğŸ“Š ${recogidasFiltradas.length} recogidas activas
âš–ï¸ ${totalKilosGeneral} kg`;

        // ğŸ”¥ CAPACITOR: Forzar detecciÃ³n alternativa si es necesario
        console.log('ğŸ” Verificaciones adicionales:');
        console.log('  - location.protocol:', window.location.protocol);
        console.log('  - location.hostname:', window.location.hostname);
        
        // Forzar modo Capacitor si estamos en localhost con protocolo capacitor o file
        const esForzadamenteCapacitor = 
            window.location.protocol === 'capacitor:' ||
            window.location.protocol === 'file:' ||
            (window.location.hostname === 'localhost' && window.Capacitor) ||
            window.location.hostname.includes('capacitor');
            
        console.log('ğŸ” Es forzadamente Capacitor:', esForzadamenteCapacitor);
        
        if (esCapacitor || esForzadamenteCapacitor) {
            console.log('ğŸ“± MODO CAPACITOR DETECTADO - generando imagen directamente...');
            
            try {
                // Verificar plugins con mÃ¡s detalle
                if (!window.Capacitor) {
                    throw new Error('window.Capacitor no existe');
                }
                
                if (!window.Capacitor.Plugins) {
                    throw new Error('window.Capacitor.Plugins no existe');
                }
                
                const { Share, Filesystem } = window.Capacitor.Plugins;
                
                if (!Share) {
                    throw new Error('Plugin Share no disponible');
                }
                
                if (!Filesystem) {
                    throw new Error('Plugin Filesystem no disponible');
                }
                
                console.log('âœ… Plugins verificados correctamente');

                // Crear imagen usando Canvas API directamente
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Configurar dimensiones
                canvas.width = 800;
                canvas.height = 1000;
                
                // Fondo
                ctx.fillStyle = '#f5f7fa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Configurar texto
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'center';
                
                let y = 80;
                
                // TÃ­tulo
                ctx.fillText('â³ LIQUIDACIÃ“N', canvas.width / 2, y);
                y += 60;
                
                // InformaciÃ³n de finca
                ctx.font = '20px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`ğŸ  Finca: ${fincaNombre || 'Sin especificar'}`, 50, y);
                y += 40;
                ctx.fillText(`ğŸ‘¤ Propietario: ${propietario || 'Sin especificar'}`, 50, y);
                y += 40;
                ctx.fillText(`â³ Recogidas Pendientes: ${recogidasFiltradas.length}`, 50, y);
                y += 60;
                
                // Resumen por fruta y calidad
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ“‹ RESUMEN POR FRUTA Y CALIDAD', canvas.width / 2, y);
                y += 40;
                
                ctx.font = '18px Arial';
                ctx.textAlign = 'left';
                
                Object.entries(resumenPorFrutaCalidad).forEach(([clave, datos]) => {
                    ctx.fillText(`${clave}`, 50, y);
                    ctx.fillText(`${datos.kilos} kg`, 400, y);
                    if (!isSubusuario) {
                        ctx.fillText(`$${datos.precio.toLocaleString()}/kg`, 500, y);
                        ctx.fillText(`$${datos.valor.toLocaleString()}`, 650, y);
                    }
                    y += 30;
                });
                
                y += 40;
                
                // Totales
                ctx.font = 'bold 28px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('â³ TOTALES', canvas.width / 2, y);
                y += 40;
                
                ctx.font = 'bold 22px Arial';
                ctx.fillText(`âš–ï¸ ${totalKilosGeneral} kg`, canvas.width / 2, y);
                y += 35;
                
                if (!isSubusuario) {
                    ctx.fillText(`ğŸ’° $${totalValorGeneral.toLocaleString()}`, canvas.width / 2, y);
                }
                
                // Fecha de generaciÃ³n
                y = canvas.height - 30;
                ctx.font = '16px Arial';
                ctx.textAlign = 'right';
                ctx.fillStyle = '#95a5a6';
                ctx.fillText(`Generado: ${new Date().toLocaleString('es-ES')}`, canvas.width - 30, y);
                
                console.log('ğŸ¨ Canvas creado exitosamente');
                
                // Convertir canvas a blob
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/png', 1.0);
                });
                
                console.log('ğŸ“¸ Imagen generada, tamaÃ±o:', blob.size);
                
                // Convertir a base64
                const reader = new FileReader();
                reader.onload = async function() {
                    try {
                        const base64Data = reader.result.split(',')[1];
                        console.log('ğŸ”„ Imagen convertida a base64, tamaÃ±o:', base64Data.length);
                        
                        // Generar nombre Ãºnico
                        const nombreArchivo = `liquidacion_${fincaNombre}_${Date.now()}.png`;
                        console.log('ğŸ’¾ Guardando como:', nombreArchivo);
                        
                       const reader = new FileReader();
reader.onload = async function() {
    try {
        console.log('ğŸ”„ Imagen convertida a base64, tamaÃ±o:', base64Data.length);
        
        // Generar nombre Ãºnico
        const nombreArchivo = `liquidacion_${fincaNombre.replace(/\s+/g, '_')}_${Date.now()}.png`;
        console.log('ğŸ’¾ Guardando como:', nombreArchivo);
        
        // ğŸ”¥ USAR DIRECTORIO DOCUMENTS EN LUGAR DE CACHE
        console.log('ğŸ“ Directorios disponibles:', Object.keys(Filesystem.Directory || {}));
        
        let directorioAUsar;
        if (Filesystem.Directory.Documents) {
            directorioAUsar = Filesystem.Directory.Documents;
            console.log('ğŸ“ Usando Directory.Documents');
        } else if (Filesystem.Directory.Data) {
            directorioAUsar = Filesystem.Directory.Data;
            console.log('ğŸ“ Usando Directory.Data');
        } else {
            // Usar string directamente como fallback
            directorioAUsar = 'DOCUMENTS';
            console.log('ğŸ“ Usando string DOCUMENTS como fallback');
        }
        
        // Guardar archivo
// âœ… Guardar imagen como archivo
const base64Data = canvas.toDataURL('image/png').split(',')[1]; // solo el base64
const fileName = `liquidacion_${Date.now()}.png`;

await Filesystem.writeFile({
  path: fileName,
  data: base64Data,
  directory: Directory.Cache,
  recursive: true
});
        console.log('ğŸ’¾ Archivo guardado exitosamente:', fileResult.uri);
        
        // Compartir
        const shareResult = await Share.share({
            title: 'Recibo de LiquidaciÃ³n',
            text: mensaje,
            url: fileResult.uri,
            dialogTitle: 'Compartir recibo'
        });
        
        console.log('ğŸ“¤ Compartido exitosamente:', shareResult);
        
        // Limpiar despuÃ©s de 10 segundos (mÃ¡s tiempo por seguridad)
        setTimeout(async () => {
            try {
                await Filesystem.deleteFile({
                    path: nombreArchivo,
                    directory: directorioAUsar
                });
                console.log('ğŸ—‘ï¸ Archivo temporal eliminado');
            } catch (e) {
                console.warn('âš ï¸ No se pudo eliminar archivo temporal:', e);
            }
        }, 10000);
        
    } catch (error) {
        console.error('âŒ Error al procesar imagen:', error);
        
        // ğŸ”¥ MÃ‰TODO ALTERNATIVO: Compartir directamente el blob como data URL
        console.log('ğŸ”„ Intentando mÃ©todo alternativo...');
        try {
            const dataUrl = reader.result;
            await Share.share({
                title: 'Recibo de LiquidaciÃ³n',
                text: mensaje,
                url: dataUrl,
                dialogTitle: 'Compartir recibo'
            });
            console.log('âœ… Compartido con data URL exitosamente');
        } catch (fallbackError) {
            console.error('âŒ Error en mÃ©todo alternativo:', fallbackError);
            alert('Error al generar/compartir imagen: ' + error.message);
        }
    }
};
                        
                        console.log('ğŸ’¾ Archivo guardado:', fileResult.uri);
                        
                        // Compartir
                        const shareResult = await Share.share({
                            title: 'Recibo de LiquidaciÃ³n',
                            text: mensaje,
                            url: fileResult.uri,
                            dialogTitle: 'Compartir recibo'
                        });
                        
                        console.log('ğŸ“¤ Compartido exitosamente:', shareResult);
                        
                        // Limpiar despuÃ©s de 5 segundos
                        setTimeout(async () => {
                            try {
                                await Filesystem.deleteFile({
                                    path: nombreArchivo,
                                    directory: Filesystem.Directory.Cache
                                });
                                console.log('ğŸ—‘ï¸ Archivo temporal eliminado');
                            } catch (e) {
                                console.warn('âš ï¸ No se pudo eliminar archivo temporal:', e);
                            }
                        }, 5000);
                        
                    } catch (error) {
                        console.error('âŒ Error al procesar imagen:', error);
                        alert('Error al generar imagen: ' + error.message);
                    }
                };
                
                reader.readAsDataURL(blob);
                
            } catch (capacitorError) {
                console.error('âŒ Error en Capacitor:', capacitorError);
                alert('Error al generar imagen en Capacitor: ' + capacitorError.message);
            }
            
            return; // Salir aquÃ­ para Capacitor
        }

        // El resto del cÃ³digo para navegador web continÃºa igual...
        console.log('ğŸŒ Modo navegador web - usando html2canvas...');
        // ... resto del cÃ³digo original
        
    } catch (error) {
        console.error('âŒ Error generando recibo:', error);
        alert('Error al generar recibo: ' + error.message);
    }
}
        function configurarEventosFecha() {
    const fechaInicioInput = document.getElementById('fechaInicio');
    const fechaFinInput = document.getElementById('fechaFin');
    const btnLiquidarIntervalo = document.getElementById('btnLiquidarIntervalo');

    function verificarFechas() {
        if (fechaInicioInput.value && fechaFinInput.value) {
            btnLiquidarIntervalo.style.display = 'block';
        } else {
            btnLiquidarIntervalo.style.display = 'none';
        }
    }

    fechaInicioInput.addEventListener('change', verificarFechas);
    fechaFinInput.addEventListener('change', verificarFechas);
}

function extraerFechaSimple(fechaString) {
    if (!fechaString || fechaString === 'Sin fecha') {
        console.log('âš ï¸ Fecha vacÃ­a o sin fecha');
        return null;
    }
    
    try {
        // Si ya estÃ¡ en formato YYYY-MM-DD
        if (typeof fechaString === 'string' && fechaString.match(/^\d{4}-\d{2}-\d{2}$/)) {
            console.log(`âœ… Fecha ya en formato correcto: ${fechaString}`);
            return fechaString;
        }
        
        // Si tiene la T (formato ISO como "2025-08-03T00:00:00.000Z")
        if (typeof fechaString === 'string' && fechaString.includes('T') && fechaString.includes('-')) {
            const fechaSolo = fechaString.split('T')[0];
            console.log(`âœ… Fecha extraÃ­da de ISO: ${fechaString} â†’ ${fechaSolo}`);
            return fechaSolo;
        }
        
        // ğŸ”¥ CASO PRINCIPAL: Fechas como "Sun Aug 03 2025 00:00:00 GMT+0000"
        // Crear objeto Date y extraer en UTC para evitar problemas de zona horaria
        const fechaObj = new Date(fechaString);
        if (!isNaN(fechaObj.getTime())) {
            const aÃ±o = fechaObj.getUTCFullYear();
            const mes = String(fechaObj.getUTCMonth() + 1).padStart(2, '0');
            const dia = String(fechaObj.getUTCDate()).padStart(2, '0');
            const fechaFormateada = `${aÃ±o}-${mes}-${dia}`;
            console.log(`âœ… Fecha convertida de GMT: ${fechaString} â†’ ${fechaFormateada}`);
            return fechaFormateada;
        }
        
        console.error(`âŒ No se pudo procesar la fecha: ${fechaString}`);
        return null;
        
    } catch (error) {
        console.error(`âŒ Error al procesar fecha "${fechaString}":`, error);
        return null;
    }
}

function fechaAYYYYMMDD(fecha) {
    if (!fecha) return null;
    
    try {
        const d = new Date(fecha);
        if (isNaN(d.getTime())) return null;
        
        // Usar UTC para evitar problemas de zona horaria
        const aÃ±o = d.getUTCFullYear();
        const mes = String(d.getUTCMonth() + 1).padStart(2, '0');
        const dia = String(d.getUTCDate()).padStart(2, '0');
        
        return `${aÃ±o}-${mes}-${dia}`;
    } catch (error) {
        console.error('Error procesando fecha:', fecha, error);
        return null;
    }
}

function extraerFechaRobusta(fechaString) {
    if (!fechaString || fechaString === 'Sin fecha') {
        return null;
    }
    
    try {
        // Siempre crear objeto Date y extraer componentes UTC
        const fechaObj = new Date(fechaString);
        
        if (isNaN(fechaObj.getTime())) {
            console.error(`âŒ Fecha invÃ¡lida: ${fechaString}`);
            return null;
        }
        
        const aÃ±o = fechaObj.getUTCFullYear();
        const mes = String(fechaObj.getUTCMonth() + 1).padStart(2, '0');
        const dia = String(fechaObj.getUTCDate()).padStart(2, '0');
        const fechaFormateada = `${aÃ±o}-${mes}-${dia}`;
        
        console.log(`ğŸ”„ ConversiÃ³n: "${fechaString}" â†’ "${fechaFormateada}"`);
        return fechaFormateada;
        
    } catch (error) {
        console.error(`âŒ Error al procesar fecha "${fechaString}":`, error);
        return null;
    }
}

// FunciÃ³n para liquidar todas las recogidas en el intervalo seleccionado
// FunciÃ³n corregida para liquidar todas las recogidas en el intervalo seleccionado
async function liquidarIntervaloFechas() {
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    
    if (!fechaInicio || !fechaFin) {
        mostrarNotificacion('âŒ Por favor selecciona un intervalo de fechas vÃ¡lido', 'error');
        return;
    }

    console.log('ğŸ” LIQUIDAR INTERVALO - Iniciando filtro');
    console.log(`ğŸ“… Fecha inicio: "${fechaInicio}"`);
    console.log(`ğŸ“… Fecha fin: "${fechaFin}"`);

    // Filtrar recogidas en el intervalo que no estÃ©n liquidadas
    const recogidasParaLiquidar = todasLasRecogidas.filter(recogida => {
        // Excluir ya liquidadas
        if (recogida.estadoLiquidacion === 'liquidada') {
            console.log(`âŒ Recogida ${recogida._id} ya liquidada - excluida`);
            return false;
        }
        
        // Verificar fecha usando la misma funciÃ³n que el filtro principal
        const fechaRecogida = fechaAYYYYMMDD(recogida.fecha);
        
        console.log(`ğŸ“¦ Recogida ${recogida._id}:`);
        console.log(`   ğŸ“… Original: "${recogida.fecha}"`);
        console.log(`   ğŸ“… Convertida: "${fechaRecogida}"`);
        console.log(`   ğŸ·ï¸ Estado: ${recogida.estadoLiquidacion || 'SIN ESTADO (ACTIVA)'}`);
        
        if (!fechaRecogida) {
            console.log(`   âŒ Sin fecha vÃ¡lida - excluida`);
            return false;
        }
        
        // Aplicar filtros de fecha
        const cumple = fechaRecogida >= fechaInicio && fechaRecogida <= fechaFin;
        console.log(`   ğŸ” En rango ${fechaInicio} - ${fechaFin}? ${cumple}`);
        console.log(`   ${cumple ? 'âœ… INCLUIDA PARA LIQUIDAR' : 'âŒ FUERA DEL RANGO'}`);
        
        return cumple;
    });

    console.log(`ğŸ“Š Resultado filtro: ${recogidasParaLiquidar.length}/${todasLasRecogidas.length} recogidas para liquidar`);

    if (recogidasParaLiquidar.length === 0) {
        mostrarNotificacion('â„¹ï¸ No hay recogidas activas en el intervalo seleccionado para liquidar', 'warning');
        return;
    }

    if (!confirm(`Â¿EstÃ¡s seguro que deseas liquidar TODAS las ${recogidasParaLiquidar.length} recogidas activas entre ${fechaInicio} y ${fechaFin}?`)) {
        return;
    }

    try {
        const storedData = sessionStorage.getItem('userData');
        let usuarioActual = usuario;
        let adminAlias = '';

        if (storedData) {
            const sessionData = JSON.parse(storedData);
            usuarioActual = sessionData.username;
            adminAlias = sessionData.adminAlias || sessionData.alias;
        }

        const btnLiquidar = document.getElementById('btnLiquidarIntervalo');
        if (btnLiquidar) {
            btnLiquidar.disabled = true;
            btnLiquidar.innerHTML = 'â³ Liquidando...';
        }

        // Obtener solo los IDs de las recogidas a liquidar
        const recogidaIds = recogidasParaLiquidar.map(r => r._id);

        console.log('ğŸš€ Enviando solicitud de liquidaciÃ³n masiva para:', recogidaIds);

        // Llamar al endpoint para liquidaciÃ³n masiva
        const response = await fetch('https://jc-frutas.onrender.com/recogidas/liquidar-multiples', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                recogidaIds: recogidaIds,
                usuario: usuarioActual,
                adminAlias: adminAlias
            })
        });

        if (!response.ok) {
            throw new Error('Error en la solicitud de liquidaciÃ³n masiva');
        }

        const result = await response.json();

        if (result.success) {
            mostrarNotificacion(`âœ… ${result.exitosas || recogidasParaLiquidar.length} recogidas liquidadas exitosamente`, 'success');
            
            // Recargar las recogidas para actualizar la vista
            await cargarRecogidas();
            
            // Restaurar botÃ³n
            if (btnLiquidar) {
                btnLiquidar.disabled = false;
                btnLiquidar.innerHTML = 'ğŸ’° Liquidar Intervalo';
            }
        } else {
            throw new Error(result.message || 'Error al liquidar recogidas');
        }

    } catch (error) {
        console.error('âŒ Error al liquidar intervalo:', error);
        mostrarNotificacion(`âŒ Error al liquidar intervalo: ${error.message}`, 'error');
        
        const btnLiquidar = document.getElementById('btnLiquidarIntervalo');
        if (btnLiquidar) {
            btnLiquidar.disabled = false;
            btnLiquidar.innerHTML = 'ğŸ’° Liquidar Intervalo';
        }
    }
}
function formatearFecha(fecha) {
    if (!fecha) return "Sin fecha";
    
    try {
        const d = new Date(fecha);
        if (isNaN(d.getTime())) return "Fecha invÃ¡lida";
        
        // Usar UTC y formatear como DD/MM/YYYY
        const dia = String(d.getUTCDate()).padStart(2, '0');
        const mes = String(d.getUTCMonth() + 1).padStart(2, '0');
        const aÃ±o = d.getUTCFullYear();
        
        return `${dia}/${mes}/${aÃ±o}`;
    } catch (error) {
        console.error("Error formateando fecha:", fecha, error);
        return "Fecha invÃ¡lida";
    }
}

        // ğŸ”¥ FUNCIÃ“N PARA COMPARAR FECHAS SIN PROBLEMAS DE ZONA HORARIA
        function compararFechas(fechaRecogida, fechaComparacion) {
            if (!fechaRecogida || !fechaComparacion) return true;
            
            const partes1 = fechaRecogida.split('T')[0].split('-');
            const partes2 = fechaComparacion.split('-');
            
            if (partes1.length === 3 && partes2.length === 3) {
                const fecha1 = new Date(parseInt(partes1[0]), parseInt(partes1[1]) - 1, parseInt(partes1[2]));
                const fecha2 = new Date(parseInt(partes2[0]), parseInt(partes2[1]) - 1, parseInt(partes2[2]));
                return fecha1.getTime() === fecha2.getTime() ? 0 : (fecha1 > fecha2 ? 1 : -1);
            }
            
            return 0;
        }

        // Inicializar pÃ¡gina
        document.addEventListener('DOMContentLoaded', async () => {
            if (!fincaId) {
                alert('Error: No se especificÃ³ la finca');
                volverDashboard();
                return;
            }

            // Mostrar informaciÃ³n de la finca
            document.getElementById('fincaNombre').textContent = fincaNombre || 'Sin nombre';
            document.getElementById('propietarioNombre').textContent = propietario || 'Sin propietario';
            document.getElementById('fincaId').textContent = fincaId;

            fincaData = { fincaId, fincaNombre, propietario };

            // Verificar tipo de usuario
            await verificarTipoUsuario();

            // Configurar fechas por defecto (Ãºltima semana)
            const hoy = new Date();
            const haceUnaSemana = new Date();
            haceUnaSemana.setDate(hoy.getDate() - 7);

            document.getElementById('fechaFin').value = hoy.toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = haceUnaSemana.toISOString().split('T')[0];

            // Cargar recogidas
            await cargarRecogidas();
             configurarEventosFecha();
        });

        // Verificar tipo de usuario
        async function verificarTipoUsuario() {
            try {
                const storedData = sessionStorage.getItem('userData');
                if (storedData) {
                    const sessionData = JSON.parse(storedData);
                    isSubusuario = sessionData.tipo === 2;
                } else if (usuario) {
                    const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
                    if (response.ok) {
                        const userData = await response.json();
                        isSubusuario = userData.tipo === 2;
                    }
                }

                // Ocultar valores monetarios para subusuarios
                if (isSubusuario) {
                    document.getElementById('totalValorContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error verificando tipo de usuario:', error);
            }
        }

        // Cargar todas las recogidas de la finca
function filtrarRecogidas() {
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;

    console.log('ğŸ” FILTRO INICIADO');
    console.log(`ğŸ“… Fecha inicio: "${fechaInicio}"`);
    console.log(`ğŸ“… Fecha fin: "${fechaFin}"`);

    recogidasFiltradas = todasLasRecogidas.filter(recogida => {
        // Excluir liquidadas SIEMPRE
        if (recogida.estadoLiquidacion === 'liquidada') {
            return false;
        }
        
        // Si no hay filtros de fecha, incluir todas las activas
        if (!fechaInicio && !fechaFin) {
            return true;
        }
        
        // Convertir fecha de la recogida
        const fechaRecogida = fechaAYYYYMMDD(recogida.fecha);
        
        console.log(`ğŸ“¦ Recogida ${recogida._id}:`);
        console.log(`   ğŸ“… Original: "${recogida.fecha}"`);
        console.log(`   ğŸ“… Convertida: "${fechaRecogida}"`);
        
        if (!fechaRecogida) {
            console.log(`   âŒ Sin fecha vÃ¡lida - excluida`);
            return false;
        }
        
        // Aplicar filtros
        let cumple = true;
        
        if (fechaInicio) {
            cumple = cumple && (fechaRecogida >= fechaInicio);
            console.log(`   ğŸ” >= ${fechaInicio}? ${fechaRecogida >= fechaInicio}`);
        }
        
        if (fechaFin) {
            cumple = cumple && (fechaRecogida <= fechaFin);
            console.log(`   ğŸ” <= ${fechaFin}? ${fechaRecogida <= fechaFin}`);
        }
        
        console.log(`   ${cumple ? 'âœ… INCLUIDA' : 'âŒ EXCLUIDA'}`);
        return cumple;
    });

    console.log(`ğŸ“Š Resultado: ${recogidasFiltradas.length}/${todasLasRecogidas.length} recogidas`);
    mostrarRecogidas();
}


// ğŸ”¥ FUNCIÃ“N ADICIONAL PARA DEBUG: Verificar estado de recogidas
function verificarEstadoRecogidas() {
    console.log('ğŸ” VERIFICANDO ESTADO DE TODAS LAS RECOGIDAS:');
    
    todasLasRecogidas.forEach((recogida, index) => {
        const estado = recogida.estadoLiquidacion;
        const fecha = recogida.fecha ? recogida.fecha.split('T')[0] : 'Sin fecha';
        const totalKilos = recogida.totalKilos || 0;
        const valor = recogida.valorPagar || 0;
        
        console.log(`ğŸ“¦ Recogida ${index + 1}:`);
        console.log(`   ğŸ†” ID: ${recogida._id}`);
        console.log(`   ğŸ“… Fecha: ${fecha}`);
        console.log(`   âš–ï¸ Kilos: ${totalKilos}`);
        console.log(`   ğŸ’° Valor: ${valor}`);
        console.log(`   ğŸ·ï¸ Estado: ${estado || 'SIN ESTADO (ACTIVA)'}`);
        console.log(`   âœ… Â¿Es activa?: ${!estado || estado !== 'liquidada' ? 'SÃ' : 'NO'}`);
        console.log('   ---');
    });
}

// ğŸ”¥ FUNCIÃ“N CORREGIDA: Cargar todas las recogidas de la finca
async function cargarRecogidas() {
    try {
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('noDataMessage').style.display = 'none';

        console.log('ğŸ”„ Cargando recogidas para finca:', fincaId);
        
        const response = await fetch(`https://jc-frutas.onrender.com/recogidas/por-finca/${fincaId}`);
        if (!response.ok) throw new Error('Error al cargar recogidas');

        todasLasRecogidas = await response.json();
        console.log('ğŸ“¥ Recogidas cargadas del servidor:', todasLasRecogidas.length);

        // ğŸ”¥ DEBUG INMEDIATO: Ver las primeras 3 recogidas
        console.log('ğŸ” ===== PRIMERAS 3 RECOGIDAS PARA DEBUG =====');
        todasLasRecogidas.slice(0, 3).forEach((recogida, index) => {
            console.log(`ğŸ“¦ Recogida ${index + 1}:`);
            console.log(`   ğŸ†” ID: ${recogida._id}`);
            console.log(`   ğŸ“… Fecha RAW: ${recogida.fecha}`);
            console.log(`   ğŸ“… Tipo fecha: ${typeof recogida.fecha}`);
            console.log(`   ğŸ·ï¸ Estado liquidaciÃ³n: ${recogida.estadoLiquidacion || 'UNDEFINED (ACTIVA)'}`);
            console.log(`   âš–ï¸ Kilos: ${recogida.totalKilos}`);
            console.log('   ---');
        });
        console.log('===============================================');

        // Verificar estados de liquidaciÃ³n
        const estadisticas = {
            total: todasLasRecogidas.length,
            liquidadas: todasLasRecogidas.filter(r => r.estadoLiquidacion === 'liquidada').length,
            pendientes: todasLasRecogidas.filter(r => r.estadoLiquidacion === 'pendiente').length,
            sinEstado: todasLasRecogidas.filter(r => !r.estadoLiquidacion).length,
            conFecha: todasLasRecogidas.filter(r => r.fecha).length,
            sinFecha: todasLasRecogidas.filter(r => !r.fecha).length
        };

        console.log('ğŸ“Š ESTADÃSTICAS DE RECOGIDAS:');
        console.log(`   ğŸ“¦ Total: ${estadisticas.total}`);
        console.log(`   âœ… Liquidadas: ${estadisticas.liquidadas}`);
        console.log(`   â³ Pendientes: ${estadisticas.pendientes}`);
        console.log(`   ğŸ†˜ Sin estado (activas): ${estadisticas.sinEstado}`);
        console.log(`   ğŸ“… Con fecha: ${estadisticas.conFecha}`);
        console.log(`   âŒ Sin fecha: ${estadisticas.sinFecha}`);

        // Aplicar filtro inicial
        filtrarRecogidas();

    } catch (error) {
        console.error('âŒ Error cargando recogidas:', error);
        document.getElementById('loadingIndicator').innerHTML = 'âŒ Error al cargar recogidas';
    }
}


// Mostrar recogidas filtradas
        function mostrarRecogidas() {
            document.getElementById('loadingIndicator').style.display = 'none';

            if (recogidasFiltradas.length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('resumenTotales').style.display = 'none';
                document.getElementById('btnRecibo').style.display = 'none';
                document.getElementById('recogidasContainer').innerHTML = '';
                return;
            }

            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('resumenTotales').style.display = 'grid';
            document.getElementById('btnRecibo').style.display = 'block';

            // Calcular totales SOLO DE RECOGIDAS ACTIVAS
            let totalRecogidas = recogidasFiltradas.length;
            let totalKilos = 0;
            let totalValor = 0;
            let totalPesas = 0;

            recogidasFiltradas.forEach(recogida => {
                totalKilos += recogida.totalKilos || 0;
                totalValor += recogida.valorPagar || 0;
                totalPesas += recogida.pesas ? recogida.pesas.length : 0;
            });

            // Actualizar resumen
            document.getElementById('totalRecogidas').textContent = totalRecogidas;
            document.getElementById('totalKilos').textContent = totalKilos + ' kg';
            document.getElementById('totalValor').textContent = '$' + totalValor.toLocaleString();
            document.getElementById('totalPesas').textContent = totalPesas;

            // Mostrar recogidas
            const container = document.getElementById('recogidasContainer');
            container.innerHTML = '';

            recogidasFiltradas.forEach((recogida, index) => {
                const card = crearTarjetaRecogida(recogida, index + 1);
                container.appendChild(card);
            });
        }

        // ğŸ”¥ NUEVA FUNCIÃ“N: Liquidar recogida automÃ¡ticamente
        async function liquidarRecogidaAutomatica(recogidaId) {
            if (!confirm('ğŸ”¥ Â¿LIQUIDAR esta recogida inmediatamente?\n\nâš ï¸ Esta acciÃ³n:\nâœ… MarcarÃ¡ la recogida como LIQUIDADA\nğŸš« La quitarÃ¡ de recogidas activas\nğŸ’° DescontarÃ¡ del total a pagar\n\nÂ¿Continuar?')) {
                return;
            }

            try {
                const storedData = sessionStorage.getItem('userData');
                let usuarioActual = usuario;
                let adminAlias = '';

                if (storedData) {
                    const sessionData = JSON.parse(storedData);
                    usuarioActual = sessionData.username;
                    adminAlias = sessionData.adminAlias || sessionData.alias;
                }

                // Deshabilitar botÃ³n para evitar doble clic
                const botonLiquidar = document.querySelector(`button[onclick="liquidarRecogidaAutomatica('${recogidaId}')"]`);
                if (botonLiquidar) {
                    botonLiquidar.disabled = true;
                    botonLiquidar.textContent = 'â³ Liquidando...';
                }

                console.log('ğŸ”¥ Liquidando recogida automÃ¡ticamente:', recogidaId);

                // ğŸ”¥ PASO 1: Marcar para liquidaciÃ³n si no estÃ¡ marcada
                const recogida = todasLasRecogidas.find(r => r._id === recogidaId);
                if (!recogida.estadoLiquidacion) {
                    const responseMarcar = await fetch(`https://jc-frutas.onrender.com/recogidas/marcar-liquidacion/${recogidaId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            usuario: usuarioActual,
                            adminAlias: adminAlias
                        })
                    });

                    if (!responseMarcar.ok) {
                        throw new Error('Error al marcar para liquidaciÃ³n');
                    }
                }

                // ğŸ”¥ PASO 2: Liquidar inmediatamente
                const responseLiquidar = await fetch(`https://jc-frutas.onrender.com/recogidas/cambiar-estado-liquidacion/${recogidaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        estado: 'liquidada',
                        usuario: usuarioActual
                    })
                });

                if (!responseLiquidar.ok) {
                    throw new Error('Error al liquidar la recogida');
                }

                const result = await responseLiquidar.json();
                
                if (result.success) {
                    // ğŸ”¥ MOSTRAR NOTIFICACIÃ“N DE Ã‰XITO
                    mostrarNotificacion('ğŸ‰ Â¡RECOGIDA LIQUIDADA EXITOSAMENTE!', 'success');

                    // ğŸ”¥ ANIMAR LA TARJETA ANTES DE QUITARLA
                    const tarjeta = botonLiquidar.closest('.recogida-card');
                    if (tarjeta) {
                        tarjeta.classList.add('liquidacion-exitosa');
                        
                        // Esperar la animaciÃ³n y luego recargar
                        setTimeout(async () => {
                            // Recargar recogidas para actualizar totales
                            await cargarRecogidas();
                        }, 2000);
                    }

                    console.log('âœ… Recogida liquidada exitosamente');
                } else {
                    throw new Error('La respuesta no indica Ã©xito');
                }

            } catch (error) {
                console.error('âŒ Error al liquidar recogida:', error);
                mostrarNotificacion('âŒ Error al liquidar: ' + error.message, 'error');
                
                // Reactivar botÃ³n en caso de error
                const botonLiquidar = document.querySelector(`button[onclick="liquidarRecogidaAutomatica('${recogidaId}')"]`);
                if (botonLiquidar) {
                    botonLiquidar.disabled = false;
                    botonLiquidar.textContent = 'ğŸ’° Liquidar';
                }
            }
        }

        // ğŸ”¥ FUNCIÃ“N PARA MOSTRAR NOTIFICACIONES
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion';
            
            const colores = {
                'success': 'linear-gradient(135deg, #28a745 0%, #20c997 100%)',
                'error': 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)',
                'warning': 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)'
            };

            notificacion.style.background = colores[tipo] || colores.success;
            notificacion.textContent = mensaje;
            
            document.body.appendChild(notificacion);

            // Remover despuÃ©s de 5 segundos
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notificacion.parentNode) {
                            notificacion.parentNode.removeChild(notificacion);
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Crear tarjeta de recogida - MODIFICADA PARA LIQUIDACIÃ“N AUTOMÃTICA
function crearTarjetaRecogida(recogida, numero) {
    const div = document.createElement('div');
    div.className = 'recogida-card';

    // ğŸ”¥ USAR LA MISMA FUNCIÃ“N DE FORMATEO QUE EN HISTORIAL
    const fecha = formatearFecha(recogida.fecha);
    const totalPesas = recogida.pesas ? recogida.pesas.length : 0;

    // Determinar estado de liquidaciÃ³n
    const estadoLiquidacion = recogida.estadoLiquidacion;
    let badgeEstado = '';
    let mostrarBotonLiquidar = !estadoLiquidacion || estadoLiquidacion === 'pendiente';

    if (estadoLiquidacion) {
        const colores = {
            'pendiente': 'background: #ffc107; color: #000;',
            'liquidada': 'background: #28a745; color: white;',
            'cancelada': 'background: #dc3545; color: white;'
        };
        const textos = {
            'pendiente': 'â³ Pendiente',
            'liquidada': 'âœ… Liquidada',
            'cancelada': 'âŒ Cancelada'
        };
        
        badgeEstado = `<span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; ${colores[estadoLiquidacion]}">${textos[estadoLiquidacion]}</span>`;
    }

    div.innerHTML = `
        <div class="recogida-header">
            <div class="recogida-fecha">ğŸ“… ${fecha} - Recogida #${numero}</div>
            <div style="display: flex; align-items: center; gap: 10px;">
                ${badgeEstado}
                <div style="font-size: 14px; color: #6c757d;">ğŸ‘¤ ${recogida.alias || recogida.usuario}</div>
            </div>
        </div>
        
        <div class="recogida-info">
            <div class="info-item">
                <strong>${recogida.fruta || 'N/A'}</strong>
                <span>Fruta Principal</span>
            </div>

            <div class="info-item">
                <strong>${recogida.totalKilos || 0} kg</strong>
                <span>Total Kilos</span>
            </div>
            ${!isSubusuario ? `
            <div class="info-item">
                <strong>${(recogida.valorPagar || 0).toLocaleString()}</strong>
                <span>Valor Total</span>
            </div>
            ` : ''}
            <div class="info-item">
                <strong>${totalPesas}</strong>
                <span>Pesas</span>
            </div>
        </div>

        ${mostrarBotonLiquidar ? `
        <button class="btn-liquidar" onclick="liquidarRecogidaAutomatica('${recogida._id}')">
            ğŸ’° LIQUIDAR AHORA
        </button>
        ` : estadoLiquidacion === 'liquidada' ? `
        <div style="text-align: center; padding: 15px; background: #d4edda; border-radius: 10px; margin-top: 15px;">
            <strong style="color: #155724;">âœ… RECOGIDA LIQUIDADA</strong>
            <div style="font-size: 12px; color: #155724; margin-top: 5px;">
                ${recogida.fechaLiquidacion ? `Liquidada el ${formatearFecha(recogida.fechaLiquidacion)}` : ''}
                ${recogida.usuarioLiquida ? ` por ${recogida.usuarioLiquida}` : ''}
            </div>
        </div>
        ` : ''}
    `;

    return div;
}
        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            recogidasFiltradas = [...todasLasRecogidas];
            filtrarRecogidas(); // Usar filtrarRecogidas para mantener el filtro de activas
        }

        // Volver al dashboard
        function volverDashboard() {
            window.history.back();
        }


        // -------------------------------------------------
//  Helper: Blob â†’ base64 (para Capacitor)
// -------------------------------------------------
function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend  = () => resolve(reader.result.split(',')[1]);
    reader.onerror    = reject;
    reader.readAsDataURL(blob);
  });
}

        // Generar recibo de liquidaciÃ³n con mÃºltiples pÃ¡ginas - SOLO RECOGIDAS ACTIVAS
// REEMPLAZAR COMPLETAMENTE la funciÃ³n generarReciboLiquidacion() en liquidacion.html

// Generar recibo de liquidaciÃ³n con mÃºltiples pÃ¡ginas - SOLO RECOGIDAS ACTIVAS
async function generarReciboLiquidacion() {
    if (recogidasFiltradas.length === 0) {
        alert('No hay recogidas activas para generar el recibo');
        return;
    }

    try {
        console.log('ğŸš€ Iniciando generaciÃ³n de recibo de liquidaciÃ³n de recogidas ACTIVAS...');
        
        // Procesar datos para el recibo - SOLO RECOGIDAS FILTRADAS ACTIVAS
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;
        
        const resumenPorFrutaCalidad = {};
        let totalKilosGeneral = 0;
        let totalValorGeneral = 0;
        let totalPesasGeneral = 0;

        console.log('ğŸ“Š Procesando', recogidasFiltradas.length, 'recogidas activas filtradas...');

        recogidasFiltradas.forEach(recogida => {
            totalKilosGeneral += recogida.totalKilos || 0;
            totalValorGeneral += recogida.valorPagar || 0;
            
            if (recogida.pesas) {
                totalPesasGeneral += recogida.pesas.length;
                
                recogida.pesas.forEach(pesa => {
                    const fruta = pesa.fruta || recogida.fruta || 'Sin especificar';
                    const calidad = pesa.calidad || recogida.calidad || 'Sin especificar';
                    const precio = pesa.precio || recogida.precio || 0;
                    const clave = `${fruta} - ${calidad}`;
                    
                    if (!resumenPorFrutaCalidad[clave]) {
                        resumenPorFrutaCalidad[clave] = {
                            kilos: 0,
                            valor: 0,
                            precio: precio,
                            cantidad: 0
                        };
                    }
                    
                    resumenPorFrutaCalidad[clave].kilos += pesa.kilos || 0;
                    resumenPorFrutaCalidad[clave].valor += pesa.valor || 0;
                    resumenPorFrutaCalidad[clave].cantidad += 1;
                });
            }
        });

        console.log('ğŸ“‹ Resumen procesado:', Object.keys(resumenPorFrutaCalidad).length, 'combinaciones fruta-calidad');

        // Crear mensaje de texto para fallback
        const mensaje = `ğŸ’° Recogidas Pendientes - ${fincaNombre}
ğŸ“Š ${recogidasFiltradas.length} recogidas activas
âš–ï¸ ${totalKilosGeneral} kg`;

        // ğŸ”¥ CAPACITOR: ImplementaciÃ³n directa sin html2canvas
        if (isCapacitor()) {
            try {
                console.log('ğŸ“± Modo Capacitor - generando imagen directamente...');
                
                // Verificar plugins
                const { Share, Filesystem } = window.Capacitor.Plugins;
                if (!Share || !Filesystem) {
                    throw new Error('Plugins no disponibles');
                }

                // Crear imagen usando Canvas API directamente
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Configurar dimensiones
                canvas.width = 800;
                canvas.height = 1000;
                
                // Fondo
                ctx.fillStyle = '#f5f7fa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Configurar texto
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'center';
                
                let y = 80;
                
                // TÃ­tulo
                ctx.fillText('â³ LIQUIDACIÃ“N', canvas.width / 2, y);
                y += 60;
                
                // InformaciÃ³n de finca
                ctx.font = '20px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`ğŸ  Finca: ${fincaNombre || 'Sin especificar'}`, 50, y);
                y += 40;
                ctx.fillText(`ğŸ‘¤ Propietario: ${propietario || 'Sin especificar'}`, 50, y);
                y += 40;
                ctx.fillText(`â³ Recogidas Pendientes: ${recogidasFiltradas.length}`, 50, y);
                y += 60;
                
                // Resumen por fruta y calidad
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ“‹ RESUMEN POR FRUTA Y CALIDAD', canvas.width / 2, y);
                y += 40;
                
                ctx.font = '18px Arial';
                ctx.textAlign = 'left';
                
                Object.entries(resumenPorFrutaCalidad).forEach(([clave, datos]) => {
                    ctx.fillText(`${clave}`, 50, y);
                    ctx.fillText(`${datos.kilos} kg`, 400, y);
                    if (!isSubusuario) {
                        ctx.fillText(`$${datos.precio.toLocaleString()}/kg`, 500, y);
                        ctx.fillText(`$${datos.valor.toLocaleString()}`, 650, y);
                    }
                    y += 30;
                });
                
                y += 40;
                
                // Totales
                ctx.font = 'bold 28px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('â³ TOTALES', canvas.width / 2, y);
                y += 40;
                
                ctx.font = 'bold 22px Arial';
                ctx.fillText(`âš–ï¸ ${totalKilosGeneral} kg`, canvas.width / 2, y);
                y += 35;
                
                if (!isSubusuario) {
                    ctx.fillText(`ğŸ’° $${totalValorGeneral.toLocaleString()}`, canvas.width / 2, y);
                }
                
                // Fecha de generaciÃ³n
                y = canvas.height - 30;
                ctx.font = '16px Arial';
                ctx.textAlign = 'right';
                ctx.fillStyle = '#95a5a6';
                ctx.fillText(`Generado: ${new Date().toLocaleString('es-ES')}`, canvas.width - 30, y);
                
                console.log('ğŸ¨ Canvas creado exitosamente');
                
                // Convertir canvas a blob
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/png', 1.0);
                });
                
                console.log('ğŸ“¸ Imagen generada, tamaÃ±o:', blob.size);
                
                // Convertir a base64
             // ENCONTRAR Y REEMPLAZAR esta secciÃ³n en tu archivo liquidacion.html
// Buscar desde "// Convertir a base64" hasta el final del reader.onload

// Convertir a base64
const reader = new FileReader();
reader.onload = async function() {
    try {
        const base64Data = reader.result.split(',')[1];
        console.log('ğŸ”„ Imagen convertida a base64, tamaÃ±o:', base64Data.length);
        
        // Generar nombre Ãºnico
        const nombreArchivo = `liquidacion_${fincaNombre.replace(/\s+/g, '_')}_${Date.now()}.png`;
        console.log('ğŸ’¾ Guardando como:', nombreArchivo);
        
        // ğŸ”¥ USAR DIRECTORIO DOCUMENTS EN LUGAR DE CACHE
        console.log('ğŸ“ Verificando directorios disponibles...');
        
        let directorioAUsar;
        try {
            // Verificar quÃ© directorios estÃ¡n disponibles
            if (Filesystem.Directory && Filesystem.Directory.Documents) {
                directorioAUsar = Filesystem.Directory.Documents;
                console.log('ğŸ“ Usando Directory.Documents');
            } else if (Filesystem.Directory && Filesystem.Directory.Data) {
                directorioAUsar = Filesystem.Directory.Data;
                console.log('ğŸ“ Usando Directory.Data');
            } else {
                // Ãšltimo recurso: usar string directamente
                directorioAUsar = 'DOCUMENTS';
                console.log('ğŸ“ Usando string DOCUMENTS como fallback');
            }
        } catch (dirError) {
            console.warn('âš ï¸ Error verificando directorios:', dirError);
            directorioAUsar = 'DOCUMENTS';
        }
        
        // Intentar guardar archivo
        try {
  const fileResult = await Filesystem.writeFile({
  path: nombreArchivo,
  data: base64Data,
  directory: 'CACHE'           // â† string directo, siempre disponible // â† Sin encoding, usa Cache
});
            console.log('ğŸ’¾ Archivo guardado exitosamente:', fileResult.uri);
            
            // Compartir usando el archivo guardado
          await Share.share({
  title: 'Recibo de LiquidaciÃ³n',
  text: mensaje,
  url: fileResult.uri  // â† URI real del archivo guardado
});
            
            console.log('ğŸ“¤ Compartido exitosamente:', shareResult);
            
            // Limpiar despuÃ©s de 10 segundos
            setTimeout(async () => {
                try {
                    await Filesystem.deleteFile({
                        path: nombreArchivo,
                        directory: directorioAUsar
                    });
                    console.log('ğŸ—‘ï¸ Archivo temporal eliminado');
                } catch (e) {
                    console.warn('âš ï¸ No se pudo eliminar archivo temporal:', e);
                }
            }, 10000);
            
        } catch (filesystemError) {
            console.error('âŒ Error con Filesystem:', filesystemError);
            
            // ğŸ”¥ MÃ‰TODO ALTERNATIVO: Compartir directamente como data URL
            console.log('ğŸ”„ Intentando mÃ©todo alternativo con data URL...');
            try {
                const dataUrl = reader.result; // Usar el data URL completo
                const shareResult = await Share.share({
                    title: 'Recibo de LiquidaciÃ³n',
                    text: mensaje,
                    url: dataUrl,
                    dialogTitle: 'Compartir recibo'
                });
                console.log('âœ… Compartido con data URL exitosamente:', shareResult);
                
            } catch (dataUrlError) {
                console.error('âŒ Error con data URL:', dataUrlError);
                
                // ÃšLTIMO RECURSO: Mostrar mensaje de error
                alert(`Error al compartir imagen: ${filesystemError.message}\n\nPor favor, verifica los permisos de la aplicaciÃ³n.`);
            }
        }
        
    } catch (error) {
        console.error('âŒ Error general al procesar imagen:', error);
        alert('Error al generar/compartir imagen: ' + error.message);
    }
};

reader.readAsDataURL(blob);
                
            } catch (capacitorError) {
                console.error('âŒ Error en Capacitor:', capacitorError);
                alert('Error al generar imagen en Capacitor: ' + capacitorError.message);
            }
            
            return; // Salir aquÃ­ para Capacitor
        }

        // ğŸŒ NAVEGADOR WEB: CÃ³digo original con html2canvas
        console.log('ğŸŒ Modo navegador web - usando html2canvas...');
        
        const entradasResumen = Object.entries(resumenPorFrutaCalidad);
        const ITEMS_POR_PAGINA = 15;
        const totalPaginas = Math.ceil(entradasResumen.length / ITEMS_POR_PAGINA);
        
        console.log('ğŸ“„ Se generarÃ¡n', totalPaginas, 'pÃ¡ginas de recibo');

        const archivos = [];

        // Generar cada pÃ¡gina
        for (let i = 0; i < totalPaginas; i++) {
            const inicio = i * ITEMS_POR_PAGINA;
            const fin = Math.min(inicio + ITEMS_POR_PAGINA, entradasResumen.length);
            const entradasPagina = entradasResumen.slice(inicio, fin);
            
            console.log(`ğŸ“„ Generando pÃ¡gina ${i + 1}/${totalPaginas} con ${entradasPagina.length} elementos`);

            // Convertir de vuelta a objeto para esta pÃ¡gina
            const resumenPagina = {};
            entradasPagina.forEach(([clave, datos]) => {
                resumenPagina[clave] = datos;
            });

            // Crear pÃ¡gina de recibo
            const divRecibo = crearReciboLiquidacionPaginado(
                resumenPagina,
                totalKilosGeneral,
                totalValorGeneral,
                totalPesasGeneral,
                recogidasFiltradas.length,
                fechaInicio,
                fechaFin,
                i + 1,
                totalPaginas
            );

            document.body.appendChild(divRecibo);
            await document.fonts.ready;

            // Generar imagen
            const canvas = await html2canvas(divRecibo, {
                scale: 3,
                useCORS: true,
                allowTaint: false,
                backgroundColor: '#ffffff',
                width: divRecibo.offsetWidth,
                height: divRecibo.offsetHeight,
                logging: false,
                imageTimeout: 0
            });

            document.body.removeChild(divRecibo);

            // Crear archivo
            const blob = await new Promise(resolve => 
                canvas.toBlob(resolve, "image/png", 1.0)
            );
            
            const nombreArchivo = totalPaginas > 1 ? 
                `liquidacion_pendiente_${fincaNombre}_pagina_${i + 1}.png` :
                `liquidacion_pendiente_${fincaNombre}.png`;
            
            const file = new File([blob], nombreArchivo, { type: "image/png" });
            archivos.push(file);
        }

        // Compartir navegador web
        if (navigator.share) {
            await navigator.share({
                title: 'Recibo de LiquidaciÃ³n',
                text: mensaje,
                files: archivos,
            });
        } else {
            await navigator.clipboard.writeText(mensaje);
            alert("ğŸ“‹ Recibo copiado al portapapeles");
        }

        console.log('âœ… Recibo generado y compartido exitosamente');

    } catch (error) {
        console.error('âŒ Error generando recibo:', error);
        mostrarNotificacion('âŒ Error al generar recibo: ' + error.message, 'error');
    }
}

        // Crear recibo de liquidaciÃ³n paginado con el mismo estilo - ACTUALIZADO PARA PENDIENTES
  function crearReciboLiquidacionPaginado(resumen, totalKilos, totalValor, totalPesas, totalRecogidas, fechaInicio, fechaFin, numeroPagina, totalPaginasRecibo) {
            const div = document.createElement("div");
            div.style.cssText = `
                width: 800px;
                min-height: 1000px;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                color: #2c3e50;
                font-family: 'Arial', sans-serif;
                padding: 30px;
                margin: 0;
                box-sizing: border-box;
                position: relative;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            `;

            // Formatear perÃ­odo correctamente
            let periodo = 'Todas las fechas';
            if (fechaInicio && fechaFin) {
                const fechaInicioObj = new Date(fechaInicio + 'T00:00:00');
                const fechaFinObj = new Date(fechaFin + 'T00:00:00');
                periodo = `${fechaInicioObj.toLocaleDateString('es-ES')} - ${fechaFinObj.toLocaleDateString('es-ES')}`;
            } else if (fechaInicio) {
                const fechaInicioObj = new Date(fechaInicio + 'T00:00:00');
                periodo = `Desde ${fechaInicioObj.toLocaleDateString('es-ES')}`;
            } else if (fechaFin) {
                const fechaFinObj = new Date(fechaFin + 'T00:00:00');
                periodo = `Hasta ${fechaFinObj.toLocaleDateString('es-ES')}`;
            }

            const tituloRecibo = totalPaginasRecibo > 1 ? 
                `â³ LIQUIDACIÃ“N - PÃGINA ${numeroPagina}/${totalPaginasRecibo}` :
                `â³  LIQUIDACIÃ“N`;

            div.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="margin: 0; font-size: 42px; font-weight: bold; color: #34495e;">
                        ${tituloRecibo}
                    </h1>
                    <div style="width: 60px; height: 4px; background: linear-gradient(to right, #f39c12, #e67e22); margin: 15px auto; border-radius: 2px;"></div>
                    ${totalPaginasRecibo > 1 ? `<p style="margin: 5px 0; font-size: 18px; color: #7f8c8d;">PÃ¡gina ${numeroPagina} de ${totalPaginasRecibo}</p>` : ''}
                </div>

                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; margin-bottom: 25px; backdrop-filter: blur(10px);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 20px;">
                        <div><strong>ğŸ  Finca:</strong> ${fincaNombre || 'Sin especificar'}</div>
                        <div><strong>ğŸ‘¤ Propietario:</strong> ${propietario || 'Sin especificar'}</div>
                        <div><strong>ğŸ“… PerÃ­odo:</strong> ${periodo}</div>
                        <div><strong>â³ Recogidas Pendientes:</strong> ${totalRecogidas}</div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; margin-bottom: 25px; backdrop-filter: blur(10px);">
                    <h3 style="margin: 0 0 25px 0; text-align: center; font-size: 26px;">ğŸ“‹ RESUMEN POR FRUTA Y CALIDAD </h3>
                    <div style="display: grid; gap: 18px;">
                        ${Object.entries(resumen).map(([clave, datos]) => `
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; display: grid; grid-template-columns: 2.5fr 1fr 1fr 1fr ${!isSubusuario ? '1.2fr' : ''}; gap: 18px; align-items: center; color: #2c3e50; box-shadow: 0 3px 10px rgba(0,0,0,0.1); font-size: 24px;">
                            <div style="font-weight: bold; color: #2c3e50;">${clave}</div>
                            <div style="text-align: center; color: #2c3e50; font-weight: 600;">${datos.kilos} kg</div>
                            <div style="text-align: center; color: #2c3e50;">${datos.precio.toLocaleString()}/kg</div>
                            ${!isSubusuario ? `<div style="text-align: center; color: #2c3e50; font-weight: bold;">${datos.valor.toLocaleString()}</div>` : ''}
                        </div>
                        `).join('')}
                    </div>
                </div>

                ${numeroPagina === totalPaginasRecibo ? `
                <div style="background: rgba(255,255,255,0.15); padding: 25px; border-radius: 15px; text-align: center; margin-top: 30px;">
                    <h2 style="margin: 0 0 15px 0; font-size: 32px; color: #2c3e50; font-weight: bold;">
                        â³ TOTALES
                    </h2>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 25px; margin-top: 20px; font-size: 22px; opacity: 0.9; flex-wrap: wrap;">
                        <span style="color: #2c3e50; font-weight: bold; background: rgba(243, 156, 18, 0.2); padding: 12px 18px; border-radius: 20px;">âš–ï¸ ${totalKilos} kg</span>
                        ${!isSubusuario ? `<span style="color: #2c3e50; font-weight: bold; background: rgba(243, 156, 18, 0.2); padding: 12px 18px; border-radius: 20px;">ğŸ’° ${totalValor.toLocaleString()}</span>` : ''}
                    </div>
                </div>
                ` : `
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px; border: 2px dashed rgba(255,255,255,0.3);">
                    <p style="margin: 0; font-size: 20px; color: #2c3e50; opacity: 0.7;">
                        ğŸ“„ ContinÃºa en la pÃ¡gina ${numeroPagina + 1}/${totalPaginasRecibo}
                    </p>
                </div>
                `}

                <div style="position: absolute; bottom: 20px; right: 30px; font-size: 16px; color: #95a5a6;">
                    Generado: ${new Date().toLocaleString('es-ES')}
                </div>
            `;

            return div;
        }
    </script>
</body>
</html>