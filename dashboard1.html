<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Tipo 1</title>
  <link rel="stylesheet" href="style.css">
  <script src="jc-loader.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .card-glass {
      background: var(--glass-bg, rgba(255, 255, 255, 0.1));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .finca-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .finca-title {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary-color, #00d4ff);
      margin-bottom: 5px;
    }

    .propietario {
      opacity: 0.8;
      font-size: 0.95em;
    }

    .recogida-info {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }

    .info-label {
      font-weight: bold;
      opacity: 0.8;
    }

    .info-value {
      color: var(--primary-color, #00d4ff);
      font-weight: bold;
    }

    .sin-recogidas {
      text-align: center;
      opacity: 0.6;
      font-style: italic;
      padding: 20px;
    }

    .botones-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .botones-container button {
      flex: 1;
      min-width: 120px;
      padding: 8px 12px;
      font-size: 0.85em;
    }

    .loading-info {
      opacity: 0.6;
      text-align: center;
      padding: 10px;
      font-style: italic;
    }

    .historial-btn {
      position: absolute;
      transform: translateX(-270px);

}

.historial-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}


  </style>
</head>
<body>
 

  
  <div class="container">
    <h1 id="saludo">Bienvenido</h1>
    <button id="btnAgregarFinca">‚ûï Agregar Finca</button>
    <input type="text" id="buscarFinca" placeholder="Buscar finca o propietario...">
    <div id="listaFincas"></div>
  </div>

  <div id="modalFinca" class="modal hidden">
    <div class="modal-content">
      <h3>Agregar Finca</h3>
      <input type="text" id="nombreFinca" placeholder="Nombre de la finca">
      <input type="text" id="propietarioFinca" placeholder="Nombre del propietario">
      <button id="guardarFinca">Guardar</button>
    </div>
  </div>

  

 <script type="module">
  import { apiFetch } from "./api.js";

  // üîç DEBUG: Verificar la URL completa
  console.log("=== URL Y PAR√ÅMETROS ===");
  console.log("URL completa:", window.location.href);
  console.log("Search params:", window.location.search);

  // Obtener los par√°metros de la URL
  const params = new URLSearchParams(window.location.search);
  const usuario = params.get("usuario");
  let alias = params.get("alias");
  let adminAlias = alias; // üîß Para admins, su propio alias es el adminAlias

  // Si no se encuentra alias en la URL, hacer una llamada al servidor para obtenerlo
  if (!alias && usuario) {
    console.log("Alias no encontrado en la URL, haciendo una llamada al servidor para obtenerlo...");

    // Llamar al backend para obtener el alias basado en el usuario (usamos apiFetch para esto)
    async function obtenerAliasDesdeServidor() {
      try {
        const response = await apiFetch(`/auth/get-alias?usuario=${usuario}`, "GET");
        alias = response.alias || 'Alias no disponible'; // Asignamos el alias obtenido o un valor por defecto
        adminAlias = alias; // üîß Para admins, su propio alias es el adminAlias
        console.log("Alias obtenido desde el servidor:", alias);
        
        // Actualizar el saludo o lo que sea necesario con el alias
        mostrarUsuarioYAlias();
      } catch (error) {
        console.error("Error al obtener alias desde el servidor:", error);
        alias = 'Alias no disponible'; // Si ocurre un error, asignamos un valor por defecto
        adminAlias = alias;
        mostrarUsuarioYAlias();
      }
    }

    // Llamada a la funci√≥n para obtener el alias
    obtenerAliasDesdeServidor();
  } else {
    // Si el alias est√° presente en la URL, simplemente lo mostramos
    console.log("Alias encontrado en la URL:", alias);
    adminAlias = alias; // üîß Para admins, su propio alias es el adminAlias
    mostrarUsuarioYAlias();
  }

  // üî• FUNCI√ìN PARA CREAR EL BOT√ìN DE HISTORIAL DE RECOGIDAS
function crearBotonHistorialRecogidas() {
  // Verificar si ya existe el bot√≥n
  const existingButton = document.getElementById('historial-recogidas-btn');
  if (existingButton) return;

  // Obtener par√°metros de URL
  const params = new URLSearchParams(window.location.search);
  const usuario = params.get('usuario');
  const alias = params.get('alias');

  if (!usuario) {
    console.warn('‚ö†Ô∏è No se encontr√≥ usuario en los par√°metros URL');
    return;
  }

  // Crear el bot√≥n
  const button = document.createElement('button');
  button.id = 'historial-recogidas-btn';
  button.className = 'historial-btn';
  button.innerHTML = 'üìä Historial Completo';
  
  // Estilos del bot√≥n
  button.style.cssText = `
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    font-size: 1rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    margin: 10px;
    min-width: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  `;

  // Efectos hover
  button.addEventListener('mouseenter', () => {
    button.style.transform = 'translateY(-2px)';
    button.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.4)';
    button.style.background = 'linear-gradient(135deg, #5a6fd8, #6a4c93)';
  });

  button.addEventListener('mouseleave', () => {
    button.style.transform = 'translateY(0)';
    button.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.3)';
    button.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
  });

  // Funcionalidad del bot√≥n
  button.addEventListener('click', () => {
    // Construir URL del historial completo
    let historialUrl = `historial-recogidas.html?usuario=${encodeURIComponent(usuario)}`;
    
    if (alias) {
      historialUrl += `&alias=${encodeURIComponent(alias)}`;
    }

    console.log('üìä Navegando al historial completo:', historialUrl);
    
    // Mostrar indicador de carga
    button.innerHTML = '‚è≥ Cargando...';
    button.disabled = true;
    
    // Redirigir despu√©s de un breve delay para mostrar el estado de carga
    setTimeout(() => {
      window.location.href = historialUrl;
    }, 300);
  });

  return button;
}

// üî• FUNCI√ìN PARA INSERTAR EL BOT√ìN SIEMPRE ARRIBA Y FUERA DEL CONTAINER
function insertarBotonHistorial() {
  const button = crearBotonHistorialRecogidas();
  if (!button) return;

  // Siempre insertar arriba, fuera del container
  insertarArribaFueraContainer(button);
}

// üî• INSERTAR SIEMPRE ARRIBA, FUERA DEL CONTAINER
function insertarArribaFueraContainer(button) {
  // Crear un contenedor fijo en la parte superior
  const topContainer = document.createElement('div');
  topContainer.id = 'historial-top-container';
  topContainer.style.cssText = `
    position: absolute;
    top: 10px;
    left: -2
    
    0px;
    right: 0;

  `;

  // Ajustar estilos del bot√≥n para la posici√≥n superior
  button.style.cssText = `
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.95rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-width: 180px;
  `;

  // Agregar el bot√≥n al contenedor
  topContainer.appendChild(button);

  // Insertar al principio del body (antes que todo)
  document.body.insertBefore(topContainer, document.body.firstChild);

  // Ajustar el body para que no se superponga con el bot√≥n fijo
  adjustBodyForFixedButton();

  console.log('‚úÖ Bot√≥n insertado arriba, fuera del container');
}

// üî• AJUSTAR EL BODY PARA EL BOT√ìN FIJO
function adjustBodyForFixedButton() {
  // Agregar padding-top al body o al primer container
  const body = document.body;
  const container = document.querySelector('.container');
  
  // Calcular altura del bot√≥n (aproximadamente 60px incluyendo padding)
  const buttonHeight = '70px';
  
  if (container) {
    // Si hay container, agregarle margen superior
    container.style.marginTop = buttonHeight;
  } else {
    // Si no hay container, ajustar el body
    body.style.paddingTop = buttonHeight;
  }

  // Ajustar cualquier elemento que pueda tener position fixed en el top
  const existingFixedElements = document.querySelectorAll('[style*="position: fixed"][style*="top:"]');
  existingFixedElements.forEach(element => {
    const currentTop = element.style.top;
    if (currentTop === '0px' || currentTop === '0') {
      element.style.top = buttonHeight;
    }
  });
}

// üî• FUNCI√ìN PARA VERIFICAR PERMISOS DEL USUARIO
async function verificarPermisosHistorial() {
  try {
    const params = new URLSearchParams(window.location.search);
    const usuario = params.get('usuario');
    
    if (!usuario) return false;

    // Verificar desde sessionStorage primero
    const storedData = sessionStorage.getItem('userData');
    if (storedData) {
      const userData = JSON.parse(storedData);
      return userData.tipo === 1 || userData.tipo === 2; // Admin o Subusuario
    }

    // Si no hay datos en session, consultar servidor
    const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
    if (response.ok) {
      const userData = await response.json();
      return userData.tipo === 1 || userData.tipo === 2; // Admin o Subusuario
    }

    return false;
  } catch (error) {
    console.error('‚ùå Error al verificar permisos:', error);
    return false;
  }
}

// üî• FUNCI√ìN PRINCIPAL PARA INICIALIZAR EL BOT√ìN
async function inicializarBotonHistorial() {
  // Verificar permisos primero
  const tienePermisos = await verificarPermisosHistorial();
  
  if (!tienePermisos) {
    console.log('‚ÑπÔ∏è Usuario sin permisos para ver historial completo');
    return;
  }

  // Verificar que no estemos ya en la p√°gina de historial completo
  if (window.location.pathname.includes('historial-recogidas.html')) {
    console.log('‚ÑπÔ∏è Ya estamos en la p√°gina de historial completo');
    return;
  }

  // Insertar el bot√≥n
  insertarBotonHistorial();
}

// üî• ESTILOS RESPONSIVOS PARA EL BOT√ìN FIJO SUPERIOR
function agregarEstilosResponsivos() {
  const style = document.createElement('style');
  style.textContent = `
    /* Estilos para el contenedor superior fijo */
    #historial-top-container {
      transition: all 0.3s ease;
    }

    /* Efectos hover para el bot√≥n en posici√≥n fija */
    #historial-top-container .historial-btn:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4) !important;
      background: linear-gradient(135deg, #5a6fd8, #6a4c93) !important;
    }

    #historial-top-container .historial-btn:active {
      transform: translateY(0) !important;
    }

    /* Responsive para tablets */
    @media (max-width: 768px) {
      #historial-top-container {
        padding: 8px 15px;
      }

      #historial-top-container .historial-btn {
        padding: 10px 20px;
        font-size: 0.9rem;
        min-width: 160px;
      }

      /* Ajustar margen del body/container */
      body[style*="padding-top"] {
        padding-top: 60px !important;
      }
      .container[style*="margin-top"] {
        margin-top: 60px !important;
      }
    }

    /* Responsive para m√≥viles */
    @media (max-width: 480px) {
      #historial-top-container {
        padding: 6px 10px;
      }

      #historial-top-container .historial-btn {
        padding: 8px 16px;
        font-size: 0.85rem;
        min-width: 140px;
        gap: 6px;
      }

      /* Ajustar margen del body/container para m√≥viles */
      body[style*="padding-top"] {
        padding-top: 50px !important;
      }
      .container[style*="margin-top"] {
        margin-top: 50px !important;
      }
    }

    /* Animaci√≥n de aparici√≥n desde arriba */
    #historial-top-container {
      animation: slideDownFromTop 0.5s ease forwards;
    }

    @keyframes slideDownFromTop {
      from {
        opacity: 0;
        transform: translateY(-100%);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Efecto glassmorphism mejorado */
    #historial-top-container {
      background: rgba(255, 255, 255, 0.9) !important;
      backdrop-filter: blur(20px) !important;
      -webkit-backdrop-filter: blur(20px) !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
    }

    /* Para temas oscuros (opcional) */
    @media (prefers-color-scheme: dark) {
      #historial-top-container {
        background: rgba(0, 0, 0, 0.8) !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
      }
    }

    /* Asegurar que est√© por encima de todo */
    #historial-top-container {
      z-index: 99999 !important;
    }

    /* Evitar interferencia con elementos existentes */
    body.has-fixed-historial-btn {
      transition: padding-top 0.3s ease;
    }

    .container.has-fixed-historial-btn {
      transition: margin-top 0.3s ease;
    }
  `;
  document.head.appendChild(style);
}

// üî• INICIALIZAR TODO AL CARGAR LA P√ÅGINA
document.addEventListener('DOMContentLoaded', () => {
  // Agregar estilos responsivos
  agregarEstilosResponsivos();
  
  // Inicializar el bot√≥n con un peque√±o delay para asegurar que la p√°gina est√© lista
  setTimeout(() => {
    inicializarBotonHistorial();
  }, 500);
});

// üî• TAMBI√âN INICIALIZAR SI LA P√ÅGINA YA EST√Å CARGADA
if (document.readyState === 'loading') {
  // El evento DOMContentLoaded se ejecutar√°
} else {
  // La p√°gina ya est√° cargada
  setTimeout(() => {
    agregarEstilosResponsivos();
    inicializarBotonHistorial();
  }, 100);
}

// üî• FUNCI√ìN PARA LIMPIAR EL BOT√ìN AL SALIR DE LA P√ÅGINA (opcional)
window.addEventListener('beforeunload', () => {
  const topContainer = document.getElementById('historial-top-container');
  if (topContainer) {
    topContainer.remove();
  }
  
  // Restaurar el padding/margin original del body/container
  const body = document.body;
  const container = document.querySelector('.container');
  
  if (body.style.paddingTop) {
    body.style.paddingTop = '';
  }
  
  if (container && container.style.marginTop) {
    container.style.marginTop = '';
  }
});

  // Funci√≥n para mostrar el usuario y alias
  function mostrarUsuarioYAlias() {
    // Verificaci√≥n y consola
    console.log("=== DEBUG URL ===");
    console.log("Usuario extra√≠do de URL:", usuario);
    console.log("Alias extra√≠do de URL:", alias);
    console.log("AdminAlias asignado:", adminAlias);

    // Mostrar usuario y alias juntos
    console.log("Usuario y Alias:", `Usuario: ${usuario}, Alias: ${alias || 'No disponible'}`);
    console.log("=== FIN DEBUG URL ===");

    // Saludo con el nombre de usuario
    const saludo = document.getElementById("saludo");
    if (usuario) {
      saludo.textContent = `Bienvenido, ${alias}`;
    } else {
      saludo.textContent = "Bienvenido (usuario no identificado)";
    }
  }

    const btnAgregar = document.getElementById("btnAgregarFinca");
    const modal = document.getElementById("modalFinca");
    const guardar = document.getElementById("guardarFinca");
    const lista = document.getElementById("listaFincas");

    // ‚úÖ Variables globales
    let todasLasFincas = [];

    // Funci√≥n para obtener informaci√≥n de la √∫ltima recogida
    async function obtenerInfoRecogida(fincaId) {
      try {
        const recogidas = await apiFetch(`/recogidas/por-finca/${fincaId}`, "GET");
        
        if (!recogidas || recogidas.length === 0) {
          return null;
        }

        // Obtener la √∫ltima recogida
        const ultimaRecogida = recogidas[0];
        
        // Calcular estad√≠sticas generales
        const totalRecogidas = recogidas.length;
        const totalKilosAcumulado = recogidas.reduce((sum, r) => sum + (r.totalKilos || 0), 0);
        const totalPagadoAcumulado = recogidas.reduce((sum, r) => sum + (r.valorPagar || 0), 0);
        
        return {
          ultimaRecogida,
          totalRecogidas,
          totalKilosAcumulado,
          totalPagadoAcumulado
        };
      } catch (error) {
        console.error("Error al obtener informaci√≥n de recogidas:", error);
        return null;
      }
    }

function formatearFecha(fecha) {
  if (!fecha) return "No disponible";
  
  try {
    // Si la fecha viene como string de tipo "2024-01-15" (formato YYYY-MM-DD)
    if (typeof fecha === 'string' && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
      const [year, month, day] = fecha.split('-');
      return `${day}/${month}/${year}`;
    }
    
    // Si la fecha viene como ISO string o timestamp
    const date = new Date(fecha);
    
    // üî• SOLUCI√ìN: Usar getUTCDate, getUTCMonth, getUTCFullYear para evitar problemas de zona horaria
    const dia = String(date.getUTCDate()).padStart(2, '0');
    const mes = String(date.getUTCMonth() + 1).padStart(2, '0'); // getUTCMonth() devuelve 0-11
    const a√±o = date.getUTCFullYear();
    
    return `${dia}/${mes}/${a√±o}`;
  } catch (error) {
    console.error("‚ùå Error al formatear fecha:", error, "Fecha recibida:", fecha);
    return "Fecha inv√°lida";
  }
}

function formatearFechaLocal(fecha) {
  if (!fecha) return "No disponible";
  
  try {
    const date = new Date(fecha);
    
    // Verificar que la fecha sea v√°lida
    if (isNaN(date.getTime())) {
      return "Fecha inv√°lida";
    }
    
    // Usar m√©todos locales pero ajustando por el offset de zona horaria
    const dia = String(date.getDate()).padStart(2, '0');
    const mes = String(date.getMonth() + 1).padStart(2, '0');
    const a√±o = date.getFullYear();
    
    return `${dia}/${mes}/${a√±o}`;
  } catch (error) {
    console.error("‚ùå Error al formatear fecha local:", error, "Fecha recibida:", fecha);
    return "Fecha inv√°lida";
  }
}


function formatearFechaConDebug(fecha) {
  if (!fecha) return "No disponible";
  
  console.log("üîç DEBUG FECHA:");
  console.log("  - Fecha original:", fecha);
  console.log("  - Tipo:", typeof fecha);
  
  try {
    const date = new Date(fecha);
    console.log("  - Date object:", date);
    console.log("  - getDate():", date.getDate());
    console.log("  - getUTCDate():", date.getUTCDate());
    console.log("  - Timezone offset:", date.getTimezoneOffset());
    
    // Usar UTC para evitar problemas de zona horaria
    const dia = String(date.getUTCDate()).padStart(2, '0');
    const mes = String(date.getUTCMonth() + 1).padStart(2, '0');
    const a√±o = date.getUTCFullYear();
    
    const fechaFormateada = `${dia}/${mes}/${a√±o}`;
    console.log("  - Fecha formateada:", fechaFormateada);
    
    return fechaFormateada;
  } catch (error) {
    console.error("‚ùå Error al formatear fecha:", error);
    return "Fecha inv√°lida";
  }
}

// üî• FUNCI√ìN ESPEC√çFICA: Para fechas que vienen del backend en formato ISO
function formatearFechaISO(fechaISO) {
  if (!fechaISO) return "No disponible";
  
  try {
    // Si es una fecha ISO como "2024-01-15T00:00:00.000Z"
    const date = new Date(fechaISO);
    
    // Crear una nueva fecha usando solo la parte de la fecha (sin hora)
    // Esto evita problemas de zona horaria
    const year = date.getUTCFullYear();
    const month = date.getUTCMonth();
    const day = date.getUTCDate();
    
    // Crear fecha local con esos valores
    const fechaLocal = new Date(year, month, day);
    
    const dia = String(fechaLocal.getDate()).padStart(2, '0');
    const mes = String(fechaLocal.getMonth() + 1).padStart(2, '0');
    const a√±o = fechaLocal.getFullYear();
    
    return `${dia}/${mes}/${a√±o}`;
  } catch (error) {
    console.error("‚ùå Error al formatear fecha ISO:", error);
    return "Fecha inv√°lida";
  }
}

// üî• FUNCI√ìN UNIVERSAL: Maneja todos los formatos de fecha comunes
function formatearFechaUniversal(fecha) {
  if (!fecha) return "No disponible";
  
  try {
    let dateObj;
    
    // Caso 1: String en formato YYYY-MM-DD
    if (typeof fecha === 'string' && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
      const [year, month, day] = fecha.split('-');
      // Crear fecha local directamente para evitar conversiones UTC
      dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
    }
    // Caso 2: String ISO o timestamp
    else {
      dateObj = new Date(fecha);
      
      // Si la fecha parece ser solo fecha (sin componente de tiempo significativo)
      // usar UTC para evitar shifts de zona horaria
      const timeComponent = dateObj.getUTCHours() + dateObj.getUTCMinutes() + dateObj.getUTCSeconds();
      
      if (timeComponent === 0) {
        // Es solo fecha, usar UTC
        const dia = String(dateObj.getUTCDate()).padStart(2, '0');
        const mes = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
        const a√±o = dateObj.getUTCFullYear();
        return `${dia}/${mes}/${a√±o}`;
      }
    }
    
    // Verificar que la fecha sea v√°lida
    if (isNaN(dateObj.getTime())) {
      return "Fecha inv√°lida";
    }
    
    // Formatear usando fecha local
    const dia = String(dateObj.getDate()).padStart(2, '0');
    const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
    const a√±o = dateObj.getFullYear();
    
    return `${dia}/${mes}/${a√±o}`;
    
  } catch (error) {
    console.error("‚ùå Error al formatear fecha universal:", error, "Fecha:", fecha);
    return "Fecha inv√°lida";
  }
}

// üî• REEMPLAZAR EN EL DASHBOARD: Usar la funci√≥n corregida
// En la funci√≥n renderFinca(), reemplazar la l√≠nea que usa formatearFecha() con:

// ANTES:
// üìä √öltima Recogida - ${formatearFecha(ultimaRecogida.fecha)}

// DESPU√âS:
// üìä √öltima Recogida - ${formatearFechaUniversal(ultimaRecogida.fecha)}


    // Funci√≥n para formatear moneda
    function formatearMoneda(valor) {
      if (!valor && valor !== 0) return "$0";
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(valor);
    }

    // Funci√≥n para renderizar finca con informaci√≥n de recogidas
// Funci√≥n para renderizar finca con informaci√≥n de recogidas
async function renderFinca(finca) {
  const div = document.createElement("div");
  div.className = "card-glass";
  
  // HTML inicial de la tarjeta
  div.innerHTML = `
    <div class="finca-header">
      <div class="finca-title">${finca.nombre}</div>
      <div class="propietario">Propietario: ${finca.propietario}</div>
    </div>
    
    <div class="recogida-info">
      <div class="loading-info">‚è≥ Cargando informaci√≥n de recogidas...</div>
    </div>
    
<div class="botones-container">
  <button onclick="location.href='precios.html?id=${finca._id}&usuario=${encodeURIComponent(usuario)}'">üí∞ Precios</button>
  <button onclick="location.href='recogida.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üìä Recogida</button>
  <button onclick="location.href='historial.html?id=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}'">üìã Historial</button>
  <button onclick="location.href='liquidacion.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üí∞ Liquidaci√≥n</button>
</div>
  `;
  
  lista.prepend(div);

  // Cargar informaci√≥n de recogidas de forma as√≠ncrona
  const infoRecogidas = await obtenerInfoRecogida(finca._id);
  const recogidaInfoDiv = div.querySelector('.recogida-info');
  
  if (infoRecogidas && infoRecogidas.ultimaRecogida) {
    const { ultimaRecogida, totalRecogidas, totalKilosAcumulado, totalPagadoAcumulado } = infoRecogidas;
    
    // Priorizar el alias sobre el usuario
    const usuarioMostrar = ultimaRecogida.alias || ultimaRecogida.usuario || 'Usuario desconocido';
    
    console.log("=== DEBUG USUARIO EN DASHBOARD ===");
    console.log("alias:", ultimaRecogida.alias);
    console.log("usuario:", ultimaRecogida.usuario);
    console.log("usuarioMostrar:", usuarioMostrar);
    console.log("=== FIN DEBUG ===");

    // üî• NUEVA FUNCI√ìN: Analizar todas las frutas de la √∫ltima recogida
    const frutasInfo = analizarFrutasDeRecogida(ultimaRecogida);
    console.log("üçé An√°lisis de frutas en √∫ltima recogida:", frutasInfo);

    // üî• CORRECCI√ìN: Obtener tipo del usuario ACTUAL (no del que hizo la recogida)
    const storedData = sessionStorage.getItem('userData');
    let tipoUsuarioActual = 1; // Por defecto administrador
    
    if (storedData) {
      const userData = JSON.parse(storedData);
      tipoUsuarioActual = userData.tipo;
    } else if (usuario) {
      // Si no hay datos en sessionStorage, hacer consulta
      try {
        const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
        if (response.ok) {
          const userData = await response.json();
          tipoUsuarioActual = userData.tipo;
        }
      } catch (error) {
        console.error("Error al obtener tipo de usuario:", error);
      }
    }

    const esUsuarioActualSubusuario = tipoUsuarioActual === 2;
    
    console.log("üë§ Tipo de usuario ACTUAL:", tipoUsuarioActual, "Es subusuario:", esUsuarioActualSubusuario);
    
    // üî• MOSTRAR PRECIOS solo si el usuario ACTUAL NO es subusuario
    if (!esUsuarioActualSubusuario) {
      // Administrador viendo - mostrar todos los datos incluyendo precios
      recogidaInfoDiv.innerHTML = `
        <div style="text-align: center; font-weight: bold; margin-bottom: 10px; color: var(--primary-color, #00d4ff);">
          üìä √öltima Recogida - ${formatearFecha(ultimaRecogida.fecha)}
        </div>

        <div class="info-row">
          <span class="info-label">üë§ Usuario:</span>
          <span class="info-value">${usuarioMostrar}</span>
        </div>
        
        ${generarHtmlFrutas(frutasInfo, false)}
        
        <div class="info-row">
          <span class="info-label">‚öñÔ∏è Kilos:</span>
          <span class="info-value">${ultimaRecogida.totalKilos ? ultimaRecogida.totalKilos.toFixed(1) + ' kg' : 'N/A'}</span>
        </div>
        
        <div class="info-row">
          <span class="info-label">üß∫ Pesas:</span>
          <span class="info-value">${ultimaRecogida.pesas ? ultimaRecogida.pesas.length : 0}</span>
        </div>
        
        <div class="info-row">
          <span class="info-label">üíµ A pagar:</span>
          <span class="info-value">${formatearMoneda(ultimaRecogida.valorPagar)}</span>
        </div>
        
        <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px; padding-top: 10px;">
          <div class="info-row">
            <span class="info-label">üìà Total recogidas:</span>
            <span class="info-value">${totalRecogidas}</span>
          </div>
          
          <div class="info-row">
            <span class="info-label">üì¶ Total kilos:</span>
            <span class="info-value">${totalKilosAcumulado.toFixed(1)} kg</span>
          </div>
          
          <div class="info-row">
            <span class="info-label">üí∞ Total pagado:</span>
            <span class="info-value">${formatearMoneda(totalPagadoAcumulado)}</span>
          </div>
        </div>
      `;
    } else {
      // Subusuario viendo - ocultar precios y valores monetarios
      recogidaInfoDiv.innerHTML = `
        <div style="text-align: center; font-weight: bold; margin-bottom: 10px; color: var(--primary-color, #00d4ff);">
          üìä √öltima Recogida - ${formatearFecha(ultimaRecogida.fecha)}
        </div>

        <div class="info-row">
          <span class="info-label">üë§ Usuario:</span>
          <span class="info-value">${usuarioMostrar}</span>
        </div>
        
        ${generarHtmlFrutas(frutasInfo, true)}
        
        <div class="info-row">
          <span class="info-label">‚öñÔ∏è Kilos:</span>
          <span class="info-value">${ultimaRecogida.totalKilos ? ultimaRecogida.totalKilos.toFixed(1) + ' kg' : 'N/A'}</span>
        </div>
        
        <div class="info-row">
          <span class="info-label">üß∫ Pesas:</span>
          <span class="info-value">${ultimaRecogida.pesas ? ultimaRecogida.pesas.length : 0}</span>
        </div>
        
        <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px; padding-top: 10px;">
          <div class="info-row">
            <span class="info-label">üìà Total recogidas:</span>
            <span class="info-value">${totalRecogidas}</span>
          </div>
          
          <div class="info-row">
            <span class="info-label">üì¶ Total kilos:</span>
            <span class="info-value">${totalKilosAcumulado.toFixed(1)} kg</span>
          </div>
        </div>
      `;
    }
  } else {
    recogidaInfoDiv.innerHTML = `
      <div class="sin-recogidas">
        üìù Sin recogidas registradas<br>
        <small>¬°Realiza tu primera recogida!</small>
      </div>
    `;
  }
}

// üî• NUEVA FUNCI√ìN: Analizar todas las frutas de una recogida
function analizarFrutasDeRecogida(recogida) {
  const frutasInfo = {
    frutasUnicas: [],
    calidadesUnicas: [],
    resumenDetallado: {},
    esSoloUnaFruta: false,
    esSoloUnaCalidad: false
  };

  // Si hay pesas individuales, analizarlas
  if (recogida.pesas && recogida.pesas.length > 0) {
    console.log("üîç Analizando pesas individuales:", recogida.pesas.length);
    
    recogida.pesas.forEach(pesa => {
      const fruta = pesa.fruta || recogida.fruta || 'Sin especificar';
      const calidad = pesa.calidad || recogida.calidad || 'Sin especificar';
      
      // Recopilar frutas √∫nicas
      if (!frutasInfo.frutasUnicas.includes(fruta)) {
        frutasInfo.frutasUnicas.push(fruta);
      }
      
      // Recopilar calidades √∫nicas
      if (!frutasInfo.calidadesUnicas.includes(calidad)) {
        frutasInfo.calidadesUnicas.push(calidad);
      }
      
      // Crear resumen detallado
      const clave = `${fruta} (${calidad})`;
      if (!frutasInfo.resumenDetallado[clave]) {
        frutasInfo.resumenDetallado[clave] = {
          fruta: fruta,
          calidad: calidad,
          kilos: 0,
          pesas: 0
        };
      }
      
      frutasInfo.resumenDetallado[clave].kilos += pesa.kilos || 0;
      frutasInfo.resumenDetallado[clave].pesas += 1;
    });
  } else {
    // Si no hay pesas individuales, usar datos generales
    const fruta = recogida.fruta || 'Sin especificar';
    const calidad = recogida.calidad || 'Sin especificar';
    
    frutasInfo.frutasUnicas = [fruta];
    frutasInfo.calidadesUnicas = [calidad];
    
    const clave = `${fruta} (${calidad})`;
    frutasInfo.resumenDetallado[clave] = {
      fruta: fruta,
      calidad: calidad,
      kilos: recogida.totalKilos || 0,
      pesas: recogida.pesas ? recogida.pesas.length : 1
    };
  }

  // Determinar si es solo una fruta o una calidad
  frutasInfo.esSoloUnaFruta = frutasInfo.frutasUnicas.length === 1;
  frutasInfo.esSoloUnaCalidad = frutasInfo.calidadesUnicas.length === 1;

  console.log("üìä An√°lisis completado:", {
    totalFrutas: frutasInfo.frutasUnicas.length,
    totalCalidades: frutasInfo.calidadesUnicas.length,
    frutas: frutasInfo.frutasUnicas,
    calidades: frutasInfo.calidadesUnicas,
    combinaciones: Object.keys(frutasInfo.resumenDetallado).length
  });

  return frutasInfo;
}

// üî• NUEVA FUNCI√ìN: Generar HTML para mostrar las frutas
function generarHtmlFrutas(frutasInfo, esSubusuario = false) {
  let html = '';

  if (frutasInfo.esSoloUnaFruta && frutasInfo.esSoloUnaCalidad) {
    // Caso simple: solo una fruta y una calidad
    const fruta = frutasInfo.frutasUnicas[0];
    const calidad = frutasInfo.calidadesUnicas[0];
    
    html += `
      <div class="info-row">
        <span class="info-label">üçé Fruta:</span>
        <span class="info-value">${fruta}</span>
      </div>
      
      <div class="info-row">
        <span class="info-label">‚≠ê Calidad:</span>
        <span class="info-value">${calidad}</span>
      </div>
    `;
  } else {
    // Caso complejo: m√∫ltiples frutas y/o calidades
    if (frutasInfo.frutasUnicas.length > 1) {
      // M√∫ltiples frutas
      html += `
        <div class="info-row">
          <span class="info-label">üçé Frutas:</span>
          <span class="info-value">${frutasInfo.frutasUnicas.join(', ')}</span>
        </div>
      `;
    } else {
      // Solo una fruta pero m√∫ltiples calidades
      html += `
        <div class="info-row">
          <span class="info-label">üçé Fruta:</span>
          <span class="info-value">${frutasInfo.frutasUnicas[0]}</span>
        </div>
      `;
    }

    if (frutasInfo.calidadesUnicas.length > 1) {
      // M√∫ltiples calidades
      html += `
        <div class="info-row">
          <span class="info-label">‚≠ê Calidades:</span>
          <span class="info-value">${frutasInfo.calidadesUnicas.join(', ')}</span>
        </div>
      `;
    } else {
      // Solo una calidad pero m√∫ltiples frutas
      html += `
        <div class="info-row">
          <span class="info-label">‚≠ê Calidad:</span>
          <span class="info-value">${frutasInfo.calidadesUnicas[0]}</span>
        </div>
      `;
    }

    // Mostrar detalle de combinaciones si hay m√°s de una
    const combinaciones = Object.keys(frutasInfo.resumenDetallado);
    if (combinaciones.length > 1) {
      html += `
        <div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 8px;">
          <div style="font-size: 0.85em; font-weight: bold; margin-bottom: 5px; opacity: 0.9;">
            üìã Detalle por combinaci√≥n:
          </div>
      `;
      
      combinaciones.forEach(clave => {
        const detalle = frutasInfo.resumenDetallado[clave];
        html += `
          <div style="font-size: 0.8em; margin: 2px 0; opacity: 0.8;">
            ‚Ä¢ ${clave}: ${detalle.kilos.toFixed(1)} kg (${detalle.pesas} pesas)
          </div>
        `;
      });
      
      html += '</div>';
    }
  }

  return html;
}

// CSS adicional para mejorar la visualizaci√≥n
const estilosAdicionales = `
<style>
.recogida-info .info-row {
  display: flex;
  justify-content: space-between;
  margin: 5px 0;
  align-items: flex-start;
}

.recogida-info .info-value {
  color: var(--primary-color, #00d4ff);
  font-weight: bold;
  text-align: right;
  max-width: 60%;
  word-wrap: break-word;
}

.recogida-info .info-label {
  font-weight: bold;
  opacity: 0.8;
  min-width: 35%;
}

/* Estilos para el detalle de combinaciones */
.detalle-combinaciones {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  padding: 8px;
  margin: 8px 0;
  font-size: 0.85em;
}

.detalle-combinaciones .titulo {
  font-weight: bold;
  margin-bottom: 5px;
  opacity: 0.9;
}

.detalle-combinaciones .item {
  margin: 2px 0;
  opacity: 0.8;
  padding-left: 10px;
}

/* Responsive para textos largos */
@media (max-width: 480px) {
  .recogida-info .info-row {
    flex-direction: column;
    gap: 2px;
  }
  
  .recogida-info .info-value {
    text-align: left;
    max-width: 100%;
  }
  
  .recogida-info .info-label {
    min-width: auto;
  }
}
</style>
`;

// Agregar los estilos al documento
if (!document.getElementById('estilos-frutas-multiples')) {
  const styleElement = document.createElement('div');
  styleElement.id = 'estilos-frutas-multiples';
  styleElement.innerHTML = estilosAdicionales;
  document.head.appendChild(styleElement);
}
// Event listener para guardar finca
    guardar.addEventListener("click", async () => {
      const nombre = document.getElementById("nombreFinca").value.trim();
      const propietario = document.getElementById("propietarioFinca").value.trim();

      if (!nombre || !propietario) return alert("Completa todos los campos");

      try {
        // üîß INCLUIR EL ADMIN ALIAS AL CREAR FINCA
        const finca = await apiFetch("/fincas/agregar", "POST", { 
          nombre, 
          propietario, 
          usuario,     // Administrador que est√° creando
          adminAlias   // üîß Su propio alias como adminAlias
        });
        
        todasLasFincas.unshift(finca);
        renderFinca(finca);
        modal.classList.add("hidden");
        
        // Limpiar formulario
        document.getElementById("nombreFinca").value = "";
        document.getElementById("propietarioFinca").value = "";
      } catch (err) {
        console.error("Error al guardar finca:", err);
        alert("Error al guardar finca: " + err.message);
      }
    });

    async function cargarFincas() {
      try {
        console.log("üîç Cargando fincas para administrador:", adminAlias);
        
        if (!adminAlias) {
          console.error("‚ùå No hay adminAlias definido");
          const todasFincas = await apiFetch("/fincas/listar", "GET");
          const fincasUsuario = todasFincas.filter(f => f.usuario === usuario);
          todasLasFincas = fincasUsuario;
        } else {
          // üîß USAR EL ENDPOINT POR ADMIN
          const response = await fetch(`https://jc-frutas.onrender.com/fincas/por-admin/${adminAlias}`);
          if (response.ok) {
            const fincasAdmin = await response.json();
            todasLasFincas = fincasAdmin;
            console.log("üìã Fincas del administrador:", todasLasFincas.length);
          } else {
            // Fallback al m√©todo tradicional
            const todasFincas = await apiFetch("/fincas/listar", "GET");
            const fincasUsuario = todasFincas.filter(f => f.usuario === usuario || f.adminAlias === adminAlias);
            todasLasFincas = fincasUsuario;
          }
        }
        
        console.log("üìã Total de fincas cargadas:", todasLasFincas.length);
        await mostrarFincas(todasLasFincas);
      } catch (err) {
        console.error("Error al cargar fincas:", err);
        alert("Error al cargar fincas: " + err.message);
      }
    }

    async function mostrarFincas(fincas) {
      lista.innerHTML = ""; // Limpiar
      if (fincas.length === 0) {
        lista.innerHTML = "<p>No tienes fincas registradas a√∫n.</p>";
      } else {
        // Renderizar fincas de forma secuencial para mejor UX
        for (const finca of fincas) {
          await renderFinca(finca);
        }
      }
    }

    // Event listeners para el modal
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.add("hidden");
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        modal.classList.add("hidden");
      }
    });

    btnAgregar.addEventListener("click", () => {
      modal.classList.remove("hidden");
    });

    // B√∫squeda de fincas
    const inputBuscar = document.getElementById("buscarFinca");
    inputBuscar.addEventListener("input", async () => {
      const texto = inputBuscar.value.toLowerCase();

      const filtradas = todasLasFincas.filter(finca =>
        finca.nombre.toLowerCase().includes(texto) ||
        finca.propietario.toLowerCase().includes(texto)
      );

      await mostrarFincas(filtradas);
    });

    // Cargar fincas al iniciar
    cargarFincas();
  </script>
</body>
</html>