<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Tipo 1</title>
  <link rel="stylesheet" href="style.css">
  <script src="jc-loader.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .card-glass {
      background: var(--glass-bg, rgba(255, 255, 255, 0.1));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      position: relative; /* Para posicionar la etiqueta de notas */
    }

    .finca-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .finca-title {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary-color, #00d4ff);
      margin-bottom: 5px;
    }

    .propietario {
      opacity: 0.8;
      font-size: 0.95em;
    }

    .recogida-info {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      align-items: flex-start;
    }

    .info-label {
      font-weight: bold;
      opacity: 0.8;
      min-width: 35%;
    }

    .info-value {
      color: var(--primary-color, #00d4ff);
      font-weight: bold;
      text-align: right;
      max-width: 60%;
      word-wrap: break-word;
    }

    .sin-recogidas {
      text-align: center;
      opacity: 0.6;
      font-style: italic;
      padding: 20px;
    }

    .botones-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .botones-container button {
      flex: 1;
      min-width: 120px;
      padding: 8px 12px;
      font-size: 0.85em;
    }

    .loading-info {
      text-align: center;
      padding: 10px;
      font-style: italic;
    }

    .historial-btn {
      position: absolute;
      transform: translateX(-270px);
    }

    /* Skeleton loading animation */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-text {
      height: 16px;
      border-radius: 4px;
      margin: 8px 0;
    }

    .skeleton-title {
      height: 24px;
      border-radius: 6px;
      margin: 10px 0;
      width: 70%;
    }

    /* Loader general */
    .general-loader {
      text-align: center;
      padding: 40px 20px;
      color: var(--primary-color, #00d4ff);
      font-size: 1.1em;
    }

    .loader-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 212, 255, 0.3);
      border-top: 4px solid var(--primary-color, #00d4ff);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive optimizations */
    @media (max-width: 480px) {
      .info-row {
        flex-direction: column;
        gap: 2px;
      }
      
      .info-value {
        text-align: left;
        max-width: 100%;
      }
      
      .info-label {
        min-width: auto;
      }
    }
    

       .boton-liquidacion {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      margin-left: 20px;
      display: inline-block;
    }

    .boton-liquidacion:hover {
      background: linear-gradient(135deg, #5a6fd8, #6a4c93);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .boton-liquidacion:active {
      transform: translateY(0);
    }
    
    /* Estilo de los botones existentes */
    .botones-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
      position: relative;
    }

    .botones-container button {
      flex: 1;
      min-width: 120px;
      padding: 8px 12px;
      font-size: 0.85em;
    }

    /* Estilos para las notas */
    .nota-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #2196F3;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
      transition: all 0.3s ease;
    }

    .nota-badge:hover {
      background: #0b7dda;
      transform: scale(1.05);
    }

    .nota-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .nota-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .nota-modal-content {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }

    .nota-modal.active .nota-modal-content {
      transform: translateY(0);
    }

    .nota-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      padding-bottom: 10px;
    }

    .nota-modal-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }

    .nota-modal-close {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: #666;
    }

    .nota-list {
      margin-top: 15px;
    }

    .nota-item {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .nota-content {
      margin-bottom: 10px;
      white-space: pre-wrap;
    }

    .nota-meta {
      font-size: 0.8em;
      color: #666;
      display: flex;
      justify-content: space-between;
    }

    .nota-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .nota-actions button {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8em;
    }

    .edit-nota-btn {
      background: #4CAF50;
      color: white;
    }

    .delete-nota-btn {
      background: #f44336;
      color: white;
    }

    .add-nota-btn {
      background: #2196F3;
      color: white;
    }

    .quick-note-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      z-index: 1001;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .quick-note-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .quick-note-header {
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    .quick-note-textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
      resize: vertical;
    }

    .quick-note-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .quick-note-actions button {
      padding: 8px 15px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }

    .quick-note-cancel {
      background: #f5f5f5;
      color: #333;
    }

    .quick-note-save {
      background: #2196F3;
      color: white;
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      .nota-modal-content,
      .quick-note-modal {
        background: rgba(30, 30, 30, 0.95);
        color: #eee;
      }

      .nota-item {
        background: rgba(50, 50, 50, 0.7);
        color: #eee;
      }

      .nota-modal-title {
        color: #eee;
      }

      .nota-modal-close {
        color: #aaa;
      }

      .nota-meta {
        color: #aaa;
      }

      .quick-note-header {
        color: #eee;
      }

      .quick-note-textarea {
        background: rgba(50, 50, 50, 0.7);
        color: #eee;
        border-color: #444;
      }

      .quick-note-cancel {
        background: #444;
        color: #eee;
      }
    }
  </style>
</head>
<body>

  <div class="container">

        <button id="btnEditarPrecios" class="floating-btn">‚úèÔ∏è Globalizar Precios</button>
        <button id="btnLiquidacion" class="boton-liquidacion">üí∞ liqudiaciones</button>

    <h1 id="saludo">Bienvenido</h1>
    <button id="btnAgregarFinca">‚ûï Agregar Finca</button>
    <input type="text" id="buscarFinca" placeholder="Buscar finca o propietario...">
    <div id="listaFincas"></div>
  </div>

  <div id="modalFinca" class="modal hidden">
    <div class="modal-content">
      <h3>Agregar Finca</h3>
      <input type="text" id="nombreFinca" placeholder="Nombre de la finca">
      <input type="text" id="propietarioFinca" placeholder="Nombre del propietario">
      <button id="guardarFinca">Guardar</button>
    </div>
  </div>

  <!-- Modal para agregar nota r√°pida -->
  <div id="quickNoteModal" class="quick-note-modal">
    <div class="quick-note-header" id="quickNoteTitle">Agregar nota para finca</div>
    <textarea id="quickNoteContent" class="quick-note-textarea" placeholder="Escribe tu nota aqu√≠..."></textarea>
    <div class="quick-note-actions">
      <button id="quickNoteCancel" class="quick-note-cancel">Cancelar</button>
      <button id="quickNoteSave" class="quick-note-save">Guardar Nota</button>
    </div>
  </div>

  <!-- Modal para ver todas las notas -->
  <div id="notasModal" class="nota-modal">
    <div class="nota-modal-content">
      <div class="nota-modal-header">
        <div class="nota-modal-title" id="notasModalTitle">Notas de la finca</div>
        <button class="nota-modal-close" id="notasModalClose">&times;</button>
      </div>
      <div class="nota-list" id="notasList">
        <!-- Las notas se cargar√°n aqu√≠ -->
      </div>
      <div class="nota-actions" style="justify-content: center;">
        <button id="addNewNoteBtn" class="add-nota-btn">‚ûï Agregar Nueva Nota</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { apiFetch } from "./api.js";

    // üîç DEBUG: Verificar la URL completa
    console.log("=== URL Y PAR√ÅMETROS ===");
    console.log("URL completa:", window.location.href);
    console.log("Search params:", window.location.search);

    // Obtener los par√°metros de la URL
    const params = new URLSearchParams(window.location.search);
    const usuario = params.get("usuario");
    let alias = params.get("alias");
    let adminAlias = alias;

    // Variables para manejo de notas
    let notasPorFinca = {}; // Cache de notas por finca
    let fincaActualParaNota = null; // Para saber a qu√© finca agregar la nota

    // ‚úÖ SOLUCI√ìN: Agregar event listener al bot√≥n de liquidaci√≥n
    document.getElementById('btnLiquidacion').addEventListener('click', function() {
      window.location.href = "liquidacionmes.html";
    });

const btnEditarPrecios = document.getElementById("btnEditarPrecios");

btnEditarPrecios.addEventListener("click", () => {
  // Navegar a la nueva p√°gina de gesti√≥n de precios
  let preciosUrl = `gestion-precios.html?usuario=${encodeURIComponent(usuario)}`;
  if (alias) {
    preciosUrl += `&alias=${encodeURIComponent(alias)}`;
  }
  window.location.href = preciosUrl;
});

    // Si no se encuentra alias en la URL, hacer una llamada al servidor para obtenerlo
    if (!alias && usuario) {
      console.log("Alias no encontrado en la URL, haciendo una llamada al servidor para obtenerlo...");

      async function obtenerAliasDesdeServidor() {
        try {
          const response = await apiFetch(`/auth/get-alias?usuario=${usuario}`, "GET");
          alias = response.alias || 'Alias no disponible';
          adminAlias = alias;
          console.log("Alias obtenido desde el servidor:", alias);
          mostrarUsuarioYAlias();
        } catch (error) {
          console.error("Error al obtener alias desde el servidor:", error);
          alias = 'Alias no disponible';
          adminAlias = alias;
          mostrarUsuarioYAlias();
        }
      }

      obtenerAliasDesdeServidor();
    } else {
      console.log("Alias encontrado en la URL:", alias);
      adminAlias = alias;
      mostrarUsuarioYAlias();
    }

    // Variables globales
    let todasLasFincas = [];
    let todasLasRecogidas = {}; // Cache de recogidas por finca
    let tipoUsuarioActual = 1; // Por defecto administrador

function crearBotonHistorialRecogidas() {
  // Verificar si ya existe el bot√≥n
  const existingButton = document.getElementById('historial-recogidas-btn');
  if (existingButton) return;

  // Obtener par√°metros de URL
  const params = new URLSearchParams(window.location.search);
  const usuario = params.get('usuario');
  const alias = params.get('alias');

  if (!usuario) {
    console.warn('‚ö†Ô∏è No se encontr√≥ usuario en los par√°metros URL');
    return;
  }

  // Crear el bot√≥n
  const button = document.createElement('button');
  button.id = 'historial-recogidas-btn';
  button.className = 'historial-btn';
  button.innerHTML = 'üìä Historial Completo';
  
  // Estilos del bot√≥n SIN EFECTOS DE HOVER/ACTIVE
  button.style.cssText = `
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    font-size: 1rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    margin: 10px;
    min-width: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: none !important;
    transform: none !important;
  `;

  // Funcionalidad del bot√≥n
  button.addEventListener('click', () => {
    // Construir URL del historial completo
    let historialUrl = `historial-recogidas.html?usuario=${encodeURIComponent(usuario)}`;
    
    if (alias) {
      historialUrl += `&alias=${encodeURIComponent(alias)}`;
    }

    console.log('üìä Navegando al historial completo:', historialUrl);
    
    // Mostrar indicador de carga
    button.innerHTML = '‚è≥ Cargando...';
    button.disabled = true;
    
    // Redirigir despu√©s de un breve delay para mostrar el estado de carga
    setTimeout(() => {
      window.location.href = historialUrl;
    }, 300);
  });

  return button;
}
// üî• FUNCI√ìN PARA INSERTAR EL BOT√ìN SIEMPRE ARRIBA Y FUERA DEL CONTAINER
function insertarBotonHistorial() {
  const button = crearBotonHistorialRecogidas();
  if (!button) return;

  // Siempre insertar arriba, fuera del container
  insertarArribaFueraContainer(button);
}

// üî• INSERTAR SIEMPRE ARRIBA, FUERA DEL CONTAINER
function insertarArribaFueraContainer(button) {
  // Crear un contenedor fijo en la parte superior
  const topContainer = document.createElement('div');
  topContainer.id = 'historial-top-container';
  topContainer.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 10px 20px;
    display: flex;
    justify-content: center;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    z-index: 99999;
  `;

  // Ajustar estilos del bot√≥n para la posici√≥n superior - COMPLETAMENTE EST√ÅTICO
  button.style.cssText = `
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.95rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-width: 180px;
    transition: none !important;
    transform: none !important;
  `;

  // REMOVER TODOS LOS EFECTOS DE HOVER Y ACTIVE
  button.addEventListener('mouseenter', (e) => {
    e.preventDefault();
    // No hacer nada en hover
  });

  button.addEventListener('mouseleave', (e) => {
    e.preventDefault();
    // No hacer nada al salir del hover
  });

  button.addEventListener('mousedown', (e) => {
    e.preventDefault();
    // No hacer nada al presionar
  });

  button.addEventListener('mouseup', (e) => {
    e.preventDefault();
    // No hacer nada al soltar
  });

  // Agregar el bot√≥n al contenedor
  topContainer.appendChild(button);

  // Insertar al principio del body (antes que todo)
  document.body.insertBefore(topContainer, document.body.firstChild);

  // Ajustar el body para que no se superponga con el bot√≥n fijo
  adjustBodyForFixedButton();

  console.log('‚úÖ Bot√≥n insertado arriba, fuera del container - COMPLETAMENTE EST√ÅTICO');
}
// üî• AJUSTAR EL BODY PARA EL BOT√ìN FIJO
function adjustBodyForFixedButton() {
  // Agregar padding-top al body o al primer container
  const body = document.body;
  const container = document.querySelector('.container');
  
  // Calcular altura del bot√≥n (aproximadamente 60px incluyendo padding)
  const buttonHeight = '70px';
  
  if (container) {
    // Si hay container, agregarle margen superior
    container.style.marginTop = buttonHeight;
  } else {
    // Si no hay container, ajustar el body
    body.style.paddingTop = buttonHeight;
  }

  // Ajustar cualquier elemento que pueda tener position fixed en el top
  const existingFixedElements = document.querySelectorAll('[style*="position: fixed"][style*="top:"]');
  existingFixedElements.forEach(element => {
    const currentTop = element.style.top;
    if (currentTop === '0px' || currentTop === '0') {
      element.style.top = buttonHeight;
    }
  });
}

    async function verificarPermisosHistorial() {
      try {
        const params = new URLSearchParams(window.location.search);
        const usuario = params.get('usuario');
        
        if (!usuario) return false;

        const storedData = sessionStorage.getItem('userData');
        if (storedData) {
          const userData = JSON.parse(storedData);
          return userData.tipo === 1 || userData.tipo === 2;
        }

        const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
        if (response.ok) {
          const userData = await response.json();
          return userData.tipo === 1 || userData.tipo === 2;
        }

        return false;
      } catch (error) {
        console.error('‚ùå Error al verificar permisos:', error);
        return false;
      }
    }

    async function inicializarBotonHistorial() {
      const tienePermisos = await verificarPermisosHistorial();
      
      if (!tienePermisos) {
        console.log('‚ÑπÔ∏è Usuario sin permisos para ver historial completo');
        return;
      }

      if (window.location.pathname.includes('historial-recogidas.html')) {
        console.log('‚ÑπÔ∏è Ya estamos en la p√°gina de historial completo');
        return;
      }

      insertarBotonHistorial();
    }

    // Funci√≥n para mostrar el usuario y alias
    function mostrarUsuarioYAlias() {
      console.log("=== DEBUG URL ===");
      console.log("Usuario extra√≠do de URL:", usuario);
      console.log("Alias extra√≠do de URL:", alias);
      console.log("AdminAlias asignado:", adminAlias);

      const saludo = document.getElementById("saludo");
      if (usuario) {
        saludo.textContent = `Bienvenido, ${alias}`;
      } else {
        saludo.textContent = "Bienvenido (usuario no identificado)";
      }
    }

    // üöÄ OPTIMIZACI√ìN: Cargar todas las recogidas de una vez
    async function cargarTodasLasRecogidas(fincaIds) {
      console.log("üöÄ Cargando recogidas para todas las fincas de una vez...");
      const startTime = performance.now();
      
      try {
        // Crear promises para todas las fincas al mismo tiempo
        const promises = fincaIds.map(async (fincaId) => {
          try {
            const recogidas = await apiFetch(`/recogidas/por-finca/${fincaId}`, "GET");
            return { fincaId, recogidas: recogidas || [] };
          } catch (error) {
            console.error(`Error cargando recogidas para finca ${fincaId}:`, error);
            return { fincaId, recogidas: [] };
          }
        });

        // Esperar a que todas las llamadas terminen
        const resultados = await Promise.all(promises);
        
        // Organizar los resultados en el cache
        resultados.forEach(({ fincaId, recogidas }) => {
          todasLasRecogidas[fincaId] = recogidas;
        });

        const endTime = performance.now();
        console.log(`‚úÖ Recogidas cargadas en ${(endTime - startTime).toFixed(0)}ms`);
        console.log(`üìä Total fincas procesadas: ${fincaIds.length}`);
        
        return todasLasRecogidas;
      } catch (error) {
        console.error("‚ùå Error cargando recogidas:", error);
        return {};
      }
    }

    // üöÄ OPTIMIZACI√ìN: Obtener informaci√≥n de recogida desde cache
    function obtenerInfoRecogidaDesdeCache(fincaId) {
      const recogidas = todasLasRecogidas[fincaId] || [];
      
      if (recogidas.length === 0) {
        return null;
      }

      const ultimaRecogida = recogidas[0];
      const totalRecogidas = recogidas.length;
      const totalKilosAcumulado = recogidas.reduce((sum, r) => sum + (r.totalKilos || 0), 0);
      const totalPagadoAcumulado = recogidas.reduce((sum, r) => sum + (r.valorPagar || 0), 0);
      
      return {
        ultimaRecogida,
        totalRecogidas,
        totalKilosAcumulado,
        totalPagadoAcumulado
      };
    }

    // üöÄ OPTIMIZACI√ìN: Renderizar finca sin llamadas as√≠ncronas
function renderFincaRapido(finca) {
  const div = document.createElement("div");
  div.className = "card-glass";
  div.dataset.fincaId = finca._id;
  
  // HTML inicial de la tarjeta
  div.innerHTML = `
    <div class="finca-header">
      <div class="finca-title">${finca.nombre}</div>
      <div class="propietario">Propietario: ${finca.propietario}</div>
    </div>
    
    <div class="recogida-info" data-finca-id="${finca._id}">
      <div class="loading-info">‚è≥ Cargando informaci√≥n de recogidas...</div>
    </div>
    
    <div class="botones-container">
      <button onclick="location.href='precios.html?id=${finca._id}&usuario=${encodeURIComponent(usuario)}'">üí∞ Precios</button>
      <button onclick="location.href='recogida.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üìä Recogida</button>
      <button onclick="location.href='historial.html?id=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}'">üìã Historial</button>
      <button onclick="location.href='liquidacion.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üí∞ Liquidaci√≥n</button>
      <button onclick="verLiquidacionesFinca('${finca._id}', '${encodeURIComponent(finca.nombre)}', '${encodeURIComponent(finca.propietario)}')">‚úÖ Recibos Liquidados</button>
    </div>
  `;
  
  // Agregar badge de notas si hay notas para esta finca
  if (notasPorFinca[finca._id] && notasPorFinca[finca._id].total > 0) {
    const notaBadge = document.createElement('div');
    notaBadge.className = 'nota-badge';
    notaBadge.textContent = `üìù ${notasPorFinca[finca._id].total} nota${notasPorFinca[finca._id].total > 1 ? 's' : ''}`;
    notaBadge.addEventListener('click', (e) => {
      e.stopPropagation();
      mostrarNotasFinca(finca);
    });
    div.appendChild(notaBadge);
  }
  
  // Agregar event listener para el long press
  let pressTimer;
  div.addEventListener('mousedown', (e) => {
    pressTimer = setTimeout(() => {
      mostrarQuickNoteModal(finca);
    }, 1000); // 3 segundos
  });
  
  div.addEventListener('mouseup', () => {
    clearTimeout(pressTimer);
  });
  
  div.addEventListener('mouseleave', () => {
    clearTimeout(pressTimer);
  });
  
  // Para dispositivos t√°ctiles
  div.addEventListener('touchstart', (e) => {
    pressTimer = setTimeout(() => {
      e.preventDefault();
      mostrarQuickNoteModal(finca);
    }, 3000);
  });
  
  div.addEventListener('touchend', () => {
    clearTimeout(pressTimer);
  });
  
  return div;
}

// üî• SOLUCI√ìN: Hacer la funci√≥n verLiquidacionesFinca accesible globalmente
window.verLiquidacionesFinca = function(fincaId, fincaNombre, fincaPropietario) {
  console.log('üîç Navegando a liquidaciones de finca:', { fincaId, fincaNombre, fincaPropietario });
  
  // Obtener datos del usuario actual desde los par√°metros URL o sessionStorage
  const params = new URLSearchParams(window.location.search);
  let usuarioActual = params.get("usuario") || usuario;
  let adminAliasActual = params.get("alias") || alias;
  
  // Si no est√°n en URL, intentar obtener desde sessionStorage
  if (!usuarioActual || !adminAliasActual) {
    const storedData = sessionStorage.getItem('userData');
    if (storedData) {
      const sessionData = JSON.parse(storedData);
      usuarioActual = usuarioActual || sessionData.username;
      adminAliasActual = adminAliasActual || sessionData.adminAlias || sessionData.alias;
    }
  }
  
  // Decodificar los nombres si vienen codificados
  const fincaDecodificada = decodeURIComponent(fincaNombre);
  const propietarioDecodificado = decodeURIComponent(fincaPropietario);
  
  // Construir URL para la p√°gina de liquidaciones de finca espec√≠fica
  const baseUrl = 'liquidacion-finca.html';
  const urlParams = new URLSearchParams({
    fincaId: fincaId,
    finca: fincaDecodificada,
    propietario: propietarioDecodificado,
    usuario: usuarioActual,
    adminAlias: adminAliasActual
  });
  
  const url = `${baseUrl}?${urlParams.toString()}`;
  
  console.log('üöÄ URL construida para liquidaciones de finca:', url);
  
  // Navegar a la p√°gina
  window.location.href = url;
};

// üî• ALTERNATIVA: Si prefieres modificar el renderizado para evitar funciones globales
function renderFincaConEventListeners(finca) {
  const div = document.createElement("div");
  div.className = "card-glass";
  
  // HTML inicial de la tarjeta SIN onclick en el bot√≥n problem√°tico
  div.innerHTML = `
    <div class="finca-header">
      <div class="finca-title">${finca.nombre}</div>
      <div class="propietario">Propietario: ${finca.propietario}</div>
    </div>
    
    <div class="recogida-info" data-finca-id="${finca._id}">
      <div class="loading-info">‚è≥ Cargando informaci√≥n de recogidas...</div>
    </div>
    
    <div class="botones-container">
      <button onclick="location.href='precios.html?id=${finca._id}&usuario=${encodeURIComponent(usuario)}'">üí∞ Precios</button>
      <button onclick="location.href='recogida.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üìä Recogida</button>
      <button onclick="location.href='historial.html?id=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}'">üìã Historial</button>
      <button onclick="location.href='liquidacion.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üí∞ Liquidaci√≥n</button>
      <button class="btn-liquidaciones-finca" data-finca-id="${finca._id}" data-finca-nombre="${encodeURIComponent(finca.nombre)}" data-propietario="${encodeURIComponent(finca.propietario)}">‚úÖ Recibos Liquidados</button>
    </div>
  `;
  
  // Agregar event listener al bot√≥n de liquidaciones despu√©s de crear el elemento
  const btnLiquidaciones = div.querySelector('.btn-liquidaciones-finca');
  btnLiquidaciones.addEventListener('click', function() {
    const fincaId = this.dataset.fincaId;
    const fincaNombre = this.dataset.fincaNombre;
    const propietario = this.dataset.propietario;
    
    // Llamar a la funci√≥n directamente (no global)
    navegarALiquidacionesFinca(fincaId, fincaNombre, propietario);
  });
  
  return div;
}

// Funci√≥n local para navegaci√≥n a liquidaciones
function navegarALiquidacionesFinca(fincaId, fincaNombre, fincaPropietario) {
  console.log('üîç Navegando a liquidaciones de finca:', { fincaId, fincaNombre, fincaPropietario });
  
  // Obtener datos del usuario actual
  const params = new URLSearchParams(window.location.search);
  let usuarioActual = params.get("usuario") || usuario;
  let adminAliasActual = params.get("alias") || alias;
  
  // Si no est√°n en URL, intentar obtener desde sessionStorage
  if (!usuarioActual || !adminAliasActual) {
    const storedData = sessionStorage.getItem('userData');
    if (storedData) {
      const sessionData = JSON.parse(storedData);
      usuarioActual = usuarioActual || sessionData.username;
      adminAliasActual = adminAliasActual || sessionData.adminAlias || sessionData.alias;
    }
  }
  
  // Construir URL para la p√°gina de liquidaciones de finca
  const url = `liquidacion-finca.html?fincaId=${fincaId}&finca=${fincaNombre}&propietario=${fincaPropietario}&usuario=${encodeURIComponent(usuarioActual)}&adminAlias=${encodeURIComponent(adminAliasActual)}`;
  
  console.log('üöÄ Navegando a:', url);
  window.location.href = url;
}

// Funci√≥n para ver liquidaciones de la finca espec√≠fica
function verLiquidacionesFinca(fincaId, fincaNombre, fincaPropietario) {
  // Obtener datos del usuario actual
  const storedData = sessionStorage.getItem('userData');
  let usuarioActual = usuario;
  let adminAliasActual = '';
  
  if (storedData) {
    const sessionData = JSON.parse(storedData);
    usuarioActual = sessionData.username;
    adminAliasActual = sessionData.adminAlias || sessionData.alias;
  }
  
  // Construir URL para la p√°gina de liquidaciones de finca
  const url = `liquidacion-finca.html?fincaId=${fincaId}&finca=${fincaNombre}&propietario=${fincaPropietario}&usuario=${encodeURIComponent(usuarioActual)}&adminAlias=${encodeURIComponent(adminAliasActual)}`;
  
  // Navegar a la p√°gina
  location.href = url;
}
    // üöÄ OPTIMIZACI√ìN: Actualizar informaci√≥n de recogidas despu√©s del renderizado
    function actualizarInfoRecogidas(div, finca) {
      const recogidaInfoDiv = div.querySelector('.recogida-info');
      const infoRecogidas = obtenerInfoRecogidaDesdeCache(finca._id);
      
      if (infoRecogidas && infoRecogidas.ultimaRecogida) {
        const { ultimaRecogida, totalRecogidas, totalKilosAcumulado, totalPagadoAcumulado } = infoRecogidas;
        
        const usuarioMostrar = ultimaRecogida.alias || ultimaRecogida.usuario || 'Usuario desconocido';
        const frutasInfo = analizarFrutasDeRecogida(ultimaRecogida);
        
        const esUsuarioActualSubusuario = tipoUsuarioActual === 2;
        
        if (!esUsuarioActualSubusuario) {
          recogidaInfoDiv.innerHTML = `
            <div style="text-align: center; font-weight: bold; margin-bottom: 10px; color: var(--primary-color, #00d4ff);">
              üìä √öltima Recogida - ${formatearFechaUniversal(ultimaRecogida.fecha)}
            </div>

            <div class="info-row">
              <span class="info-label">üë§ Usuario:</span>
              <span class="info-value">${usuarioMostrar}</span>
            </div>
            
            ${generarHtmlFrutas(frutasInfo, false)}
            
            <div class="info-row">
              <span class="info-label">‚öñÔ∏è Kilos:</span>
              <span class="info-value">${ultimaRecogida.totalKilos ? ultimaRecogida.totalKilos.toFixed(1) + ' kg' : 'N/A'}</span>
            </div>
            
            <div class="info-row">
              <span class="info-label">üß∫ Pesas:</span>
              <span class="info-value">${ultimaRecogida.pesas ? ultimaRecogida.pesas.length : 0}</span>
            </div>
            
            <div class="info-row">
              <span class="info-label">üíµ A pagar:</span>
              <span class="info-value">${formatearMoneda(ultimaRecogida.valorPagar)}</span>
            </div>
            
            <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px; padding-top: 10px;">
              <div class="info-row">
                <span class="info-label">üìà Total recogidas:</span>
                <span class="info-value">${totalRecogidas}</span>
              </div>
              
              <div class="info-row">
                <span class="info-label">üì¶ Total kilos:</span>
                <span class="info-value">${totalKilosAcumulado.toFixed(1)} kg</span>
              </div>
              
              <div class="info-row">
                <span class="info-label">üí∞ Total pagado:</span>
                <span class="info-value">${formatearMoneda(totalPagadoAcumulado)}</span>
              </div>
            </div>
          `;
        } else {
          recogidaInfoDiv.innerHTML = `
            <div style="text-align: center; font-weight: bold; margin-bottom: 10px; color: var(--primary-color, #00d4ff);">
              üìä √öltima Recogida - ${formatearFechaUniversal(ultimaRecogida.fecha)}
            </div>

            <div class="info-row">
              <span class="info-label">üë§ Usuario:</span>
              <span class="info-value">${usuarioMostrar}</span>
            </div>
            
            ${generarHtmlFrutas(frutasInfo, true)}
            
            <div class="info-row">
              <span class="info-label">‚öñÔ∏è Kilos:</span>
              <span class="info-value">${ultimaRecogida.totalKilos ? ultimaRecogida.totalKilos.toFixed(1) + ' kg' : 'N/A'}</span>
            </div>
            
            <div class="info-row">
              <span class="info-label">üß∫ Pesas:</span>
              <span class="info-value">${ultimaRecogida.pesas ? ultimaRecogida.pesas.length : 0}</span>
            </div>
            
            <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px; padding-top: 10px;">
              <div class="info-row">
                <span class="info-label">üìà Total recogidas:</span>
                <span class="info-value">${totalRecogidas}</span>
              </div>
              
              <div class="info-row">
                <span class="info-label">üì¶ Total kilos:</span>
                <span class="info-value">${totalKilosAcumulado.toFixed(1)} kg</span>
              </div>
            </div>
          `;
        }
      } else {
        recogidaInfoDiv.innerHTML = `
          <div class="sin-recogidas">
            üìù Sin recogidas registradas<br>
            <small>¬°Realiza tu primera recogida!</small>
          </div>
        `;
      }
    }

    // Funci√≥n para formatear fecha universal
    function formatearFechaUniversal(fecha) {
      if (!fecha) return "No disponible";
      
      try {
        let dateObj;
        
        if (typeof fecha === 'string' && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
          const [year, month, day] = fecha.split('-');
          dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        } else {
          dateObj = new Date(fecha);
          
          const timeComponent = dateObj.getUTCHours() + dateObj.getUTCMinutes() + dateObj.getUTCSeconds();
          
          if (timeComponent === 0) {
            const dia = String(dateObj.getUTCDate()).padStart(2, '0');
            const mes = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
            const a√±o = dateObj.getUTCFullYear();
            return `${dia}/${mes}/${a√±o}`;
          }
        }
        
        if (isNaN(dateObj.getTime())) {
          return "Fecha inv√°lida";
        }
        
        const dia = String(dateObj.getDate()).padStart(2, '0');
        const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
        const a√±o = dateObj.getFullYear();
        
        return `${dia}/${mes}/${a√±o}`;
        
      } catch (error) {
        console.error("‚ùå Error al formatear fecha universal:", error, "Fecha:", fecha);
        return "Fecha inv√°lida";
      }
    }

    // Funci√≥n para formatear moneda
    function formatearMoneda(valor) {
      if (!valor && valor !== 0) return "$0";
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(valor);
    }

    // Funci√≥n para analizar frutas de recogida
    function analizarFrutasDeRecogida(recogida) {
      const frutasInfo = {
        frutasUnicas: [],
        calidadesUnicas: [],
        resumenDetallado: {},
        esSoloUnaFruta: false,
        esSoloUnaCalidad: false
      };

      if (recogida.pesas && recogida.pesas.length > 0) {
        recogida.pesas.forEach(pesa => {
          const fruta = pesa.fruta || recogida.fruta || 'Sin especificar';
          const calidad = pesa.calidad || recogida.calidad || 'Sin especificar';
          
          if (!frutasInfo.frutasUnicas.includes(fruta)) {
            frutasInfo.frutasUnicas.push(fruta);
          }
          
          if (!frutasInfo.calidadesUnicas.includes(calidad)) {
            frutasInfo.calidadesUnicas.push(calidad);
          }
          
          const clave = `${fruta} (${calidad})`;
          if (!frutasInfo.resumenDetallado[clave]) {
            frutasInfo.resumenDetallado[clave] = {
              fruta: fruta,
              calidad: calidad,
              kilos: 0,
              pesas: 0
            };
          }
          
          frutasInfo.resumenDetallado[clave].kilos += pesa.kilos || 0;
          frutasInfo.resumenDetallado[clave].pesas += 1;
        });
      } else {
        const fruta = recogida.fruta || 'Sin especificar';
        const calidad = recogida.calidad || 'Sin especificar';
        
        frutasInfo.frutasUnicas = [fruta];
        frutasInfo.calidadesUnicas = [calidad];
        
        const clave = `${fruta} (${calidad})`;
        frutasInfo.resumenDetallado[clave] = {
          fruta: fruta,
          calidad: calidad,
          kilos: recogida.totalKilos || 0,
          pesas: recogida.pesas ? recogida.pesas.length : 1
        };
      }

      frutasInfo.esSoloUnaFruta = frutasInfo.frutasUnicas.length === 1;
      frutasInfo.esSoloUnaCalidad = frutasInfo.calidadesUnicas.length === 1;

      return frutasInfo;
    }

    // Funci√≥n para generar HTML de frutas
    function generarHtmlFrutas(frutasInfo, esSubusuario = false) {
      let html = '';

      if (frutasInfo.esSoloUnaFruta && frutasInfo.esSoloUnaCalidad) {
        const fruta = frutasInfo.frutasUnicas[0];
        const calidad = frutasInfo.calidadesUnicas[0];
        
        html += `
          <div class="info-row">
            <span class="info-label">üçé Fruta:</span>
            <span class="info-value">${fruta}</span>
          </div>
          
          <div class="info-row">
            <span class="info-label">‚≠ê Calidad:</span>
            <span class="info-value">${calidad}</span>
          </div>
        `;
      } else {
        if (frutasInfo.frutasUnicas.length > 1) {
          html += `
            <div class="info-row">
              <span class="info-label">üçé Frutas:</span>
              <span class="info-value">${frutasInfo.frutasUnicas.join(', ')}</span>
            </div>
          `;
        } else {
          html += `
            <div class="info-row">
              <span class="info-label">üçé Fruta:</span>
              <span class="info-value">${frutasInfo.frutasUnicas[0]}</span>
            </div>
          `;
        }

        if (frutasInfo.calidadesUnicas.length > 1) {
          html += `
            <div class="info-row">
              <span class="info-label">‚≠ê Calidades:</span>
              <span class="info-value">${frutasInfo.calidadesUnicas.join(', ')}</span>
            </div>
          `;
        } else {
          html += `
            <div class="info-row">
              <span class="info-label">‚≠ê Calidad:</span>
              <span class="info-value">${frutasInfo.calidadesUnicas[0]}</span>
            </div>
          `;
        }

        const combinaciones = Object.keys(frutasInfo.resumenDetallado);
        if (combinaciones.length > 1) {
          html += `
            <div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 8px;">
              <div style="font-size: 0.85em; font-weight: bold; margin-bottom: 5px; opacity: 0.9;">
                üìã Detalle por combinaci√≥n:
              </div>
          `;
          
          combinaciones.forEach(clave => {
            const detalle = frutasInfo.resumenDetallado[clave];
            html += `
              <div style="font-size: 0.8em; margin: 2px 0; opacity: 0.8;">
                ‚Ä¢ ${clave}: ${detalle.kilos.toFixed(1)} kg (${detalle.pesas} pesas)
              </div>
            `;
          });
          
          html += '</div>';
        }
      }

      return html;
    }

    // üöÄ FUNCIONES PARA MANEJAR NOTAS DE FINCAS

    // Funci√≥n para cargar las notas de todas las fincas
    async function cargarNotasFincas() {
      try {
        if (!adminAlias) {
          console.log("No hay adminAlias definido, no se cargar√°n notas");
          return {};
        }

        console.log("üìù Cargando notas para admin:", adminAlias);
        const response = await apiFetch(`/notas-finca/conteos/${adminAlias}`, "GET");
        notasPorFinca = response || {};
        console.log(`üìù Notas cargadas para ${Object.keys(notasPorFinca).length} fincas`);
        return notasPorFinca;
      } catch (error) {
        console.error("‚ùå Error al cargar notas de fincas:", error);
        return {};
      }
    }

    // Funci√≥n para mostrar el modal de nota r√°pida
    function mostrarQuickNoteModal(finca) {
      fincaActualParaNota = finca;
      const quickNoteModal = document.getElementById('quickNoteModal');
      const quickNoteTitle = document.getElementById('quickNoteTitle');
      
      quickNoteTitle.textContent = `Agregar nota para finca ${finca.nombre}`;
      document.getElementById('quickNoteContent').value = '';
      quickNoteModal.classList.add('active');
    }

    // Funci√≥n para guardar una nueva nota
    async function guardarNotaFinca() {
      const quickNoteModal = document.getElementById('quickNoteModal');
      const contenido = document.getElementById('quickNoteContent').value.trim();
      
      if (!contenido || !fincaActualParaNota) {
        alert("Por favor escribe una nota");
        return;
      }

      try {
        const nuevaNota = await apiFetch("/notas-finca/agregar", "POST", {
          fincaId: fincaActualParaNota._id,
          contenido,
          usuario,
          adminAlias
        });

        console.log("‚úÖ Nota guardada:", nuevaNota);
        
        // Actualizar el cache local
        if (!notasPorFinca[fincaActualParaNota._id]) {
          notasPorFinca[fincaActualParaNota._id] = { total: 0, fincaNombre: fincaActualParaNota.nombre };
        }
        notasPorFinca[fincaActualParaNota._id].total += 1;
        
        // Actualizar la tarjeta de la finca
        const tarjetaFinca = document.querySelector(`.card-glass[data-finca-id="${fincaActualParaNota._id}"]`);
        if (tarjetaFinca) {
          const existingBadge = tarjetaFinca.querySelector('.nota-badge');
          if (existingBadge) {
            existingBadge.textContent = `üìù ${notasPorFinca[fincaActualParaNota._id].total} nota${notasPorFinca[fincaActualParaNota._id].total > 1 ? 's' : ''}`;
          } else {
            const notaBadge = document.createElement('div');
            notaBadge.className = 'nota-badge';
            notaBadge.textContent = `üìù ${notasPorFinca[fincaActualParaNota._id].total} nota${notasPorFinca[fincaActualParaNota._id].total > 1 ? 's' : ''}`;
            notaBadge.addEventListener('click', (e) => {
              e.stopPropagation();
              mostrarNotasFinca(fincaActualParaNota);
            });
            tarjetaFinca.appendChild(notaBadge);
          }
        }

        quickNoteModal.classList.remove('active');
      } catch (error) {
        console.error("‚ùå Error al guardar nota:", error);
        alert("Error al guardar la nota: " + error.message);
      }
    }

    // Funci√≥n para mostrar todas las notas de una finca
    async function mostrarNotasFinca(finca) {
      fincaActualParaNota = finca;
      const notasModal = document.getElementById('notasModal');
      const notasModalTitle = document.getElementById('notasModalTitle');
      const notasList = document.getElementById('notasList');
      
      notasModalTitle.textContent = `Notas de ${finca.nombre}`;
      notasList.innerHTML = '<div style="text-align: center; padding: 20px;">Cargando notas...</div>';
      notasModal.classList.add('active');

      try {
        const notas = await apiFetch(`/notas-finca/finca/${finca._id}`, "GET");
        
        if (notas.length === 0) {
          notasList.innerHTML = '<div style="text-align: center; padding: 20px;">No hay notas para esta finca</div>';
          return;
        }

        notasList.innerHTML = '';
        notas.forEach(nota => {
          const notaItem = document.createElement('div');
          notaItem.className = 'nota-item';
          
          const fechaCreacion = new Date(nota.fechaCreacion).toLocaleString();
          const fechaModificacion = new Date(nota.fechaModificacion).toLocaleString();
          
          notaItem.innerHTML = `
            <div class="nota-content">${nota.contenido}</div>
            <div class="nota-meta">
              <span>Creada: ${fechaCreacion}</span>
            </div>
            <div class="nota-actions">
              <button class="delete-nota-btn" data-nota-id="${nota._id}">üóëÔ∏è Eliminar</button>
            </div>
          `;
          
          notasList.appendChild(notaItem);
        });

        // Agregar event listeners a los botones de editar y eliminar
        document.querySelectorAll('.edit-nota-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const notaId = e.target.dataset.notaId;
            editarNota(notaId);
          });
        });

        document.querySelectorAll('.delete-nota-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const notaId = e.target.dataset.notaId;
            eliminarNota(notaId);
          });
        });
      } catch (error) {
        console.error("‚ùå Error al cargar notas:", error);
        notasList.innerHTML = '<div style="text-align: center; padding: 20px; color: #f44336;">Error al cargar las notas</div>';
      }
    }

    // Funci√≥n para editar una nota
    async function editarNota(notaId) {
      try {
        const nota = await apiFetch(`/notas-finca/${notaId}`, "GET");
        if (!nota) {
          alert("Nota no encontrada");
          return;
        }

        fincaActualParaNota = { _id: nota.fincaId, nombre: nota.fincaNombre };
        
        const quickNoteModal = document.getElementById('quickNoteModal');
        const quickNoteTitle = document.getElementById('quickNoteTitle');
        const quickNoteContent = document.getElementById('quickNoteContent');
        
        quickNoteTitle.textContent = `Editar nota para finca ${nota.fincaNombre}`;
        quickNoteContent.value = nota.contenido;
        quickNoteModal.classList.add('active');
        
        // Cambiar el bot√≥n de guardar para que actualice en lugar de crear
        const quickNoteSave = document.getElementById('quickNoteSave');
        quickNoteSave.textContent = "Actualizar Nota";
        quickNoteSave.onclick = async () => {
          try {
            const notaActualizada = await apiFetch(`/notas-finca/editar/${notaId}`, "PUT", {
              contenido: quickNoteContent.value.trim()
            });
            
            console.log("‚úÖ Nota actualizada:", notaActualizada);
            quickNoteModal.classList.remove('active');
            mostrarNotasFinca(fincaActualParaNota);
          } catch (error) {
            console.error("‚ùå Error al actualizar nota:", error);
            alert("Error al actualizar la nota: " + error.message);
          }
        };
      } catch (error) {
        console.error("‚ùå Error al cargar nota para editar:", error);
        alert("Error al cargar la nota para editar: " + error.message);
      }
    }

    // Funci√≥n para eliminar una nota
    async function eliminarNota(notaId) {
      if (!confirm("¬øEst√°s seguro de que quieres eliminar esta nota?")) {
        return;
      }

      try {
        await apiFetch(`/notas-finca/eliminar/${notaId}`, "DELETE");
        console.log("‚úÖ Nota eliminada:", notaId);
        
        // Actualizar el cache local
        if (notasPorFinca[fincaActualParaNota._id] && notasPorFinca[fincaActualParaNota._id].total > 0) {
          notasPorFinca[fincaActualParaNota._id].total -= 1;
          
          // Actualizar la tarjeta de la finca
          const tarjetaFinca = document.querySelector(`.card-glass[data-finca-id="${fincaActualParaNota._id}"]`);
          if (tarjetaFinca) {
            const existingBadge = tarjetaFinca.querySelector('.nota-badge');
            if (existingBadge) {
              if (notasPorFinca[fincaActualParaNota._id].total === 0) {
                existingBadge.remove();
              } else {
                existingBadge.textContent = `üìù ${notasPorFinca[fincaActualParaNota._id].total} nota${notasPorFinca[fincaActualParaNota._id].total > 1 ? 's' : ''}`;
              }
            }
          }
        }
        
        mostrarNotasFinca(fincaActualParaNota);
      } catch (error) {
        console.error("‚ùå Error al eliminar nota:", error);
        alert("Error al eliminar la nota: " + error.message);
      }
    }

    // üöÄ OPTIMIZACI√ìN: Mostrar fincas de forma r√°pida
    async function mostrarFincasOptimizado(fincas) {
      const lista = document.getElementById("listaFincas");
      
      if (fincas.length === 0) {
        lista.innerHTML = "<p>No tienes fincas registradas a√∫n.</p>";
        return;
      }

      // Mostrar loader general
      lista.innerHTML = `
        <div class="general-loader">
          <div class="loader-spinner"></div>
          <div>Cargando informaci√≥n de ${fincas.length} finca${fincas.length > 1 ? 's' : ''}...</div>
        </div>
      `;

      console.log("üöÄ Iniciando renderizado optimizado...");
      const startTime = performance.now();

      // 1. Cargar notas de fincas primero
      await cargarNotasFincas();

      // 2. Renderizar todas las fincas (sin datos de recogidas)
      const fragments = document.createDocumentFragment();
      const divsFincas = [];

      fincas.forEach(finca => {
        const div = renderFincaRapido(finca);
        fragments.appendChild(div);
        divsFincas.push({ div, finca });
      });

      // Limpiar y agregar todas las fincas de una vez
      lista.innerHTML = "";
      lista.appendChild(fragments);

      const renderTime = performance.now();
      console.log(`‚úÖ Fincas renderizadas en ${(renderTime - startTime).toFixed(0)}ms`);

      // 3. Cargar todas las recogidas en paralelo
      const fincaIds = fincas.map(f => f._id);
      await cargarTodasLasRecogidas(fincaIds);

      // 4. Actualizar la informaci√≥n de recogidas para todas las fincas
      divsFincas.forEach(({ div, finca }) => {
        actualizarInfoRecogidas(div, finca);
      });

      const totalTime = performance.now();
      console.log(`üéâ Proceso completo terminado en ${(totalTime - startTime).toFixed(0)}ms`);
      console.log(`üìä Rendimiento: ${fincas.length} fincas en ${((totalTime - startTime) / 1000).toFixed(2)} segundos`);
    }

    // üöÄ OPTIMIZACI√ìN: Obtener tipo de usuario al inicio
    async function obtenerTipoUsuario() {
      try {
        const storedData = sessionStorage.getItem('userData');
        if (storedData) {
          const userData = JSON.parse(storedData);
          tipoUsuarioActual = userData.tipo;
          console.log("üë§ Tipo de usuario desde sessionStorage:", tipoUsuarioActual);
          return tipoUsuarioActual;
        }

        if (usuario) {
          const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
          if (response.ok) {
            const userData = await response.json();
            tipoUsuarioActual = userData.tipo;
            console.log("üë§ Tipo de usuario desde servidor:", tipoUsuarioActual);
            
            // Guardar en sessionStorage para pr√≥ximas consultas
            sessionStorage.setItem('userData', JSON.stringify(userData));
            return tipoUsuarioActual;
          }
        }

        console.log("üë§ Usando tipo de usuario por defecto:", tipoUsuarioActual);
        return tipoUsuarioActual;
      } catch (error) {
        console.error("‚ùå Error al obtener tipo de usuario:", error);
        return tipoUsuarioActual;
      }
    }

    // Event listeners y funciones principales
    const btnAgregar = document.getElementById("btnAgregarFinca");
    const modal = document.getElementById("modalFinca");
    const guardar = document.getElementById("guardarFinca");
    const lista = document.getElementById("listaFincas");

    // Event listeners para el modal de notas
    document.getElementById('quickNoteCancel').addEventListener('click', () => {
      document.getElementById('quickNoteModal').classList.remove('active');    });

    document.getElementById('quickNoteSave').addEventListener('click', guardarNotaFinca);

    document.getElementById('notasModalClose').addEventListener('click', () => {
      document.getElementById('notasModal').classList.remove('active');
    });

    document.getElementById('addNewNoteBtn').addEventListener('click', () => {
      document.getElementById('notasModal').classList.remove('active');
      mostrarQuickNoteModal(fincaActualParaNota);
    });

    // Event listener para guardar finca
    guardar.addEventListener("click", async () => {
      const nombre = document.getElementById("nombreFinca").value.trim();
      const propietario = document.getElementById("propietarioFinca").value.trim();

      if (!nombre || !propietario) return alert("Completa todos los campos");

      try {
        const finca = await apiFetch("/fincas/agregar", "POST", { 
          nombre, 
          propietario, 
          usuario,
          adminAlias
        });
        
        // Agregar la nueva finca al inicio del array
        todasLasFincas.unshift(finca);
        
        // Renderizar solo la nueva finca y agregarla al inicio
        const div = renderFincaRapido(finca);
        lista.prepend(div);
        
        // Cargar datos de recogidas para la nueva finca
        await cargarTodasLasRecogidas([finca._id]);
        actualizarInfoRecogidas(div, finca);
        
        modal.classList.add("hidden");
        
        // Limpiar formulario
        document.getElementById("nombreFinca").value = "";
        document.getElementById("propietarioFinca").value = "";
      } catch (err) {
        console.error("Error al guardar finca:", err);
        alert("Error al guardar finca: " + err.message);
      }
    });

    async function cargarFincas() {
      try {
        console.log("üîç Cargando fincas para administrador:", adminAlias);
        
        if (!adminAlias) {
          console.error("‚ùå No hay adminAlias definido");
          const todasFincas = await apiFetch("/fincas/listar", "GET");
          const fincasUsuario = todasFincas.filter(f => f.usuario === usuario);
          todasLasFincas = fincasUsuario;
        } else {
          const response = await fetch(`https://jc-frutas.onrender.com/fincas/por-admin/${adminAlias}`);
          if (response.ok) {
            const fincasAdmin = await response.json();
            todasLasFincas = fincasAdmin;
            console.log("üìã Fincas del administrador:", todasLasFincas.length);
          } else {
            const todasFincas = await apiFetch("/fincas/listar", "GET");
            const fincasUsuario = todasFincas.filter(f => f.usuario === usuario || f.adminAlias === adminAlias);
            todasLasFincas = fincasUsuario;
          }
        }
        
        console.log("üìã Total de fincas cargadas:", todasLasFincas.length);
        
        // Obtener tipo de usuario antes de mostrar las fincas
        await obtenerTipoUsuario();
        
        // Mostrar fincas con el m√©todo optimizado
        await mostrarFincasOptimizado(todasLasFincas);
      } catch (err) {
        console.error("Error al cargar fincas:", err);
        alert("Error al cargar fincas: " + err.message);
      }
    }

    // Event listeners para el modal
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.add("hidden");
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        modal.classList.add("hidden");
      }
    });

    btnAgregar.addEventListener("click", () => {
      modal.classList.remove("hidden");
    });

    // üöÄ OPTIMIZACI√ìN: B√∫squeda optimizada
    const inputBuscar = document.getElementById("buscarFinca");
    let timeoutBusqueda;

    inputBuscar.addEventListener("input", () => {
      // Debounce para evitar b√∫squedas excesivas
      clearTimeout(timeoutBusqueda);
      
      timeoutBusqueda = setTimeout(async () => {
        const texto = inputBuscar.value.toLowerCase();

        const filtradas = todasLasFincas.filter(finca =>
          finca.nombre.toLowerCase().includes(texto) ||
          finca.propietario.toLowerCase().includes(texto)
        );

        console.log(`üîç B√∫squeda: "${texto}" - ${filtradas.length} resultados`);
        await mostrarFincasOptimizado(filtradas);
      }, 300); // Esperar 300ms despu√©s de que el usuario deje de escribir
    });

    // Agregar estilos responsivos
    function agregarEstilosResponsivos() {
      const style = document.createElement('style');
      style.textContent = `
        @media (max-width: 768px) {
          #historial-top-container {
            padding: 8px 15px;
          }

          #historial-top-container .historial-btn {
            padding: 10px 20px;
            font-size: 0.9rem;
            min-width: 160px;
          }

          body[style*="padding-top"] {
            padding-top: 60px !important;
          }
          .container[style*="margin-top"] {
            margin-top: 60px !important;
          }
        }

        @media (max-width: 480px) {
          #historial-top-container {
            padding: 6px 10px;
          }

          #historial-top-container .historial-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            min-width: 140px;
            gap: 6px;
          }

          body[style*="padding-top"] {
            padding-top: 50px !important;
          }
          .container[style*="margin-top"] {
            margin-top: 50px !important;
          }
        }

        #historial-top-container {
          animation: slideDownFromTop 0.5s ease forwards;
          z-index: 99999 !important;
          background: rgba(255, 255, 255, 0.9) !important;
          backdrop-filter: blur(20px) !important;
          -webkit-backdrop-filter: blur(20px) !important;
          border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        @keyframes slideDownFromTop {
          from {
            opacity: 0;
            transform: translateY(-100%);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        @media (prefers-color-scheme: dark) {
          #historial-top-container {
            background: rgba(0, 0, 0, 0.8) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
          }
        }
      `;
      document.head.appendChild(style);
    }

    // Inicializaci√≥n principal
    document.addEventListener('DOMContentLoaded', () => {
      agregarEstilosResponsivos();
      
      setTimeout(() => {
        inicializarBotonHistorial();
      }, 500);
    });

    if (document.readyState === 'loading') {
      // El evento DOMContentLoaded se ejecutar√°
    } else {
      setTimeout(() => {
        agregarEstilosResponsivos();
        inicializarBotonHistorial();
      }, 100);
    }

    // Cleanup al salir de la p√°gina
    window.addEventListener('beforeunload', () => {
      const topContainer = document.getElementById('historial-top-container');
      if (topContainer) {
        topContainer.remove();
      }
      
      const body = document.body;
      const container = document.querySelector('.container');
      
      if (body.style.paddingTop) {
        body.style.paddingTop = '';
      }
      
      if (container && container.style.marginTop) {
        container.style.marginTop = '';
      }
    });

    // Cargar fincas al iniciar
    cargarFincas();
  </script>
</body>
</html>