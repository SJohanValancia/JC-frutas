<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Tipo 1</title>
  <link rel="stylesheet" href="style.css">
  <script src="jc-loader.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .card-glass {
      background: var(--glass-bg, rgba(255, 255, 255, 0.1));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .finca-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .finca-title {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary-color, #00d4ff);
      margin-bottom: 5px;
    }

    .propietario {
      opacity: 0.8;
      font-size: 0.95em;
    }

    .recogida-info {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      align-items: flex-start;
    }

    .info-label {
      font-weight: bold;
      opacity: 0.8;
      min-width: 35%;
    }

    .info-value {
      color: var(--primary-color, #00d4ff);
      font-weight: bold;
      text-align: right;
      max-width: 60%;
      word-wrap: break-word;
    }

    .sin-recogidas {
      text-align: center;
      opacity: 0.6;
      font-style: italic;
      padding: 20px;
    }

    .botones-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .botones-container button {
      flex: 1;
      min-width: 120px;
      padding: 8px 12px;
      font-size: 0.85em;
    }

    .loading-info {
      opacity: 0.6;
      text-align: center;
      padding: 10px;
      font-style: italic;
    }

    .historial-btn {
      position: absolute;
      transform: translateX(-270px);
    }

    .historial-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* Skeleton loading animation */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-text {
      height: 16px;
      border-radius: 4px;
      margin: 8px 0;
    }

    .skeleton-title {
      height: 24px;
      border-radius: 6px;
      margin: 10px 0;
      width: 70%;
    }

    /* Loader general */
    .general-loader {
      text-align: center;
      padding: 40px 20px;
      color: var(--primary-color, #00d4ff);
      font-size: 1.1em;
    }

    .loader-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 212, 255, 0.3);
      border-top: 4px solid var(--primary-color, #00d4ff);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive optimizations */
    @media (max-width: 480px) {
      .info-row {
        flex-direction: column;
        gap: 2px;
      }
      
      .info-value {
        text-align: left;
        max-width: 100%;
      }
      
      .info-label {
        min-width: auto;
      }
    }
  </style>
</head>
<body>

  

  <div class="container">

        <button id="btnEditarPrecios" class="floating-btn">‚úèÔ∏è Editar Precios</button>

    <h1 id="saludo">Bienvenido</h1>
    <button id="btnAgregarFinca">‚ûï Agregar Finca</button>
    <input type="text" id="buscarFinca" placeholder="Buscar finca o propietario...">
    <div id="listaFincas"></div>
  </div>

  <div id="modalFinca" class="modal hidden">
    <div class="modal-content">
      <h3>Agregar Finca</h3>
      <input type="text" id="nombreFinca" placeholder="Nombre de la finca">
      <input type="text" id="propietarioFinca" placeholder="Nombre del propietario">
      <button id="guardarFinca">Guardar</button>
    </div>
  </div>

  <script type="module">
    import { apiFetch } from "./api.js";

    // üîç DEBUG: Verificar la URL completa
    console.log("=== URL Y PAR√ÅMETROS ===");
    console.log("URL completa:", window.location.href);
    console.log("Search params:", window.location.search);

    // Obtener los par√°metros de la URL
    const params = new URLSearchParams(window.location.search);
    const usuario = params.get("usuario");
    let alias = params.get("alias");
    let adminAlias = alias;

    

const btnEditarPrecios = document.getElementById("btnEditarPrecios");

btnEditarPrecios.addEventListener("click", () => {
  // Navegar a la nueva p√°gina de gesti√≥n de precios
  let preciosUrl = `gestion-precios.html?usuario=${encodeURIComponent(usuario)}`;
  if (alias) {
    preciosUrl += `&alias=${encodeURIComponent(alias)}`;
  }
  window.location.href = preciosUrl;
});

    // Si no se encuentra alias en la URL, hacer una llamada al servidor para obtenerlo
    if (!alias && usuario) {
      console.log("Alias no encontrado en la URL, haciendo una llamada al servidor para obtenerlo...");

      async function obtenerAliasDesdeServidor() {
        try {
          const response = await apiFetch(`/auth/get-alias?usuario=${usuario}`, "GET");
          alias = response.alias || 'Alias no disponible';
          adminAlias = alias;
          console.log("Alias obtenido desde el servidor:", alias);
          mostrarUsuarioYAlias();
        } catch (error) {
          console.error("Error al obtener alias desde el servidor:", error);
          alias = 'Alias no disponible';
          adminAlias = alias;
          mostrarUsuarioYAlias();
        }
      }

      obtenerAliasDesdeServidor();
    } else {
      console.log("Alias encontrado en la URL:", alias);
      adminAlias = alias;
      mostrarUsuarioYAlias();
    }

    // Variables globales
    let todasLasFincas = [];
    let todasLasRecogidas = {}; // Cache de recogidas por finca
    let tipoUsuarioActual = 1; // Por defecto administrador

    // üî• FUNCI√ìN PARA CREAR EL BOT√ìN DE HISTORIAL DE RECOGIDAS
    function crearBotonHistorialRecogidas() {
      const existingButton = document.getElementById('historial-recogidas-btn');
      if (existingButton) return;

      const params = new URLSearchParams(window.location.search);
      const usuario = params.get('usuario');
      const alias = params.get('alias');

      if (!usuario) {
        console.warn('‚ö†Ô∏è No se encontr√≥ usuario en los par√°metros URL');
        return;
      }

      const button = document.createElement('button');
      button.id = 'historial-recogidas-btn';
      button.className = 'historial-btn';
      button.innerHTML = 'üìä Historial Completo';
      
      button.style.cssText = `
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        font-size: 1rem;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
        margin: 10px;
        min-width: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      `;

      button.addEventListener('mouseenter', () => {
        button.style.transform = 'translateY(-2px)';
        button.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.4)';
        button.style.background = 'linear-gradient(135deg, #5a6fd8, #6a4c93)';
      });

      button.addEventListener('mouseleave', () => {
        button.style.transform = 'translateY(0)';
        button.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.3)';
        button.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
      });

      button.addEventListener('click', () => {
        let historialUrl = `historial-recogidas.html?usuario=${encodeURIComponent(usuario)}`;
        
        if (alias) {
          historialUrl += `&alias=${encodeURIComponent(alias)}`;
        }

        console.log('üìä Navegando al historial completo:', historialUrl);
        
        button.innerHTML = '‚è≥ Cargando...';
        button.disabled = true;
        
        setTimeout(() => {
          window.location.href = historialUrl;
        }, 300);
      });

      return button;
    }

    function insertarBotonHistorial() {
      const button = crearBotonHistorialRecogidas();
      if (!button) return;

      const topContainer = document.createElement('div');
      topContainer.id = 'historial-top-container';
      topContainer.style.cssText = `
        position: absolute;
        top: 10px;
        left: -20px;
        right: 0;
      `;

      button.style.cssText = `
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.95rem;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 180px;
      `;

      topContainer.appendChild(button);
      document.body.insertBefore(topContainer, document.body.firstChild);
      adjustBodyForFixedButton();

      console.log('‚úÖ Bot√≥n insertado arriba, fuera del container');
    }

    function adjustBodyForFixedButton() {
      const body = document.body;
      const container = document.querySelector('.container');
      const buttonHeight = '70px';
      
      if (container) {
        container.style.marginTop = buttonHeight;
      } else {
        body.style.paddingTop = buttonHeight;
      }
    }

    async function verificarPermisosHistorial() {
      try {
        const params = new URLSearchParams(window.location.search);
        const usuario = params.get('usuario');
        
        if (!usuario) return false;

        const storedData = sessionStorage.getItem('userData');
        if (storedData) {
          const userData = JSON.parse(storedData);
          return userData.tipo === 1 || userData.tipo === 2;
        }

        const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
        if (response.ok) {
          const userData = await response.json();
          return userData.tipo === 1 || userData.tipo === 2;
        }

        return false;
      } catch (error) {
        console.error('‚ùå Error al verificar permisos:', error);
        return false;
      }
    }

    async function inicializarBotonHistorial() {
      const tienePermisos = await verificarPermisosHistorial();
      
      if (!tienePermisos) {
        console.log('‚ÑπÔ∏è Usuario sin permisos para ver historial completo');
        return;
      }

      if (window.location.pathname.includes('historial-recogidas.html')) {
        console.log('‚ÑπÔ∏è Ya estamos en la p√°gina de historial completo');
        return;
      }

      insertarBotonHistorial();
    }

    // Funci√≥n para mostrar el usuario y alias
    function mostrarUsuarioYAlias() {
      console.log("=== DEBUG URL ===");
      console.log("Usuario extra√≠do de URL:", usuario);
      console.log("Alias extra√≠do de URL:", alias);
      console.log("AdminAlias asignado:", adminAlias);

      const saludo = document.getElementById("saludo");
      if (usuario) {
        saludo.textContent = `Bienvenido, ${alias}`;
      } else {
        saludo.textContent = "Bienvenido (usuario no identificado)";
      }
    }

    // üöÄ OPTIMIZACI√ìN: Cargar todas las recogidas de una vez
    async function cargarTodasLasRecogidas(fincaIds) {
      console.log("üöÄ Cargando recogidas para todas las fincas de una vez...");
      const startTime = performance.now();
      
      try {
        // Crear promises para todas las fincas al mismo tiempo
        const promises = fincaIds.map(async (fincaId) => {
          try {
            const recogidas = await apiFetch(`/recogidas/por-finca/${fincaId}`, "GET");
            return { fincaId, recogidas: recogidas || [] };
          } catch (error) {
            console.error(`Error cargando recogidas para finca ${fincaId}:`, error);
            return { fincaId, recogidas: [] };
          }
        });

        // Esperar a que todas las llamadas terminen
        const resultados = await Promise.all(promises);
        
        // Organizar los resultados en el cache
        resultados.forEach(({ fincaId, recogidas }) => {
          todasLasRecogidas[fincaId] = recogidas;
        });

        const endTime = performance.now();
        console.log(`‚úÖ Recogidas cargadas en ${(endTime - startTime).toFixed(0)}ms`);
        console.log(`üìä Total fincas procesadas: ${fincaIds.length}`);
        
        return todasLasRecogidas;
      } catch (error) {
        console.error("‚ùå Error cargando recogidas:", error);
        return {};
      }
    }

    // üöÄ OPTIMIZACI√ìN: Obtener informaci√≥n de recogida desde cache
    function obtenerInfoRecogidaDesdeCache(fincaId) {
      const recogidas = todasLasRecogidas[fincaId] || [];
      
      if (recogidas.length === 0) {
        return null;
      }

      const ultimaRecogida = recogidas[0];
      const totalRecogidas = recogidas.length;
      const totalKilosAcumulado = recogidas.reduce((sum, r) => sum + (r.totalKilos || 0), 0);
      const totalPagadoAcumulado = recogidas.reduce((sum, r) => sum + (r.valorPagar || 0), 0);
      
      return {
        ultimaRecogida,
        totalRecogidas,
        totalKilosAcumulado,
        totalPagadoAcumulado
      };
    }

    // üöÄ OPTIMIZACI√ìN: Renderizar finca sin llamadas as√≠ncronas
    function renderFincaRapido(finca) {
      const div = document.createElement("div");
      div.className = "card-glass";
      
      // HTML inicial de la tarjeta
      div.innerHTML = `
        <div class="finca-header">
          <div class="finca-title">${finca.nombre}</div>
          <div class="propietario">Propietario: ${finca.propietario}</div>
        </div>
        
        <div class="recogida-info" data-finca-id="${finca._id}">
          <div class="loading-info">‚è≥ Cargando informaci√≥n de recogidas...</div>
        </div>
        
        <div class="botones-container">
          <button onclick="location.href='precios.html?id=${finca._id}&usuario=${encodeURIComponent(usuario)}'">üí∞ Precios</button>
          <button onclick="location.href='recogida.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üìä Recogida</button>
          <button onclick="location.href='historial.html?id=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}'">üìã Historial</button>
          <button onclick="location.href='liquidacion.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üí∞ Liquidaci√≥n</button>
        </div>
      `;
      
      return div;
    }

    // üöÄ OPTIMIZACI√ìN: Actualizar informaci√≥n de recogidas despu√©s del renderizado
    function actualizarInfoRecogidas(div, finca) {
      const recogidaInfoDiv = div.querySelector('.recogida-info');
      const infoRecogidas = obtenerInfoRecogidaDesdeCache(finca._id);
      
      if (infoRecogidas && infoRecogidas.ultimaRecogida) {
        const { ultimaRecogida, totalRecogidas, totalKilosAcumulado, totalPagadoAcumulado } = infoRecogidas;
        
        const usuarioMostrar = ultimaRecogida.alias || ultimaRecogida.usuario || 'Usuario desconocido';
        const frutasInfo = analizarFrutasDeRecogida(ultimaRecogida);
        
        const esUsuarioActualSubusuario = tipoUsuarioActual === 2;
        
        if (!esUsuarioActualSubusuario) {
          recogidaInfoDiv.innerHTML = `
            <div style="text-align: center; font-weight: bold; margin-bottom: 10px; color: var(--primary-color, #00d4ff);">
              üìä √öltima Recogida - ${formatearFechaUniversal(ultimaRecogida.fecha)}
            </div>

            <div class="info-row">
              <span class="info-label">üë§ Usuario:</span>
              <span class="info-value">${usuarioMostrar}</span>
            </div>
            
            ${generarHtmlFrutas(frutasInfo, false)}
            
            <div class="info-row">
              <span class="info-label">‚öñÔ∏è Kilos:</span>
              <span class="info-value">${ultimaRecogida.totalKilos ? ultimaRecogida.totalKilos.toFixed(1) + ' kg' : 'N/A'}</span>
            </div>
            
            <div class="info-row">
              <span class="info-label">üß∫ Pesas:</span>
              <span class="info-value">${ultimaRecogida.pesas ? ultimaRecogida.pesas.length : 0}</span>
            </div>
            
            <div class="info-row">
              <span class="info-label">üíµ A pagar:</span>
              <span class="info-value">${formatearMoneda(ultimaRecogida.valorPagar)}</span>
            </div>
            
            <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px; padding-top: 10px;">
              <div class="info-row">
                <span class="info-label">üìà Total recogidas:</span>
                <span class="info-value">${totalRecogidas}</span>
              </div>
              
              <div class="info-row">
                <span class="info-label">üì¶ Total kilos:</span>
                <span class="info-value">${totalKilosAcumulado.toFixed(1)} kg</span>
              </div>
              
              <div class="info-row">
                <span class="info-label">üí∞ Total pagado:</span>
                <span class="info-value">${formatearMoneda(totalPagadoAcumulado)}</span>
              </div>
            </div>
          `;
        } else {
          recogidaInfoDiv.innerHTML = `
            <div style="text-align: center; font-weight: bold; margin-bottom: 10px; color: var(--primary-color, #00d4ff);">
              üìä √öltima Recogida - ${formatearFechaUniversal(ultimaRecogida.fecha)}
            </div>

            <div class="info-row">
              <span class="info-label">üë§ Usuario:</span>
              <span class="info-value">${usuarioMostrar}</span>
            </div>
            
            ${generarHtmlFrutas(frutasInfo, true)}
            
            <div class="info-row">
              <span class="info-label">‚öñÔ∏è Kilos:</span>
              <span class="info-value">${ultimaRecogida.totalKilos ? ultimaRecogida.totalKilos.toFixed(1) + ' kg' : 'N/A'}</span>
            </div>
            
            <div class="info-row">
              <span class="info-label">üß∫ Pesas:</span>
              <span class="info-value">${ultimaRecogida.pesas ? ultimaRecogida.pesas.length : 0}</span>
            </div>
            
            <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px; padding-top: 10px;">
              <div class="info-row">
                <span class="info-label">üìà Total recogidas:</span>
                <span class="info-value">${totalRecogidas}</span>
              </div>
              
              <div class="info-row">
                <span class="info-label">üì¶ Total kilos:</span>
                <span class="info-value">${totalKilosAcumulado.toFixed(1)} kg</span>
              </div>
            </div>
          `;
        }
      } else {
        recogidaInfoDiv.innerHTML = `
          <div class="sin-recogidas">
            üìù Sin recogidas registradas<br>
            <small>¬°Realiza tu primera recogida!</small>
          </div>
        `;
      }
    }

    // Funci√≥n para formatear fecha universal
    function formatearFechaUniversal(fecha) {
      if (!fecha) return "No disponible";
      
      try {
        let dateObj;
        
        if (typeof fecha === 'string' && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
          const [year, month, day] = fecha.split('-');
          dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        } else {
          dateObj = new Date(fecha);
          
          const timeComponent = dateObj.getUTCHours() + dateObj.getUTCMinutes() + dateObj.getUTCSeconds();
          
          if (timeComponent === 0) {
            const dia = String(dateObj.getUTCDate()).padStart(2, '0');
            const mes = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
            const a√±o = dateObj.getUTCFullYear();
            return `${dia}/${mes}/${a√±o}`;
          }
        }
        
        if (isNaN(dateObj.getTime())) {
          return "Fecha inv√°lida";
        }
        
        const dia = String(dateObj.getDate()).padStart(2, '0');
        const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
        const a√±o = dateObj.getFullYear();
        
        return `${dia}/${mes}/${a√±o}`;
        
      } catch (error) {
        console.error("‚ùå Error al formatear fecha universal:", error, "Fecha:", fecha);
        return "Fecha inv√°lida";
      }
    }

    // Funci√≥n para formatear moneda
    function formatearMoneda(valor) {
      if (!valor && valor !== 0) return "$0";
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(valor);
    }

    // Funci√≥n para analizar frutas de recogida
    function analizarFrutasDeRecogida(recogida) {
      const frutasInfo = {
        frutasUnicas: [],
        calidadesUnicas: [],
        resumenDetallado: {},
        esSoloUnaFruta: false,
        esSoloUnaCalidad: false
      };

      if (recogida.pesas && recogida.pesas.length > 0) {
        recogida.pesas.forEach(pesa => {
          const fruta = pesa.fruta || recogida.fruta || 'Sin especificar';
          const calidad = pesa.calidad || recogida.calidad || 'Sin especificar';
          
          if (!frutasInfo.frutasUnicas.includes(fruta)) {
            frutasInfo.frutasUnicas.push(fruta);
          }
          
          if (!frutasInfo.calidadesUnicas.includes(calidad)) {
            frutasInfo.calidadesUnicas.push(calidad);
          }
          
          const clave = `${fruta} (${calidad})`;
          if (!frutasInfo.resumenDetallado[clave]) {
            frutasInfo.resumenDetallado[clave] = {
              fruta: fruta,
              calidad: calidad,
              kilos: 0,
              pesas: 0
            };
          }
          
          frutasInfo.resumenDetallado[clave].kilos += pesa.kilos || 0;
          frutasInfo.resumenDetallado[clave].pesas += 1;
        });
      } else {
        const fruta = recogida.fruta || 'Sin especificar';
        const calidad = recogida.calidad || 'Sin especificar';
        
        frutasInfo.frutasUnicas = [fruta];
        frutasInfo.calidadesUnicas = [calidad];
        
        const clave = `${fruta} (${calidad})`;
        frutasInfo.resumenDetallado[clave] = {
          fruta: fruta,
          calidad: calidad,
          kilos: recogida.totalKilos || 0,
          pesas: recogida.pesas ? recogida.pesas.length : 1
        };
      }

      frutasInfo.esSoloUnaFruta = frutasInfo.frutasUnicas.length === 1;
      frutasInfo.esSoloUnaCalidad = frutasInfo.calidadesUnicas.length === 1;

      return frutasInfo;
    }

    // Funci√≥n para generar HTML de frutas
    function generarHtmlFrutas(frutasInfo, esSubusuario = false) {
      let html = '';

      if (frutasInfo.esSoloUnaFruta && frutasInfo.esSoloUnaCalidad) {
        const fruta = frutasInfo.frutasUnicas[0];
        const calidad = frutasInfo.calidadesUnicas[0];
        
        html += `
          <div class="info-row">
            <span class="info-label">üçé Fruta:</span>
            <span class="info-value">${fruta}</span>
          </div>
          
          <div class="info-row">
            <span class="info-label">‚≠ê Calidad:</span>
            <span class="info-value">${calidad}</span>
          </div>
        `;
      } else {
        if (frutasInfo.frutasUnicas.length > 1) {
          html += `
            <div class="info-row">
              <span class="info-label">üçé Frutas:</span>
              <span class="info-value">${frutasInfo.frutasUnicas.join(', ')}</span>
            </div>
          `;
        } else {
          html += `
            <div class="info-row">
              <span class="info-label">üçé Fruta:</span>
              <span class="info-value">${frutasInfo.frutasUnicas[0]}</span>
            </div>
          `;
        }

        if (frutasInfo.calidadesUnicas.length > 1) {
          html += `
            <div class="info-row">
              <span class="info-label">‚≠ê Calidades:</span>
              <span class="info-value">${frutasInfo.calidadesUnicas.join(', ')}</span>
            </div>
          `;
        } else {
          html += `
            <div class="info-row">
              <span class="info-label">‚≠ê Calidad:</span>
              <span class="info-value">${frutasInfo.calidadesUnicas[0]}</span>
            </div>
          `;
        }

        const combinaciones = Object.keys(frutasInfo.resumenDetallado);
        if (combinaciones.length > 1) {
          html += `
            <div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 8px;">
              <div style="font-size: 0.85em; font-weight: bold; margin-bottom: 5px; opacity: 0.9;">
                üìã Detalle por combinaci√≥n:
              </div>
          `;
          
          combinaciones.forEach(clave => {
            const detalle = frutasInfo.resumenDetallado[clave];
            html += `
              <div style="font-size: 0.8em; margin: 2px 0; opacity: 0.8;">
                ‚Ä¢ ${clave}: ${detalle.kilos.toFixed(1)} kg (${detalle.pesas} pesas)
              </div>
            `;
          });
          
          html += '</div>';
        }
      }

      return html;
    }

    // üöÄ OPTIMIZACI√ìN: Mostrar fincas de forma r√°pida
    async function mostrarFincasOptimizado(fincas) {
      const lista = document.getElementById("listaFincas");
      
      if (fincas.length === 0) {
        lista.innerHTML = "<p>No tienes fincas registradas a√∫n.</p>";
        return;
      }

      // Mostrar loader general
      lista.innerHTML = `
        <div class="general-loader">
          <div class="loader-spinner"></div>
          <div>Cargando informaci√≥n de ${fincas.length} finca${fincas.length > 1 ? 's' : ''}...</div>
        </div>
      `;

      console.log("üöÄ Iniciando renderizado optimizado...");
      const startTime = performance.now();

      // 1. Renderizar todas las fincas primero (sin datos de recogidas)
      const fragments = document.createDocumentFragment();
      const divsFincas = [];

      fincas.forEach(finca => {
        const div = renderFincaRapido(finca);
        fragments.appendChild(div);
        divsFincas.push({ div, finca });
      });

      // Limpiar y agregar todas las fincas de una vez
      lista.innerHTML = "";
      lista.appendChild(fragments);

      const renderTime = performance.now();
      console.log(`‚úÖ Fincas renderizadas en ${(renderTime - startTime).toFixed(0)}ms`);

      // 2. Cargar todas las recogidas en paralelo
      const fincaIds = fincas.map(f => f._id);
      await cargarTodasLasRecogidas(fincaIds);

      // 3. Actualizar la informaci√≥n de recogidas para todas las fincas
      divsFincas.forEach(({ div, finca }) => {
        actualizarInfoRecogidas(div, finca);
      });

      const totalTime = performance.now();
      console.log(`üéâ Proceso completo terminado en ${(totalTime - startTime).toFixed(0)}ms`);
      console.log(`üìä Rendimiento: ${fincas.length} fincas en ${((totalTime - startTime) / 1000).toFixed(2)} segundos`);
    }

    // üöÄ OPTIMIZACI√ìN: Obtener tipo de usuario al inicio
    async function obtenerTipoUsuario() {
      try {
        const storedData = sessionStorage.getItem('userData');
        if (storedData) {
          const userData = JSON.parse(storedData);
          tipoUsuarioActual = userData.tipo;
          console.log("üë§ Tipo de usuario desde sessionStorage:", tipoUsuarioActual);
          return tipoUsuarioActual;
        }

        if (usuario) {
          const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
          if (response.ok) {
            const userData = await response.json();
            tipoUsuarioActual = userData.tipo;
            console.log("üë§ Tipo de usuario desde servidor:", tipoUsuarioActual);
            
            // Guardar en sessionStorage para pr√≥ximas consultas
            sessionStorage.setItem('userData', JSON.stringify(userData));
            return tipoUsuarioActual;
          }
        }

        console.log("üë§ Usando tipo de usuario por defecto:", tipoUsuarioActual);
        return tipoUsuarioActual;
      } catch (error) {
        console.error("‚ùå Error al obtener tipo de usuario:", error);
        return tipoUsuarioActual;
      }
    }

    // Event listeners y funciones principales
    const btnAgregar = document.getElementById("btnAgregarFinca");
    const modal = document.getElementById("modalFinca");
    const guardar = document.getElementById("guardarFinca");
    const lista = document.getElementById("listaFincas");

    // Event listener para guardar finca
    guardar.addEventListener("click", async () => {
      const nombre = document.getElementById("nombreFinca").value.trim();
      const propietario = document.getElementById("propietarioFinca").value.trim();

      if (!nombre || !propietario) return alert("Completa todos los campos");

      try {
        const finca = await apiFetch("/fincas/agregar", "POST", { 
          nombre, 
          propietario, 
          usuario,
          adminAlias
        });
        
        // Agregar la nueva finca al inicio del array
        todasLasFincas.unshift(finca);
        
        // Renderizar solo la nueva finca y agregarla al inicio
        const div = renderFincaRapido(finca);
        lista.prepend(div);
        
        // Cargar datos de recogidas para la nueva finca
        await cargarTodasLasRecogidas([finca._id]);
        actualizarInfoRecogidas(div, finca);
        
        modal.classList.add("hidden");
        
        // Limpiar formulario
        document.getElementById("nombreFinca").value = "";
        document.getElementById("propietarioFinca").value = "";
      } catch (err) {
        console.error("Error al guardar finca:", err);
        alert("Error al guardar finca: " + err.message);
      }
    });

    async function cargarFincas() {
      try {
        console.log("üîç Cargando fincas para administrador:", adminAlias);
        
        if (!adminAlias) {
          console.error("‚ùå No hay adminAlias definido");
          const todasFincas = await apiFetch("/fincas/listar", "GET");
          const fincasUsuario = todasFincas.filter(f => f.usuario === usuario);
          todasLasFincas = fincasUsuario;
        } else {
          const response = await fetch(`https://jc-frutas.onrender.com/fincas/por-admin/${adminAlias}`);
          if (response.ok) {
            const fincasAdmin = await response.json();
            todasLasFincas = fincasAdmin;
            console.log("üìã Fincas del administrador:", todasLasFincas.length);
          } else {
            const todasFincas = await apiFetch("/fincas/listar", "GET");
            const fincasUsuario = todasFincas.filter(f => f.usuario === usuario || f.adminAlias === adminAlias);
            todasLasFincas = fincasUsuario;
          }
        }
        
        console.log("üìã Total de fincas cargadas:", todasLasFincas.length);
        
        // Obtener tipo de usuario antes de mostrar las fincas
        await obtenerTipoUsuario();
        
        // Mostrar fincas con el m√©todo optimizado
        await mostrarFincasOptimizado(todasLasFincas);
      } catch (err) {
        console.error("Error al cargar fincas:", err);
        alert("Error al cargar fincas: " + err.message);
      }
    }

    // Event listeners para el modal
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.add("hidden");
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        modal.classList.add("hidden");
      }
    });

    btnAgregar.addEventListener("click", () => {
      modal.classList.remove("hidden");
    });

    // üöÄ OPTIMIZACI√ìN: B√∫squeda optimizada
    const inputBuscar = document.getElementById("buscarFinca");
    let timeoutBusqueda;

    inputBuscar.addEventListener("input", () => {
      // Debounce para evitar b√∫squedas excesivas
      clearTimeout(timeoutBusqueda);
      
      timeoutBusqueda = setTimeout(async () => {
        const texto = inputBuscar.value.toLowerCase();

        const filtradas = todasLasFincas.filter(finca =>
          finca.nombre.toLowerCase().includes(texto) ||
          finca.propietario.toLowerCase().includes(texto)
        );

        console.log(`üîç B√∫squeda: "${texto}" - ${filtradas.length} resultados`);
        await mostrarFincasOptimizado(filtradas);
      }, 300); // Esperar 300ms despu√©s de que el usuario deje de escribir
    });

    // Agregar estilos responsivos
    function agregarEstilosResponsivos() {
      const style = document.createElement('style');
      style.textContent = `
        @media (max-width: 768px) {
          #historial-top-container {
            padding: 8px 15px;
          }

          #historial-top-container .historial-btn {
            padding: 10px 20px;
            font-size: 0.9rem;
            min-width: 160px;
          }

          body[style*="padding-top"] {
            padding-top: 60px !important;
          }
          .container[style*="margin-top"] {
            margin-top: 60px !important;
          }
        }

        @media (max-width: 480px) {
          #historial-top-container {
            padding: 6px 10px;
          }

          #historial-top-container .historial-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            min-width: 140px;
            gap: 6px;
          }

          body[style*="padding-top"] {
            padding-top: 50px !important;
          }
          .container[style*="margin-top"] {
            margin-top: 50px !important;
          }
        }

        #historial-top-container {
          animation: slideDownFromTop 0.5s ease forwards;
          z-index: 99999 !important;
          background: rgba(255, 255, 255, 0.9) !important;
          backdrop-filter: blur(20px) !important;
          -webkit-backdrop-filter: blur(20px) !important;
          border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        @keyframes slideDownFromTop {
          from {
            opacity: 0;
            transform: translateY(-100%);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        @media (prefers-color-scheme: dark) {
          #historial-top-container {
            background: rgba(0, 0, 0, 0.8) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
          }
        }
      `;
      document.head.appendChild(style);
    }

    // Inicializaci√≥n principal
    document.addEventListener('DOMContentLoaded', () => {
      agregarEstilosResponsivos();
      
      setTimeout(() => {
        inicializarBotonHistorial();
      }, 500);
    });

    if (document.readyState === 'loading') {
      // El evento DOMContentLoaded se ejecutar√°
    } else {
      setTimeout(() => {
        agregarEstilosResponsivos();
        inicializarBotonHistorial();
      }, 100);
    }

    // Cleanup al salir de la p√°gina
    window.addEventListener('beforeunload', () => {
      const topContainer = document.getElementById('historial-top-container');
      if (topContainer) {
        topContainer.remove();
      }
      
      const body = document.body;
      const container = document.querySelector('.container');
      
      if (body.style.paddingTop) {
        body.style.paddingTop = '';
      }
      
      if (container && container.style.marginTop) {
        container.style.marginTop = '';
      }
    });

    // Cargar fincas al iniciar
    cargarFincas();
  </script>
</body>
</html>