<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Subusuario</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .card-glass {
      background: var(--glass-bg, rgba(255, 255, 255, 0.1));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .finca-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .finca-title {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary-color, #00d4ff);
      margin-bottom: 5px;
    }

    .propietario {
      opacity: 0.8;
      font-size: 0.95em;
    }

    .finca-meta {
      opacity: 0.6;
      font-size: 0.8em;
      margin-top: 5px;
    }

    .recogida-info {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }

    .info-label {
      font-weight: bold;
      opacity: 0.8;
    }

    .info-value {
      color: var(--primary-color, #00d4ff);
      font-weight: bold;
    }

    .sin-recogidas {
      text-align: center;
      opacity: 0.6;
      font-style: italic;
      padding: 20px;
    }

    .botones-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .botones-container button {
      flex: 1;
      min-width: 120px;
      padding: 8px 12px;
      font-size: 0.85em;
    }

    .loading-info {
      opacity: 0.6;
      text-align: center;
      padding: 10px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="saludo">Bienvenido <span id="usuarioInfo"></span></h1>
    
    <!-- Secci√≥n removida de la info de debug -->
    <!-- No aparece debug info ni bot√≥n para debug -->

    <!-- Informaci√≥n del Administrador eliminada para subusuarios -->
    <!-- <div id="adminInfo" class="admin-info">
      <h3 style="margin-top: 0; color: var(--primary-color, #00d4ff);">üìã Informaci√≥n del Administrador</h3>
      <p><strong>Administrador:</strong> <span id="adminNombre">Cargando...</span></p>
      <p><strong>Email:</strong> <span id="adminEmail">Cargando...</span></p>
      <p><strong>Alias:</strong> <span id="adminAlias">Cargando...</span></p>
    </div> -->

    <!-- Eliminar el bot√≥n de agregar finca para subusuarios -->
    <!-- <button id="btnAgregarFinca">‚ûï Agregar Finca</button> -->

    <input type="text" id="buscarFinca" placeholder="Buscar finca o propietario...">
    
    <div id="listaFincas"></div>
  </div>

  <div id="modalFinca" class="modal hidden">
    <div class="modal-content">
      <h3>Agregar Finca</h3>
      <input type="text" id="nombreFinca" placeholder="Nombre de la finca">
      <input type="text" id="propietarioFinca" placeholder="Nombre del propietario">
      <button id="guardarFinca">Guardar</button>
    </div>
  </div>

<script type="module">
  import { apiFetch } from "./api.js";

  // Obtener par√°metros de la URL
  const params = new URLSearchParams(window.location.search);
  const usuario = params.get("usuario");
  const adminAlias = params.get("admin");

  // Obtener el alias del subusuario desde sessionStorage
  const sessionData = JSON.parse(sessionStorage.getItem('userData') || '{}');
  const currentUserAlias = sessionData.alias;  // Usamos el alias desde sessionStorage

  // Cambiar el saludo para mostrar el alias
  const saludo = document.getElementById("saludo");
  document.getElementById("usuarioInfo").textContent = currentUserAlias;

  // L√≥gica para ocultar elementos para subusuarios
  if (usuario && usuario !== "null" && usuario !== "undefined" && usuario !== null && usuario !== undefined) {
    if (sessionData.tipo === 2) {  // Si es subusuario
      // Remover o deshabilitar las secciones no deseadas para subusuarios
      const btnAgregarFinca = document.getElementById("btnAgregarFinca");
      const adminInfo = document.getElementById("adminInfo");
      
      // Ocultar el bot√≥n de agregar finca y la informaci√≥n del administrador
      if (btnAgregarFinca) btnAgregarFinca.style.display = "none"; // Ocultar bot√≥n de agregar finca
      if (adminInfo) adminInfo.style.display = "none"; // Ocultar informaci√≥n del administrador
    }
  }

  // L√≥gica para cargar las fincas
  const lista = document.getElementById("listaFincas");
  const buscarInput = document.getElementById("buscarFinca");

  async function cargarFincas() {
    try {
      if (!adminAlias) {
        console.error("‚ùå No hay adminAlias definido");
        lista.innerHTML = "<p>‚ùå Error: No se puede cargar fincas sin adminAlias</p>";
        return;
      }

      const response = await fetch(`http://localhost:3000/fincas/por-admin/${adminAlias}`);
      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${response.statusText}`);
      }

      const fincasAdmin = await response.json();
      mostrarFincas(fincasAdmin);
    } catch (err) {
      console.error("‚ùå Error al cargar fincas:", err);
      alert("Error al cargar fincas: " + err.message);
      lista.innerHTML = `<p>‚ùå Error al cargar fincas: ${err.message}</p>`;
    }
  }

  async function mostrarFincas(fincas) {
    lista.innerHTML = ""; // Limpiar la lista de fincas
    if (fincas.length === 0) {
      lista.innerHTML = `
        <div class="card-glass">
          <p style="text-align: center; opacity: 0.7;">
            üìã No hay fincas registradas para el administrador: <strong>${adminAlias}</strong><br>
            <small>Las fincas aparecer√°n aqu√≠ cuando se creen con este adminAlias.</small>
          </p>
        </div>
      `;
    } else {
      // Renderizar solo las tarjetas de finca que contienen los detalles que el subusuario puede ver
      for (const finca of fincas) {
        const div = document.createElement("div");
        div.className = "card-glass";

        div.innerHTML = `
          <div class="finca-header">
            <div class="finca-title">${finca.nombre}</div>
            <div class="propietario">Propietario: ${finca.propietario}</div>
          </div>
          
          <div class="botones-container">
            <button onclick="location.href='recogida.html?fincaId=${finca._id}&usuario=${encodeURIComponent(usuario)}&finca=${encodeURIComponent(finca.nombre)}&propietario=${encodeURIComponent(finca.propietario)}'">üìä Recogida</button>
          </div>
        `;
        
        lista.prepend(div);
      }
    }
  }

  // Funci√≥n para buscar por finca o propietario
  function buscarFinca() {
    const query = buscarInput.value.toLowerCase();
    const fincas = document.querySelectorAll('.card-glass');

    fincas.forEach(finca => {
      const fincaNombre = finca.querySelector('.finca-title').textContent.toLowerCase();
      const propietario = finca.querySelector('.propietario').textContent.toLowerCase();

      if (fincaNombre.includes(query) || propietario.includes(query)) {
        finca.style.display = 'block'; // Mostrar finca que coincida
      } else {
        finca.style.display = 'none'; // Ocultar finca que no coincida
      }
    });
  }

  // Agregar el evento de b√∫squeda
  buscarInput.addEventListener('input', buscarFinca);

  // Inicializar la aplicaci√≥n
  async function inicializarApp() {
    console.log("üöÄ Inicializando dashboard subusuario...");

    if (!usuario) {
      alert("‚ùå Error: Falta el par√°metro 'usuario' en la URL");
      return;
    }

    if (!adminAlias) {
      alert("‚ùå Error: Falta el par√°metro 'admin' en la URL");
      return;
    }

    await cargarFincas();
  }

  // Ejecutar inicializaci√≥n
  inicializarApp();
</script>
</body>
</html>