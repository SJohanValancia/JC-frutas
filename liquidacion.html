<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jc-loader.js"></script>
        <title>Liquidaci√≥n de Finca</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f0f0f0;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .finca-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filtros {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filtros label {
            font-weight: bold;
            color: #2c3e50;
        }

        .filtros input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .resumen-totales {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .total-item h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .total-item p {
            opacity: 0.9;
            font-size: 14px;
        }

        .recogidas-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }

        .recogida-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .recogida-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .recogida-card.liquidada {
            background: #f8f9fa;
            border-color: #28a745;
            opacity: 0.7;
        }

        .recogida-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .recogida-fecha {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .recogida-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item strong {
            display: block;
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .info-item span {
            color: #6c757d;
            font-size: 12px;
        }

        .pesas-detalle {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .pesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .pesa-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #6c757d;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .floating-recibo {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .btn-recibo {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }

        .btn-recibo:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.6);
        }

        /* üî• NUEVOS ESTILOS PARA LIQUIDACI√ìN */
        .btn-liquidar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }

        .btn-liquidar:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-liquidar:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .liquidacion-exitosa {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745 !important;
            animation: liquidacionPulse 2s ease-in-out;
        }

        @keyframes liquidacionPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .notificacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .filtros {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filtros > * {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Liquidaci√≥n de Finca</h1>
            <p>Resumen completo de recogidas por per√≠odo</p>
        </div>

        <div class="finca-info" id="fincaInfo">
            <div>
                <strong>üè† Finca:</strong>
                <span id="fincaNombre">Cargando...</span>
            </div>
            <div>
                <strong>üë§ Propietario:</strong>
                <span id="propietarioNombre">Cargando...</span>
            </div>
            <div>
                <strong style="display: none;">üìç ID:</strong>
                <span style="display: none;" id="fincaId">-</span>
            </div>
        </div>

        <div class="filtros">
            <label for="fechaInicio">üìÖ Fecha Inicio:</label>
            <input type="date" id="fechaInicio">
            
            <label for="fechaFin">üìÖ Fecha Fin:</label>
            <input type="date" id="fechaFin">
            
            <button class="btn btn-primary" onclick="filtrarRecogidas()">
                üîç Filtrar
            </button>
            
            <button class="btn btn-secondary" onclick="limpiarFiltros()">
                üßπ Limpiar Filtros
            </button>
        </div>

                 <button class="btn-liquidar-intervalo" onclick="liquidarIntervaloFechas()" id="btnLiquidarIntervalo" style="display: none;">
                üí∞ Liquidar Intervalo
            </button>

        <div class="resumen-totales" id="resumenTotales" style="display: none;">
            <div class="total-item">
                <h3 id="totalRecogidas">0</h3>
                <p>Recogidas Activas</p>
            </div>
            <div class="total-item">
                <h3 style="display: none;" id="totalKilos">0</h3>

            </div>
            <div class="total-item" id="totalValorContainer">
                <h3 id="totalValor">$0</h3>
                <p>Valor Pendiente</p>
            </div>
            <div  class="total-item">
                <h3 style="display: none;" id="totalPesas">0</h3>

            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            üîÑ Cargando recogidas...
        </div>

        <div id="noDataMessage" class="no-data" style="display: none;">
            üì≠ No se encontraron recogidas activas para el per√≠odo seleccionado
        </div>

        <div class="recogidas-grid" id="recogidasContainer">
        </div>

        <button class="btn btn-secondary" onclick="volverDashboard()" style="margin-top: 20px;">
            ‚Üê Volver al Dashboard
        </button>
    </div>

    <div class="floating-recibo">
        <button class="btn-recibo" onclick="generarReciboLiquidacion()" id="btnRecibo" style="display: none;">
            üìÑ Generar Recibo
        </button>
    </div>

    <!-- Script para html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Variables globales
        let todasLasRecogidas = [];
        let recogidasFiltradas = [];
        let isSubusuario = false;
        let fincaData = {};

        // Obtener par√°metros de URL
        const urlParams = new URLSearchParams(window.location.search);
        const fincaId = urlParams.get('fincaId');
        const fincaNombre = urlParams.get('finca');
        const propietario = urlParams.get('propietario');
        const usuario = urlParams.get('usuario');

        function configurarEventosFecha() {
    const fechaInicioInput = document.getElementById('fechaInicio');
    const fechaFinInput = document.getElementById('fechaFin');
    const btnLiquidarIntervalo = document.getElementById('btnLiquidarIntervalo');

    function verificarFechas() {
        if (fechaInicioInput.value && fechaFinInput.value) {
            btnLiquidarIntervalo.style.display = 'block';
        } else {
            btnLiquidarIntervalo.style.display = 'none';
        }
    }

    fechaInicioInput.addEventListener('change', verificarFechas);
    fechaFinInput.addEventListener('change', verificarFechas);
}

// Funci√≥n para liquidar todas las recogidas en el intervalo seleccionado
async function liquidarIntervaloFechas() {
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    
    if (!fechaInicio || !fechaFin) {
        mostrarNotificacion('‚ùå Por favor selecciona un intervalo de fechas v√°lido', 'error');
        return;
    }

    // Filtrar recogidas en el intervalo que no est√©n liquidadas
    const recogidasParaLiquidar = todasLasRecogidas.filter(recogida => {
        if (!recogida.fecha) return false;
        if (recogida.estadoLiquidacion === 'liquidada') return false;
        
        const fechaRecogidaSolo = recogida.fecha.split('T')[0];
        return fechaRecogidaSolo >= fechaInicio && fechaRecogidaSolo <= fechaFin;
    });

    if (recogidasParaLiquidar.length === 0) {
        mostrarNotificacion('‚ÑπÔ∏è No hay recogidas pendientes en el intervalo seleccionado', 'warning');
        return;
    }

    if (!confirm(`¬øEst√°s seguro que deseas liquidar TODAS las ${recogidasParaLiquidar.length} recogidas pendientes entre ${fechaInicio} y ${fechaFin}?`)) {
        return;
    }

    try {
        const storedData = sessionStorage.getItem('userData');
        let usuarioActual = usuario;
        let adminAlias = '';

        if (storedData) {
            const sessionData = JSON.parse(storedData);
            usuarioActual = sessionData.username;
            adminAlias = sessionData.adminAlias || sessionData.alias;
        }

        const btnLiquidar = document.getElementById('btnLiquidarIntervalo');
        btnLiquidar.disabled = true;
        btnLiquidar.innerHTML = '‚è≥ Liquidando...';

        // Obtener solo los IDs de las recogidas a liquidar
        const recogidaIds = recogidasParaLiquidar.map(r => r._id);

        // Llamar al endpoint para liquidaci√≥n masiva
        const response = await fetch('https://jc-frutas.onrender.com/recogidas/liquidar-multiples', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                recogidaIds: recogidaIds,
                usuario: usuarioActual,
                adminAlias: adminAlias
            })
        });

        if (!response.ok) {
            throw new Error('Error en la solicitud de liquidaci√≥n masiva');
        }

        const result = await response.json();

        if (result.success) {
            mostrarNotificacion(`‚úÖ ${result.exitosas} recogidas liquidadas exitosamente`, 'success');
            
            // Recargar las recogidas para actualizar la vista
            await cargarRecogidas();
            
            // Actualizar el bot√≥n
            btnLiquidar.disabled = false;
            btnLiquidar.innerHTML = 'üí∞ Liquidar Intervalo';
        } else {
            throw new Error(result.message || 'Error al liquidar recogidas');
        }

    } catch (error) {
        console.error('Error al liquidar intervalo:', error);
        mostrarNotificacion(`‚ùå Error al liquidar intervalo: ${error.message}`, 'error');
        
        const btnLiquidar = document.getElementById('btnLiquidarIntervalo');
        if (btnLiquidar) {
            btnLiquidar.disabled = false;
            btnLiquidar.innerHTML = 'üí∞ Liquidar Intervalo';
        }
    }
}

        // üî• FUNCI√ìN PARA FORMATEAR fechas CORRECTAMENTE - CORREGIDA
        function formatearFechaLocal(fechaString) {
            if (!fechaString) return 'Sin fecha';
            
            // Si la fecha viene en formato ISO (YYYY-MM-DD), la parseamos directamente
            // sin que JavaScript aplique conversiones de zona horaria
            const partes = fechaString.split('T')[0].split('-');
            if (partes.length === 3) {
                const a√±o = parseInt(partes[0]);
                const mes = parseInt(partes[1]) - 1; // JavaScript usa meses base 0
                const dia = parseInt(partes[2]);
                
                const fecha = new Date(a√±o, mes, dia);
                return fecha.toLocaleDateString('es-ES');
            }
            
            // Fallback para otros formatos
            return new Date(fechaString).toLocaleDateString('es-ES');
        }

        // üî• FUNCI√ìN PARA FORMATEAR FECHA SIN ZONA HORARIA - NUEVA
        function formatearFechaSinZonaHoraria(fechaString) {
            if (!fechaString) return 'Sin fecha';
            
            // Extraer solo la parte de fecha (YYYY-MM-DD)
            const fechaSolo = fechaString.split('T')[0];
            const [a√±o, mes, dia] = fechaSolo.split('-');
            
            // Crear fecha usando los componentes directamente
            const fecha = new Date(parseInt(a√±o), parseInt(mes) - 1, parseInt(dia));
            
            return fecha.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // üî• FUNCI√ìN PARA COMPARAR FECHAS SIN PROBLEMAS DE ZONA HORARIA
        function compararFechas(fechaRecogida, fechaComparacion) {
            if (!fechaRecogida || !fechaComparacion) return true;
            
            const partes1 = fechaRecogida.split('T')[0].split('-');
            const partes2 = fechaComparacion.split('-');
            
            if (partes1.length === 3 && partes2.length === 3) {
                const fecha1 = new Date(parseInt(partes1[0]), parseInt(partes1[1]) - 1, parseInt(partes1[2]));
                const fecha2 = new Date(parseInt(partes2[0]), parseInt(partes2[1]) - 1, parseInt(partes2[2]));
                return fecha1.getTime() === fecha2.getTime() ? 0 : (fecha1 > fecha2 ? 1 : -1);
            }
            
            return 0;
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            if (!fincaId) {
                alert('Error: No se especific√≥ la finca');
                volverDashboard();
                return;
            }

            // Mostrar informaci√≥n de la finca
            document.getElementById('fincaNombre').textContent = fincaNombre || 'Sin nombre';
            document.getElementById('propietarioNombre').textContent = propietario || 'Sin propietario';
            document.getElementById('fincaId').textContent = fincaId;

            fincaData = { fincaId, fincaNombre, propietario };

            // Verificar tipo de usuario
            await verificarTipoUsuario();

            // Configurar fechas por defecto (√∫ltima semana)
            const hoy = new Date();
            const haceUnaSemana = new Date();
            haceUnaSemana.setDate(hoy.getDate() - 7);

            document.getElementById('fechaFin').value = hoy.toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = haceUnaSemana.toISOString().split('T')[0];

            // Cargar recogidas
            await cargarRecogidas();
             configurarEventosFecha();
        });

        // Verificar tipo de usuario
        async function verificarTipoUsuario() {
            try {
                const storedData = sessionStorage.getItem('userData');
                if (storedData) {
                    const sessionData = JSON.parse(storedData);
                    isSubusuario = sessionData.tipo === 2;
                } else if (usuario) {
                    const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
                    if (response.ok) {
                        const userData = await response.json();
                        isSubusuario = userData.tipo === 2;
                    }
                }

                // Ocultar valores monetarios para subusuarios
                if (isSubusuario) {
                    document.getElementById('totalValorContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error verificando tipo de usuario:', error);
            }
        }

        // Cargar todas las recogidas de la finca
        async function cargarRecogidas() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('noDataMessage').style.display = 'none';

                const response = await fetch(`https://jc-frutas.onrender.com/recogidas/por-finca/${fincaId}`);
                if (!response.ok) throw new Error('Error al cargar recogidas');

                todasLasRecogidas = await response.json();
                console.log('Recogidas cargadas:', todasLasRecogidas.length);

                // Aplicar filtro inicial
                filtrarRecogidas();

            } catch (error) {
                console.error('Error cargando recogidas:', error);
                document.getElementById('loadingIndicator').innerHTML = '‚ùå Error al cargar recogidas';
            }
        }

        // Filtrar recogidas por fecha - CORREGIDA - SOLO ACTIVAS
        function filtrarRecogidas() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;

            recogidasFiltradas = todasLasRecogidas.filter(recogida => {
                if (!recogida.fecha) return false;
                
                // üî• FILTRAR SOLO RECOGIDAS ACTIVAS (sin liquidar)
                const estaLiquidada = recogida.estadoLiquidacion === 'liquidada';
                if (estaLiquidada) return false;
                
                // Extraer solo la parte de fecha sin hora
                const fechaRecogidaSolo = recogida.fecha.split('T')[0];
                
                // Comparar directamente las fechas en formato YYYY-MM-DD
                const cumpleFechaInicio = !fechaInicio || fechaRecogidaSolo >= fechaInicio;
                const cumpleFechaFin = !fechaFin || fechaRecogidaSolo <= fechaFin;
                
                return cumpleFechaInicio && cumpleFechaFin;
            });

            console.log('Recogidas activas filtradas:', recogidasFiltradas.length);
            mostrarRecogidas();
        }

        // Mostrar recogidas filtradas
        function mostrarRecogidas() {
            document.getElementById('loadingIndicator').style.display = 'none';

            if (recogidasFiltradas.length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('resumenTotales').style.display = 'none';
                document.getElementById('btnRecibo').style.display = 'none';
                document.getElementById('recogidasContainer').innerHTML = '';
                return;
            }

            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('resumenTotales').style.display = 'grid';
            document.getElementById('btnRecibo').style.display = 'block';

            // Calcular totales SOLO DE RECOGIDAS ACTIVAS
            let totalRecogidas = recogidasFiltradas.length;
            let totalKilos = 0;
            let totalValor = 0;
            let totalPesas = 0;

            recogidasFiltradas.forEach(recogida => {
                totalKilos += recogida.totalKilos || 0;
                totalValor += recogida.valorPagar || 0;
                totalPesas += recogida.pesas ? recogida.pesas.length : 0;
            });

            // Actualizar resumen
            document.getElementById('totalRecogidas').textContent = totalRecogidas;
            document.getElementById('totalKilos').textContent = totalKilos + ' kg';
            document.getElementById('totalValor').textContent = '$' + totalValor.toLocaleString();
            document.getElementById('totalPesas').textContent = totalPesas;

            // Mostrar recogidas
            const container = document.getElementById('recogidasContainer');
            container.innerHTML = '';

            recogidasFiltradas.forEach((recogida, index) => {
                const card = crearTarjetaRecogida(recogida, index + 1);
                container.appendChild(card);
            });
        }

        // üî• NUEVA FUNCI√ìN: Liquidar recogida autom√°ticamente
        async function liquidarRecogidaAutomatica(recogidaId) {
            if (!confirm('üî• ¬øLIQUIDAR esta recogida inmediatamente?\n\n‚ö†Ô∏è Esta acci√≥n:\n‚úÖ Marcar√° la recogida como LIQUIDADA\nüö´ La quitar√° de recogidas activas\nüí∞ Descontar√° del total a pagar\n\n¬øContinuar?')) {
                return;
            }

            try {
                const storedData = sessionStorage.getItem('userData');
                let usuarioActual = usuario;
                let adminAlias = '';

                if (storedData) {
                    const sessionData = JSON.parse(storedData);
                    usuarioActual = sessionData.username;
                    adminAlias = sessionData.adminAlias || sessionData.alias;
                }

                // Deshabilitar bot√≥n para evitar doble clic
                const botonLiquidar = document.querySelector(`button[onclick="liquidarRecogidaAutomatica('${recogidaId}')"]`);
                if (botonLiquidar) {
                    botonLiquidar.disabled = true;
                    botonLiquidar.textContent = '‚è≥ Liquidando...';
                }

                console.log('üî• Liquidando recogida autom√°ticamente:', recogidaId);

                // üî• PASO 1: Marcar para liquidaci√≥n si no est√° marcada
                const recogida = todasLasRecogidas.find(r => r._id === recogidaId);
                if (!recogida.estadoLiquidacion) {
                    const responseMarcar = await fetch(`https://jc-frutas.onrender.com/recogidas/marcar-liquidacion/${recogidaId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            usuario: usuarioActual,
                            adminAlias: adminAlias
                        })
                    });

                    if (!responseMarcar.ok) {
                        throw new Error('Error al marcar para liquidaci√≥n');
                    }
                }

                // üî• PASO 2: Liquidar inmediatamente
                const responseLiquidar = await fetch(`https://jc-frutas.onrender.com/recogidas/cambiar-estado-liquidacion/${recogidaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        estado: 'liquidada',
                        usuario: usuarioActual
                    })
                });

                if (!responseLiquidar.ok) {
                    throw new Error('Error al liquidar la recogida');
                }

                const result = await responseLiquidar.json();
                
                if (result.success) {
                    // üî• MOSTRAR NOTIFICACI√ìN DE √âXITO
                    mostrarNotificacion('üéâ ¬°RECOGIDA LIQUIDADA EXITOSAMENTE!', 'success');

                    // üî• ANIMAR LA TARJETA ANTES DE QUITARLA
                    const tarjeta = botonLiquidar.closest('.recogida-card');
                    if (tarjeta) {
                        tarjeta.classList.add('liquidacion-exitosa');
                        
                        // Esperar la animaci√≥n y luego recargar
                        setTimeout(async () => {
                            // Recargar recogidas para actualizar totales
                            await cargarRecogidas();
                        }, 2000);
                    }

                    console.log('‚úÖ Recogida liquidada exitosamente');
                } else {
                    throw new Error('La respuesta no indica √©xito');
                }

            } catch (error) {
                console.error('‚ùå Error al liquidar recogida:', error);
                mostrarNotificacion('‚ùå Error al liquidar: ' + error.message, 'error');
                
                // Reactivar bot√≥n en caso de error
                const botonLiquidar = document.querySelector(`button[onclick="liquidarRecogidaAutomatica('${recogidaId}')"]`);
                if (botonLiquidar) {
                    botonLiquidar.disabled = false;
                    botonLiquidar.textContent = 'üí∞ Liquidar';
                }
            }
        }

        // üî• FUNCI√ìN PARA MOSTRAR NOTIFICACIONES
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion';
            
            const colores = {
                'success': 'linear-gradient(135deg, #28a745 0%, #20c997 100%)',
                'error': 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)',
                'warning': 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)'
            };

            notificacion.style.background = colores[tipo] || colores.success;
            notificacion.textContent = mensaje;
            
            document.body.appendChild(notificacion);

            // Remover despu√©s de 5 segundos
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notificacion.parentNode) {
                            notificacion.parentNode.removeChild(notificacion);
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Crear tarjeta de recogida - MODIFICADA PARA LIQUIDACI√ìN AUTOM√ÅTICA
        function crearTarjetaRecogida(recogida, numero) {
            const div = document.createElement('div');
            div.className = 'recogida-card';

            // Usar la nueva funci√≥n para formatear fecha sin zona horaria
            const fecha = formatearFechaSinZonaHoraria(recogida.fecha);
            const totalPesas = recogida.pesas ? recogida.pesas.length : 0;

            // Determinar estado de liquidaci√≥n
            const estadoLiquidacion = recogida.estadoLiquidacion;
            let badgeEstado = '';
            let mostrarBotonLiquidar = !estadoLiquidacion || estadoLiquidacion === 'pendiente'; // Mostrar si no tiene estado o est√° pendiente

            if (estadoLiquidacion) {
                const colores = {
                    'pendiente': 'background: #ffc107; color: #000;',
                    'liquidada': 'background: #28a745; color: white;',
                    'cancelada': 'background: #dc3545; color: white;'
                };
                const textos = {
                    'pendiente': '‚è≥ Pendiente',
                    'liquidada': '‚úÖ Liquidada',
                    'cancelada': '‚ùå Cancelada'
                };
                
                badgeEstado = `<span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; ${colores[estadoLiquidacion]}">${textos[estadoLiquidacion]}</span>`;
            }

            div.innerHTML = `
                <div class="recogida-header">
                    <div class="recogida-fecha">üìÖ ${fecha} - Recogida #${numero}</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${badgeEstado}
                        <div style="font-size: 14px; color: #6c757d;">üë§ ${recogida.alias || recogida.usuario}</div>
                    </div>
                </div>
                
                <div class="recogida-info">
                    <div class="info-item">
                        <strong>${recogida.fruta || 'N/A'}</strong>
                        <span>Fruta Principal</span>
                    </div>

                    <div class="info-item">
                        <strong>${recogida.totalKilos || 0} kg</strong>
                        <span>Total Kilos</span>
                    </div>
                    ${!isSubusuario ? `
                    <div class="info-item">
                        <strong>${(recogida.valorPagar || 0).toLocaleString()}</strong>
                        <span>Valor Total</span>
                    </div>
                    ` : ''}
                    <div class="info-item">
                        <strong>${totalPesas}</strong>
                        <span>Pesas</span>
                    </div>
                </div>
                


                ${mostrarBotonLiquidar ? `
                <button class="btn-liquidar" onclick="liquidarRecogidaAutomatica('${recogida._id}')">
                    üí∞ LIQUIDAR AHORA
                </button>
                ` : estadoLiquidacion === 'liquidada' ? `
                <div style="text-align: center; padding: 15px; background: #d4edda; border-radius: 10px; margin-top: 15px;">
                    <strong style="color: #155724;">‚úÖ RECOGIDA LIQUIDADA</strong>
                    <div style="font-size: 12px; color: #155724; margin-top: 5px;">
                        ${recogida.fechaLiquidacion ? `Liquidada el ${formatearFechaSinZonaHoraria(recogida.fechaLiquidacion)}` : ''}
                        ${recogida.usuarioLiquida ? ` por ${recogida.usuarioLiquida}` : ''}
                    </div>
                </div>
                ` : ''}
            `;

            return div;
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            recogidasFiltradas = [...todasLasRecogidas];
            filtrarRecogidas(); // Usar filtrarRecogidas para mantener el filtro de activas
        }

        // Volver al dashboard
        function volverDashboard() {
            window.history.back();
        }

        // Generar recibo de liquidaci√≥n con m√∫ltiples p√°ginas - SOLO RECOGIDAS ACTIVAS
        async function generarReciboLiquidacion() {
            if (recogidasFiltradas.length === 0) {
                alert('No hay recogidas activas para generar el recibo');
                return;
            }

            try {
                console.log('üöÄ Iniciando generaci√≥n de recibo de liquidaci√≥n de recogidas ACTIVAS...');
                
                // Procesar datos para el recibo - SOLO RECOGIDAS FILTRADAS ACTIVAS
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                
                const resumenPorFrutaCalidad = {};
                let totalKilosGeneral = 0;
                let totalValorGeneral = 0;
                let totalPesasGeneral = 0;

                console.log('üìä Procesando', recogidasFiltradas.length, 'recogidas activas filtradas...');

                recogidasFiltradas.forEach(recogida => {
                    totalKilosGeneral += recogida.totalKilos || 0;
                    totalValorGeneral += recogida.valorPagar || 0;
                    
                    if (recogida.pesas) {
                        totalPesasGeneral += recogida.pesas.length;
                        
                        recogida.pesas.forEach(pesa => {
                            const fruta = pesa.fruta || recogida.fruta || 'Sin especificar';
                            const calidad = pesa.calidad || recogida.calidad || 'Sin especificar';
                            const precio = pesa.precio || recogida.precio || 0;
                            const clave = `${fruta} - ${calidad}`;
                            
                            if (!resumenPorFrutaCalidad[clave]) {
                                resumenPorFrutaCalidad[clave] = {
                                    kilos: 0,
                                    valor: 0,
                                    precio: precio,
                                    cantidad: 0
                                };
                            }
                            
                            resumenPorFrutaCalidad[clave].kilos += pesa.kilos || 0;
                            resumenPorFrutaCalidad[clave].valor += pesa.valor || 0;
                            resumenPorFrutaCalidad[clave].cantidad += 1;
                        });
                    }
                });

                console.log('üìã Resumen procesado:', Object.keys(resumenPorFrutaCalidad).length, 'combinaciones fruta-calidad');

                // üî• DIVIDIR EN P√ÅGINAS DE 15 ELEMENTOS M√ÅXIMO
                const entradasResumen = Object.entries(resumenPorFrutaCalidad);
                const ITEMS_POR_PAGINA = 15;
                const totalPaginas = Math.ceil(entradasResumen.length / ITEMS_POR_PAGINA);
                
                console.log('üìÑ Se generar√°n', totalPaginas, 'p√°ginas de recibo');

                const archivos = [];

                // Generar cada p√°gina
                for (let i = 0; i < totalPaginas; i++) {
                    const inicio = i * ITEMS_POR_PAGINA;
                    const fin = Math.min(inicio + ITEMS_POR_PAGINA, entradasResumen.length);
                    const entradasPagina = entradasResumen.slice(inicio, fin);
                    
                    console.log(`üìÑ Generando p√°gina ${i + 1}/${totalPaginas} con ${entradasPagina.length} elementos`);

                    // Convertir de vuelta a objeto para esta p√°gina
                    const resumenPagina = {};
                    entradasPagina.forEach(([clave, datos]) => {
                        resumenPagina[clave] = datos;
                    });

                    // Crear p√°gina de recibo
                    const divRecibo = crearReciboLiquidacionPaginado(
                        resumenPagina,
                        totalKilosGeneral,
                        totalValorGeneral,
                        totalPesasGeneral,
                        recogidasFiltradas.length,
                        fechaInicio,
                        fechaFin,
                        i + 1,
                        totalPaginas
                    );

                    document.body.appendChild(divRecibo);
                    await document.fonts.ready;

                    // Generar imagen
                    const canvas = await html2canvas(divRecibo, {
                        scale: 3,
                        useCORS: true,
                        allowTaint: false,
                        backgroundColor: '#ffffff',
                        width: divRecibo.offsetWidth,
                        height: divRecibo.offsetHeight,
                        logging: false,
                        imageTimeout: 0
                    });

                    document.body.removeChild(divRecibo);

                    // Crear archivo
                    const blob = await new Promise(resolve => 
                        canvas.toBlob(resolve, "image/png", 1.0)
                    );
                    
                    const nombreArchivo = totalPaginas > 1 ? 
                        `liquidacion_pendiente_${fincaNombre}_pagina_${i + 1}.png` :
                        `liquidacion_pendiente_${fincaNombre}.png`;
                    
                    const file = new File([blob], nombreArchivo, { type: "image/png" });
                    archivos.push(file);
                }

                // Compartir todos los archivos
                const mensaje = totalPaginas > 1 ?
                    `üí∞ Recogidas Pendientes - ${fincaNombre}\nüìä ${recogidasFiltradas.length} recogidas activas\n‚öñÔ∏è ${totalKilosGeneral} kg pendientes\nüìÑ ${totalPaginas} p√°ginas generadas` :
                    `üí∞ Recogidas Pendientes - ${fincaNombre}\nüìä ${recogidasFiltradas.length} recogidas activas\n‚öñÔ∏è ${totalKilosGeneral} kg pendientes`;

                console.log('üì§ Compartiendo', archivos.length, 'archivos...');

                await navigator.share({
                    title: 'Recogidas Pendientes de Liquidaci√≥n',
                    text: mensaje,
                    files: archivos,
                });

                console.log('‚úÖ Recibo de recogidas pendientes generado y compartido exitosamente');

            } catch (error) {
                console.error('‚ùå Error generando recibo:', error);
                mostrarNotificacion('‚ùå Error al generar recibo: ' + error.message, 'error');
            }
        }

        // Crear recibo de liquidaci√≥n paginado con el mismo estilo - ACTUALIZADO PARA PENDIENTES
        function crearReciboLiquidacionPaginado(resumen, totalKilos, totalValor, totalPesas, totalRecogidas, fechaInicio, fechaFin, numeroPagina, totalPaginasRecibo) {
            const div = document.createElement("div");
            div.style.cssText = `
                width: 800px;
                min-height: 1000px;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                color: #2c3e50;
                font-family: 'Arial', sans-serif;
                padding: 30px;
                margin: 0;
                box-sizing: border-box;
                position: relative;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            `;

            // Formatear per√≠odo correctamente
            let periodo = 'Todas las fechas';
            if (fechaInicio && fechaFin) {
                const fechaInicioObj = new Date(fechaInicio + 'T00:00:00');
                const fechaFinObj = new Date(fechaFin + 'T00:00:00');
                periodo = `${fechaInicioObj.toLocaleDateString('es-ES')} - ${fechaFinObj.toLocaleDateString('es-ES')}`;
            } else if (fechaInicio) {
                const fechaInicioObj = new Date(fechaInicio + 'T00:00:00');
                periodo = `Desde ${fechaInicioObj.toLocaleDateString('es-ES')}`;
            } else if (fechaFin) {
                const fechaFinObj = new Date(fechaFin + 'T00:00:00');
                periodo = `Hasta ${fechaFinObj.toLocaleDateString('es-ES')}`;
            }

            const tituloRecibo = totalPaginasRecibo > 1 ? 
                `‚è≥ RECOGIDAS PENDIENTES DE LIQUIDACI√ìN - P√ÅGINA ${numeroPagina}/${totalPaginasRecibo}` :
                `‚è≥ RECOGIDAS PENDIENTES DE LIQUIDACI√ìN`;

            div.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="margin: 0; font-size: 32px; font-weight: bold; color: #34495e;">
                        ${tituloRecibo}
                    </h1>
                    <div style="width: 60px; height: 4px; background: linear-gradient(to right, #f39c12, #e67e22); margin: 15px auto; border-radius: 2px;"></div>
                    ${totalPaginasRecibo > 1 ? `<p style="margin: 5px 0; font-size: 14px; color: #7f8c8d;">P√°gina ${numeroPagina} de ${totalPaginasRecibo}</p>` : ''}
                </div>

                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; margin-bottom: 25px; backdrop-filter: blur(10px);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 16px;">
                        <div><strong>üè† Finca:</strong> ${fincaNombre || 'Sin especificar'}</div>
                        <div><strong>üë§ Propietario:</strong> ${propietario || 'Sin especificar'}</div>
                        <div><strong>üìÖ Per√≠odo:</strong> ${periodo}</div>
                        <div><strong>‚è≥ Recogidas Pendientes:</strong> ${totalRecogidas}</div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; margin-bottom: 25px; backdrop-filter: blur(10px);">
                    <h3 style="margin: 0 0 25px 0; text-align: center; font-size: 20px;">üìã RESUMEN POR FRUTA Y CALIDAD (PENDIENTES)</h3>
                    <div style="display: grid; gap: 12px;">
                        ${Object.entries(resumen).map(([clave, datos]) => `
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; display: grid; grid-template-columns: 2.5fr 1fr 1fr 1fr ${!isSubusuario ? '1.2fr' : ''}; gap: 12px; align-items: center; color: #2c3e50; box-shadow: 0 3px 10px rgba(0,0,0,0.1); font-size: 14px;">
                            <div style="font-weight: bold; color: #2c3e50;">${clave}</div>
                            <div style="text-align: center; color: #2c3e50; font-weight: 600;">${datos.kilos} kg</div>
                            <div style="text-align: center; color: #2c3e50;">${datos.cantidad} pesas</div>
                            <div style="text-align: center; color: #2c3e50;">${datos.precio.toLocaleString()}/kg</div>
                            ${!isSubusuario ? `<div style="text-align: center; color: #2c3e50; font-weight: bold;">${datos.valor.toLocaleString()}</div>` : ''}
                        </div>
                        `).join('')}
                    </div>
                </div>

                ${numeroPagina === totalPaginasRecibo ? `
                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; text-align: center; margin-top: 30px;">
                    <h2 style="margin: 0 0 15px 0; font-size: 24px; color: #2c3e50; font-weight: bold;">
                        ‚è≥ TOTALES PENDIENTES DE LIQUIDACI√ìN
                    </h2>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 15px; font-size: 16px; opacity: 0.9; flex-wrap: wrap;">
                        <span style="color: #2c3e50; font-weight: bold; background: rgba(243, 156, 18, 0.2); padding: 8px 12px; border-radius: 20px;">üì¶ ${totalRecogidas} recogidas</span>
                        <span style="color: #2c3e50; font-weight: bold; background: rgba(243, 156, 18, 0.2); padding: 8px 12px; border-radius: 20px;">‚öñÔ∏è ${totalKilos} kg</span>
                        ${!isSubusuario ? `<span style="color: #2c3e50; font-weight: bold; background: rgba(243, 156, 18, 0.2); padding: 8px 12px; border-radius: 20px;">üí∞ ${totalValor.toLocaleString()}</span>` : ''}
                        <span style="color: #2c3e50; font-weight: bold; background: rgba(243, 156, 18, 0.2); padding: 8px 12px; border-radius: 20px;">üìä ${totalPesas} pesas</span>
                    </div>
                </div>
                ` : `
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center; margin-top: 20px; border: 2px dashed rgba(255,255,255,0.3);">
                    <p style="margin: 0; font-size: 16px; color: #2c3e50; opacity: 0.7;">
                        üìÑ Contin√∫a en la p√°gina ${numeroPagina + 1}/${totalPaginasRecibo}
                    </p>
                </div>
                `}

                <div style="position: absolute; bottom: 20px; right: 30px; font-size: 12px; color: #95a5a6;">
                    Generado: ${new Date().toLocaleString('es-ES')}
                </div>
            `;

            return div;
        }
    </script>
</body>
</html>