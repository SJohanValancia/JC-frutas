<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jc-loader.js"></script>
        <title>Liquidaci√≥n de Finca</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f0f0f0;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 32px;
            margin-bottom: 10px;
        }


        .finca-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filtros {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filtros label {
            font-weight: bold;
            color: #2c3e50;
        }

        .filtros input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .resumen-totales {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .total-item h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .total-item p {
            opacity: 0.9;
            font-size: 14px;
        }

        .recogidas-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }

        .recogida-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .recogida-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .recogida-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .recogida-fecha {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .recogida-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item strong {
            display: block;
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .info-item span {
            color: #6c757d;
            font-size: 12px;
        }

        .pesas-detalle {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .pesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .pesa-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #6c757d;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .floating-recibo {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .btn-recibo {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }

        .btn-recibo:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.6);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .filtros {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filtros > * {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Liquidaci√≥n de Finca</h1>
            <p>Resumen completo de recogidas por per√≠odo</p>
        </div>

        <div class="finca-info" id="fincaInfo">
            <div>
                <strong>üè† Finca:</strong>
                <span id="fincaNombre">Cargando...</span>
            </div>
            <div>
                <strong>üë§ Propietario:</strong>
                <span id="propietarioNombre">Cargando...</span>
            </div>
            <div>
                <strong>üìç ID:</strong>
                <span id="fincaId">-</span>
            </div>
        </div>

        <div class="filtros">
            <label for="fechaInicio">üìÖ Fecha Inicio:</label>
            <input type="date" id="fechaInicio">
            
            <label for="fechaFin">üìÖ Fecha Fin:</label>
            <input type="date" id="fechaFin">
            
            <button class="btn btn-primary" onclick="filtrarRecogidas()">
                üîç Filtrar
            </button>
            
            <button class="btn btn-secondary" onclick="limpiarFiltros()">
                üßπ Limpiar Filtros
            </button>
        </div>

        <div class="resumen-totales" id="resumenTotales" style="display: none;">
            <div class="total-item">
                <h3 id="totalRecogidas">0</h3>
                <p>Recogidas</p>
            </div>
            <div class="total-item">
                <h3 id="totalKilos">0</h3>
                <p>Kilos Total</p>
            </div>
            <div class="total-item" id="totalValorContainer">
                <h3 id="totalValor">$0</h3>
                <p>Valor Total</p>
            </div>
            <div class="total-item">
                <h3 id="totalPesas">0</h3>
                <p>Pesas Total</p>
            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            üîÑ Cargando recogidas...
        </div>

        <div id="noDataMessage" class="no-data" style="display: none;">
            üì≠ No se encontraron recogidas para el per√≠odo seleccionado
        </div>

        <div class="recogidas-grid" id="recogidasContainer">
        </div>

        <button class="btn btn-secondary" onclick="volverDashboard()" style="margin-top: 20px;">
            ‚Üê Volver al Dashboard
        </button>
    </div>

    <div class="floating-recibo">
        <button class="btn-recibo" onclick="generarReciboLiquidacion()" id="btnRecibo" style="display: none;">
            üìÑ Generar Recibo
        </button>
    </div>

    <!-- Script para html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Variables globales
        let todasLasRecogidas = [];
        let recogidasFiltradas = [];
        let isSubusuario = false;
        let fincaData = {};

        // Obtener par√°metros de URL
        const urlParams = new URLSearchParams(window.location.search);
        const fincaId = urlParams.get('fincaId');
        const fincaNombre = urlParams.get('finca');
        const propietario = urlParams.get('propietario');
        const usuario = urlParams.get('usuario');

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            if (!fincaId) {
                alert('Error: No se especific√≥ la finca');
                volverDashboard();
                return;
            }

            // Mostrar informaci√≥n de la finca
            document.getElementById('fincaNombre').textContent = fincaNombre || 'Sin nombre';
            document.getElementById('propietarioNombre').textContent = propietario || 'Sin propietario';
            document.getElementById('fincaId').textContent = fincaId;

            fincaData = { fincaId, fincaNombre, propietario };

            // Verificar tipo de usuario
            await verificarTipoUsuario();

            // Configurar fechas por defecto (√∫ltima semana)
            const hoy = new Date();
            const haceUnaSemana = new Date();
            haceUnaSemana.setDate(hoy.getDate() - 7);

            document.getElementById('fechaFin').value = hoy.toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = haceUnaSemana.toISOString().split('T')[0];

            // Cargar recogidas
            await cargarRecogidas();
        });

        // Verificar tipo de usuario
        async function verificarTipoUsuario() {
            try {
                const storedData = sessionStorage.getItem('userData');
                if (storedData) {
                    const sessionData = JSON.parse(storedData);
                    isSubusuario = sessionData.tipo === 2;
                } else if (usuario) {
                    const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
                    if (response.ok) {
                        const userData = await response.json();
                        isSubusuario = userData.tipo === 2;
                    }
                }

                // Ocultar valores monetarios para subusuarios
                if (isSubusuario) {
                    document.getElementById('totalValorContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error verificando tipo de usuario:', error);
            }
        }

        // Cargar todas las recogidas de la finca
        async function cargarRecogidas() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('noDataMessage').style.display = 'none';

                const response = await fetch(`https://jc-frutas.onrender.com/recogidas/por-finca/${fincaId}`);
                if (!response.ok) throw new Error('Error al cargar recogidas');

                todasLasRecogidas = await response.json();
                console.log('Recogidas cargadas:', todasLasRecogidas.length);

                // Aplicar filtro inicial
                filtrarRecogidas();

            } catch (error) {
                console.error('Error cargando recogidas:', error);
                document.getElementById('loadingIndicator').innerHTML = '‚ùå Error al cargar recogidas';
            }
        }

        // Filtrar recogidas por fecha
        function filtrarRecogidas() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;

            recogidasFiltradas = todasLasRecogidas.filter(recogida => {
                const fechaRecogida = new Date(recogida.fecha);
                const inicio = fechaInicio ? new Date(fechaInicio) : new Date('1900-01-01');
                const fin = fechaFin ? new Date(fechaFin) : new Date('2100-12-31');

                return fechaRecogida >= inicio && fechaRecogida <= fin;
            });

            console.log('Recogidas filtradas:', recogidasFiltradas.length);
            mostrarRecogidas();
        }

        // Mostrar recogidas filtradas
        function mostrarRecogidas() {
            document.getElementById('loadingIndicator').style.display = 'none';

            if (recogidasFiltradas.length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('resumenTotales').style.display = 'none';
                document.getElementById('btnRecibo').style.display = 'none';
                document.getElementById('recogidasContainer').innerHTML = '';
                return;
            }

            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('resumenTotales').style.display = 'grid';
            document.getElementById('btnRecibo').style.display = 'block';

            // Calcular totales
            let totalRecogidas = recogidasFiltradas.length;
            let totalKilos = 0;
            let totalValor = 0;
            let totalPesas = 0;

            recogidasFiltradas.forEach(recogida => {
                totalKilos += recogida.totalKilos || 0;
                totalValor += recogida.valorPagar || 0;
                totalPesas += recogida.pesas ? recogida.pesas.length : 0;
            });

            // Actualizar resumen
            document.getElementById('totalRecogidas').textContent = totalRecogidas;
            document.getElementById('totalKilos').textContent = totalKilos + ' kg';
            document.getElementById('totalValor').textContent = '$' + totalValor.toLocaleString();
            document.getElementById('totalPesas').textContent = totalPesas;

            // Mostrar recogidas
            const container = document.getElementById('recogidasContainer');
            container.innerHTML = '';

            recogidasFiltradas.forEach((recogida, index) => {
                const card = crearTarjetaRecogida(recogida, index + 1);
                container.appendChild(card);
            });
        }

        // Crear tarjeta de recogida
        function crearTarjetaRecogida(recogida, numero) {
            const div = document.createElement('div');
            div.className = 'recogida-card';

            const fecha = new Date(recogida.fecha).toLocaleDateString('es-ES');
            const totalPesas = recogida.pesas ? recogida.pesas.length : 0;

            div.innerHTML = `
                <div class="recogida-header">
                    <div class="recogida-fecha">üìÖ ${fecha} - Recogida #${numero}</div>
                    <div style="font-size: 14px; color: #6c757d;">üë§ ${recogida.alias || recogida.usuario}</div>
                </div>
                
                <div class="recogida-info">
                    <div class="info-item">
                        <strong>${recogida.fruta || 'N/A'}</strong>
                        <span>Fruta Principal</span>
                    </div>
                    <div class="info-item">
                        <strong>${recogida.calidad || 'N/A'}</strong>
                        <span>Calidad Principal</span>
                    </div>
                    <div class="info-item">
                        <strong>${recogida.totalKilos || 0} kg</strong>
                        <span>Total Kilos</span>
                    </div>
                    ${!isSubusuario ? `
                    <div class="info-item">
                        <strong>$${(recogida.valorPagar || 0).toLocaleString()}</strong>
                        <span>Valor Total</span>
                    </div>
                    ` : ''}
                    <div class="info-item">
                        <strong>${totalPesas}</strong>
                        <span>Pesas</span>
                    </div>
                </div>
                
                ${recogida.pesas && recogida.pesas.length > 0 ? `
                <div class="pesas-detalle">
                    <strong>üì¶ Detalle de Pesas:</strong>
                    <div class="pesas-grid">
                        ${recogida.pesas.map((pesa, idx) => `
                            <div class="pesa-item">
                                <strong>Pesa ${idx + 1}</strong><br>
                                ${pesa.kilos} kg<br>
                                ${pesa.fruta || recogida.fruta}<br>
                                ${pesa.calidad || recogida.calidad}
                                ${!isSubusuario && pesa.valor ? `<br>$${pesa.valor.toLocaleString()}` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;

            return div;
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            recogidasFiltradas = [...todasLasRecogidas];
            mostrarRecogidas();
        }

        // Volver al dashboard
        function volverDashboard() {
            window.history.back();
        }

        // Generar recibo de liquidaci√≥n con m√∫ltiples p√°ginas
        async function generarReciboLiquidacion() {
            if (recogidasFiltradas.length === 0) {
                alert('No hay recogidas para generar el recibo');
                return;
            }

            try {
                console.log('üöÄ Iniciando generaci√≥n de recibo de liquidaci√≥n...');
                
                // Procesar datos para el recibo - SOLO RECOGIDAS FILTRADAS
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                
                const resumenPorFrutaCalidad = {};
                let totalKilosGeneral = 0;
                let totalValorGeneral = 0;
                let totalPesasGeneral = 0;

                console.log('üìä Procesando', recogidasFiltradas.length, 'recogidas filtradas...');

                recogidasFiltradas.forEach(recogida => {
                    totalKilosGeneral += recogida.totalKilos || 0;
                    totalValorGeneral += recogida.valorPagar || 0;
                    
                    if (recogida.pesas) {
                        totalPesasGeneral += recogida.pesas.length;
                        
                        recogida.pesas.forEach(pesa => {
                            const fruta = pesa.fruta || recogida.fruta || 'Sin especificar';
                            const calidad = pesa.calidad || recogida.calidad || 'Sin especificar';
                            const precio = pesa.precio || recogida.precio || 0;
                            const clave = `${fruta} - ${calidad}`;
                            
                            if (!resumenPorFrutaCalidad[clave]) {
                                resumenPorFrutaCalidad[clave] = {
                                    kilos: 0,
                                    valor: 0,
                                    precio: precio,
                                    cantidad: 0
                                };
                            }
                            
                            resumenPorFrutaCalidad[clave].kilos += pesa.kilos || 0;
                            resumenPorFrutaCalidad[clave].valor += pesa.valor || 0;
                            resumenPorFrutaCalidad[clave].cantidad += 1;
                        });
                    }
                });

                console.log('üìã Resumen procesado:', Object.keys(resumenPorFrutaCalidad).length, 'combinaciones fruta-calidad');

                // üî• DIVIDIR EN P√ÅGINAS DE 15 ELEMENTOS M√ÅXIMO
                const entradasResumen = Object.entries(resumenPorFrutaCalidad);
                const ITEMS_POR_PAGINA = 15;
                const totalPaginas = Math.ceil(entradasResumen.length / ITEMS_POR_PAGINA);
                
                console.log('üìÑ Se generar√°n', totalPaginas, 'p√°ginas de recibo');

                const archivos = [];

                // Generar cada p√°gina
                for (let i = 0; i < totalPaginas; i++) {
                    const inicio = i * ITEMS_POR_PAGINA;
                    const fin = Math.min(inicio + ITEMS_POR_PAGINA, entradasResumen.length);
                    const entradasPagina = entradasResumen.slice(inicio, fin);
                    
                    console.log(`üìÑ Generando p√°gina ${i + 1}/${totalPaginas} con ${entradasPagina.length} elementos`);

                    // Convertir de vuelta a objeto para esta p√°gina
                    const resumenPagina = {};
                    entradasPagina.forEach(([clave, datos]) => {
                        resumenPagina[clave] = datos;
                    });

                    // Crear p√°gina de recibo
                    const divRecibo = crearReciboLiquidacionPaginado(
                        resumenPagina,
                        totalKilosGeneral,
                        totalValorGeneral,
                        totalPesasGeneral,
                        recogidasFiltradas.length,
                        fechaInicio,
                        fechaFin,
                        i + 1,
                        totalPaginas
                    );

                    document.body.appendChild(divRecibo);
                    await document.fonts.ready;

                    // Generar imagen
                    const canvas = await html2canvas(divRecibo, {
                        scale: 3,
                        useCORS: true,
                        allowTaint: false,
                        backgroundColor: '#ffffff',
                        width: divRecibo.offsetWidth,
                        height: divRecibo.offsetHeight,
                        logging: false,
                        imageTimeout: 0
                    });

                    document.body.removeChild(divRecibo);

                    // Crear archivo
                    const blob = await new Promise(resolve => 
                        canvas.toBlob(resolve, "image/png", 1.0)
                    );
                    
                    const nombreArchivo = totalPaginas > 1 ? 
                        `liquidacion_${fincaNombre}_pagina_${i + 1}.png` :
                        `liquidacion_${fincaNombre}.png`;
                    
                    const file = new File([blob], nombreArchivo, { type: "image/png" });
                    archivos.push(file);
                }

                // Compartir todos los archivos
                const mensaje = totalPaginas > 1 ?
                    `üí∞ Liquidaci√≥n de ${fincaNombre}\nüìä ${recogidasFiltradas.length} recogidas\n‚öñÔ∏è ${totalKilosGeneral} kg totales\nüìÑ ${totalPaginas} p√°ginas generadas` :
                    `üí∞ Liquidaci√≥n de ${fincaNombre}\nüìä ${recogidasFiltradas.length} recogidas\n‚öñÔ∏è ${totalKilosGeneral} kg totales`;

                console.log('üì§ Compartiendo', archivos.length, 'archivos...');

                await navigator.share({
                    title: 'Liquidaci√≥n de Finca',
                    text: mensaje,
                    files: archivos,
                });

                console.log('‚úÖ Recibo de liquidaci√≥n generado y compartido exitosamente');

            } catch (error) {
                console.error('‚ùå Error generando recibo:', error);
                alert('Error al generar el recibo: ' + error.message);
            }
        }

        // Crear recibo de liquidaci√≥n paginado con el mismo estilo
        function crearReciboLiquidacionPaginado(resumen, totalKilos, totalValor, totalPesas, totalRecogidas, fechaInicio, fechaFin, numeroPagina, totalPaginasRecibo) {
            const div = document.createElement("div");
            div.style.cssText = `
                width: 800px;
                min-height: 1000px;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                color: #2c3e50;
                font-family: 'Arial', sans-serif;
                padding: 30px;
                margin: 0;
                box-sizing: border-box;
                position: relative;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            `;

            const periodo = fechaInicio && fechaFin ? 
                `${new Date(fechaInicio).toLocaleDateString('es-ES')} - ${new Date(fechaFin).toLocaleDateString('es-ES')}` :
                'Todas las fechas';

            const tituloRecibo = totalPaginasRecibo > 1 ? 
                `üí∞ LIQUIDACI√ìN DE FINCA - P√ÅGINA ${numeroPagina}/${totalPaginasRecibo}` :
                `üí∞ LIQUIDACI√ìN DE FINCA`;

            div.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="margin: 0; font-size: 32px; font-weight: bold; color: #34495e;">
                        ${tituloRecibo}
                    </h1>
                    <div style="width: 60px; height: 4px; background: linear-gradient(to right, #3498db, #2ecc71); margin: 15px auto; border-radius: 2px;"></div>
                    ${totalPaginasRecibo > 1 ? `<p style="margin: 5px 0; font-size: 14px; color: #7f8c8d;">P√°gina ${numeroPagina} de ${totalPaginasRecibo}</p>` : ''}
                </div>

                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; margin-bottom: 25px; backdrop-filter: blur(10px);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 16px;">
                        <div><strong>üè† Finca:</strong> ${fincaNombre || 'Sin especificar'}</div>
                        <div><strong>üë§ Propietario:</strong> ${propietario || 'Sin especificar'}</div>
                        <div><strong>üìÖ Per√≠odo:</strong> ${periodo}</div>
                        <div><strong>üìä Total Recogidas:</strong> ${totalRecogidas}</div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; margin-bottom: 25px; backdrop-filter: blur(10px);">
                    <h3 style="margin: 0 0 25px 0; text-align: center; font-size: 20px;">üìã RESUMEN POR FRUTA Y CALIDAD</h3>
                    <div style="display: grid; gap: 12px;">
                        ${Object.entries(resumen).map(([clave, datos]) => `
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; display: grid; grid-template-columns: 2.5fr 1fr 1fr 1fr ${!isSubusuario ? '1.2fr' : ''}; gap: 12px; align-items: center; color: #2c3e50; box-shadow: 0 3px 10px rgba(0,0,0,0.1); font-size: 14px;">
                            <div style="font-weight: bold; color: #2c3e50;">${clave}</div>
                            <div style="text-align: center; color: #2c3e50; font-weight: 600;">${datos.kilos} kg</div>
                            <div style="text-align: center; color: #2c3e50;">${datos.cantidad} pesas</div>
                            <div style="text-align: center; color: #2c3e50;">${datos.precio.toLocaleString()}/kg</div>
                            ${!isSubusuario ? `<div style="text-align: center; color: #2c3e50; font-weight: bold;">${datos.valor.toLocaleString()}</div>` : ''}
                        </div>
                        `).join('')}
                    </div>
                </div>

                ${numeroPagina === totalPaginasRecibo ? `
                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; text-align: center; margin-top: 30px;">
                    <h2 style="margin: 0 0 15px 0; font-size: 24px; color: #2c3e50; font-weight: bold;">
                        üéØ TOTALES GENERALES DE LA LIQUIDACI√ìN
                    </h2>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 15px; font-size: 16px; opacity: 0.9; flex-wrap: wrap;">
                        <span style="color: #2c3e50; font-weight: bold; background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px;">üì¶ ${totalRecogidas} recogidas</span>
                        <span style="color: #2c3e50; font-weight: bold; background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px;">‚öñÔ∏è ${totalKilos} kg</span>
                        ${!isSubusuario ? `<span style="color: #2c3e50; font-weight: bold; background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px;">üí∞ ${totalValor.toLocaleString()}</span>` : ''}
                        <span style="color: #2c3e50; font-weight: bold; background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px;">üìä ${totalPesas} pesas</span>
                    </div>
                </div>
                ` : `
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center; margin-top: 20px; border: 2px dashed rgba(255,255,255,0.3);">
                    <p style="margin: 0; font-size: 16px; color: #2c3e50; opacity: 0.7;">
                        üìÑ Contin√∫a en la p√°gina ${numeroPagina + 1}/${totalPaginasRecibo}
                    </p>
                </div>
                `}

                <div style="position: absolute; bottom: 20px; right: 30px; font-size: 12px; color: #95a5a6;">
                    Generado: ${new Date().toLocaleString()}
                </div>
            `;

            return div;
        }
    </script>
</body>
</html>