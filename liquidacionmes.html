<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jc-loader.js"></script>
      <script src="blockCheck.js"></script>

    <title>Gesti√≥n de Liquidaciones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f0f0f0;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 36px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 14px;
        }

        .filters-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }

        .filter-group input, .filter-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .liquidaciones-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .liquidacion-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .liquidacion-card:hover {
            border-color: #667eea;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .liquidacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .liquidacion-fecha {
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .estado-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .estado-pendiente {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .estado-liquidada {
            background: #d1edff;
            color: #0c5460;
            border: 1px solid #bee1e5;
        }

        .estado-cancelada {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .liquidacion-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .info-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: #6c757d;
            font-weight: 500;
        }

        .info-value {
            color: #2c3e50;
            font-weight: bold;
        }

        .pesas-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .pesas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .pesa-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .pesa-item strong {
            display: block;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .actions-section {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 18px;
            color: #6c757d;
        }

        .loading::before {
            content: "üîÑ";
            display: block;
            font-size: 48px;
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .no-data::before {
            content: "üì≠";
            display: block;
            font-size: 64px;
            margin-bottom: 20px;
        }

        .back-button {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 1000;
        }

        .summary-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .filters-container {
                grid-template-columns: 1fr;
            }
            
            .liquidacion-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .liquidacion-info {
                grid-template-columns: 1fr;
            }

            .back-button, .summary-button {
                position: static;
                margin: 10px 0;
            }
        }

        .filter-clear {
            background: #dc3545;
            color: white;
        }

        .highlight {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea !important;
        }
    </style>
</head>
<body>

        <div class="back-button">
        <button class="btn btn-secondary" onclick="volverDashboard()">
            ‚Üê Volver
        </button>
    </div>

    <div class="container">
        <div class="header">
            <h1>üí∞ Gesti√≥n de Liquidaciones</h1>
            <p>Administra y controla todas las recogidas marcadas para liquidaci√≥n</p>
        </div>

        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <h3 id="totalPendientes">0</h3>
                <p>‚è≥ Pendientes</p>
            </div>
            <div class="stat-card">
                <h3 id="totalLiquidadas">0</h3>
                <p>‚úÖ Liquidadas</p>
            </div>
            <div class="stat-card">
                <h3 id="totalKilos">0</h3>
                <p>‚öñÔ∏è Kilos Totales</p>
            </div>
            <div class="stat-card" id="totalValorCard">
                <h3 id="totalValor">$0</h3>
                <p>üí∞ Valor Total</p>
            </div>
        </div>

        <div class="filters-container">
            <div class="filter-group">
                <label for="filtroRecolector">üë§ Recolector:</label>
                <input type="text" id="filtroRecolector" placeholder="Buscar por alias/usuario">
            </div>
            <div class="filter-group">
                <label for="filtroPropietario">üè† Propietario:</label>
                <input type="text" id="filtroPropietario" placeholder="Buscar por propietario">
            </div>
            <div class="filter-group">
                <label for="filtroFinca">üåæ Finca:</label>
                <input type="text" id="filtroFinca" placeholder="Buscar por finca">
            </div>
            <div class="filter-group">
                <label style="display: none;" for="filtroEstado">üìä Estado:</label>
                <select style="display: none;"  id="filtroEstado">
                    <option value="todas">Todas</option>
                    <option value="pendiente">‚è≥ Pendientes</option>
                    <option value="liquidada">‚úÖ Liquidadas</option>
                    <option value="cancelada">‚ùå Canceladas</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filtroFecha">üìÖ Fecha:</label>
                <input type="date" id="filtroFecha">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn filter-clear" onclick="limpiarFiltros()">
                    üßπ Limpiar Filtros
                </button>
            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            Cargando liquidaciones...
        </div>

        <div id="noDataMessage" class="no-data" style="display: none;">
            <h3>No se encontraron liquidaciones</h3>
            <p>No hay recogidas que coincidan con los filtros aplicados</p>
        </div>

        <div class="liquidaciones-grid" id="liquidacionesContainer">
        </div>
    </div>



    <div style="display: none;" class="summary-button">
        <button class="btn btn-success" onclick="generarResumenGeneral()" id="btnResumen" style="display: none;">
            üìä Resumen General
        </button>
    </div>

    <!-- Script para html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Variables globales
        let todasLasLiquidaciones = [];
        let liquidacionesFiltradas = [];
        let isSubusuario = false;
        let adminAlias = '';
        let usuario = '';

        // Obtener par√°metros de URL
        const urlParams = new URLSearchParams(window.location.search);
        adminAlias = urlParams.get('adminAlias') || '';
        usuario = urlParams.get('usuario') || '';

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            if (!adminAlias) {
                // Intentar obtener de sessionStorage
                const storedData = sessionStorage.getItem('userData');
                if (storedData) {
                    const sessionData = JSON.parse(storedData);
                    adminAlias = sessionData.adminAlias || sessionData.alias;
                    usuario = sessionData.username;
                }
                
                if (!adminAlias) {
                    alert('Error: No se pudo determinar el administrador');
                    volverDashboard();
                    return;
                }
            }

            // Verificar tipo de usuario
            await verificarTipoUsuario();

            // Configurar filtros en tiempo real
            configurarFiltros();

            // Cargar liquidaciones
            await cargarLiquidaciones();
        });

        // Verificar tipo de usuario
        async function verificarTipoUsuario() {
            try {
                const storedData = sessionStorage.getItem('userData');
                if (storedData) {
                    const sessionData = JSON.parse(storedData);
                    isSubusuario = sessionData.tipo === 2;
                } else if (usuario) {
                    const response = await fetch(`https://jc-frutas.onrender.com/auth/get-alias?usuario=${encodeURIComponent(usuario)}`);
                    if (response.ok) {
                        const userData = await response.json();
                        isSubusuario = userData.tipo === 2;
                    }
                }

                // Ocultar valores monetarios para subusuarios
                if (isSubusuario) {
                    document.getElementById('totalValorCard').style.display = 'none';
                }
            } catch (error) {
                console.error('Error verificando tipo de usuario:', error);
            }
        }

        // Configurar filtros en tiempo real
        function configurarFiltros() {
            const filtros = ['filtroRecolector', 'filtroPropietario', 'filtroFinca', 'filtroEstado', 'filtroFecha'];
            
            filtros.forEach(filtroId => {
                const elemento = document.getElementById(filtroId);
                elemento.addEventListener('input', filtrarLiquidaciones);
                elemento.addEventListener('change', filtrarLiquidaciones);
            });
        }

        // Cargar todas las liquidaciones
        async function cargarLiquidaciones() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('noDataMessage').style.display = 'none';

                // Primero intentamos obtener liquidaciones pendientes
                let response = await fetch(`https://jc-frutas.onrender.com/recogidas/liquidaciones/${adminAlias}?usuario=${encodeURIComponent(usuario)}`);
                
                if (!response.ok) {
                    throw new Error('Error al cargar liquidaciones pendientes');
                }

                const liquidacionesPendientes = await response.json();

                // Luego obtenemos el historial completo
                response = await fetch(`https://jc-frutas.onrender.com/recogidas/historial-liquidaciones/${adminAlias}?usuario=${encodeURIComponent(usuario)}`);
                
                if (!response.ok) {
                    throw new Error('Error al cargar historial de liquidaciones');
                }

                const historialLiquidaciones = await response.json();

                // Combinar ambos resultados evitando duplicados
                const todasIds = new Set();
                todasLasLiquidaciones = [];

                // Agregar liquidaciones pendientes
                liquidacionesPendientes.recogidas.forEach(liquidacion => {
                    if (!todasIds.has(liquidacion._id)) {
                        todasLasLiquidaciones.push(liquidacion);
                        todasIds.add(liquidacion._id);
                    }
                });

                // Agregar historial
                historialLiquidaciones.recogidas.forEach(liquidacion => {
                    if (!todasIds.has(liquidacion._id)) {
                        todasLasLiquidaciones.push(liquidacion);
                        todasIds.add(liquidacion._id);
                    }
                });

                console.log('Liquidaciones cargadas:', todasLasLiquidaciones.length);

                // Aplicar filtros
                filtrarLiquidaciones();

            } catch (error) {
                console.error('Error cargando liquidaciones:', error);
                document.getElementById('loadingIndicator').innerHTML = '‚ùå Error al cargar liquidaciones: ' + error.message;
            }
        }

        // Filtrar liquidaciones
        function filtrarLiquidaciones() {
            const filtroRecolector = document.getElementById('filtroRecolector').value.toLowerCase();
            const filtroPropietario = document.getElementById('filtroPropietario').value.toLowerCase();
            const filtroFinca = document.getElementById('filtroFinca').value.toLowerCase();
            const filtroEstado = document.getElementById('filtroEstado').value;
            const filtroFecha = document.getElementById('filtroFecha').value;

            liquidacionesFiltradas = todasLasLiquidaciones.filter(liquidacion => {
                // Filtro por recolector (alias o usuario)
                const cumpleRecolector = !filtroRecolector || 
                    (liquidacion.alias && liquidacion.alias.toLowerCase().includes(filtroRecolector)) ||
                    (liquidacion.usuario && liquidacion.usuario.toLowerCase().includes(filtroRecolector));

                // Filtro por propietario
                const cumplePropietario = !filtroPropietario || 
                    (liquidacion.propietario && liquidacion.propietario.toLowerCase().includes(filtroPropietario));

                // Filtro por finca
                const cumpleFinca = !filtroFinca || 
                    (liquidacion.finca && liquidacion.finca.toLowerCase().includes(filtroFinca));

                // Filtro por estado
                const cumpleEstado = filtroEstado === 'todas' || 
                    liquidacion.estadoLiquidacion === filtroEstado ||
                    (!liquidacion.estadoLiquidacion && filtroEstado === 'pendiente');

                // Filtro por fecha
                let cumpleFecha = true;
                if (filtroFecha) {
                    const fechaLiquidacion = liquidacion.fecha ? liquidacion.fecha.split('T')[0] : '';
                    cumpleFecha = fechaLiquidacion === filtroFecha;
                }

                return cumpleRecolector && cumplePropietario && cumpleFinca && cumpleEstado && cumpleFecha;
            });

            mostrarLiquidaciones();
        }

        // Mostrar liquidaciones filtradas
        function mostrarLiquidaciones() {
            document.getElementById('loadingIndicator').style.display = 'none';

            if (liquidacionesFiltradas.length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('btnResumen').style.display = 'none';
                document.getElementById('liquidacionesContainer').innerHTML = '';
                return;
            }

            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'grid';
            document.getElementById('btnResumen').style.display = 'block';

            // Calcular estad√≠sticas
            let totalPendientes = 0;
            let totalLiquidadas = 0;
            let totalKilos = 0;
            let totalValor = 0;

            liquidacionesFiltradas.forEach(liquidacion => {
                const estado = liquidacion.estadoLiquidacion || 'pendiente';
                
                if (estado === 'pendiente') totalPendientes++;
                else if (estado === 'liquidada') totalLiquidadas++;
                
                totalKilos += liquidacion.totalKilos || 0;
                if (!isSubusuario) {
                    totalValor += liquidacion.valorPagar || 0;
                }
            });

            // Actualizar estad√≠sticas
            document.getElementById('totalPendientes').textContent = totalPendientes;
            document.getElementById('totalLiquidadas').textContent = totalLiquidadas;
            document.getElementById('totalKilos').textContent = totalKilos + ' kg';
            if (!isSubusuario) {
                document.getElementById('totalValor').textContent = '$' + totalValor.toLocaleString();
            }

            // Mostrar liquidaciones
            const container = document.getElementById('liquidacionesContainer');
            container.innerHTML = '';

            liquidacionesFiltradas.forEach((liquidacion, index) => {
                const card = crearTarjetaLiquidacion(liquidacion, index + 1);
                container.appendChild(card);
            });
        }

        // Crear tarjeta de liquidaci√≥n
        function crearTarjetaLiquidacion(liquidacion, numero) {
            const div = document.createElement('div');
            div.className = 'liquidacion-card';

            const fecha = formatearFechaLocal(liquidacion.fecha);
            const estado = liquidacion.estadoLiquidacion || 'pendiente';
            const totalPesas = liquidacion.pesas ? liquidacion.pesas.length : 0;

            // Clases y textos para estados
            const estadoClases = {
                'pendiente': 'estado-pendiente',
                'liquidada': 'estado-liquidada',
                'cancelada': 'estado-cancelada'
            };

            const estadoTextos = {
                'pendiente': '‚è≥ Pendiente',
                'liquidada': '‚úÖ Liquidada',
                'cancelada': '‚ùå Cancelada'
            };

            div.innerHTML = `
                <div class="liquidacion-header">
                    <div class="liquidacion-fecha">
                        üìÖ ${fecha} - Liquidaci√≥n #${numero}
                    </div>
                    <div class="estado-badge ${estadoClases[estado]}">
                        ${estadoTextos[estado]}
                    </div>
                </div>
                
                <div class="liquidacion-info">
                    <div class="info-section">
                        <h4>üè† Informaci√≥n de Finca</h4>
                        <div class="info-item">
                            <span class="info-label">Finca:</span>
                            <span class="info-value">${liquidacion.finca || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Propietario:</span>
                            <span class="info-value">${liquidacion.propietario || 'N/A'}</span>
                        </div>


                    <div class="info-section">
                        <h4>üë§ Informaci√≥n de Recogida</h4>
                        <div class="info-item">
                            <span class="info-label">Recolector:</span>
                            <span class="info-value">${liquidacion.alias || liquidacion.usuario}</span>
                        </div>


                    </div>

                    <div class="info-section">
                        <h4>üìä Totales</h4>
                        <div class="info-item">
                            <span class="info-label">Total Kilos:</span>
                            <span class="info-value">${liquidacion.totalKilos || 0} kg</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Total Pesas:</span>
                            <span class="info-value">${totalPesas}</span>
                        </div>
                        ${!isSubusuario ? `
                        <div class="info-item">
                            <span class="info-label">Valor Total:</span>
                            <span class="info-value">$${(liquidacion.valorPagar || 0).toLocaleString()}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>

                ${liquidacion.pesas && liquidacion.pesas.length > 0 ? `
 
                ` : ''}

                <div class="actions-section">
                    ${estado === 'pendiente' ? `
                        <button class="btn btn-success" onclick="cambiarEstadoLiquidacion('${liquidacion._id}', 'liquidada')">
                            ‚úÖ Marcar como Liquidada
                        </button>
                        <button class="btn btn-warning" onclick="cambiarEstadoLiquidacion('${liquidacion._id}', 'cancelada')">
                            ‚ùå Cancelar Liquidaci√≥n
                        </button>
                    ` : ''}
                    


                    <button class="btn btn-primary" onclick="verDetalleLiquidacion('${liquidacion._id}')">
                        üëÅÔ∏è Ver Detalles
                    </button>
                </div>
            `;

            return div;
        }

        // Cambiar estado de liquidaci√≥n
        async function cambiarEstadoLiquidacion(liquidacionId, nuevoEstado) {
            const confirmMessages = {
                'liquidada': '¬øConfirma que desea marcar esta recogida como liquidada?',
                'pendiente': '¬øDesea marcar esta recogida como pendiente de liquidaci√≥n?',
                'cancelada': '¬øEst√° seguro de que desea cancelar esta liquidaci√≥n?'
            };

            if (!confirm(confirmMessages[nuevoEstado])) {
                return;
            }

            try {
                const storedData = sessionStorage.getItem('userData');
                let usuarioActual = usuario;

                if (storedData) {
                    const sessionData = JSON.parse(storedData);
                    usuarioActual = sessionData.username;
                }

                const response = await fetch(`https://jc-frutas.onrender.com/recogidas/cambiar-estado-liquidacion/${liquidacionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        estado: nuevoEstado,
                        usuario: usuarioActual
                    })
                });

                if (!response.ok) {
                    throw new Error('Error al cambiar estado de liquidaci√≥n');
                }

                const result = await response.json();
                
                if (result.success) {
                    // Mostrar confirmaci√≥n
                    mostrarNotificacion(`‚úÖ Estado cambiado a "${nuevoEstado}" exitosamente`, 'success');

                    // Recargar liquidaciones
                    await cargarLiquidaciones();
                }
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                mostrarNotificacion('‚ùå Error al cambiar el estado: ' + error.message, 'error');
            }
        }

        // Ver detalle de liquidaci√≥n
        function verDetalleLiquidacion(liquidacionId) {
            const liquidacion = todasLasLiquidaciones.find(l => l._id === liquidacionId);
            if (!liquidacion) {
                mostrarNotificacion('‚ùå No se encontr√≥ la liquidaci√≥n', 'error');
                return;
            }

            // Crear modal con detalle completo
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 30px;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;

            const fecha = formatearFechaLocal(liquidacion.fecha);
            const estado = liquidacion.estadoLiquidacion || 'pendiente';
            const totalPesas = liquidacion.pesas ? liquidacion.pesas.length : 0;

            modalContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #2c3e50; margin-bottom: 10px;">üìã Detalle de Liquidaci√≥n</h2>
                    <p style="color: #7f8c8d;">Informaci√≥n completa de la recogida</p>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üìÖ ${fecha}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>üè† Finca:</strong> ${liquidacion.finca || 'N/A'}</div>
                        <div><strong>üë§ Propietario:</strong> ${liquidacion.propietario || 'N/A'}</div>
                        <div><strong>üåæ Recolector:</strong> ${liquidacion.alias || liquidacion.usuario}</div>
                        <div><strong>üìä Estado:</strong> ${estado}</div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üìä Resumen de Recogida</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                            <strong style="display: block; font-size: 24px; color: #667eea;">${liquidacion.totalKilos || 0}</strong>
                            <span style="color: #6c757d;">Kilos Totales</span>
                        </div>
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                            <strong style="display: block; font-size: 24px; color: #667eea;">${totalPesas}</strong>
                            <span style="color: #6c757d;">Total Pesas</span>
                        </div>
                        ${!isSubusuario ? `
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                            <strong style="display: block; font-size: 24px; color: #667eea;">${(liquidacion.valorPagar || 0).toLocaleString()}</strong>
                            <span style="color: #6c757d;">Valor Total</span>
                        </div>
                        ` : ''}
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 10px;">
                            <strong style="display: block; font-size: 24px; color: #667eea;">${liquidacion.fruta || 'N/A'}</strong>
                            <span style="color: #6c757d;">Fruta Principal</span>
                        </div>
                    </div>
                </div>

                ${liquidacion.pesas && liquidacion.pesas.length > 0 ? `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üì¶ Detalle de ${totalPesas} Pesas</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        ${liquidacion.pesas.map((pesa, idx) => `
                            <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; font-size: 13px;">
                                <strong style="display: block; color: #2c3e50; margin-bottom: 5px;">Pesa ${idx + 1}</strong>
                                <div>${pesa.kilos} kg</div>
                                <div style="color: #667eea;">${pesa.fruta || liquidacion.fruta}</div>
                                <div style="color: #6c757d;">${pesa.calidad || liquidacion.calidad}</div>
                                ${!isSubusuario && pesa.valor ? `<div style="font-weight: bold; color: #28a745;">${pesa.valor.toLocaleString()}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${liquidacion.fechaMarcadoLiquidacion || liquidacion.fechaLiquidacion ? `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üìã Historial de Liquidaci√≥n</h3>
                    ${liquidacion.fechaMarcadoLiquidacion ? `
                        <div style="margin-bottom: 10px;">
                            <strong>‚è≥ Marcado para liquidaci√≥n:</strong> ${formatearFechaLocal(liquidacion.fechaMarcadoLiquidacion)}
                            ${liquidacion.usuarioMarcaLiquidacion ? ` por ${liquidacion.usuarioMarcaLiquidacion}` : ''}
                        </div>
                    ` : ''}
                    ${liquidacion.fechaLiquidacion ? `
                        <div>
                            <strong>‚úÖ Liquidado:</strong> ${formatearFechaLocal(liquidacion.fechaLiquidacion)}
                            ${liquidacion.usuarioLiquida ? ` por ${liquidacion.usuarioLiquida}` : ''}
                        </div>
                    ` : ''}
                </div>
                ` : ''}

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="cerrarModal()" style="padding: 12px 30px;">
                        Cerrar
                    </button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Funci√≥n para cerrar modal
            window.cerrarModal = function() {
                document.body.removeChild(modal);
                delete window.cerrarModal;
            };

            // Cerrar al hacer clic fuera del modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    window.cerrarModal();
                }
            });
        }

// Formatear fecha local - CORREGIDO PARA OBJETOS DATE CON UTC
        function formatearFechaLocal(fechaString) {
            if (!fechaString) return 'Sin fecha';
            
            // Log para debug
            console.log('üîç Formateando fecha:', fechaString, typeof fechaString);
            
            try {
                let fecha = null;
                
                // Caso 1: Ya es un objeto Date
                if (fechaString instanceof Date) {
                    fecha = fechaString;
                }
                // Caso 2: String que parece un objeto Date serializado
                else if (typeof fechaString === 'string' && (fechaString.includes('GMT') || fechaString.includes('UTC'))) {
                    // Crear fecha desde el string del objeto Date
                    fecha = new Date(fechaString);
                }
                // Caso 3: String con formato ISO (2024-08-04T00:00:00.000Z)
                else if (typeof fechaString === 'string' && fechaString.includes('T')) {
                    const fechaSolo = fechaString.split('T')[0];
                    const partes = fechaSolo.split('-');
                    
                    if (partes.length === 3 && partes[0].length === 4) {
                        const a√±o = parseInt(partes[0]);
                        const mes = parseInt(partes[1]) - 1;
                        const dia = parseInt(partes[2]);
                        
                        if (!isNaN(a√±o) && !isNaN(mes) && !isNaN(dia) && 
                            a√±o > 1900 && a√±o < 2100 && mes >= 0 && mes <= 11 && dia >= 1 && dia <= 31) {
                            fecha = new Date(a√±o, mes, dia);
                        }
                    }
                }
                // Caso 4: String con formato simple (YYYY-MM-DD)
                else if (typeof fechaString === 'string') {
                    const partes = fechaString.split('-');
                    
                    if (partes.length === 3 && partes[0].length === 4) {
                        const a√±o = parseInt(partes[0]);
                        const mes = parseInt(partes[1]) - 1;
                        const dia = parseInt(partes[2]);
                        
                        if (!isNaN(a√±o) && !isNaN(mes) && !isNaN(dia) && 
                            a√±o > 1900 && a√±o < 2100 && mes >= 0 && mes <= 11 && dia >= 1 && dia <= 31) {
                            fecha = new Date(a√±o, mes, dia);
                        }
                    } else {
                        // √öltimo recurso: usar Date.parse()
                        fecha = new Date(fechaString);
                    }
                }
                
                // Verificar si la fecha es v√°lida
                if (fecha && !isNaN(fecha.getTime())) {
                    // Para fechas UTC, usar los m√©todos UTC para evitar conversi√≥n de timezone
                    let fechaFormateada;
                    
                    if (fechaString.toString().includes('GMT+0000') || fechaString.toString().includes('UTC')) {
                        // Es una fecha UTC, extraer componentes usando UTC
                        const a√±o = fecha.getUTCFullYear();
                        const mes = fecha.getUTCMonth();
                        const dia = fecha.getUTCDate();
                        
                        // Crear nueva fecha local con esos componentes
                        const fechaLocal = new Date(a√±o, mes, dia);
                        
                        fechaFormateada = fechaLocal.toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } else {
                        // Fecha normal
                        fechaFormateada = fecha.toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            timeZone: 'America/Bogota'
                        });
                    }
                    
                    console.log('‚úÖ Fecha formateada exitosamente:', fechaFormateada);
                    return fechaFormateada;
                } else {
                    console.warn('‚ö†Ô∏è Fecha inv√°lida despu√©s del procesamiento:', fechaString);
                    return `Fecha inv√°lida: ${fechaString}`;
                }
                
            } catch (error) {
                console.error('‚ùå Error formateando fecha:', fechaString, error);
                return `Error en fecha: ${fechaString}`;
            }
        }
// Mostrar notificaci√≥n
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notificacion = document.createElement('div');
            const colores = {
                'success': 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)',
                'error': 'linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)',
                'warning': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
            };

            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colores[tipo]};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 2000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;

            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);

            // Remover despu√©s de 4 segundos
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notificacion.parentNode) {
                            notificacion.parentNode.removeChild(notificacion);
                        }
                    }, 300);
                }
            }, 4000);
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('filtroRecolector').value = '';
            document.getElementById('filtroPropietario').value = '';
            document.getElementById('filtroFinca').value = '';
            document.getElementById('filtroEstado').value = 'todas';
            document.getElementById('filtroFecha').value = '';
            
            filtrarLiquidaciones();
        }

        // Generar resumen general
        async function generarResumenGeneral() {
            if (liquidacionesFiltradas.length === 0) {
                mostrarNotificacion('‚ùå No hay liquidaciones para generar resumen', 'error');
                return;
            }

            try {
                console.log('üöÄ Generando resumen general de liquidaciones...');
                
                // Procesar datos para el resumen
                const resumenPorEstado = {};
                const resumenPorRecolector = {};
                const resumenPorFinca = {};
                let totalKilosGeneral = 0;
                let totalValorGeneral = 0;
                let totalPesasGeneral = 0;

                liquidacionesFiltradas.forEach(liquidacion => {
                    const estado = liquidacion.estadoLiquidacion || 'pendiente';
                    const recolector = liquidacion.alias || liquidacion.usuario || 'Sin especificar';
                    const finca = liquidacion.finca || 'Sin especificar';

                    // Resumen por estado
                    if (!resumenPorEstado[estado]) {
                        resumenPorEstado[estado] = { cantidad: 0, kilos: 0, valor: 0 };
                    }
                    resumenPorEstado[estado].cantidad++;
                    resumenPorEstado[estado].kilos += liquidacion.totalKilos || 0;
                    resumenPorEstado[estado].valor += liquidacion.valorPagar || 0;

                    // Resumen por recolector
                    if (!resumenPorRecolector[recolector]) {
                        resumenPorRecolector[recolector] = { cantidad: 0, kilos: 0, valor: 0 };
                    }
                    resumenPorRecolector[recolector].cantidad++;
                    resumenPorRecolector[recolector].kilos += liquidacion.totalKilos || 0;
                    resumenPorRecolector[recolector].valor += liquidacion.valorPagar || 0;

                    // Resumen por finca
                    if (!resumenPorFinca[finca]) {
                        resumenPorFinca[finca] = { cantidad: 0, kilos: 0, valor: 0 };
                    }
                    resumenPorFinca[finca].cantidad++;
                    resumenPorFinca[finca].kilos += liquidacion.totalKilos || 0;
                    resumenPorFinca[finca].valor += liquidacion.valorPagar || 0;

                    // Totales generales
                    totalKilosGeneral += liquidacion.totalKilos || 0;
                    totalValorGeneral += liquidacion.valorPagar || 0;
                    if (liquidacion.pesas) {
                        totalPesasGeneral += liquidacion.pesas.length;
                    }
                });

                // Crear resumen visual
                const divResumen = crearResumenGeneral(
                    resumenPorEstado,
                    resumenPorRecolector,
                    resumenPorFinca,
                    totalKilosGeneral,
                    totalValorGeneral,
                    totalPesasGeneral,
                    liquidacionesFiltradas.length
                );

                document.body.appendChild(divResumen);
                await document.fonts.ready;

                // Generar imagen
                const canvas = await html2canvas(divResumen, {
                    scale: 3,
                    useCORS: true,
                    allowTaint: false,
                    backgroundColor: '#ffffff',
                    width: divResumen.offsetWidth,
                    height: divResumen.offsetHeight,
                    logging: false,
                    imageTimeout: 0
                });

                document.body.removeChild(divResumen);

                // Crear archivo
                const blob = await new Promise(resolve => 
                    canvas.toBlob(resolve, "image/png", 1.0)
                );
                
                const nombreArchivo = `resumen_liquidaciones_${new Date().toISOString().split('T')[0]}.png`;
                const file = new File([blob], nombreArchivo, { type: "image/png" });

                // Compartir archivo
                const mensaje = `üìä Resumen de Liquidaciones\nüí∞ ${liquidacionesFiltradas.length} liquidaciones\n‚öñÔ∏è ${totalKilosGeneral} kg totales${!isSubusuario ? `\nüíµ ${totalValorGeneral.toLocaleString()} valor total` : ''}`;

                await navigator.share({
                    title: 'Resumen de Liquidaciones',
                    text: mensaje,
                    files: [file],
                });

                console.log('‚úÖ Resumen general generado y compartido exitosamente');

            } catch (error) {
                console.error('‚ùå Error generando resumen:', error);
                mostrarNotificacion('‚ùå Error al generar resumen: ' + error.message, 'error');
            }
        }

        // Crear resumen general visual
        function crearResumenGeneral(resumenEstado, resumenRecolector, resumenFinca, totalKilos, totalValor, totalPesas, totalLiquidaciones) {
            const div = document.createElement("div");
            div.style.cssText = `
                width: 900px;
                min-height: 1200px;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                color: #2c3e50;
                font-family: 'Arial', sans-serif;
                padding: 40px;
                margin: 0;
                box-sizing: border-box;
                position: relative;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            `;

            const fechaActual = new Date().toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            div.innerHTML = `
                <div style="text-align: center; margin-bottom: 40px;">
                    <h1 style="margin: 0; font-size: 36px; font-weight: bold; color: #34495e;">
                        üìä RESUMEN GENERAL DE LIQUIDACIONES
                    </h1>
                    <div style="width: 80px; height: 4px; background: linear-gradient(to right, #3498db, #2ecc71); margin: 20px auto; border-radius: 2px;"></div>
                    <p style="margin: 10px 0; font-size: 16px; color: #7f8c8d;">Generado el ${fechaActual}</p>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 25px; border-radius: 20px; margin-bottom: 30px; backdrop-filter: blur(10px);">
                    <h2 style="margin: 0 0 20px 0; text-align: center; font-size: 24px; color: #2c3e50;">üéØ TOTALES GENERALES</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: #2c3e50; margin-bottom: 5px;">${totalLiquidaciones}</div>
                            <div style="font-size: 14px; color: #2c3e50; opacity: 0.8;">Total Liquidaciones</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: #2c3e50; margin-bottom: 5px;">${totalKilos}</div>
                            <div style="font-size: 14px; color: #2c3e50; opacity: 0.8;">Kilos Totales</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: #2c3e50; margin-bottom: 5px;">${totalPesas}</div>
                            <div style="font-size: 14px; color: #2c3e50; opacity: 0.8;">Pesas Totales</div>
                        </div>
                        ${!isSubusuario ? `
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: #2c3e50; margin-bottom: 5px;">${totalValor.toLocaleString()}</div>
                            <div style="font-size: 14px; color: #2c3e50; opacity: 0.8;">Valor Total</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 25px; border-radius: 20px; margin-bottom: 30px; backdrop-filter: blur(10px);">
                    <h2 style="margin: 0 0 20px 0; text-align: center; font-size: 20px; color: #2c3e50;">üìä RESUMEN POR ESTADO</h2>
                    <div style="display: grid; gap: 15px;">
                        ${Object.entries(resumenEstado).map(([estado, datos]) => {
                            const iconos = { 'pendiente': '‚è≥', 'liquidada': '‚úÖ', 'cancelada': '‚ùå' };
                            const colores = { 'pendiente': '#f39c12', 'liquidada': '#27ae60', 'cancelada': '#e74c3c' };
                            return `
                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; display: grid; grid-template-columns: 1fr 1fr 1fr ${!isSubusuario ? '1fr' : ''}; gap: 15px; align-items: center;">
                                <div style="font-weight: bold; color: ${colores[estado]}; font-size: 16px;">${iconos[estado]} ${estado.toUpperCase()}</div>
                                <div style="text-align: center; font-weight: bold;">${datos.cantidad} liquidaciones</div>
                                <div style="text-align: center; font-weight: bold;">${datos.kilos} kg</div>
                                ${!isSubusuario ? `<div style="text-align: center; font-weight: bold;">${datos.valor.toLocaleString()}</div>` : ''}
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 25px; border-radius: 20px; margin-bottom: 30px; backdrop-filter: blur(10px);">
                    <h2 style="margin: 0 0 20px 0; text-align: center; font-size: 20px; color: #2c3e50;">üë§ RESUMEN POR RECOLECTOR</h2>
                    <div style="display: grid; gap: 12px;">
                        ${Object.entries(resumenRecolector).slice(0, 10).map(([recolector, datos]) => `
                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; display: grid; grid-template-columns: 2fr 1fr 1fr ${!isSubusuario ? '1fr' : ''}; gap: 15px; align-items: center;">
                                <div style="font-weight: bold; color: #2c3e50;">${recolector}</div>
                                <div style="text-align: center; font-weight: bold;">${datos.cantidad} liquidaciones</div>
                                <div style="text-align: center; font-weight: bold;">${datos.kilos} kg</div>
                                ${!isSubusuario ? `<div style="text-align: center; font-weight: bold;">${datos.valor.toLocaleString()}</div>` : ''}
                            </div>
                        `).join('')}
                        ${Object.entries(resumenRecolector).length > 10 ? `
                            <div style="text-align: center; padding: 10px; color: #7f8c8d; font-style: italic;">
                                ... y ${Object.entries(resumenRecolector).length - 10} recolectores m√°s
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.2); padding: 25px; border-radius: 20px; margin-bottom: 30px; backdrop-filter: blur(10px);">
                    <h2 style="margin: 0 0 20px 0; text-align: center; font-size: 20px; color: #2c3e50;">üè† RESUMEN POR FINCA</h2>
                    <div style="display: grid; gap: 12px;">
                        ${Object.entries(resumenFinca).slice(0, 10).map(([finca, datos]) => `
                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; display: grid; grid-template-columns: 2fr 1fr 1fr ${!isSubusuario ? '1fr' : ''}; gap: 15px; align-items: center;">
                                <div style="font-weight: bold; color: #2c3e50;">${finca}</div>
                                <div style="text-align: center; font-weight: bold;">${datos.cantidad} liquidaciones</div>
                                <div style="text-align: center; font-weight: bold;">${datos.kilos} kg</div>
                                ${!isSubusuario ? `<div style="text-align: center; font-weight: bold;">${datos.valor.toLocaleString()}</div>` : ''}
                            </div>
                        `).join('')}
                        ${Object.entries(resumenFinca).length > 10 ? `
                            <div style="text-align: center; padding: 10px; color: #7f8c8d; font-style: italic;">
                                ... y ${Object.entries(resumenFinca).length - 10} fincas m√°s
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div style="position: absolute; bottom: 20px; right: 40px; font-size: 12px; color: #95a5a6;">
                    Generado: ${new Date().toLocaleString('es-ES')}
                </div>
            `;

            return div;
        }

        // Volver al dashboard
        function volverDashboard() {
            window.history.back();
        }

        // Agregar estilos de animaci√≥n
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>